import{e as n,c as w}from"./subclass-f7409b1b.js";import"./ClassBreaksRenderer-aa69b6ca.js";import{o as R,m as O}from"./jsonUtils-7ee1282d.js";import{j as te,b as re,a as E}from"./UniqueValueRenderer-983c9a3e.js";import{m as j}from"./SimpleRenderer-2c5d637a.js";import{b as d,o as q,a as ie,s as se}from"./Error-21d1d076.js";import{d as ne,C as oe}from"./reactiveUtils-e7d9f86e.js";import{y as a,f as z}from"./JSONSupport-acf2865c.js";import{h as J}from"./typedArrayUtil-2af43698.js";import{i as ae}from"./Clonable-b71fa929.js";import{m as U,y as H,a as le}from"./commonProperties-0c35c2c9.js";import{t as $,p as k}from"./FeatureReductionSelection-d7d28c54.js";import{P}from"./PopupTemplate-18f22683.js";import{o as N}from"./enumeration-4a4e87c4.js";import{o as S}from"./Extent-2b4578b8.js";import{r as _}from"./SpatialReference-428523ee.js";import{D as K}from"./featureLayerUtils-87358b6a.js";import{C as Q}from"./LabelClass-bca4dcea.js";import{D as ue}from"./symbols-b3e075ad.js";import{o as v}from"./screenUtils-7afeb41c.js";import{x as W}from"./MD5-715f37cd.js";import{y as pe}from"./TextSymbol-53669eb2.js";let b=class extends ae(z){constructor(s){super(s),this.expression=null,this.title=null,this.returnType=null}};n([a({type:String,json:{write:!0}})],b.prototype,"expression",void 0),n([a({type:String,json:{write:!0}})],b.prototype,"title",void 0),n([a({type:String,json:{write:!0}})],b.prototype,"returnType",void 0),b=n([w("esri.layers.support.ExpressionInfo")],b);const C=b;var F;let c=F=class extends z{constructor(r){super(r),this.isAutoGenerated=!1,this.name=null,this.alias=null,this.onStatisticField=null,this.onStatisticExpression=null,this.statisticType=null}clone(){return new F({name:this.name,alias:this.alias,isAutoGenerated:this.isAutoGenerated,onStatisticExpression:d(this.onStatisticExpression),onStatisticField:this.onStatisticField,statisticType:this.statisticType})}};n([a({type:Boolean,json:{write:!0}})],c.prototype,"isAutoGenerated",void 0),n([a({type:String,json:{write:!0}})],c.prototype,"name",void 0),n([a({type:String,json:{write:!0}})],c.prototype,"alias",void 0),n([a({type:String,json:{write:!0}})],c.prototype,"onStatisticField",void 0),n([a({type:C,json:{write:!0}})],c.prototype,"onStatisticExpression",void 0),n([a({type:String,json:{write:!0}})],c.prototype,"statisticType",void 0),c=F=n([w("esri.layers.support.AggregateField")],c);const m=c;var V;const de="esri.layers.support.FeatureReductionBinning";let p=V=class extends ${constructor(r){super(r),this.type="binning",this.binType="geohash",this.fixedBinLevel=3,this.labelingInfo=null,this.labelsVisible=!0,this.maxScale=0,this.popupEnabled=!0,this.popupTemplate=null,this.fields=[],this.renderer=null}writeFields(r,s,e){const t=r.filter(i=>i.statisticType!=="avg_angle").map(i=>i.toJSON());q(e,t,s)}readRenderer(r,s,e){var i;const t=(i=s.drawingInfo)==null?void 0:i.renderer;return t?R(t,s,e)??void 0:K(s,e)}clone(){return new V({fields:d(this.fields),fixedBinLevel:this.fixedBinLevel,labelingInfo:d(this.labelingInfo),labelsVisible:this.labelsVisible,maxScale:this.maxScale,popupEnabled:this.popupEnabled,popupTemplate:d(this.popupTemplate),renderer:d(this.renderer)})}};n([N({binning:"binning"})],p.prototype,"type",void 0),n([N({geohash:"geohash"})],p.prototype,"binType",void 0),n([a({type:Number,range:{min:1,max:9},json:{write:!0}})],p.prototype,"fixedBinLevel",void 0),n([a({type:[Q],json:{read:{source:"drawingInfo.labelingInfo"},write:{target:"drawingInfo.labelingInfo"}}})],p.prototype,"labelingInfo",void 0),n([a(U)],p.prototype,"labelsVisible",void 0),n([a({type:Number,json:{default:0,name:"visibilityInfo.maxScale"}})],p.prototype,"maxScale",void 0),n([a(H)],p.prototype,"popupEnabled",void 0),n([a({type:P,json:{name:"popupInfo",write:!0}})],p.prototype,"popupTemplate",void 0),n([a({type:[m],json:{write:!0}})],p.prototype,"fields",void 0),n([_("fields")],p.prototype,"writeFields",null),n([a({types:O,json:{write:{target:"drawingInfo.renderer"}}})],p.prototype,"renderer",void 0),n([S("renderer",["drawingInfo.renderer"])],p.prototype,"readRenderer",null),p=V=n([w(de)],p);const X=p;var T;const ce="esri.layers.support.FeatureReductionCluster";function L(r){var s;return r.type==="simple"&&!((s=r.visualVariables)!=null&&s.length)}let l=T=class extends z{constructor(r){super(r),this.type="cluster",this.clusterRadius=v("80px"),this.clusterMinSize=v("12px"),this.clusterMaxSize=v("50px"),this.maxScale=0,this.popupEnabled=!0,this.popupTemplate=null,this.renderer=null,this.symbol=null,this.labelingInfo=null,this.labelsVisible=!0,this.fields=[]}readRenderer(r,s,e){var i,o;const t=(i=s.drawingInfo)==null?void 0:i.renderer;return(o=t==null?void 0:t.authoringInfo)!=null&&o.isAutoGenerated?null:t?L(t)?null:R(t,s,e)??void 0:K(s,e)}readSymbol(r,s,e){var i,o;const t=(i=s.drawingInfo)==null?void 0:i.renderer;if((o=t==null?void 0:t.authoringInfo)!=null&&o.isAutoGenerated)return null;if(t&&L(t)){const u=R(t,s,e);return u==null?void 0:u.symbol}return null}writeSymbol(r,s,e,t){var o,u;const i=(u=(o=this.renderer)==null?void 0:o.authoringInfo)==null?void 0:u.isAutoGenerated;if(!this.renderer||i){const h=new j({symbol:r});s.drawingInfo={renderer:h.write({},t)}}}writeFields(r,s,e){const t=r.filter(i=>i.statisticType!=="avg_angle").map(i=>i.toJSON());q(e,t,s)}readFields(r,s,e){return r.filter(t=>!t.isAutoGenerated).map(t=>m.fromJSON(t))}clone(){return new T({clusterRadius:this.clusterRadius,clusterMinSize:this.clusterMinSize,clusterMaxSize:this.clusterMaxSize,labelingInfo:d(this.labelingInfo),labelsVisible:this.labelsVisible,fields:d(this.fields),maxScale:this.maxScale,renderer:d(this.renderer),symbol:d(this.symbol),popupEnabled:this.popupEnabled,popupTemplate:d(this.popupTemplate)})}};n([a({type:["cluster"],readOnly:!0,json:{write:!0}})],l.prototype,"type",void 0),n([a({type:Number,cast:r=>r==="auto"?r:v(r),json:{write:!0}})],l.prototype,"clusterRadius",void 0),n([a({type:Number,cast:v,json:{write:!0}})],l.prototype,"clusterMinSize",void 0),n([a({type:Number,cast:v,json:{write:!0}})],l.prototype,"clusterMaxSize",void 0),n([a({type:Number,json:{default:0,name:"visibilityInfo.maxScale"}})],l.prototype,"maxScale",void 0),n([a(H)],l.prototype,"popupEnabled",void 0),n([a({type:P,json:{read:{source:"popupInfo"},write:{target:"popupInfo"}}})],l.prototype,"popupTemplate",void 0),n([a({types:O,json:{write:{target:"drawingInfo.renderer"}}})],l.prototype,"renderer",void 0),n([S("renderer",["drawingInfo.renderer"])],l.prototype,"readRenderer",null),n([a({types:ue})],l.prototype,"symbol",void 0),n([S("symbol",["drawingInfo.renderer"])],l.prototype,"readSymbol",null),n([_("symbol")],l.prototype,"writeSymbol",null),n([a({type:[Q],json:{read:{source:"drawingInfo.labelingInfo"},write:{target:"drawingInfo.labelingInfo"}}})],l.prototype,"labelingInfo",void 0),n([a(U)],l.prototype,"labelsVisible",void 0),n([a({type:[m],json:{write:!0}})],l.prototype,"fields",void 0),n([_("fields")],l.prototype,"writeFields",null),n([S("fields")],l.prototype,"readFields",null),l=T=n([w(ce)],l);const Y=l,B={key:"type",base:$,typeMap:{cluster:Y,binning:X}},fe={types:{key:"type",base:$,typeMap:{selection:k,cluster:Y,binning:X}},json:{name:"layerDefinition.featureReduction",write:{allowNull:!0},origins:{"web-map":{types:B},"portal-item":{types:B},"web-scene":{types:{key:"type",base:$,typeMap:{selection:k}},name:"layerDefinition.featureReduction",write:{layerContainerTypes:le}}}}},me=()=>se.getLogger("esri.views.2d.layers.support.clusterUtils");J.add("esri-cluster-arcade-enabled",!0);const ye=J("esri-cluster-arcade-enabled"),be=new Set(["simple-line","simple-fill","picture-fill"]);function D(r,s){let e=s.clone();if(!ve(e))return e;if(s.getSymbols().some(t=>be.has(t.type))&&(e=new j({symbol:new pe})),e.authoringInfo||(e.authoringInfo=new te),e.authoringInfo.isAutoGenerated=!0,"visualVariables"in e){const t=(e.visualVariables||[]).filter(i=>i.valueExpression!=="$view.scale");t.forEach(i=>{i.type==="rotation"?i.field?i.field=f(r,i.field,"avg_angle","number"):i.valueExpression&&(i.field=g(r,i.valueExpression,"avg_angle","number"),i.valueExpression=null):i.normalizationField?(i.field=f(r,i.field,"avg_norm","number",i.normalizationField),i.normalizationField=null):i.field?i.field=f(r,i.field,"avg","number"):i.valueExpression&&(i.field=g(r,i.valueExpression,"avg","number"),i.valueExpression=null)}),e.visualVariables=t}switch(e.type){case"simple":break;case"pie-chart":for(const t of e.attributes)t.field?t.field=f(r,t.field,"sum","number"):t.valueExpression&&(t.field=g(r,t.valueExpression,"sum","number"),t.valueExpression=null);break;case"unique-value":e.field?e.field=f(r,e.field,"mode","string"):e.valueExpression&&(e.field=g(r,e.valueExpression,"mode","string"),e.valueExpression=null);break;case"class-breaks":e.normalizationField?(e.field=f(r,e.field,"avg_norm","number",e.normalizationField),e.normalizationField=null):e.field?e.field=f(r,e.field,"avg","number"):e.valueExpression&&(e.field=g(r,e.valueExpression,"avg","number"),e.valueExpression=null)}return e}const ve=r=>{const s=e=>me().error(new ie("Unsupported-renderer",e,{renderer:r}));if(!r)return!1;switch(r.type){case"unique-value":if(r.field2||r.field3)return s("FeatureReductionCluster does not support multi-field UniqueValueRenderers"),!1;break;case"class-breaks":if(r.normalizationField){const e=r.normalizationType;if(e!=="field")return s(`FeatureReductionCluster does not support a normalizationType of ${e}`),!1}break;case"simple":case"pie-chart":break;default:return s(`FeatureReductionCluster does not support renderers of type ${r.type}`),!1}if(!ye){if("valueExpression"in r&&r.valueExpression)return s("FeatureReductionCluster does not currently support renderer.valueExpression. Support will be added in a future release"),!1;if(("visualVariables"in r&&r.visualVariables||[]).some(e=>!(!("valueExpression"in e)||!e.valueExpression)))return s("FeatureReductionCluster does not currently support visualVariables with a valueExpression. Support will be added in a future release"),!1}return!0};function he(r,s,e){switch(r){case"sum":return`cluster_sum_${s}`;case"avg":case"avg_angle":return`cluster_avg_${s}`;case"mode":return`cluster_type_${s}`;case"avg_norm":{const t=e,i="field",o=s.toLowerCase()+",norm:"+i+","+t.toLowerCase();return"cluster_avg_"+W(o)}}}function g(r,s,e,t){const i=W(s),o=e==="mode"?`cluster_type_${i}`:e==="sum"?`cluster_sum_${i}`:`cluster_avg_${i}`;return r.some(u=>u.name===o)||r.push(new m({name:o,isAutoGenerated:!0,onStatisticExpression:new C({expression:s,returnType:t}),statisticType:e})),o}function f(r,s,e,t,i){if(s==="cluster_count"||r.some(u=>u.name===s))return s;const o=he(e,s,i);return r.some(u=>u.name===o)||(e==="avg_norm"?r.push(new m({name:o,isAutoGenerated:!0,onStatisticExpression:new C({expression:`$feature.${s} / $feature.${i}`,returnType:t}),statisticType:"avg"})):r.push(new m({name:o,isAutoGenerated:!0,onStatisticField:s,statisticType:e}))),o}const Oe=r=>{let s=class extends r{constructor(...e){super(...e),this.addHandles(ne(()=>this.renderer,()=>{if(this.featureReduction){const t=this._normalizeFeatureReduction(this.featureReduction);this._set("featureReduction",t)}},oe))}set featureReduction(e){const t=this._normalizeFeatureReduction(e);this._set("featureReduction",t)}set renderer(e){}_withClusterVariable(e,t,i){const o=e.clone();return"visualVariables"in o&&(o.visualVariables||(o.visualVariables=[]),o.visualVariables.some(u=>u.type==="size")||o.visualVariables.push(new re({field:"cluster_count",stops:[new E({value:1}),new E({useMinValue:!0,size:t}),new E({useMaxValue:!0,size:i})]}))),o}_normalizeFeatureReduction(e){var M;if((e==null?void 0:e.type)!=="cluster")return e;const t=e.clone(),i=[new m({name:"cluster_count",isAutoGenerated:!0,statisticType:"count"})],o=(t.fields??[]).filter(y=>!y.isAutoGenerated),u=e.renderer&&!((M=e.renderer.authoringInfo)!=null&&M.isAutoGenerated),{clusterMinSize:h,clusterMaxSize:I}=t;if(u){t.fields=[...i,...o];const y=this._withClusterVariable(t.renderer,h,I);return t.effectiveFeatureRenderer=y,t.effectiveClusterRenderer=y,t}if(e.symbol){if(t.fields=[...i,...o],t.renderer=null,!this.renderer)return t.effectiveFeatureRenderer=null,t.effectiveClusterRenderer=null,t;const y=D(i,this.renderer),x=this._withClusterVariable(y,h,I),Z="visualVariables"in x&&x.visualVariables?x.visualVariables:[],ee=new j({symbol:e.symbol,visualVariables:Z});return t.fields=[...i,...o],t.effectiveFeatureRenderer=x,t.effectiveClusterRenderer=ee,t}if(!this.renderer)return e;const A=D(i,this.renderer);t.fields=[...i,...o],t.renderer=A;const G=this._withClusterVariable(A,h,I);return t.effectiveFeatureRenderer=G,t.effectiveClusterRenderer=G,t}};return n([a(fe)],s.prototype,"featureReduction",null),s=n([w("esri.layers.mixins.FeatureReductionLayer")],s),s};export{Oe as c};
