import{e as L,c as we,r as ie}from"./subclass-f7409b1b.js";import"./geometry-31b45acd.js";import{V as qe}from"./Collection-aa6ef54b.js";import{a as te,s as de}from"./Error-21d1d076.js";import{s as dt}from"./promiseUtils-1d963c7c.js";import{y as w,S as yt}from"./JSONSupport-acf2865c.js";import"./typedArrayUtil-2af43698.js";import{z as oe}from"./geohashUtils-f211fce6.js";import{b as it}from"./Layer-668dff8a.js";import{o as ae}from"./featureConversionUtils-e62978d0.js";import{e as Pe}from"./OptimizedGeometry-5ad221bf.js";import{e as je,p as mt}from"./fieldUtils-fcb2a714.js";import{j as at,m as Re}from"./Polyline-013cde1f.js";import{I as nt,U as ve}from"./projection-41da473c.js";import{v as me}from"./SpatialReference-428523ee.js";import{t as Ue}from"./OptimizedFeature-0af09c7a.js";import{y as ut}from"./jsonUtils-2c7f966c.js";import{_ as ct}from"./request-a10d6950.js";import"./aaBoundingBox-7242ce3e.js";import"./mathUtils-19b6edfc.js";import{M as ue,x as Qe}from"./Extent-2b4578b8.js";import{G as be,p as ft,t as gt,T as Tt}from"./knowledgeGraphService-bc5f863d.js";import{a as ye}from"./GraphQueryStreaming-7c6b1c66.js";import{b as he}from"./Query-aaf746b1.js";import{P as bt}from"./PopupTemplate-18f22683.js";import"./ClassBreaksRenderer-aa69b6ca.js";import{t as Me,m as Lt}from"./jsonUtils-7ee1282d.js";import"./UniqueValueRenderer-983c9a3e.js";import"./SimpleRenderer-2c5d637a.js";import"./workers-1be2b889.js";import{m as kt}from"./FeatureStore-d7126e99.js";import{$ as wt}from"./QueryEngine-98332c44.js";import{l as Ct,o as Ee}from"./clientSideDefaults-1b55d85f.js";import{s as Mt}from"./fieldProperties-663ad9a8.js";import{n as ot}from"./BlendLayer-2e0705c7.js";import{c as Et}from"./FeatureReductionLayer-b89875ed.js";import{f as xt}from"./RefreshableLayer-9477518b.js";import{t as rt}from"./ScaleRangeLayer-61383a56.js";import{y as Dt}from"./commonProperties-0c35c2c9.js";import{y as xe}from"./Field-be948aef.js";import{d as It}from"./FeatureSet-32e85c3a.js";import{p as Nt}from"./popupUtils-de5a8217.js";import{O as Rt}from"./Connection-2d969448.js";import{o as pe}from"./typeUtils-3056a943.js";import{n as vt}from"./assets-6fd92e57.js";import"./Evented-b5127116.js";import"./SimpleObservable-ae589a25.js";import"./time-0817624a.js";import"./timeSupport-57e57e41.js";import"./jsonMap-5ba4a9c2.js";import"./normalizeUtils-059b11cb.js";import"./normalizeUtilsCommon-c4e9ddb1.js";import"./utils-3234cfff.js";import"./utils-ed91a700.js";import"./json-48e3ea08.js";import"./Identifiable-1430bdc2.js";import"./Loadable-8a1ead8b.js";import"./Promise-ec74e14b.js";import"./aaBoundingRect-aef00841.js";import"./Axis-30be7e73.js";import"./OptimizedFeatureSet-1d1ac4b9.js";import"./intl-fe039018.js";import"./date-7940da18.js";import"./locale-bde6d0f6.js";import"./datetime-7e00d9ef.js";import"./messages-2d262041.js";import"./projectBuffer-af7b4ad9.js";import"./zscale-d7e12601.js";import"./cast-e7a2f9aa.js";import"./TimeExtent-579f0e32.js";import"./timeUtils-24502426.js";import"./enumeration-4a4e87c4.js";import"./DataLayerSource-62d0bfcf.js";import"./Clonable-b71fa929.js";import"./Color-e1a6dfab.js";import"./colorUtils-ac6863dc.js";import"./symbols-b3e075ad.js";import"./TextSymbol-53669eb2.js";import"./screenUtils-7afeb41c.js";import"./opacityUtils-f0a081b4.js";import"./symbolLayerUtils3D-5b91ffd6.js";import"./persistableUrlUtils-ca6bb38d.js";import"./collectionUtils-b6e30316.js";import"./Portal-cb507469.js";import"./reactiveUtils-e7d9f86e.js";import"./ColorStop-6cee3909.js";import"./LRUCache-000d0e19.js";import"./Version-ef27dfc4.js";import"./FieldsIndex-9238b8b6.js";import"./UnknownTimeZone-8ede07af.js";import"./colorUtils-f660fd36.js";import"./vec42-a95eff2d.js";import"./vec4f64-430e4feb.js";import"./utils-064c64c4.js";import"./heatmapUtils-7a838493.js";import"./diffUtils-d0e8b583.js";import"./colorRamps-bef5e122.js";import"./visualVariableUtils-79811b9c.js";import"./Graphic-f1881791.js";import"./compilerUtils-7f5a3043.js";import"./lengthUtils-1e9c410b.js";import"./styleUtils-d9ef5ac0.js";import"./layerUtils-c805b05c.js";import"./BoundsStore-efd6e714.js";import"./PooledRBush-7b613e7a.js";import"./quickselect-fcce738b.js";import"./_commonjsHelpers-2f3e7994.js";import"./WhereClause-239b807b.js";import"./TimeOnly-e43464ca.js";import"./fieldType-4834e8bc.js";import"./QueryEngineCapabilities-85c4f1d0.js";import"./utils-0bd9b85f.js";import"./utils-522ed121.js";import"./Basemap-09ab572b.js";import"./loadAll-19f96669.js";import"./PortalItem-9d3416e3.js";import"./writeUtils-ef8a6958.js";import"./mat4f32-1b45b54f.js";import"./mat4-a6ac6b0f.js";import"./utils-11762b6e.js";import"./ClassBreaksDefinition-be15ec21.js";import"./signal-b060d75f.js";import"./RenderState-1d6218ee.js";import"./defaultsJSON-b087dd4d.js";import"./FeatureReductionSelection-d7d28c54.js";import"./featureLayerUtils-87358b6a.js";import"./AttachmentQuery-36a8e4f4.js";import"./RelationshipQuery-722111d3.js";import"./LabelClass-bca4dcea.js";import"./defaults-473b7c21.js";import"./MD5-715f37cd.js";import"./ElevationInfo-e9f55e40.js";const At="ESRI__DESTINATION_ID",_t="ESRI__ORIGIN_ID";let De=class ne{constructor(){this._featureLookup=new Map}static getInstance(){return ne.instance||(ne.instance=new ne),ne.instance}static resetInstance(){ne.instance&&(ne.instance=null)}deleteFromStore(i){i.forEach(t=>{this._featureLookup.delete(t)})}readFromStoreByList(i){const t=[];return i.forEach(o=>{const s=this.readFromStoreById(o);s&&t.push(s)}),t}readFromStoreById(i){return this._featureLookup.get(i)??null}writeToStore(i,t,o){const s=[];return i.forEach(r=>{if(!(r!=null&&r.id))return;r.properties||(r.properties=[]);let a,n=null;if(o&&r.properties[o]&&(n=ae(r.properties[o])),"originId"in r&&"destinationId"in r&&(r.properties[_t]=r.originId,r.properties[At]=r.destinationId),r.properties[t]=r.id,r.id&&this._featureLookup.has(r.id)&&this._featureLookup.get(r.id).attributes){const d=this._featureLookup.get(r.id),l=JSON.parse(JSON.stringify(Object.assign(d.attributes,r.properties)));o&&r.properties[o]&&(l[o]=ut(r.properties[o])),a=new Ue(n?JSON.parse(JSON.stringify(n)):d!=null&&d.geometry?JSON.parse(JSON.stringify(d.geometry)):null,l,null,r.properties[t])}else a=new Ue(n?JSON.parse(JSON.stringify(n)):null,r.properties,null,r.properties[t]);this._featureLookup.set(r.id,a),s.push(a)}),s}};var Le;(function(e){e.ELEMENTUID="ELEMENTUID",e.TYPENAME="TYPENAME"})(Le||(Le={}));Le.ELEMENTUID,Le.TYPENAME;var He,Be;(function(e){e[e.ELEMENTUID=0]="ELEMENTUID",e[e.TYPENAME=1]="TYPENAME"})(He||(He={})),function(e){e[e.ELEMENTUID=0]="ELEMENTUID",e[e.TYPENAME=1]="TYPENAME",e[e.FROMUID=2]="FROMUID",e[e.TOUID=3]="TOUID"}(Be||(Be={}));var Je,ze,Ye,Ve;(function(e){e[e.featureResult=0]="featureResult",e[e.countResult=1]="countResult",e[e.idsResult=2]="idsResult"})(Je||(Je={})),function(e){e[e.upperLeft=0]="upperLeft",e[e.lowerLeft=1]="lowerLeft"}(ze||(ze={})),function(e){e[e.sqlTypeBigInt=0]="sqlTypeBigInt",e[e.sqlTypeBinary=1]="sqlTypeBinary",e[e.sqlTypeBit=2]="sqlTypeBit",e[e.sqlTypeChar=3]="sqlTypeChar",e[e.sqlTypeDate=4]="sqlTypeDate",e[e.sqlTypeDecimal=5]="sqlTypeDecimal",e[e.sqlTypeDouble=6]="sqlTypeDouble",e[e.sqlTypeFloat=7]="sqlTypeFloat",e[e.sqlTypeGeometry=8]="sqlTypeGeometry",e[e.sqlTypeGUID=9]="sqlTypeGUID",e[e.sqlTypeInteger=10]="sqlTypeInteger",e[e.sqlTypeLongNVarchar=11]="sqlTypeLongNVarchar",e[e.sqlTypeLongVarbinary=12]="sqlTypeLongVarbinary",e[e.sqlTypeLongVarchar=13]="sqlTypeLongVarchar",e[e.sqlTypeNChar=14]="sqlTypeNChar",e[e.sqlTypeNVarChar=15]="sqlTypeNVarChar",e[e.sqlTypeOther=16]="sqlTypeOther",e[e.sqlTypeReal=17]="sqlTypeReal",e[e.sqlTypeSmallInt=18]="sqlTypeSmallInt",e[e.sqlTypeSqlXml=19]="sqlTypeSqlXml",e[e.sqlTypeTime=20]="sqlTypeTime",e[e.sqlTypeTimestamp=21]="sqlTypeTimestamp",e[e.sqlTypeTimestamp2=22]="sqlTypeTimestamp2",e[e.sqlTypeTinyInt=23]="sqlTypeTinyInt",e[e.sqlTypeVarbinary=24]="sqlTypeVarbinary",e[e.sqlTypeVarchar=25]="sqlTypeVarchar"}(Ye||(Ye={})),function(e){e[e.OID_ARRAY=0]="OID_ARRAY",e[e.GLOBALID_ARRAY=1]="GLOBALID_ARRAY",e[e.STRING_ARRAY=2]="STRING_ARRAY",e[e.IDENTIFIER_ARRAY=3]="IDENTIFIER_ARRAY"}(Ve||(Ve={}));function $t(e){if(!e.spatialReference.isWGS84)throw new te("knowledge-graph:layer-support-utils","The extentToInBoundsRings function only supports WGS84 spatial references.");let i;return i=e.xmax>180&&e.xmin<180?[[[e.xmin,e.ymin],[e.xmin,e.ymax],[180,e.ymax],[180,e.ymin],[e.xmin,e.ymin]],[[-180,e.ymin],[-180,e.ymax],[e.xmax-360,e.ymax],[e.xmax-360,e.ymin],[-180,e.ymin]]]:e.xmax>180&&e.xmin>180?[[[e.xmin-360,e.ymin],[e.xmin-360,e.ymax],[e.xmax-360,e.ymax],[e.xmax-360,e.ymin],[e.xmin-360,e.ymin]]]:e.xmax>-180&&e.xmin<-180?[[[e.xmin+360,e.ymin],[e.xmin+360,e.ymax],[180,e.ymax],[180,e.ymin],[e.xmin+360,e.ymin]],[[-180,e.ymin],[-180,e.ymax],[e.xmax,e.ymax],[e.xmax,e.ymin],[-180,e.ymin]]]:e.xmax<-180&&e.xmin<-180?[[[e.xmin+360,e.ymin],[e.xmin+360,e.ymax],[e.xmax+360,e.ymax],[e.xmax+360,e.ymin],[e.xmin+360,e.ymin]]]:[[[e.xmin,e.ymin],[e.xmin,e.ymax],[e.xmax,e.ymax],[e.xmax,e.ymin],[e.xmin,e.ymin]]],i}async function St(e,i){var r,a;const t=[],o=new Map,s=[];if((r=i.dataModel)!=null&&r.relationshipTypes)for(const n of i.dataModel.relationshipTypes)n.name&&o.set(n.name,[]);for(const n of e)o.has(n.typeName)&&((a=o.get(n.typeName))==null||a.push(n.id));for(const[n,d]of o){if(d.length<1)continue;const l=new ye({openCypherQuery:`MATCH (n)-[r:${n}]->(m) WHERE id(r) in $ids RETURN id(n), labels(n)[0], id(m), labels(m)[0]`,bindParameters:{ids:d}});s.push(be(i,l).then(async c=>{const m=c.resultRowsStream.getReader();for(;;){const{done:g,value:b}=await m.read();if(g)break;for(const f of b)t.push({id:f[0],typeName:f[1]}),t.push({id:f[2],typeName:f[3]})}}))}return await Promise.all(s),t}const R="ESRI__ID",ge="ESRI__ORIGIN_ID",Te="ESRI__DESTINATION_ID",G="ESRI__LAYOUT_GEOMETRY",Ae="ESRI__AGGREGATION_COUNT",re=12;let B=class extends yt{constructor(i){var o,s,r;super(i),this._processingCacheUpdatesLookup=new Map,this.knowledgeGraph=null,this.inclusionModeDefinition={generateAllSublayers:!0,namedTypeDefinitions:new Map},this.entityTypeNames=new Set,this.relationshipTypeNames=new Set,this.geographicLookup=new Map,this.sublayerCaches=new Map,this.nodeConnectionsLookup=new Map,this.relationshipConnectionsLookup=new Map,this.memberIdTypeLookup=new Map;const t=new Map;(o=i.knowledgeGraph.dataModel.entityTypes)==null||o.forEach(a=>{var n,d;a.name&&(t.set(a.name,"entity"),this._processingCacheUpdatesLookup.set(a.name,[]),i.inclusionModeDefinition&&!((n=i.inclusionModeDefinition)!=null&&n.generateAllSublayers)||this.entityTypeNames.add(a.name),(d=a.properties)==null||d.forEach(l=>{l.geometryType&&l.geometryType!=="esriGeometryNull"&&this.geographicLookup.set(a.name,{name:l.name??"",geometryType:l.geometryType})}))}),(s=i.knowledgeGraph.dataModel.relationshipTypes)==null||s.forEach(a=>{var n,d;a.name&&(t.set(a.name,"relationship"),this._processingCacheUpdatesLookup.set(a.name,[]),i.inclusionModeDefinition&&!((n=i.inclusionModeDefinition)!=null&&n.generateAllSublayers)||this.relationshipTypeNames.add(a.name),(d=a.properties)==null||d.forEach(l=>{l.geometryType&&l.geometryType!=="esriGeometryNull"&&this.geographicLookup.set(a.name,{name:l.name??"",geometryType:l.geometryType})}))}),(r=i.inclusionModeDefinition)==null||r.namedTypeDefinitions.forEach((a,n)=>{var l,c;if(t.get(n)==="entity")this.entityTypeNames.add(n);else{if(t.get(n)!=="relationship")return de.getLogger(this).warn(`A named type, ${n}, was in the inclusion list that wasn't in the data model and will be removed`),void((l=i.inclusionModeDefinition)==null?void 0:l.namedTypeDefinitions.delete(n));this.relationshipTypeNames.add(n)}const d=new Map;(c=a.members)==null||c.forEach(m=>{ie(this.memberIdTypeLookup,m.id,()=>new Set).add(n);const g=this.getById(m.id);g&&d.set(m.id,g)}),this.sublayerCaches.set(n,d)})}addToLayer(i){i.forEach(({typeName:t,id:o})=>{if(!this.inclusionModeDefinition)throw new te("knowledge-graph:layer-data-manager","You cannot add to a layer's exclusion list if it was not created with an exclusion list originally");if(this.inclusionModeDefinition.namedTypeDefinitions.has(t)){if(this.inclusionModeDefinition.namedTypeDefinitions.has(t)){const s=this.inclusionModeDefinition.namedTypeDefinitions.get(t);s.members||(s.members=new Map),s.members.set(o,{id:o}),ie(this.memberIdTypeLookup,o,()=>new Set).add(t)}}else{const s=new Map;s.set(o,{id:o}),this.inclusionModeDefinition.namedTypeDefinitions.set(t,{useAllData:!1,members:s}),ie(this.memberIdTypeLookup,o,()=>new Set).add(t)}})}getById(i){return De.getInstance().readFromStoreById(i)}async getData(i,t,o){var r,a;if(t.objectType.name&&((r=this.inclusionModeDefinition)!=null&&r.namedTypeDefinitions)&&this.inclusionModeDefinition.namedTypeDefinitions.size>0&&!this.inclusionModeDefinition.namedTypeDefinitions.has(t.objectType.name))return[];let s;if(s=i||new he({where:"1=1",outFields:["*"]}),t.parentCompositeLayer.type==="link-chart"){const n=t.parentCompositeLayer,d=this._processingCacheUpdatesLookup.get(t.objectType.name??""),l=s.outFields,c=s.geometry;let m="",g="";c&&c.extent&&(m=oe(c.extent.ymin,c.extent.xmin,re),g=oe(c.extent.ymax,c.extent.xmax,re)),l&&l.length===1&&l[0]===R&&s.where==="1=1"||await Promise.all(d??[]);const b=this.sublayerCaches.has(t.objectType.name??"")?Array.from((a=this.sublayerCaches.get(t.objectType.name))==null?void 0:a.values()):[],f=[];return b.forEach(M=>{if(this.relationshipTypeNames.has(t.objectType.name)?M.geometry=n.relationshipLinkChartDiagramLookup.get(M.attributes[t.objectIdField]):M.geometry=n.entityLinkChartDiagramLookup.get(M.attributes[t.objectIdField]),M.attributes[G]=M.geometry,m&&g){const h=n.linkChartGeohashLookup.get(M.attributes[t.objectIdField]);h?h>=m&&h<=g&&f.push(M):f.push(M)}else f.push(M)}),f}return this.retrieveDataFromService(s,t,o)}async getConnectedRecordIds(i,t){const o=[];let s="";const r=[],a=new Map;if(i.forEach(n=>{var d;if(this.memberIdTypeLookup.has(n))for(const l of this.memberIdTypeLookup.get(n)){if(!this.entityTypeNames.has(l))return;a.has(l)?(d=a.get(l))==null||d.push(n):a.set(l,[n])}}),t&&(t==null?void 0:t.length)!==0){for(const n of t)s=s+n+"|";s=s.slice(0,-1)}return a.forEach((n,d)=>{let l;l=t&&(t==null?void 0:t.length)!==0?`MATCH (n:${d})-[r:${s}]-(m) WHERE id(n) IN $ids RETURN id(r), type(r), id(m), labels(m)[0]`:`MATCH (n:${d})-[r]-(m) WHERE id(n) IN $ids RETURN id(r), type(r), id(m), labels(m)[0]`;const c=new Promise(m=>{(async()=>{const g=(await be(this.knowledgeGraph,new ye({openCypherQuery:l,bindParameters:{ids:n}}))).resultRowsStream.getReader();try{for(;;){const{done:b,value:f}=await g.read();if(b)break;for(let M=0;M<f.length;M++){const h=f[M];o.push({id:h[0],typeName:h[1]}),o.push({id:h[2],typeName:h[3]})}}}catch(b){if(b.name!=="AbortError")throw b;de.getLogger(this).info("Request aborted as expected")}})().then(()=>{m()})});r.push(c)}),this.refreshCacheContent(),await Promise.all(r),o}async refreshCacheContent(i,t,o,s=!0){var l,c,m,g,b,f,M;const r=De.getInstance(),a=[],n=new Map,d=new Map;(l=this.knowledgeGraph.dataModel.entityTypes)==null||l.forEach(h=>{h.name&&d.set(h.name,h)}),(c=this.knowledgeGraph.dataModel.relationshipTypes)==null||c.forEach(h=>{h.name&&d.set(h.name,h)}),i||this.inclusionModeDefinition?i?i.forEach(h=>{var D;if(this.memberIdTypeLookup.has(h))for(const O of this.memberIdTypeLookup.get(h))n.has(O)?(D=n.get(O))==null||D.push(h):n.set(O,[h])}):(g=(m=this.inclusionModeDefinition)==null?void 0:m.namedTypeDefinitions)==null||g.forEach((h,D)=>{h.useAllData?n.set(D,null):h.members&&h.members.forEach(O=>{var E;n.has(D)&&n.get(D)!==null?(E=n.get(D))==null||E.push(O.id):n.set(D,[O.id])})}):((b=this.knowledgeGraph.dataModel.entityTypes)==null||b.forEach(h=>{h.name&&n.set(h.name,null)}),(f=this.knowledgeGraph.dataModel.entityTypes)==null||f.forEach(h=>{h.name&&n.set(h.name,null)}));for(const[h,D]of n){const O=new Promise(E=>{(async()=>{var z,V,W,Z,K,p,y;const Q=new Set,H=[];let ee,v="",P=!1;if(t||((V=(z=d.get(h))==null?void 0:z.properties)==null||V.forEach(u=>{u.name&&Q.add(u.name)})),o&&this.geographicLookup.has(h)){const u=(W=this.geographicLookup.get(h))==null?void 0:W.name;u&&Q.add(u)}if(this.entityTypeNames.has(h))v=`MATCH (n:${h}) ${D?"WHERE id(n) IN $ids ":""}return ID(n)`,Q.forEach(u=>{v+=`, n.${u}`,H.push(u)});else{if(!this.relationshipTypeNames.has(h))throw new te("knowledge-graph:layer-data-manager",`The graph type of ${h} could not be determined. Was this type set in the KG data model and inclusion definition?`);P=!0,v=`MATCH ()-[n:${h}]->() ${D?"WHERE id(n) IN $ids ":""}return ID(n), id(startNode(n)), id(endNode(n))`,Q.forEach(u=>{v+=`, n.${u}`,H.push(u)})}ee=new ye(D?{openCypherQuery:v,bindParameters:{ids:D}}:{openCypherQuery:v});const J=(await be(this.knowledgeGraph,ee)).resultRowsStream.getReader();for(;;){const{done:u,value:I}=await J.read();if(u)break;const N=[];for(let x=0;x<I.length;x++){const C=I[x];let A=0,F=0;const j={properties:{}};for(j.id=C[A],A++,F++,P&&(j.originId=C[A],A++,F++,j.destinationId=C[A],A++,F++,ie(this.nodeConnectionsLookup,j.originId,()=>new Set).add(j.id),ie(this.nodeConnectionsLookup,j.destinationId,()=>new Set).add(j.id),ie(this.relationshipConnectionsLookup,j.id,()=>[j.originId,j.destinationId]));A<C.length;A++)j.properties[H[A-F]]=C[A];N.push(j)}const T=r.writeToStore(N,R,(Z=this.geographicLookup.get(h))==null?void 0:Z.name);this.sublayerCaches.has(h)||this.sublayerCaches.set(h,new Map),s&&!((K=this.inclusionModeDefinition)!=null&&K.namedTypeDefinitions.has(h))&&((p=this.inclusionModeDefinition)==null||p.namedTypeDefinitions.set(h,{useAllData:!1,members:new Map})),s&&!((y=this.inclusionModeDefinition)!=null&&y.namedTypeDefinitions.get(h).members)&&(this.inclusionModeDefinition.namedTypeDefinitions.get(h).members=new Map);const k=this.sublayerCaches.get(h);T.forEach(x=>{var C,A;k==null||k.set(x.attributes[R],x),s&&!((C=this.inclusionModeDefinition)!=null&&C.namedTypeDefinitions.get(h).members.has(x.attributes[R]))&&((A=this.inclusionModeDefinition)==null||A.namedTypeDefinitions.get(h).members.set(x.attributes[R],{id:x.attributes[R]}),ie(this.memberIdTypeLookup,x.attributes[R],()=>new Set).add(h))})}})().then(()=>{E(null)})});a.push(O),(M=this._processingCacheUpdatesLookup.get(h))==null||M.push(O)}await Promise.all(a)}removeFromLayer(i){var s,r,a;const t=new Set,o=new Set(i.map(n=>n.id));for(const n of i)t.add(n.typeName),((s=this.memberIdTypeLookup.get(n.id))==null?void 0:s.size)===1?this.memberIdTypeLookup.delete(n.id):(r=this.memberIdTypeLookup.get(n.id))==null||r.delete(n.typeName),(a=this.inclusionModeDefinition)==null||a.namedTypeDefinitions.forEach((d,l)=>{var c;l===n.typeName&&((c=d.members)!=null&&c.has(n.id))&&d.members.delete(n.id)});t.forEach(n=>{var d;(d=this.sublayerCaches.get(n))==null||d.forEach((l,c)=>{var m;o.has(c)&&((m=this.sublayerCaches.get(n))==null||m.delete(c))})})}async retrieveDataFromService(i,t,o){var M,h,D,O,E,U,Q,H,ee,v,P,J,z,V,W,Z,K;const s=De.getInstance(),r=new Set,a=[];let n,d="",l=[];const c=t.graphType==="relationship",m=(D=(h=(M=this.inclusionModeDefinition)==null?void 0:M.namedTypeDefinitions)==null?void 0:h.get(t.objectType.name))==null?void 0:D.useAllData,g=t.parentCompositeLayer.sublayerIdsCache.get(t.objectType.name);let b=!m&&g?Array.from(g).sort():null;if((U=(E=(O=this.inclusionModeDefinition)==null?void 0:O.namedTypeDefinitions)==null?void 0:E.get(t.objectType.name))!=null&&U.useAllData)(ee=(H=(Q=this.inclusionModeDefinition)==null?void 0:Q.namedTypeDefinitions)==null?void 0:H.get(t.objectType.name))!=null&&ee.useAllData&&i.objectIds!=null&&(b=i.objectIds);else if(i.objectIds!=null&&b&&b.length>0){const p=i.objectIds;i.objectIds=b.filter(y=>p.includes(y))}else if(i.objectIds!=null)b=i.objectIds;else{if((v=this.inclusionModeDefinition)!=null&&v.namedTypeDefinitions.has(t.objectType.name)&&(!((P=this.inclusionModeDefinition.namedTypeDefinitions.get(t.objectType.name))!=null&&P.members)||((z=(J=this.inclusionModeDefinition.namedTypeDefinitions.get(t.objectType.name))==null?void 0:J.members)==null?void 0:z.size)<1))return i.objectIds=[],[];i.objectIds=b}if(i.outFields!=null){const p=i.outFields;p.includes("*")?t.fields.forEach(y=>{r.add(y.name)}):p.forEach(y=>{y!==R&&y!==t.geometryFieldName&&r.add(y)})}if(i.geometry!=null){const p=i.geometry;let y;const u=t.parentCompositeLayer.dataManager.knowledgeGraph.serviceDefinition,I=u==null?void 0:u.spatialReference,N=(V=u==null?void 0:u.serviceCapabilities)==null?void 0:V.geometryCapabilities;let T=N==null?void 0:N.geometryMaxBoundingRectangleSizeX,k=N==null?void 0:N.geometryMaxBoundingRectangleSizeY;if((W=p==null?void 0:p.extent)!=null&&W.spatialReference&&!((Z=p.spatialReference)!=null&&Z.isWGS84)?(await nt(p.extent.spatialReference,me),y=ve(p.extent,me)):y=p.extent,T&&k&&I){if(I.wkid!==4326){const x=new ue({spatialReference:I,xmax:T,ymax:k}),C=ve(x,me);T=C.xmax,k=C.ymax}if(y.xmax-y.xmin>T)throw new te("knowledge-graph:layer-data-manager",`Extent x bounds should be within ${T}° latitude, limit exceeded`);if(y.ymax-y.ymin>k)throw new te("knowledge-graph:layer-data-manager",`Extent y bounds should be within ${k}° longitude, limit exceeded`)}if(i.where!=null&&i.where!=="1=1"){const x=await je(i.where.toUpperCase(),t.fieldsIndex);t.fields.forEach(C=>{x.fieldNames.includes(C.name)&&r.add(C.name)})}d=c?`Match ()-[n:${t.objectType.name}]->() WHERE esri.graph.ST_Intersects($param_filter_geom, n.${t.geometryFieldName}) return ID(n), id(startNode(r)), id(endNode(r))`:`Match (n:${t.objectType.name}) WHERE esri.graph.ST_Intersects($param_filter_geom, n.${t.geometryFieldName}) return ID(n)`,t.geometryFieldName&&r.add(t.geometryFieldName),r.forEach(x=>{d+=`, n.${x}`,a.push(x)}),n=new ye({openCypherQuery:d,bindParameters:{param_filter_geom:new at({rings:$t(y)})}})}else{let p="";if(i.where!=null&&i.where!=="1=1"){const I=await je(i.where,t.fieldsIndex);t.fields.forEach(C=>{I.fieldNames.includes(C.name)&&r.add(C.name)});const N=new Set(["column-reference","string","number","binary-expression"]),T=new Set(["=","<","<=","<>",">",">=","AND","OR","LIKE"]);let k=!1;const x=C=>{if(C.type==="column-reference")return`n.${C.column}`;if(C.type==="string")return`'${C.value}'`;if(C.type==="number")return`${C.value}`;if(C.type==="binary-expression"&&N.has(C.left.type)&&N.has(C.right.type)&&T.has(C.operator))return`${x(C.left)} ${C.operator} ${x(C.right)}`;if(C.type==="binary-expression"&&C.operator==="LIKE"){let A="";if(C.left.type==="function"&&C.left.args.value[0].type==="column-reference")A+=`lower(n.${C.left.args.value[0].column})`;else{if(C.left.type!=="column-reference")return k=!0,"";A+=`lower(n.${C.left.column})`}if(A+=" CONTAINS (",C.right.type!=="string")return k=!0,"";{let F=C.right.value;F.charAt(0)==="%"&&(F=F.slice(1)),F.charAt(F.length-1)==="%"&&(F=F.slice(0,-1)),A+=`'${F.toLowerCase()}')`}return A}return k=!0,""};p=x(I.parseTree),k&&(p="")}let y="";y=c?`Match ()-[n:${t.objectType.name}]->()`:`Match (n:${t.objectType.name})`;let u=!1;b&&(u=!0,y+=" WHERE ID(n) IN $ids"),p&&(y+=u?" AND":" WHERE",y+=` ${p}`),y+=" return ID(n)",c&&(y+=", id(startNode(n)), id(endNode(n))"),i.returnGeometry&&t.geometryFieldName&&r.add(t.geometryFieldName),r.forEach(I=>{y+=`, n.${I}`,a.push(I)}),n=new ye(b?{openCypherQuery:y,bindParameters:{ids:b}}:{openCypherQuery:y})}const f=(await be(t.parentCompositeLayer.dataManager.knowledgeGraph,n,o)).resultRowsStream.getReader();for(;;){const{done:p,value:y}=await f.read();if(p)break;const u=[];for(let I=0;I<y.length;I++){const N=y[I];let T=0,k=0;const x={properties:{}};for(x.id=N[T],T++,k++,c&&(x.originId=N[T],T++,k++,x.destinationId=N[T],T++,k++);T<N.length;T++)x.properties[a[T-k]]=N[T];u.push(x)}l=l.concat(s.writeToStore(u,R,(K=t.parentCompositeLayer.dataManager.geographicLookup.get(t.objectType.name))==null?void 0:K.name))}return l}};L([w()],B.prototype,"knowledgeGraph",void 0),L([w()],B.prototype,"inclusionModeDefinition",void 0),L([w()],B.prototype,"entityTypeNames",void 0),L([w()],B.prototype,"relationshipTypeNames",void 0),L([w()],B.prototype,"geographicLookup",void 0),L([w()],B.prototype,"sublayerCaches",void 0),L([w()],B.prototype,"nodeConnectionsLookup",void 0),L([w()],B.prototype,"relationshipConnectionsLookup",void 0),L([w()],B.prototype,"memberIdTypeLookup",void 0),B=L([we("esri.rest.knowledgeGraph.knowledgeGraphLayer.KnowledgeGraphLayerDataManager")],B);const We=Mt(),Gt=e=>{let i=class extends e{constructor(){super(...arguments),this.fields=[],this.fieldsIndex=null}};return L([w(We.fields)],i.prototype,"fields",void 0),L([w(We.fieldsIndex)],i.prototype,"fieldsIndex",void 0),i=L([we("esri.layers.knowledgeGraphLayer.KnowledgeGraphSublayerBase")],i),i};let _=class extends Et(Gt(ot(rt(xt(it))))){constructor(e){var i,t,o,s,r;if(super(e),this.capabilities=Ct(!1,!1),this.definitionExpression="",this.displayField="",this.elevationInfo=null,this.geometryType=null,this.geometryFieldName=null,this.graphType=null,this.hasM=!1,this.hasZ=!1,this.labelsVisible=null,this.labelingInfo=null,this.objectIdField=R,this.objectType=null,this.parentCompositeLayer=null,this.popupEnabled=!0,this.popupTemplate=null,this.source={openPorts:()=>this.load().then(()=>{const a=new MessageChannel;return new Rt(a.port1,{channel:a,client:{queryFeatures:(n,d={})=>{const l=he.fromJSON(n);return this.queryFeaturesJSON(l,d)}}}),[a.port2]})},this.type="knowledge-graph-sublayer",e.parentCompositeLayer.type==="link-chart")e.graphType==="relationship"?this.geometryType="polyline":this.geometryType="point",this.geometryFieldName=G;else if((i=e.parentCompositeLayer.dataManager.geographicLookup.get(e.objectType.name))!=null&&i.geometryType&&((t=e.parentCompositeLayer.dataManager.geographicLookup.get(e.objectType.name))==null?void 0:t.geometryType)!=="esriGeometryNull"){const a=e.parentCompositeLayer.dataManager.geographicLookup.get(e.objectType.name);this.geometryFieldName=(a==null?void 0:a.name)??null,this.geometryType=a!=null&&a.geometryType?pe.fromJSON(a.geometryType):null;const n=a==null?void 0:a.name,d=n?(o=e.objectType.properties)==null?void 0:o[n]:null;d?(this.hasM=d.hasM??!1,this.hasZ=d.hasZ??!1):(this.hasM=!1,this.hasZ=!1)}else this.geometryType=null;(s=e.objectType.properties)==null||s.forEach(a=>{let n=null,d=a.fieldType;d==="esriFieldTypeOID"&&(d="esriFieldTypeInteger"),this.fields.push(xe.fromJSON({name:a.name,type:d,alias:a.alias,defaultValue:n,editable:a.editable,nullable:a.nullable}))}),this.fields.push(xe.fromJSON({name:this.objectIdField,type:"esriFieldTypeString",alias:this.objectIdField,editable:!1})),this.fields.push(xe.fromJSON({name:Ae,type:"esriFieldTypeInteger",alias:Ae,editable:!1})),this._set("fields",[...this.fields]),(r=e.parentCompositeLayer.dataManager.knowledgeGraph.dataModel)!=null&&r.spatialReference&&(this.spatialReference=e.parentCompositeLayer.dataManager.knowledgeGraph.dataModel.spatialReference),e.parentCompositeLayer.type==="link-chart"?e.graphType==="relationship"?this.renderer=Me(Ee(pe.toJSON("polyline")).renderer):this.renderer=Me(Ee(pe.toJSON("point")).renderer):this.renderer=Me(Ee(pe.toJSON(this.geometryType)).renderer)}get defaultPopupTemplate(){return this.createPopupTemplate()}set renderer(e){mt(e,this.fieldsIndex),this._set("renderer",e)}createPopupTemplate(e){return Nt(this,e)}createQuery(){return new he({where:"1=1",outFields:["*"]})}getField(e){for(let i=0;i<this.fields.length;i++)if(this.fields[i].name===e)return this.fields[i];return null}getFieldDomain(e,i){return null}async queryFeatures(e,i){const{resolvedQuery:t,queryEngine:o}=await this._setupQueryObjects(e),s=It.fromJSON(await o.executeQuery(t.toJSON(),i==null?void 0:i.signal));return s.features.forEach(r=>{r.sourceLayer=this}),s}async queryFeaturesJSON(e,i){const{resolvedQuery:t,queryEngine:o}=await this._setupQueryObjects(e);return await o.executeQuery(t.toJSON(),i==null?void 0:i.signal)}async queryFeatureCount(e,i){const{resolvedQuery:t,queryEngine:o}=await this._setupQueryObjects(e);return o.executeQueryForCount(t.toJSON(),i==null?void 0:i.signal)}async queryExtent(e={},i){var n,d,l,c;const t={...e,returnGeometry:!0},{resolvedQuery:o,queryEngine:s}=await this._setupQueryObjects(t),r=await s.executeQueryForExtent(o.toJSON(),i==null?void 0:i.signal);let a;return a=((n=r.extent)==null?void 0:n.xmin)!=null&&((d=r.extent)==null?void 0:d.xmax)!=null&&((l=r.extent)==null?void 0:l.ymin)!=null&&((c=r.extent)==null?void 0:c.ymax)!=null?new ue(r.extent):new ue,{count:r.count,extent:a}}async queryObjectIds(e,i){const t=he.from(e);let o;if(this.parentCompositeLayer.type==="link-chart"&&this._cachedQueryEngine)o=this._cachedQueryEngine;else{const s=await this.parentCompositeLayer.dataManager.getData(t,this,i);o=this.loadQueryEngine(s)}return o.executeQueryForIds(t.toJSON(),i==null?void 0:i.signal)}loadQueryEngine(e){const i=new kt({geometryType:pe.toJSON(this.geometryType),hasM:this.hasM,hasZ:this.hasZ}),t=new wt({fieldsIndex:this.fieldsIndex.toJSON(),geometryType:pe.toJSON(this.geometryType),hasM:this.hasM,hasZ:this.hasZ,objectIdField:this.objectIdField,spatialReference:this.spatialReference.toJSON(),timeInfo:null,featureStore:i});return t.featureStore.addMany(e),t}async refreshCachedQueryEngine(){const e=await this.parentCompositeLayer.dataManager.getData(new he({where:"1=1",outFields:[R]}),this);this._cachedQueryEngine=this.loadQueryEngine(e)}async _setupQueryObjects(e,i){var r;const t=he.from(e),o=t.geometry;let s;if(o&&!((r=o.spatialReference)!=null&&r.isWGS84)&&(await nt(o.spatialReference,me),t.geometry=ve(o instanceof at||o instanceof Re?o:o.extent,me)),this.parentCompositeLayer.type==="link-chart"&&this._cachedQueryEngine)s=this._cachedQueryEngine;else{const a=await this.parentCompositeLayer.dataManager.getData(t,this,i);s=this.loadQueryEngine(a)}return{resolvedQuery:t,queryEngine:s}}};L([w()],_.prototype,"capabilities",void 0),L([w({readOnly:!0})],_.prototype,"defaultPopupTemplate",null),L([w()],_.prototype,"definitionExpression",void 0),L([w()],_.prototype,"displayField",void 0),L([w()],_.prototype,"elevationInfo",void 0),L([w()],_.prototype,"geometryType",void 0),L([w()],_.prototype,"geometryFieldName",void 0),L([w()],_.prototype,"graphType",void 0),L([w()],_.prototype,"hasM",void 0),L([w()],_.prototype,"hasZ",void 0),L([w()],_.prototype,"labelsVisible",void 0),L([w()],_.prototype,"labelingInfo",void 0),L([w()],_.prototype,"objectIdField",void 0),L([w()],_.prototype,"objectType",void 0),L([w()],_.prototype,"parentCompositeLayer",void 0),L([w(Dt)],_.prototype,"popupEnabled",void 0),L([w({type:bt,json:{name:"popupInfo",write:!0}})],_.prototype,"popupTemplate",void 0),L([w({types:Lt,json:{write:{target:"layerDefinition.drawingInfo.renderer"}}})],_.prototype,"renderer",null),L([w()],_.prototype,"source",void 0),L([w({json:{read:!1}})],_.prototype,"type",void 0),_=L([we("esri.layers.knowledgeGraph.KnowledgeGraphSublayer")],_);const Ie=_;let Ne,$=null;function Ot(){return Ne||(Ne=ct(()=>import("./lclayout-5533ac69.js"),["./lclayout-5533ac69.js","./_commonjsHelpers-2f3e7994.js"],import.meta.url).then(e=>e.l).then(({default:e})=>e({locateFile:i=>vt(`esri/libs/linkchartlayout/${i}`)})).then(e=>{Ft(e)}),Ne)}function Ft(e){$=e}var X,ke;function le(e,i,t,o,s,r){const a=t.length,n=s.length,d=Float64Array.BYTES_PER_ELEMENT,l=Uint32Array.BYTES_PER_ELEMENT,c=Uint8Array.BYTES_PER_ELEMENT,m=16,g=m-1+a*(c+2*d)+n*(2*l),b=$._malloc(g);try{const f=b+m-b%m,M=f+a*d,h=M+a*d,D=h+n*l,O=D+n*l,E=()=>[$.HEAPF64.subarray(f>>3,(f>>3)+a),$.HEAPF64.subarray(M>>3,(M>>3)+a),$.HEAPU32.subarray(h>>2,(h>>2)+n),$.HEAPU32.subarray(D>>2,(D>>2)+n),$.HEAPU8.subarray(O,O+a)],[U,Q,H,ee,v]=E();U.set(t),Q.set(o),H.set(s),ee.set(r),v.set(i);let P=e(a,O,f,M,n,h,D),J=null;if(P){const p=$.getLayoutLinksTypes(),y=$.getLayoutLinksVerticesEndIndices(),u=$.getLayoutLinksVertices(),I=$.countLayoutLinksVertices();!n||p&&y?I&&!u?P=!1:J={types:new Uint8Array($.HEAPU8.subarray(p,p+n)),vertexEndIndex:new Uint32Array($.HEAPU32.subarray(y>>2,(y>>2)+n)),vertices:new Float64Array($.HEAPF64.subarray(u>>3,(u>>3)+2*I))}:P=!1}const[z,V,W,Z,K]=E();return t.set(z),o.set(V),s.set(W),r.set(Z),i.set(K),{success:P,links:J}}finally{$._free(b),$.cleanupLayout()}}(function(e){e[e.None=0]="None",e[e.IsMovable=1]="IsMovable",e[e.IsGeographic=2]="IsGeographic",e[e.IsRoot=4]="IsRoot"})(X||(X={})),function(e){e[e.Regular=0]="Regular",e[e.Orthogonal=1]="Orthogonal",e[e.Curved=2]="Curved",e[e.Recursive=3]="Recursive"}(ke||(ke={}));const Ze=2,Ke=1,Xe=-1;var _e,$e,Se,Ge,Oe,Fe,et,tt;(function(e){function i(){return $.getMinIdealEdgeLength()}function t(o,s,r,a,n,d=Ze,l=Ke,c=Xe){return le((m,g,b,f,M,h,D)=>$.applyForceDirectedLayout(m,g,b,f,M,h,D,d,l,c),o,s,r,a,n)}e.getMinIdealEdgeLength=i,e.apply=t})(_e||(_e={})),function(e){function i(t,o,s,r,a,n=Ze,d=Ke,l=Xe){return le((c,m,g,b,f,M,h)=>$.applyCommunityLayout(c,m,g,b,f,M,h,n,d,l),t,o,s,r,a)}e.apply=i}($e||($e={})),function(e){function i(t,o,s,r,a){return le($.applySimpleLayout,t,o,s,r,a)}e.apply=i}(Se||(Se={})),function(e){function i(t,o,s,r,a){return le($.applyHierarchicalLayout,t,o,s,r,a)}e.apply=i}(Ge||(Ge={})),function(e){function i(t,o,s,r,a){return le($.applyRadialTreeLayout,t,o,s,r,a)}e.apply=i}(Oe||(Oe={})),function(e){function i(t,o,s,r,a){return le($.applySmartTreeLayout,t,o,s,r,a)}e.apply=i}(Fe||(Fe={})),function(e){e[e.Undirected=0]="Undirected",e[e.Directed=1]="Directed",e[e.Reversed=2]="Reversed"}(et||(et={})),function(e){e[e.ByCC_Raw=0]="ByCC_Raw",e[e.ByCC_NormalizeGlobally=1]="ByCC_NormalizeGlobally",e[e.ByCC_NormalizeByCC=2]="ByCC_NormalizeByCC"}(tt||(tt={}));const qt=(e,i,t)=>(e.has(i)||e.set(i,t()),e.get(i));let q=class extends ot(rt(it)){constructor(e){if(super(e),this.dataPreloadedInLocalCache=!1,this.defaultLinkChartConfig=null,this._currentLinkChartConfig={layoutMode:"RADIAL_TREE"},this._graphTypeLookup=new Map,this.dataManager=null,this.knowledgeGraph=null,this.layers=new qe,this.entityLinkChartDiagramLookup=new Map,this.relationshipLinkChartDiagramLookup=new Map,this.linkChartExtent=new ue({xmin:-1e-7,ymin:-1e-7,xmax:1e-7,ymax:1e-7}),this.linkChartGeohashLookup=new Map,this.memberEntityTypes=null,this.memberRelationshipTypes=null,this.sublayerIdsCache=new Map,this.tables=new qe,this.type="link-chart",this._originalInclusionList=e.inclusionModeDefinition,e.dataPreloadedInLocalCache&&!e.inclusionModeDefinition)throw new te("knowledge-graph:linkchart-layer-constructor","If creating a link chart composite layer and configured that data is already loaded in the cache, you must specify an inclusion list so the Composite Layer knows what records belong to it")}normalizeCtorArgs(e){return{url:e.url,title:e.title,dataPreloadedInLocalCache:e.dataPreloadedInLocalCache,defaultLinkChartConfig:e.defaultLinkChartConfig}}_initializeLayerProperties(e){var r,a,n,d,l,c;if(!this.title&&this.url){const m=this.url.split("/");this.title=m[m.length-2]}const i=new Set;let t=[],o=[];if(e.inclusionModeDefinition&&(!e.inclusionModeDefinition.namedTypeDefinitions||e.inclusionModeDefinition.namedTypeDefinitions.size<1))throw new te("knowledge-graph:composite-layer-constructor","If an explicit inclusion definition is defined, at least one namedTypeDefinition must also be defined");(r=e.knowledgeGraph.dataModel.entityTypes)==null||r.forEach(m=>{m.name&&this._graphTypeLookup.set(m.name,m)}),(a=e.knowledgeGraph.dataModel.relationshipTypes)==null||a.forEach(m=>{m.name&&this._graphTypeLookup.set(m.name,m)}),(n=e.inclusionModeDefinition)!=null&&n.generateAllSublayers?(t=e.knowledgeGraph.dataModel.entityTypes??[],o=e.knowledgeGraph.dataModel.relationshipTypes??[]):(d=e.inclusionModeDefinition)!=null&&d.namedTypeDefinitions&&((l=e.inclusionModeDefinition)==null?void 0:l.namedTypeDefinitions.size)>0?(c=e.inclusionModeDefinition)==null||c.namedTypeDefinitions.forEach((m,g)=>{var b,f;if(!this._graphTypeLookup.get(g))return de.getLogger(this).warn(`A named type, ${g}, was in the inclusion list that wasn't in the data model and will be removed`),void((b=e.inclusionModeDefinition)==null?void 0:b.namedTypeDefinitions.delete(g));this._graphTypeLookup.get(g)instanceof ft||"strictOrigin"in this._graphTypeLookup.get(g)?i.has(g)||(i.add(g),o.push(this._graphTypeLookup.get(g))):this._graphTypeLookup.get(g)instanceof gt||"properties"in this._graphTypeLookup.get(g)?i.has(g)||(i.add(g),t.push(this._graphTypeLookup.get(g))):(de.getLogger(this).warn(`A named type, ${g}, was in the inclusion list that wasn't properly modeled and will be removed`),(f=e.inclusionModeDefinition)==null||f.namedTypeDefinitions.delete(g))}):(t=e.knowledgeGraph.dataModel.entityTypes??[],o=e.knowledgeGraph.dataModel.relationshipTypes??[]);const s=new B({knowledgeGraph:e.knowledgeGraph,inclusionModeDefinition:e.inclusionModeDefinition});this.knowledgeGraph=e.knowledgeGraph,this.memberEntityTypes=t,this.memberRelationshipTypes=o,this.dataManager=s}load(e){return this.addResolvingPromise(new Promise(i=>{Tt(this.url).then(t=>{var o,s,r,a,n,d;if(this._initializeLayerProperties({knowledgeGraph:t,inclusionModeDefinition:this._originalInclusionList}),(s=(o=this.dataManager.inclusionModeDefinition)==null?void 0:o.namedTypeDefinitions)!=null&&s.size||(this.dataManager.inclusionModeDefinition={generateAllSublayers:!1,namedTypeDefinitions:new Map},(r=this.dataManager.knowledgeGraph.dataModel.entityTypes)==null||r.forEach(l=>{var c;l.name&&((c=this.dataManager.inclusionModeDefinition)==null||c.namedTypeDefinitions.set(l.name,{useAllData:!0}))}),(a=this.dataManager.knowledgeGraph.dataModel.relationshipTypes)==null||a.forEach(l=>{var c;l.name&&((c=this.dataManager.inclusionModeDefinition)==null||c.namedTypeDefinitions.set(l.name,{useAllData:!0}))})),this.dataPreloadedInLocalCache)this.loadLayerAssumingLocalCache(),this.dataManager.inclusionModeDefinition&&(this.dataManager.inclusionModeDefinition.generateAllSublayers=!1),(n=this.dataManager.inclusionModeDefinition)==null||n.namedTypeDefinitions.forEach(l=>{var c;l.useAllData=!1,(c=l.members)==null||c.forEach(m=>{let g;g=m.linkChartLocation instanceof Pe?m.linkChartLocation:m.linkChartLocation?ae(m.linkChartLocation):null,g&&g.coords.length===2&&g.lengths.length===0?(this.linkChartGeohashLookup.set(m.id,oe(g.coords[1],g.coords[0],re)),this.entityLinkChartDiagramLookup.set(m.id,g)):(this.linkChartGeohashLookup.set(m.id,""),this.relationshipLinkChartDiagramLookup.set(m.id,g))}),this.addResolvingPromise(this._initializeDiagram().then(async()=>{this.layers.forEach(async m=>{await m.refreshCachedQueryEngine()}),this.tables.forEach(async m=>{await m.refreshCachedQueryEngine()})}))});else{const l=((d=this.defaultLinkChartConfig)==null?void 0:d.layoutMode)==="GEOGRAPHIC";this.addResolvingPromise(this.dataManager.refreshCacheContent(void 0,!1,l,!0).then(async()=>{dt(e);const c=[],m=[];this.loadLayerAssumingLocalCache(),this.dataManager.inclusionModeDefinition&&(this.dataManager.inclusionModeDefinition.generateAllSublayers=!1,this.dataManager.inclusionModeDefinition.namedTypeDefinitions.forEach(g=>{g.useAllData=!1})),await this._initializeDiagram(),this.layers.forEach(g=>{m.push(g.refreshCachedQueryEngine()),c.push(new Promise(b=>{g.on("layerview-create",()=>{b(null)})}))}),this.tables.forEach(g=>{m.push(g.refreshCachedQueryEngine())}),await Promise.all(m)}))}i(null)})})),Promise.resolve(this)}async addRecords(e,i){let t=[];i!=null&&i.cascadeAddRelationshipEndNodes&&this.dataManager.knowledgeGraph.dataModel&&(t=await St(e,this.dataManager.knowledgeGraph));const o=e.concat(t).filter(s=>{var r;return!((r=this.sublayerIdsCache.get(s.typeName))!=null&&r.has(s.id))});await this._handleNewRecords(o)}async removeRecords(e,{cascadeRemoveRelationships:i=!0,recalculateLayout:t=!1}={cascadeRemoveRelationships:!0,recalculateLayout:!1}){var r,a,n,d,l,c,m,g;let o=[];for(const b of e)((n=(a=(r=this.dataManager.inclusionModeDefinition)==null?void 0:r.namedTypeDefinitions)==null?void 0:a.get(b.typeName))==null?void 0:n.useAllData)===!1&&((m=(c=(l=(d=this.dataManager.inclusionModeDefinition)==null?void 0:d.namedTypeDefinitions)==null?void 0:l.get(b.typeName))==null?void 0:c.members)!=null&&m.has(b.id))&&o.push(b);if(i){const b=new Set,f=[];for(const M of o)if(this.dataManager.nodeConnectionsLookup.has(M.id))for(const h of this.dataManager.nodeConnectionsLookup.get(M.id))b.add(h);for(const M of b)if(this.dataManager.memberIdTypeLookup.has(M))for(const h of this.dataManager.memberIdTypeLookup.get(M))this.dataManager.relationshipTypeNames.has(h)&&f.push({id:M,typeName:h});o=o.concat(f)}this.dataManager.removeFromLayer(o);for(const b of o)(g=this.sublayerIdsCache.get(b.typeName))==null||g.delete(b.id),this.dataManager.relationshipTypeNames.has(b.typeName)?this.relationshipLinkChartDiagramLookup.delete(b.id):this.entityLinkChartDiagramLookup.delete(b.id);t&&await this.calculateLinkChartLayout(this._currentLinkChartConfig.layoutMode,{});const s=[];return this.layers.forEach(b=>{s.push(b.refreshCachedQueryEngine())}),await Promise.all(s),this._refreshNamedTypes(),o}async expand(e,i){const t=await this.dataManager.getConnectedRecordIds(e,i),o=t.filter(s=>{var r;return!((r=this.sublayerIdsCache.get(s.typeName))!=null&&r.has(s.id))});return await this._handleNewRecords(t),{records:o}}loadLayerAssumingLocalCache(){var e,i;this.memberRelationshipTypes.forEach(t=>{const o=new Ie({objectType:t,parentCompositeLayer:this,graphType:"relationship",title:t.name});o.geometryType?this.layers.push(o):this.tables.push(o),this.dataManager.sublayerCaches.has(t.name)||this.dataManager.sublayerCaches.set(t.name,new Map)}),this.memberEntityTypes.forEach(t=>{const o=new Ie({objectType:t,parentCompositeLayer:this,graphType:"entity",title:t.name});o.geometryType?this.layers.push(o):this.tables.push(o),this.dataManager.sublayerCaches.has(t.name)||this.dataManager.sublayerCaches.set(t.name,new Map)}),(e=this.dataManager.inclusionModeDefinition)!=null&&e.namedTypeDefinitions&&((i=this.dataManager.inclusionModeDefinition)==null||i.namedTypeDefinitions.forEach((t,o)=>{var r;const s=qt(this.sublayerIdsCache,o,()=>new Set);(r=t.members)==null||r.forEach(a=>{if(s.add(a.id),a.linkChartLocation)if(a.linkChartLocation instanceof Pe)this.dataManager.relationshipTypeNames.has(o)?this.relationshipLinkChartDiagramLookup.set(a.id,a.linkChartLocation):this.entityLinkChartDiagramLookup.set(a.id,a.linkChartLocation),a.linkChartLocation.coords.length===2&&a.linkChartLocation.lengths.length===0?this.linkChartGeohashLookup.set(a.id,oe(a.linkChartLocation.coords[1],a.linkChartLocation.coords[0],re)):this.linkChartGeohashLookup.set(a.id,"");else{const n=ae(a.linkChartLocation);this.dataManager.relationshipTypeNames.has(o)?this.relationshipLinkChartDiagramLookup.set(a.id,a.linkChartLocation?n:null):this.entityLinkChartDiagramLookup.set(a.id,a.linkChartLocation?n:null),"x"in a.linkChartLocation&&"y"in a.linkChartLocation?this.linkChartGeohashLookup.set(a.id,oe(a.linkChartLocation.x,a.linkChartLocation.y,re)):this.linkChartGeohashLookup.set(a.id,"")}})}))}async calculateLinkChartLayout(e="RADIAL_TREE",i){var W,Z,K;const t=[],o=[],s=[];this.dataManager.sublayerCaches.forEach((p,y)=>{this.dataManager.entityTypeNames.has(y)?p.forEach(u=>{t.push({typeName:y,feature:u})}):this.dataManager.relationshipTypeNames.has(y)&&p.forEach(u=>{o.push({typeName:y,feature:u})})}),this.entityLinkChartDiagramLookup=new Map,this.relationshipLinkChartDiagramLookup=new Map;const r=new Map,a=new Map,n=new Map,d=new Map,l=new Uint8Array(t.length),c=new Float64Array(t.length),m=new Float64Array(t.length),g=new Uint32Array(o.length),b=new Uint32Array(o.length),f=[],M="FORCE_DIRECTED",h=new ue({xmin:-1e-7,ymin:-1e-7,xmax:1e-7,ymax:1e-7});let D,O="FORCE_DIRECTED",E=0,U=0;switch(O=e==="GEOGRAPHIC"?M:e,O){case"FORCE_DIRECTED":D=_e.apply;break;case"COMMUNITY":D=$e.apply;break;case"HIERARCHICAL":D=Ge.apply;break;case"RADIAL_TREE":D=Oe.apply;break;case"SMART_TREE":D=Fe.apply;break;default:D=Se.apply}t.forEach(({typeName:p,feature:y})=>{var u,I,N;if((u=i==null?void 0:i.lockedNodeLocations)!=null&&u.has(y.attributes[R])){e==="GEOGRAPHIC"&&this.dataManager.geographicLookup.has(p)?l[E]=X.IsGeographic:l[E]=X.None;const T=i.lockedNodeLocations.get(y.attributes[R]);c[E]=T.x,m[E]=T.y}else if(e==="GEOGRAPHIC"&&this.dataManager.geographicLookup.has(p)){l[E]=X.IsGeographic;let T=null;const k=y.attributes[this.dataManager.geographicLookup.get(p).name];switch((I=this.dataManager.geographicLookup.get(p))==null?void 0:I.geometryType){case"esriGeometryPoint":c[E]=k==null?void 0:k.x,m[E]=k==null?void 0:k.y;break;case"esriGeometryPolygon":T=k==null?void 0:k.centroid,(T==null?void 0:T.x)!=null&&(T==null?void 0:T.y)!=null?(c[E]=T.x,m[E]=T.y):l[E]=X.IsMovable;break;case"esriGeometryPolyline":case"esriGeometryMultipoint":T=(N=k==null?void 0:k.extent)==null?void 0:N.center,(T==null?void 0:T.x)!=null&&(T==null?void 0:T.y)!=null?(c[E]=T.x,m[E]=T.y):l[E]=X.IsMovable;break;default:l[E]=X.IsMovable}(c[E]==null||m[E]==null||Number.isNaN(c[E])||Number.isNaN(m[E]))&&(l[E]=X.IsMovable,c[E]=0,m[E]=0)}else l[E]=X.IsMovable,c[E]=0,m[E]=0;d.set(y.attributes[R],E),f[E]={feature:y,typeName:p},E++});let Q=!1;const H=new Map;o.forEach(p=>{const y=p.feature.attributes[ge],u=p.feature.attributes[Te],I=d.get(y),N=d.get(u);if(I!==void 0&&N!==void 0){const T=y+"-"+u,k=H.get(T);(k==null?void 0:k.has(p.typeName))||(g[U]=I,b[U]=N,k===void 0?H.set(T,new Map([[p.typeName,U]])):k.set(p.typeName,U),U++),s.push(p)}else Q=!0,this.relationshipLinkChartDiagramLookup.set(y,null),this.linkChartGeohashLookup.set(y,null)}),Q&&de.getLogger(this).warn("A relationship is a member of this layer that has either origin or destination entity nodes that are not members. The diagram geometry will be set to null"),await Ot();const{success:ee,links:v}=D(l,c,m,g.subarray(0,U),b.subarray(0,U));if(!ee)throw new te("knowledge-graph:layout-failed","Attempting to arrange the records in the specified layout failed");for(let p=0;p<f.length;p++){if(m[p]>84.9999?m[p]=84.9999:m[p]<-84.9999&&(m[p]=-84.9999),c[p]>179.9999?c[p]=179.9999:c[p]<-179.9999&&(c[p]=-179.9999),f[p].feature.attributes[G]=new Qe(c[p],m[p]),r.has(f[p].typeName)){const u=r.get(f[p].typeName);u==null||u.set(f[p].feature.attributes[R],f[p].feature)}else{const u=new Map;u.set(f[p].feature.attributes[R],f[p].feature),r.set(f[p].typeName,u)}n.set(f[p].feature.attributes[R],f[p].feature);const y=ae(f[p].feature.attributes[G]);this.entityLinkChartDiagramLookup.set(f[p].feature.attributes[R],f[p].feature.attributes[G]?y:null),this.linkChartGeohashLookup.set(f[p].feature.attributes[R],oe(f[p].feature.attributes[G].y,f[p].feature.attributes[G].x,re)),f[p].feature.attributes[G].x<h.xmin&&(h.xmin=f[p].feature.attributes[G].x),f[p].feature.attributes[G].x>h.xmax&&(h.xmax=f[p].feature.attributes[G].x),f[p].feature.attributes[G].y<h.ymin&&(h.ymin=f[p].feature.attributes[G].y),f[p].feature.attributes[G].y>h.ymax&&(h.ymax=f[p].feature.attributes[G].y)}if(this.linkChartExtent.xmin=h.xmin,this.linkChartExtent.xmax=h.xmax,this.linkChartExtent.ymin=h.ymin,this.linkChartExtent.ymax=h.ymax,!v)throw new te("knowledge-graph:layout-failed","Attempting to retrieve link geometry from diagram engine failed");const P=new Map,J=new Map,z=new Map,V=new Set;for(let p=0;p<s.length;p++){const y=[],u=s[p],I=u.feature.attributes[ge],N=u.feature.attributes[Te],T=I+"-"+N,k=H.get(T).get(u.typeName),x=k===0?0:v==null?void 0:v.vertexEndIndex[k-1];if(!V.has(k)){if(V.add(k),v.types[k]===ke.Recursive){const S=[v.vertices[2*x],v.vertices[2*x+1]],Ce=[v.vertices[2*(x+1)],v.vertices[2*(x+1)+1]],se=[.5*(S[0]+Ce[0]),.5*(S[1]+Ce[1])],fe=[se[0]-S[0],se[1]-S[1]],lt=[se[0]+fe[1],se[1]-fe[0]],ht=[se[0]-fe[1],se[1]+fe[0]];y.push(S),y.push(lt),y.push(Ce),y.push(ht),y.push(S)}else{if(v.types[k]!==ke.Regular){de.getLogger(this).warn("A relationship generated an unsupported link geometry type.  It will not be rendered");continue}for(let S=x;S<v.vertexEndIndex[k];S++)y.push([v.vertices[2*S],v.vertices[2*S+1]])}const Y=(W=f[d.get(I)])==null?void 0:W.feature.attributes[G],ce=(Z=f[d.get(N)])==null?void 0:Z.feature.attributes[G];y[0][0]===Y.x&&y[0][1]===Y.y||(y[0]=[Y.x,Y.y]),y[y.length-1][0]===ce.x&&y[y.length-1][1]===ce.y||(y[y.length-1]=[ce.x,ce.y]);for(let S=1;S<y.length-1;S++)y[S][1]>85.5?y[S][1]=85.5:y[S][1]<-85.5&&(y[S][1]=-85.5),y[S][0]>179.9999?y[S][0]=179.9999:y[S][0]<-179.9999&&(y[S][0]=-179.9999);P.has(T)?P.get(T).push(y):P.set(T,[y])}const C=P.get(T);J.has(T)||(J.set(T,new Map),z.set(T,new Map));const A=J.get(T),F=z.get(T);A.has(u.typeName)||(A.set(u.typeName,C.shift()),F.set(u.typeName,0));const j=A.get(u.typeName);F.set(u.typeName,F.get(u.typeName)+1);const st=new Re({paths:j});if(u.feature.attributes[G]=st,a.has(u.typeName)){const Y=a.get(u.typeName);Y==null||Y.set(u.feature.attributes[R],u.feature)}else{const Y=new Map;Y.set(u.feature.attributes[R],u.feature),a.set(u.typeName,Y)}n.set(u.feature.attributes[R],u.feature);const pt=ae(u.feature.attributes[G]);this.relationshipLinkChartDiagramLookup.set(u.feature.attributes[R],u.feature.attributes[G]?pt:null),this.linkChartGeohashLookup.set(u.feature.attributes[R],"")}for(const p of s)p.feature.attributes[Ae]=((K=z.get(p.feature.attributes[ge]+"-"+p.feature.attributes[Te]))==null?void 0:K.get(p.typeName))??null;return this._currentLinkChartConfig={layoutMode:e},{nodes:r,links:a,idMap:n}}async applyNewLinkChartLayout(e="RADIAL_TREE",i){const t=[];await this.calculateLinkChartLayout(e,i),this.layers.forEach(o=>{t.push(o.refreshCachedQueryEngine())}),await Promise.all(t),this._refreshNamedTypes()}getCurrentNodeLocations(){var i,t;const e=new Map;return(t=(i=this.dataManager.inclusionModeDefinition)==null?void 0:i.namedTypeDefinitions)==null||t.forEach(o=>{var s;(s=o==null?void 0:o.members)==null||s.forEach(r=>{const a=r.linkChartLocation;let n;const d=r.id;a&&(n="x"in a?{x:a.x,y:a.y}:{x:a.coords[0],y:a.coords[1]},e.set(d,new Qe({x:n.x,y:n.y})))})}),e}async synchronizeInclusionListWithCache(){return new Promise(e=>{var i;(i=this.dataManager.inclusionModeDefinition)==null||i.namedTypeDefinitions.forEach((t,o)=>{if(t.useAllData=!1,t.members&&t.members.size>0){if(!this.dataManager.sublayerCaches.get(o))return;const s=new Set(Array.from(this.dataManager.sublayerCaches.get(o).keys()));Array.from(t.members.keys()).filter(r=>!s.has(r)).forEach(r=>{var a;(a=t.members)==null||a.delete(r)})}}),e()})}async refreshLinkChartCache(e){await this.dataManager.refreshCacheContent(e);const i=[];this.layers.forEach(t=>{i.push(t.refreshCachedQueryEngine())}),await Promise.all(i),this._refreshNamedTypes()}async _handleNewRecords(e){const i=[];this.dataManager.addToLayer(e);for(const t of e)this.sublayerIdsCache.has(t.typeName)||(this.sublayerIdsCache.set(t.typeName,new Set),i.push(t.typeName)),this.sublayerIdsCache.get(t.typeName).add(t.id);for(const t of i)if(this._graphTypeLookup.has(t)){const o=this._graphTypeLookup.get(t),s="endPoints"in o?"relationship":"entity",r=new Ie({objectType:o,parentCompositeLayer:this,graphType:s,title:t});s==="entity"?this.dataManager.entityTypeNames.add(t):this.dataManager.relationshipTypeNames.add(t),r.geometryType?this.layers.push(r):this.tables.push(r),this.dataManager.sublayerCaches.set(t,new Map)}await this.dataManager.refreshCacheContent(e.map(t=>t.id)),await this.applyNewLinkChartLayout(this._currentLinkChartConfig.layoutMode)}async _initializeDiagram(){var e,i;this.defaultLinkChartConfig?this.defaultLinkChartConfig.doNotRecalculateLayout?((i=(e=this.dataManager.inclusionModeDefinition)==null?void 0:e.namedTypeDefinitions)==null||i.forEach((t,o)=>{var s;(s=t==null?void 0:t.members)==null||s.forEach(r=>{const a=r.linkChartLocation;let n;const d=r.id;if(!a)return;n="x"in a?{x:a.x,y:a.y}:{x:a.coords[0],y:a.coords[1]};const l=ae(n);this.dataManager.relationshipTypeNames.has(o)?this.relationshipLinkChartDiagramLookup.set(d,l):this.entityLinkChartDiagramLookup.set(d,l),this.linkChartGeohashLookup.set(d,oe(n.x,n.y,re)),this.linkChartExtent.xmin>n.x&&(this.linkChartExtent.xmin=n.x),this.linkChartExtent.xmax<n.x&&(this.linkChartExtent.xmax=n.x),this.linkChartExtent.ymin>n.y&&(this.linkChartExtent.ymin=n.y),this.linkChartExtent.ymax<n.y&&(this.linkChartExtent.ymax=n.y)})}),this.memberRelationshipTypes.forEach(t=>{var o;t.name&&((o=this.dataManager.sublayerCaches.get(t.name))==null||o.forEach(s=>{const r=this.relationshipLinkChartDiagramLookup.get(s.attributes[ge]),a=this.relationshipLinkChartDiagramLookup.get(s.attributes[Te]);if(r&&a){const n=ae(new Re({paths:[[r.coords[0],r.coords[1]],[a.coords[0],a.coords[1]]]}));this.relationshipLinkChartDiagramLookup.set(s.attributes[R],n)}else this.relationshipLinkChartDiagramLookup.set(s.attributes[R],null);this.linkChartGeohashLookup.set(s.attributes[R],"")}))})):await this.calculateLinkChartLayout(this.defaultLinkChartConfig.layoutMode,{lockedNodeLocations:this.getCurrentNodeLocations()}):await this.calculateLinkChartLayout("RADIAL_TREE",{lockedNodeLocations:this.getCurrentNodeLocations()})}_refreshNamedTypes(){for(const e of this.layers)e.emit("refresh",{dataChanged:!0});for(const e of this.tables)e.emit("refresh",{dataChanged:!0})}};L([w()],q.prototype,"dataPreloadedInLocalCache",void 0),L([w()],q.prototype,"defaultLinkChartConfig",void 0),L([w()],q.prototype,"dataManager",void 0),L([w()],q.prototype,"knowledgeGraph",void 0),L([w()],q.prototype,"layers",void 0),L([w()],q.prototype,"entityLinkChartDiagramLookup",void 0),L([w()],q.prototype,"relationshipLinkChartDiagramLookup",void 0),L([w()],q.prototype,"linkChartExtent",void 0),L([w()],q.prototype,"linkChartGeohashLookup",void 0),L([w()],q.prototype,"memberEntityTypes",void 0),L([w()],q.prototype,"memberRelationshipTypes",void 0),L([w()],q.prototype,"sublayerIdsCache",void 0),L([w()],q.prototype,"tables",void 0),L([w({json:{read:!1}})],q.prototype,"type",void 0),q=L([we("esri.layers.LinkChartLayer")],q);const yn=q;export{yn as default};
