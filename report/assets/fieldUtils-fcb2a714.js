import{a as G,s as ae,t as se,o as oe}from"./Error-21d1d076.js";import{D as ue}from"./JSONSupport-acf2865c.js";import{_ as C}from"./request-a10d6950.js";import"./intl-fe039018.js";import"./typedArrayUtil-2af43698.js";import"./mathUtils-19b6edfc.js";import{t as ce}from"./promiseUtils-1d963c7c.js";import"./date-7940da18.js";import{D as x}from"./datetime-7e00d9ef.js";import"./locale-bde6d0f6.js";import"./geometry-31b45acd.js";import{f as fe}from"./SpatialReference-428523ee.js";async function de(e,t){const{WhereClause:n}=await C(()=>import("./WhereClause-239b807b.js").then(r=>r.W),["./WhereClause-239b807b.js","./TimeOnly-e43464ca.js","./Error-21d1d076.js","./typedArrayUtil-2af43698.js","./UnknownTimeZone-8ede07af.js","./datetime-7e00d9ef.js","./locale-bde6d0f6.js","./promiseUtils-1d963c7c.js","./Extent-2b4578b8.js","./subclass-f7409b1b.js","./JSONSupport-acf2865c.js","./time-0817624a.js","./SpatialReference-428523ee.js","./jsonMap-5ba4a9c2.js","./request-a10d6950.js","./assets-6fd92e57.js","./cast-e7a2f9aa.js"],import.meta.url);return n.create(e,t)}function yt(e,t){return e!=null&&e!==""?t!=null&&t!==""?`(${e}) AND (${t})`:e:t}function gt(e){return typeof e=="number"}function v(e){return typeof e=="string"||e instanceof String}const me="yyyy-MM-dd",pe="TT";var d;(function(e){e.HM="HH:mm",e.HMS="HH:mm:ss",e.HMS_MS="HH:mm:ss.SSS"})(d||(d={}));const ye=[d.HMS_MS,d.HMS,d.HM,pe];function V(e){if(!e||!v(e))return null;const t=x.fromFormat(e,me);return t.isValid?t:null}function L(e){return e&&v(e)?ce(ye,t=>{const n=x.fromFormat(e,t);return n.isValid?n:null})??null:null}function R(e){if(!e||!v(e))return null;const t=x.fromISO(e);return t.isValid?t:null}var f;(function(e){e.VALUE_OUT_OF_RANGE="domain-validation-error::value-out-of-range",e.INVALID_CODED_VALUE="domain-validation-error::invalid-coded-value"})(f||(f={}));const ge=new Set(["integer","small-integer","big-integer","esriFieldTypeInteger","esriFieldTypeSmallInteger","esriFieldTypeBigInteger"]);function Fe(e){return e!=null&&ge.has(e.type)}function H(e){return e!=null&&(e.type==="date-only"||e.type==="esriFieldTypeDateOnly")}function j(e){return e!=null&&(e.type==="timestamp-offset"||e.type==="esriFieldTypeTimestampOffset")}function k(e){return e!=null&&(e.type==="time-only"||e.type==="esriFieldTypeTimeOnly")}function Ie(e,t){const n=e==null?void 0:e.domain;if(!n)return null;switch(n.type){case"range":{const{min:r,max:i}=_e(e);if(r!=null&&+t<r||i!=null&&+t>i)return f.VALUE_OUT_OF_RANGE;break}case"coded-value":case"codedValue":if(n.codedValues==null||n.codedValues.every(r=>r==null||r.code!==t))return f.INVALID_CODED_VALUE}return null}function _e(e,t){const n=t??(e==null?void 0:e.domain);if(!n||n.type!=="range")return;const r="range"in n?n.range[0]:n.minValue,i="range"in n?n.range[1]:n.maxValue,l=Fe(e);return H(e)||k(e)||j(e)?{...we(e,i,r),isInteger:l}:{min:r!=null&&typeof r=="number"?r:null,max:i!=null&&typeof i=="number"?i:null,rawMin:r,rawMax:i,isInteger:l}}function we(e,t,n){var r,i,l,a,s,c;return H(e)?{min:(r=V(n))==null?void 0:r.toMillis(),max:(i=V(t))==null?void 0:i.toMillis(),rawMin:n,rawMax:t}:k(e)?{min:(l=L(n))==null?void 0:l.toMillis(),max:(a=L(t))==null?void 0:a.toMillis(),rawMin:n,rawMax:t}:j(e)?{min:(s=R(n))==null?void 0:s.toMillis(),max:(c=R(t))==null?void 0:c.toMillis(),rawMin:n,rawMax:t}:{max:null,min:null}}const be=()=>ae.getLogger("esri.support.arcadeOnDemand");let h;function P(){return h||(h=(async()=>{const e=await C(()=>import("./arcadeUtils-2b696ebb.js").then(t=>t.aK),["./arcadeUtils-2b696ebb.js","./geometry-31b45acd.js","./subclass-f7409b1b.js","./typedArrayUtil-2af43698.js","./Error-21d1d076.js","./promiseUtils-1d963c7c.js","./Extent-2b4578b8.js","./JSONSupport-acf2865c.js","./time-0817624a.js","./SpatialReference-428523ee.js","./jsonMap-5ba4a9c2.js","./request-a10d6950.js","./assets-6fd92e57.js","./cast-e7a2f9aa.js","./Polyline-013cde1f.js","./aaBoundingRect-aef00841.js","./Axis-30be7e73.js","./mathUtils-19b6edfc.js","./typeUtils-3056a943.js","./TimeOnly-e43464ca.js","./UnknownTimeZone-8ede07af.js","./datetime-7e00d9ef.js","./locale-bde6d0f6.js","./ImmutableArray-ee1d0ce7.js","./Field-be948aef.js","./enumeration-4a4e87c4.js","./fieldType-4834e8bc.js","./number-6ee739f3.js","./jsonUtils-2c7f966c.js","./featureConversionUtils-e62978d0.js","./aaBoundingBox-7242ce3e.js","./OptimizedFeature-0af09c7a.js","./OptimizedFeatureSet-1d1ac4b9.js","./OptimizedGeometry-5ad221bf.js","./FieldsIndex-9238b8b6.js","./date-7940da18.js","./Portal-cb507469.js","./Loadable-8a1ead8b.js","./Promise-ec74e14b.js"],import.meta.url);return{arcade:e.arcade,arcadeUtils:e,Dictionary:e.Dictionary,Feature:e.arcadeFeature}})()),h}const Ft=(e,t,n)=>z.create(e,t,n,null,["$feature","$view"],[]),It=(e,t,n,r)=>z.create(e,t,n,r,["$feature","$view"],[]);let z=class X{constructor(t,n,r,i,l,a,s){this.services=null,this.script=t,this.evaluate=i;const c=Array.isArray(a)?a:a==null?void 0:a.fields;this.fields=c??[],this._syntaxTree=r,this._arcade=n,this._arcadeFeature=l,this._spatialReference=s,this._referencesGeometry=n.scriptTouchesGeometry(this._syntaxTree),this._referencesScale=this._arcade.referencesMember(this._syntaxTree,"scale")}static async create(t,n,r,i,l,a){const{arcade:s,Feature:c,Dictionary:E}=await P(),w=fe.fromJSON(n);let u;try{u=s.parseScript(t,a)}catch(o){return be().error(new G("arcade-bad-expression","Failed to parse arcade script",{script:t,error:o})),null}const A=l.reduce((o,b)=>({...o,[b]:null}),{});let p=null;i!=null&&(p=new E(i),p.immutable=!0,A.$config=null);const M=s.scriptUsesGeometryEngine(u),Q=M&&s.enableGeometrySupport(),ee=s.scriptUsesFeatureSet(u)&&s.enableFeatureSetSupport(),D=s.scriptIsAsync(u),N=D&&s.enableAsyncSupport(),te={vars:A,spatialReference:w,useAsync:!!N};await Promise.all([Q,ee,N]);const ne=new Set;await s.loadDependentModules(ne,u,null,D,M);const y=new E;y.immutable=!1,y.setField("scale",0);const re=s.compileScript(u,te),ie=(o,b)=>{var O;const le=(O=o.$view)==null?void 0:O.timeZone;return"$view"in o&&o.$view&&(y.setField("scale",typeof o.$view=="object"&&"scale"in o.$view?o.$view.scale:void 0),o.$view=y),p&&(o.$config=p),re({vars:o,spatialReference:w,services:b,timeZone:le})};return new X(t,s,u,ie,new c,r,w)}repurposeFeature(t){return t.geometry&&!t.geometry.spatialReference&&(t.geometry.spatialReference=this._spatialReference),this._arcadeFeature.repurposeFromGraphicLikeObject(t.geometry,t.attributes,{fields:this.fields}),this._arcadeFeature}referencesGeometry(){return this._referencesGeometry}referencesScale(){return this._referencesScale}};const he=/^([0-9_])/,$e=/[^a-z0-9_\u0080-\uffff]+/gi;function _t(e){return e==null?null:e.trim().replaceAll($e,"_").replace(he,"F$1")||null}const Te=["field","field2","field3","normalizationField","rotationInfo.field","proportionalSymbolInfo.field","proportionalSymbolInfo.normalizationField","colorInfo.field","colorInfo.normalizationField"],xe=["field","normalizationField"];function wt(e,t){if(e!=null&&t!=null){for(const n of Array.isArray(e)?e:[e])if(U(Te,n,t),"visualVariables"in n&&n.visualVariables)for(const r of n.visualVariables)U(xe,r,t)}}function U(e,t,n){if(e)for(const r of e){const i=se(r,t),l=i&&typeof i!="function"&&n.get(i);l&&oe(r,l.name,t)}}function bt(e,t){var n;if(e!=null&&((n=t==null?void 0:t.fields)!=null&&n.length))if("startField"in e){const r=t.get(e.startField),i=t.get(e.endField);e.startField=(r==null?void 0:r.name)??null,e.endField=(i==null?void 0:i.name)??null}else{const r=t.get(e.startTimeField),i=t.get(e.endTimeField);e.startTimeField=(r==null?void 0:r.name)??null,e.endTimeField=(i==null?void 0:i.name)??null}}const $=new Set;function S(e,t){return e&&t?($.clear(),g($,e,t),Array.from($).sort()):[]}function g(e,t,n){var r;if(n)if((r=t==null?void 0:t.fields)!=null&&r.length)if(n.includes("*"))for(const{name:i}of t.fields)e.add(i);else for(const i of n)_(e,t,i);else{if(n.includes("*"))return e.clear(),void e.add("*");for(const i of n)i!=null&&e.add(i)}}function _(e,t,n){if(typeof n=="string")if(t){const r=t.get(n);r&&e.add(r.name)}else e.add(n)}function ht(e,t){return t==null||e==null?[]:t.includes("*")?(e.fields??[]).map(n=>n.name):t}function $t(e,t,n=1){if(!t||!e)return[];if(t.includes("*"))return["*"];const r=S(e,t);return r.length/e.fields.length>=n?["*"]:r}async function m(e,t,n){var l;if(!n)return;const{arcadeUtils:r}=await P(),i=r.extractFieldNames(n,(l=t==null?void 0:t.fields)==null?void 0:l.map(a=>a.name));for(const a of i)_(e,t,a)}async function B(e,t,n){if(n&&n!=="1=1"){const r=await de(n,t);if(!r.isStandardized)throw new G("fieldUtils:collectFilterFields","Where clause is not standardized",{where:n});g(e,t,r.fieldNames)}}function Tt({displayField:e,fields:t}){return e||(t!=null&&t.length?T(t,"name-or-title")||T(t,"unique-identifier")||T(t,"type-or-category")||ve(t):null)}function ve(e){for(const t of e){if(!(t!=null&&t.name))continue;const n=t.name.toLowerCase();if(n.includes("name")||n.includes("title"))return t.name}return null}function T(e,t){for(const n of e)if(n!=null&&n.valueType&&n.valueType===t)return n.name;return null}async function xt(e,t){var r;if(!t)return;const n=(r=t.elevationInfo)==null?void 0:r.featureExpressionInfo;return n?n.collectRequiredFields(e,t.fieldsIndex):void 0}function Se(e,t,n){n.onStatisticExpression?m(e,t,n.onStatisticExpression.expression):e.add(n.onStatisticField)}async function vt(e,t,n){if(!t||!n||!("fields"in n))return;const r=[],i=n.popupTemplate;r.push(Ee(e,t,i)),n.fields&&r.push(...n.fields.map(async l=>Se(e,t.fieldsIndex,l))),await Promise.all(r)}async function Ee(e,t,n){const r=[];n!=null&&n.expressionInfos&&r.push(...n.expressionInfos.map(l=>m(e,t.fieldsIndex,l.expression)));const i=n==null?void 0:n.content;if(Array.isArray(i))for(const l of i)l.type==="expression"&&l.expressionInfo&&r.push(m(e,t.fieldsIndex,l.expressionInfo.expression));await Promise.all(r)}async function St(e,t,n){t&&(t.timeInfo&&(n!=null&&n.timeExtent)&&g(e,t.fieldsIndex,[t.timeInfo.startField,t.timeInfo.endField]),t.floorInfo&&g(e,t.fieldsIndex,[t.floorInfo.floorField]),(n==null?void 0:n.where)!=null&&await B(e,t.fieldsIndex,n.where))}async function Et(e,t,n){t&&n&&await Promise.all(n.map(r=>Ae(e,t,r)))}async function Ae(e,t,n){t&&n&&(n.valueExpression?await m(e,t.fieldsIndex,n.valueExpression):n.field&&_(e,t.fieldsIndex,n.field))}function At(e){return e?S(e.fieldsIndex,W(e)):[]}function Me(e){if(!e)return[];const t=e.geometryFieldsInfo;return t?S(e.fieldsIndex,[t.shapeAreaField,t.shapeLengthField]):[]}const De=new Set(["oid","global-id","guid"]),Ne=new Set(["oid","global-id"]),Oe=[/^fnode_$/i,/^tnode_$/i,/^lpoly_$/i,/^rpoly_$/i,/^poly_$/i,/^shape$/i,/^shape_$/i,/^subclass$/i,/^subclass_$/i,/^rings_ok$/i,/^rings_nok$/i,/perimeter/i,/objectid/i,/_i$/i];function Ve(e){const t=new Set;J(e).forEach(r=>t.add(r)),Me(e).forEach(r=>t.add(r.toLowerCase()));const n=e&&"infoFor3D"in e?e.infoFor3D:void 0;return n&&(Object.values(n.assetMapFieldRoles).forEach(r=>t.add(r.toLowerCase())),Object.values(n.transformFieldRoles).forEach(r=>t.add(r.toLowerCase()))),Array.from(t)}function W(e){if(!e)return[];const t="editFieldsInfo"in e&&e.editFieldsInfo;if(!t)return[];const{creationDateField:n,creatorField:r,editDateField:i,editorField:l}=t;return[n,r,i,l].filter(Boolean)}function J(e){return W(e).map(t=>t.toLowerCase())}function Mt(e,t){var n;return e.editable&&!De.has(e.type)&&!J(t).includes(((n=e.name)==null?void 0:n.toLowerCase())??"")}function Dt(e,t){var r;const n=((r=e.name)==null?void 0:r.toLowerCase())??"";return!((t==null?void 0:t.objectIdField)!=null&&n===t.objectIdField.toLowerCase()||(t==null?void 0:t.globalIdField)!=null&&n===t.globalIdField.toLowerCase()||Ve(t).includes(n)||Ne.has(e.type)||Oe.some(i=>i.test(n)))}async function Nt(e,t){const{labelingInfo:n,fieldsIndex:r}=t;n!=null&&n.length&&await Promise.all(n.map(i=>Le(e,r,i)))}async function Le(e,t,n){if(!n)return;const r=n.getLabelExpression(),i=n.where;if(r.type==="arcade")await m(e,t,r.expression);else{const l=r.expression.match(/{[^}]*}/g);l&&l.forEach(a=>{_(e,t,a.slice(1,-1))})}await B(e,t,i)}function Ot(e){const t=e.defaultValue;return t!==void 0&&Z(e,t)?t:e.nullable?null:void 0}function Vt(e){const t=typeof e=="string"?{type:e}:e;return Je(t)?255:t.type==="esriFieldTypeDate"||t.type==="date"?8:void 0}function q(e){return typeof e=="number"&&!isNaN(e)&&isFinite(e)}function Re(e){return e===null||q(e)}function Ue(e){return e===null||Number.isInteger(e)}function Y(e){return e!=null&&typeof e=="string"}function Ge(e){return e===null||Y(e)}function Ce(){return!0}function Z(e,t){let n;switch(e.type){case"date":case"integer":case"long":case"small-integer":case"big-integer":case"esriFieldTypeDate":case"esriFieldTypeInteger":case"esriFieldTypeLong":case"esriFieldTypeSmallInteger":case"esriFieldTypeBigInteger":n=e.nullable?Ue:Number.isInteger;break;case"double":case"single":case"esriFieldTypeSingle":case"esriFieldTypeDouble":n=e.nullable?Re:q;break;case"string":case"esriFieldTypeString":n=e.nullable?Ge:Y;break;default:n=Ce}return arguments.length===1?n:n(t)}const He=["integer","small-integer","big-integer"],je=["single","double"],ke=["esriFieldTypeInteger","esriFieldTypeSmallInteger","esriFieldTypeBigInteger"],Pe=["esriFieldTypeSingle","esriFieldTypeDouble"],ze=new Set([...He,...ke]),Xe=new Set([...je,...Pe]),Be=ue(ze,Xe);function We(e){return e!=null&&Be.has(e.type)}function Je(e){return e!=null&&(e.type==="string"||e.type==="esriFieldTypeString")}function Lt(e){return e!=null&&(e.type==="date"||e.type==="esriFieldTypeDate")}function Rt(e){return e!=null&&(e.type==="date-only"||e.type==="esriFieldTypeDateOnly")}function Ut(e){return e!=null&&(e.type==="timestamp-offset"||e.type==="esriFieldTypeTimestampOffset")}function Gt(e){return e!=null&&(e.type==="time-only"||e.type==="esriFieldTypeTimeOnly")}function Ct(e){return e!=null&&(e.type==="oid"||e.type==="esriFieldTypeOID")}function Ht(e){return e!=null&&(e.type==="global-id"||e.type==="esriFieldTypeGlobalID")}function jt(e,t){return qe(e,t)===null}var F,I;function kt(e){return e==null||typeof e=="number"&&isNaN(e)?null:e}function qe(e,t){return e==null||e.nullable&&t===null?null:We(e)&&!Ye(e.type,Number(t))?F.OUT_OF_RANGE:Z(e,t)?e.domain?Ie(e,t):null:I.INVALID_TYPE}function Ye(e,t){const n=typeof e=="string"?K(e):e;if(!n)return!1;const r=n.min,i=n.max;return n.isInteger?Number.isInteger(t)&&t>=r&&t<=i:t>=r&&t<=i}function K(e){switch(e){case"esriFieldTypeSmallInteger":case"small-integer":return Ze;case"esriFieldTypeInteger":case"integer":return Ke;case"esriFieldTypeBigInteger":case"big-integer":return Qe;case"esriFieldTypeSingle":case"single":return et;case"esriFieldTypeDouble":case"double":return tt}}(function(e){e.OUT_OF_RANGE="numeric-range-validation-error::out-of-range"})(F||(F={})),function(e){e.INVALID_TYPE="type-validation-error::invalid-type"}(I||(I={}));const Ze={min:-32768,max:32767,isInteger:!0,rawMin:-32768,rawMax:32767},Ke={min:-2147483648,max:2147483647,isInteger:!0,rawMin:-2147483648,rawMax:2147483647},Qe={min:-Number.MAX_SAFE_INTEGER,max:Number.MAX_SAFE_INTEGER,isInteger:!0,rawMin:-Number.MAX_SAFE_INTEGER,rawMax:Number.MAX_SAFE_INTEGER},et={min:-34e37,max:12e37,isInteger:!1,rawMin:-34e37,rawMax:12e37},tt={min:-Number.MAX_VALUE,max:Number.MAX_VALUE,isInteger:!1,rawMin:-Number.MAX_VALUE,rawMax:Number.MAX_VALUE};function Pt(e,t,n){switch(e){case f.INVALID_CODED_VALUE:return`Value ${n} is not in the coded domain - field: ${t.name}, domain: ${JSON.stringify(t.domain)}`;case f.VALUE_OUT_OF_RANGE:return`Value ${n} is out of the range of valid values - field: ${t.name}, domain: ${JSON.stringify(t.domain)}`;case I.INVALID_TYPE:return`Value ${n} is not a valid value for the field type - field: ${t.name}, type: ${t.type}, nullable: ${t.nullable}`;case F.OUT_OF_RANGE:{const{min:r,max:i}=K(t.type);return`Value ${n} is out of range for the number type - field: ${t.name}, type: ${t.type}, value range is ${r} to ${i}`}}}function zt(e,t){return!nt(e,t,null)}function nt(e,t,n){if(!(t!=null&&t.attributes)||!e){if(n!=null)for(const l of e??[])n.add(l);return!0}const r=new Set(Object.keys(t.attributes));let i=!1;for(const l of e)if(!r.has(l)){if(i=!0,n==null)break;n.add(l)}return i}function Xt(e){return!!e&&["raster.itempixelvalue","raster.servicepixelvalue"].some(t=>e.toLowerCase().startsWith(t))}export{qe as A,Dt as B,gt as C,Rt as F,Xt as G,Ot as H,S as I,Nt as J,Vt as K,vt as L,St as M,Et as O,$t as T,Pt as U,Tt as _,Lt as a,g as b,We as c,Ct as d,de as e,Gt as f,bt as g,m as h,P as i,_t as j,zt as k,Ut as l,_e as m,yt as n,Ft as o,wt as p,Mt as q,At as r,ht as s,jt as t,It as u,xt as v,_ as w,Ht as x,Je as y,kt as z};
