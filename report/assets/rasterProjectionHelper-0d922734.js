import"./geometry-31b45acd.js";import{q as Pn}from"./typedArrayUtil-2af43698.js";import{a as bn}from"./Error-21d1d076.js";import{W as O,s as Gn,E as C,y as v,P as sn,z as kn,B as En,f as Nn}from"./SpatialReference-428523ee.js";import{E as nn,B as Tn,U as $,H as vn,V as rn}from"./projection-41da473c.js";import{M as A,x as k}from"./Extent-2b4578b8.js";import{j as pn}from"./Polyline-013cde1f.js";var Z;function gn(n,t,e){return!vn(n,t,e)}function I(n,t,e){const s=gn(n,t,e);if(s&&!nn())throw new bn("rasterprojectionhelper-project","projection engine is not loaded");return s}(function(n){n[n.None=0]="None",n[n.North=1]="North",n[n.South=2]="South",n[n.Both=3]="Both"})(Z||(Z={}));const an=(n,t,e,s=0)=>{if(e[0]===1)return[0,0];let r=1,i=-1,o=1,f=-1;for(let u=0;u<n.length;u+=2)isNaN(n[u])||(r=r>n[u]?n[u]:r,i=i>n[u]?i:n[u],o=o>n[u+1]?n[u+1]:o,f=f>n[u+1]?f:n[u+1]);const{cols:l,rows:a}=t,c=(i-r)/l/e[0],M=(f-o)/a/e[1],y=2*s;let x=0,m=!1,p=[0,0];for(let u=0;u<l-3;u++){for(let R=0;R<a-3;R++){const h=u*a*2+2*R,g=(n[h]+n[h+4]+n[h+4*a]+n[h+4*a+4])/4,d=(n[h+1]+n[h+5]+n[h+4*a+1]+n[h+4*a+5])/4,w=Math.abs((g-n[h+2*a+2])/c),S=Math.abs((d-n[h+2*a+3])/M);if(w+S>x&&(x=w+S,p=[w,S]),y&&x>y){m=!0;break}}if(m)break}return p},Cn={3395:20037508342789244e-9,3410:17334193943686873e-9,3857:20037508342788905e-9,3975:17367530445161372e-9,4087:20037508342789244e-9,4088:20015108787169147e-9,6933:17367530445161372e-9,32662:20037508342789244e-9,53001:2001508679602057e-8,53002:1000754339801029e-8,53003:2001508679602057e-8,53004:2001508679602057e-8,53016:14152803599503474e-9,53017:17333573624304302e-9,53034:2001508679602057e-8,53079:20015114352186374e-9,53080:20015114352186374e-9,54001:20037508342789244e-9,54002:10018754171394624e-9,54003:20037508342789244e-9,54004:20037508342789244e-9,54016:14168658027268292e-9,54017:1736753044516137e-8,54034:20037508342789244e-9,54079:20037508342789244e-9,54080:20037508342789244e-9,54100:20037508342789244e-9,54101:20037508342789244e-9},F=32,q=4,K=q,V=new Map,D=new Map,Y=500;async function Hn(){nn()||await Tn()}function _n(n,t,e){return I(n.spatialReference,t),e?rn(t,n.spatialReference,n):rn(n.spatialReference,t,n)}function ln(n,t,e,s=null){const r=n.spatialReference;if(r.equals(t))return n;I(r,t,s);const i=e.center,o=new A({xmin:i.x-n.x/2,xmax:i.x+n.x/2,ymin:i.y-n.y/2,ymax:i.y+n.y/2,spatialReference:r}),f=$(o,t,s),l=_(t);let a;if(f==null||l!=null&&f.width>=l){const c=O(r)/O(t);a={x:n.x*c,y:n.y*c}}else a={x:f.width,y:f.height};return a}function E(n,t=.01){return O(n)?t/O(n):0}function cn(n,t,e=null,s=!0){const r=n.spatialReference;if(r.equals(t))return n;I(r,t,e);const i=$(n,t,e);return s&&i&&yn([n],[i],r,t),i}function yn(n,t,e,s){const r=J(e,!0),i=J(s,!0),o=E(e,Y),f=E(s,Y);if(o&&r!=null&&i!=null)for(let l=0;l<n.length;l++){const a=t[l];if(!a)continue;const{x:c}=n[l],{x:M}=a;M>=i[1]-f&&Math.abs(c-r[0])<o?a.x-=i[1]-i[0]:M<=i[0]+f&&Math.abs(c-r[1])<o&&(a.x+=i[1]-i[0])}}function zn(n){const{inSR:t,outSR:e,datumTransformation:s,preferPE:r}=n;if(t.equals(e)){const{points:i}=tn(n,null);return i}return t.isWebMercator&&e.isWGS84||t.isWGS84&&e.isWebMercator?$n(n):I(t,e,s)&&r&&(t.isGeographic||W(t)!=null)?fn(n):Wn(n)}function Wn(n){const{points:t}=tn(n,null),{inSR:e,outSR:s,datumTransformation:r}=n,i=t.map(f=>new k(f[0],f[1],e)),o=$(i,s,r);return r&&yn(i,o,e,s),o.map(f=>f?[f.x,f.y]:[NaN,NaN])}function fn(n){const{inSR:t,outSR:e,datumTransformation:s}=n,r=W(t),{points:i,mask:o}=tn(n,r);if(!t.isGeographic){const l=t.wkid?C.coordsys(t.wkid):C.fromString(t.isGeographic?v.PE_TYPE_GEOGCS:v.PE_TYPE_PROJCS,t.wkt2||t.wkt);sn.projToGeog(l,i.length,i)}if(s!=null&&s.steps.length){let l;if(e.isGeographic&&(l=i.map(([c])=>c>179.9955?1:c<-179.9955?-1:0)),s.steps.forEach(c=>{const M=c.wkid?C.geogtran(c.wkid):C.fromString(v.PE_TYPE_GEOGTRAN,c.wkt);kn.geogToGeog(M,i.length,i,null,c.isInverse?v.PE_TRANSFORM_2_TO_1:v.PE_TRANSFORM_1_TO_2)}),l)for(let c=0;c<i.length;c++){const M=l[c],y=i[c][0],x=y>179.9955?1:y<-179.9955?-1:0;M&&x&&M!==x&&(i[c][0]=M>0?y+360:y-360)}}if(!e.isGeographic){const l=W(e,!0),a=l!=null&&l.isEnvelope?[l.bbox[1],l.bbox[3]]:[-90,90];In(i,a);const c=e.wkid?C.coordsys(e.wkid):C.fromString(e.isGeographic?v.PE_TYPE_GEOGCS:v.PE_TYPE_PROJCS,e.wkt2||e.wkt);sn.geogToProj(c,i.length,i)}let f=i;if(o&&i.length!==o.length){f=[];for(let l=0,a=0;l<o.length;l++)o[l]?f.push(i[a++]):f.push([NaN,NaN])}return f}function $n(n){const{cols:t,rows:e,xres:s,yres:r,usePixelCenter:i,inSR:o,outSR:f}=n;let{xmin:l,ymax:a}=n;i&&(l+=s/2,a-=r/2);const c=[],M=[],y=Math.max(t,e);for(let m=0;m<y;m++){const p=l+s*Math.min(t,m),u=a-r*Math.min(e,m),R=$(new k({x:p,y:u,spatialReference:o}),f);m<=t&&c.push(R.x),m<=e&&M.push(R.y)}const x=[];for(let m=0;m<t;m++)for(let p=0;p<e;p++)x.push([c[m],M[p]]);return x}function W(n,t=!1){let e=n.wkid||n.wkt2||n.wkt;if(!e||n.isGeographic)return null;if(e=String(e),V.has(e)){const o=V.get(e);return t?o==null?void 0:o.gcs:o==null?void 0:o.pcs}const s=n.wkid?C.coordsys(n.wkid):C.fromString(n.isGeographic?v.PE_TYPE_GEOGCS:v.PE_TYPE_PROJCS,n.wkt2||n.wkt),r=un(s,E(n,1e-4)),i=un(s,0,!0);return V.set(e,{pcs:r,gcs:i}),t?i:r}function un(n,t=0,e=!1){const s=En.generate(n),r=e?n.horizonGcsGenerate():n.horizonPcsGenerate();if(!s||!(r!=null&&r.length))return null;let i=!1,o=r.find(u=>u.getInclusive()===1&&u.getKind()===1);if(!o){if(o=r.find(u=>u.getInclusive()===1&&u.getKind()===0),!o)return null;i=!0}const f=e?0:(s.getNorthPoleLocation()===2?1:0)|(s.getSouthPoleLocation()===2?2:0),l=s.isPannableRectangle(),a=o.getCoord();if(i)return{isEnvelope:i,isPannable:l,vertices:a,coef:null,bbox:[a[0][0]-t,a[0][1]-t,a[1][0]+t,a[1][1]+t],poleLocation:f};let c=0;const M=[];let[y,x]=a[0],[m,p]=a[0];for(let u=0,R=a.length;u<R;u++){c++,c===R&&(c=0);const[h,g]=a[u],[d,w]=a[c];if(w===g)M.push([h,d,g,w,2]);else{const S=(d-h)/(w-g||1e-4),T=h-S*g;g<w?M.push([S,T,g,w,0]):M.push([S,T,w,g,1])}y=y<h?y:h,x=x<g?x:g,m=m>h?m:h,p=p>g?p:g}return{isEnvelope:!1,isPannable:l,vertices:a,coef:M,bbox:[y,x,m,p],poleLocation:f}}function tn(n,t){const e=[],{cols:s,rows:r,xres:i,yres:o,usePixelCenter:f}=n;let{xmin:l,ymax:a}=n;if(f&&(l+=i/2,a-=o/2),t==null){for(let x=0;x<s;x++)for(let m=0;m<r;m++)e.push([l+i*x,a-o*m]);return{points:e}}const c=new Uint8Array(s*r);if(t.isEnvelope){const{bbox:[x,m,p,u]}=t;for(let R=0,h=0;R<s;R++){const g=l+i*R,d=t.isPannable||g>=x&&g<=p;for(let w=0;w<r;w++,h++){const S=a-o*w;d&&S>=m&&S<=u&&(e.push([g,S]),c[h]=1)}}return{points:e,mask:c}}const M=t.coef,y=[];for(let x=0;x<r;x++){const m=a-o*x,p=[],u=[];for(let h=0;h<M.length;h++){const[g,d,w,S,T]=M[h];if(m===w&&w===S)p.push(g),p.push(d),u.push(2),u.push(2);else if(m>=w&&m<=S){const L=g*m+d;p.push(L),u.push(T)}}let R=p;if(p.length>2){let h=u[0]===2?0:u[0],g=p[0];R=[];for(let d=1;d<u.length;d++)u[d]===2&&d!==u.length-1||(u[d]!==h&&(R.push(h===0?Math.min(g,p[d-1]):Math.max(g,p[d-1])),h=u[d],g=p[d]),d===u.length-1&&R.push(u[d]===0?Math.min(g,p[d]):Math.max(g,p[d])));R.sort((d,w)=>d-w)}else p[0]>p[1]&&(R=[p[1],p[0]]);y.push(R)}for(let x=0,m=0;x<s;x++){const p=l+i*x;for(let u=0;u<r;u++,m++){const R=a-o*u,h=y[u];if(h.length===2)p>=h[0]&&p<=h[1]&&(e.push([p,R]),c[m]=1);else if(h.length>2){let g=!1;for(let d=0;d<h.length;d+=2)if(p>=h[d]&&p<=h[d+1]){g=!0;break}g&&(e.push([p,R]),c[m]=1)}}}return{points:e,mask:c}}function In(n,t){const[e,s]=t;for(let r=0;r<n.length;r++){const i=n[r][1];(i<e||i>s)&&(n[r]=[NaN,NaN])}}function dn(n,t){const e=_(n[0].spatialReference);if(n.length<2||e==null||(t=t??E(n[0].spatialReference),(n=n.filter(f=>f.width>t)).length===1))return n[0];let{xmin:s,xmax:r,ymin:i,ymax:o}=n[0];for(let f=1;f<n.length;f++){const l=n[f];r=l.xmax+e*f,i=Math.min(i,l.ymin),o=Math.max(o,l.ymax)}return new A({xmin:s,xmax:r,ymin:i,ymax:o,spatialReference:n[0].spatialReference})}function Mn(n,t,e=null,s=!0){const r=n.spatialReference;if(r.equals(t))return n;const i=wn(n),o=_(r,!0),f=_(t);if(i===0||o==null||f==null){const a=xn(n,t,e,s);if(o==null&&f!=null&&Math.abs(a.width-f)<E(t)&&nn()){const c=W(r);if(c!=null&&c.poleLocation===Z.None&&n.width<(c.bbox[2]-c.bbox[0])/2)return Ln(n,t)||a}return a}const l=n.clone().normalize();if(l.length===1&&n.xmax<o&&n.xmax-o/2>E(r)){const{xmin:a,xmax:c}=n;for(let M=0;M<=i;M++){const y=M===0?a:-o/2,x=M===i?c-o*M:o/2;l[M]=new A({xmin:y,xmax:x,ymin:n.ymin,ymax:n.ymax,spatialReference:r})}}return dn(l.map(a=>xn(a,t,e,s)).filter(Pn))}function Kn(n,t,e){if(n.type==="extent"){const{xmin:s,ymin:r,xmax:i,ymax:o,spatialReference:f}=n;n=new pn({rings:[[[s,o],[i,o],[i,r],[s,r],[s,o]]],spatialReference:f})}return n.spatialReference.equals(t)?n:(I(n.spatialReference,t,e),$(n,t,e))}function Ln(n,t){const e=_(t);if(e==null)return null;let{xmin:s,ymin:r,xmax:i,ymax:o}=n;const f=n.spatialReference,l=new pn({spatialReference:f,rings:[[[s,r],[i,r],[i,o],[s,o],[s,r]]]}),a=$(l,t);if(a.rings.length!==2||!a.rings[0].length||!a.rings[1].length)return null;const{rings:c}=a,M=E(f),y=new A({spatialReference:t});for(let x=0;x<2;x++){s=i=c[x][0][0],r=o=c[x][0][1];for(let m=0;m<c[x].length;m++)s=s>c[x][m][0]?c[x][m][0]:s,i=i<c[x][m][0]?c[x][m][0]:i,r=r>c[x][m][1]?c[x][m][1]:r,o=o<c[x][m][1]?c[x][m][1]:o;if(x===0)y.ymin=r,y.ymax=o,y.xmin=s,y.xmax=i;else if(y.ymin=Math.min(y.ymin,r),y.ymax=Math.max(y.ymax,o),Math.abs(i-e/2)<M)y.xmin=s,y.xmax=y.xmax+e;else{if(!(Math.abs(s+e/2)<M))return null;y.xmax=i+e}}return y}function xn(n,t,e=null,s=!0,r=!0){const i=n.spatialReference;if(i.equals(t)||!t)return n;I(i,t,e);const o=$(n,t,e);if(r&&t.isWebMercator&&o&&(o.ymax=Math.min(20037508342787e-6,o.ymax),o.ymin=Math.max(-20037508342787e-6,o.ymin),o.ymin>=o.ymax))return null;if(!s||!o)return o;const f=J(i,!0),l=J(t,!0);if(f==null||l==null)return o;const a=E(i,.001),c=E(i,Y),M=E(t,.001);if(Math.abs(o.xmin-l[0])<M&&Math.abs(o.xmax-l[1])<M){const y=Math.abs(n.xmin-f[0]),x=Math.abs(f[1]-n.xmax);if(y<a&&x>c){o.xmin=l[0];const m=[];m.push(new k(n.xmax,n.ymin,i)),m.push(new k(n.xmax,(n.ymin+n.ymax)/2,i)),m.push(new k(n.xmax,n.ymax,i));const p=m.map(u=>cn(u,t,e)).filter(u=>!isNaN(u==null?void 0:u.x)).map(u=>u.x);o.xmax=Math.max.apply(null,p)}if(x<a&&y>c){o.xmax=l[1];const m=[];m.push(new k(n.xmin,n.ymin,i)),m.push(new k(n.xmin,(n.ymin+n.ymax)/2,i)),m.push(new k(n.xmin,n.ymax,i));const p=m.map(u=>cn(u,t,e)).filter(u=>!isNaN(u==null?void 0:u.x)).map(u=>u.x);o.xmin=Math.min.apply(null,p)}}else{const y=E(t,.001);Math.abs(o.xmin-l[0])<y&&(o.xmin=l[0]),Math.abs(o.xmax-l[1])<y&&(o.xmax=l[1])}return o}function _(n,t=!1){if(!n)return null;const e=t?20037508342787e-6:20037508342788905e-9;return n.isWebMercator?2*e:n.wkid&&n.isGeographic?360:2*Cn[n.wkid]||null}function J(n,t=!1){if(n.isGeographic)return[-180,180];const e=_(n,t);return e!=null?[-e/2,e/2]:null}function mn(n,t,e,s){let r=(n-t)/e;return r-Math.floor(r)!=0?r=Math.floor(r):s&&(r-=1),r}function wn(n,t=!1){const e=_(n.spatialReference);if(e==null)return 0;const s=t?0:-(e/2),r=E(n.spatialReference),i=!t&&Math.abs(n.xmax-e/2)<r?e/2:n.xmax,o=!t&&Math.abs(n.xmin+e/2)<r?-e/2:n.xmin;return mn(i,s,e,!0)-mn(o,s,e,!1)}function Vn(n){const t=n.storageInfo.origin.x,e=_(n.spatialReference,!0);if(e==null)return{originX:t,halfWorldWidth:null,pyramidsInfo:null};const s=e/2,{nativePixelSize:r,storageInfo:i,extent:o}=n,{maximumPyramidLevel:f,blockWidth:l,pyramidScalingFactor:a}=i;let c=r.x;const M=[],y=n.transform!=null&&n.transform.type==="gcs-shift",x=t+(y?0:s),m=y?e-t:s-t;for(let p=0;p<=f;p++){const u=(o.xmax-t)/c/l,R=u-Math.floor(u)==0?u:Math.ceil(u),h=m/c/l,g=h-Math.floor(h)==0?h:Math.ceil(h),d=Math.floor(x/c/l),w=Math.round(x/c)%l,S=(l-Math.round(m/c)%l)%l;M.push({resolutionX:c,blockWidth:l,datasetColumnCount:R,worldColumnCountFromOrigin:g,leftMargin:w,rightPadding:S,originColumnOffset:d}),c*=a}return{originX:t,halfWorldWidth:s,pyramidsInfo:M,hasGCSSShiftTransform:y}}function On(n){if(!n||n.isGeographic)return n;const t=String(n.wkid||n.wkt2||n.wkt);let e;return D.has(t)?e=D.get(t):(e=(n.wkid?C.coordsys(n.wkid):C.fromString(v.PE_TYPE_PROJCS,n.wkt2||n.wkt)).getGeogcs().getCode(),D.set(t,e)),new Nn({wkid:e})}function Dn(n){const t=n.isAdaptive&&n.spacing==null;let e=n.spacing||[F,F],s=Q(n),r={cols:s.size[0]+1,rows:s.size[1]+1};const i=s.outofBoundPointCount>0&&s.outofBoundPointCount<s.offsets.length/2;let o=s.outofBoundPointCount===s.offsets.length/2||t&&i?[0,0]:an(s.offsets,r,e,K);const f=(o[0]+o[1])/2,l=n.projectedExtent.spatialReference,a=n.srcBufferExtent.spatialReference;if(t&&(i||f>K)&&(gn(l,a,n.datumTransformation)&&(l.isGeographic||W(l)),e=[q,q],s=Q({...n,spacing:e}),r={cols:s.size[0]+1,rows:s.size[1]+1},o=an(s.offsets,r,e,K)),s.error=o,e[0]>1&&(s.coefficients=hn(s.offsets,r,i)),n.includeGCSGrid&&!l.isGeographic&&!l.isWebMercator)if(a.isGeographic)s.gcsGrid={offsets:s.offsets,coefficients:s.coefficients,spacing:e};else{const c=W(l);if(c!=null&&!c.isEnvelope){const M=On(l),y=Mn(n.projectedExtent,M),{offsets:x}=Q({...n,srcBufferExtent:y,spacing:e}),m=hn(x,r,i);s.gcsGrid={offsets:x,coefficients:m,spacing:e}}}return s}function Q(n){const{projectedExtent:t,srcBufferExtent:e,pixelSize:s,datumTransformation:r,rasterTransform:i}=n,o=t.spatialReference,f=e.spatialReference,l=I(o,f),{xmin:a,ymin:c,xmax:M,ymax:y}=t,x=_(f),m=x!=null&&(n.hasWrapAround||(i==null?void 0:i.type)==="gcs-shift"),p=n.spacing||[F,F],u=p[0]*s.x,R=p[1]*s.y,h=p[0]===1,g=Math.ceil((M-a)/u-.1/p[0])+(h?0:1),d=Math.ceil((y-c)/R-.1/p[1])+(h?0:1),w=zn({cols:g,rows:d,xmin:a,ymax:y,xres:u,yres:R,inSR:o,outSR:f,datumTransformation:r,preferPE:p[0]<=q,usePixelCenter:h}),S=[];let T,L=0;const j=h?-1:NaN,{xmin:P,xmax:b,ymax:N,width:U,height:X}=e,Rn=E(f,Y),Sn=x!=null&&P>0&&b>x/2;let en=!1;if(l){const z=W(o);en=z!=null&&z.poleLocation>0}for(let z=0;z<g;z++){const H=[];for(let B=0;B<d;B++){let G=w[z*d+B];if(m&&G[0]>b&&G[0]>x/2-Rn?G[0]-=x:m&&z===0&&G[0]<0&&Sn&&!i&&(G[0]+=x),!G||isNaN(G[0])||isNaN(G[1]))S.push(j),S.push(j),H.push(null),L++;else{if(i){const on=i.inverseTransform(new k({x:G[0],y:G[1],spatialReference:f}));G=[on.x,on.y]}H.push(G),z>0&&m&&T[B]&&G[0]<T[B][0]&&(G[0]+=x,en&&G[0]>b&&G[0]>x&&(G[0]-=x)),S.push((G[0]-P)/U),S.push((N-G[1])/X)}}T=H}return{offsets:S,error:null,coefficients:null,outofBoundPointCount:L,spacing:p,size:h?[g,d]:[g-1,d-1]}}function hn(n,t,e){const{cols:s,rows:r}=t,i=new Float32Array((s-1)*(r-1)*2*6),o=new Float32Array([-0,-1,1,-1,1,-0,1,-0,-0]),f=new Float32Array([-1,1,0,0,-1,1,1,0,0]);for(let l=0;l<s-1;l++){for(let a=0;a<r-1;a++){let c=l*r*2+2*a;const M=n[c],y=n[c+1],x=n[c+2],m=n[c+3];c+=2*r;const p=n[c],u=n[c+1],R=n[c+2],h=n[c+3];let g=0,d=12*(a*(s-1)+l);for(let w=0;w<3;w++)i[d++]=o[g++]*M+o[g++]*x+o[g++]*R;g=0;for(let w=0;w<3;w++)i[d++]=o[g++]*y+o[g++]*m+o[g++]*h;g=0;for(let w=0;w<3;w++)i[d++]=f[g++]*M+f[g++]*p+f[g++]*R;g=0;for(let w=0;w<3;w++)i[d++]=f[g++]*y+f[g++]*u+f[g++]*h}if(e)for(let a=0;a<i.length;a++)isNaN(i[a])&&(i[a]=-1)}return i}function jn(n,t){const e=n.clone().normalize();return e.length===1?e[0]:dn(e,t)}function Qn(n){const{spatialReference:t}=n,e=Gn(t);if(!e)return n;const[s,r]=e.valid,i=r-s;let o=0;if(n.xmin<s){const f=s-n.xmin;o=Math.ceil(f/i)}else if(n.xmin>r){const f=n.xmin-r;o=-Math.ceil(f/i)}return new A({spatialReference:n.spatialReference,xmin:n.xmin+o*i,ymin:n.ymin,xmax:n.xmax+o*i,ymax:n.ymax})}function Zn(n,t,e){var m;const{storageInfo:s,pixelSize:r}=t;let i=0,o=!1;const{pyramidResolutions:f}=s,l=((m=s.tileInfo.format)==null?void 0:m.toLowerCase())==="mixed"?Math.max(1,Math.min(3,s.tileInfo.dpi/96)):1,a=(n.x+n.y)/2/l;if(f!=null&&f.length){const p=f[f.length-1],u=(p.x+p.y)/2,R=(r.x+r.y)/2;if(a<=R)i=0;else if(a>=u)i=f.length,o=a/u>8;else{let g,d=R;for(let w=1;w<=f.length;w++){if(g=(f[w-1].x+f[w-1].y)/2,a<=g){a===g?i=w:e==="down"?(i=w-1,o=a/d>8):i=e==="up"||a-d>g-a||a/d>2?w:w-1;break}d=g}}const h=i===0?r:f[i-1];return o&&Math.min(h.x,h.y)*O(t.spatialReference)>19567&&(o=!1),{pyramidLevel:i,pyramidResolution:new k({x:h.x,y:h.y,spatialReference:t.spatialReference}),excessiveReading:o}}const c=Math.log(n.x/r.x)/Math.LN2,M=Math.log(n.y/r.y)/Math.LN2,y=t.storageInfo.maximumPyramidLevel||0;i=e==="down"?Math.floor(Math.min(c,M)):e==="up"?Math.ceil(Math.max(c,M)):Math.round((c+M)/2),i<0?i=0:i>y&&(o=i>y+3,i=y);const x=2**i;return{pyramidLevel:i,pyramidResolution:new k({x:x*t.nativePixelSize.x,y:x*t.nativePixelSize.y,spatialReference:t.spatialReference}),excessiveReading:o}}function Bn(n,t){const{pixelSize:e,extent:s}=n,r=_n(s,t,!1);return Mn(jn(s,(e.x+e.y)/16),t,r)}function nt(n,t,e){var j;const s=(e==null?void 0:e.tileSize)??512,r=(e==null?void 0:e.alignGlobalDatasetWithAGOL)??!0,i=!!(e!=null&&e.limitToSrcResolution),{extent:o,spatialReference:f,pixelSize:l}=n,a=ln(new k({x:l.x,y:l.y,spatialReference:f}),t,o);if(a==null)return{projectedPixelSize:null,scales:null,srcResolutions:null,isCustomTilingScheme:!1};const c=(a.x+a.y)/2,M=O(t),y=c*M*96*39.37,x=t.isGeographic?256/s*2958287637958547e-7:256/s*591657527591555e-6;let m=n.dataType==="vector-magdir"||n.dataType==="vector-uv";const p=Bn(n,t),u=Math.min(Math.ceil(Math.log(Math.min(n.width,n.height)/32)/Math.LN2),Math.ceil(Math.log(x/2/y)/Math.LN2));if(!m&&r&&(t.isGeographic||t.isWebMercator)){const P=_(t);if(m=wn(p)>0||P!=null&&p.width>P/4,!m&&P!=null){let b=-1;if(u<3)b=2**u*c*s;else if(n.storageInfo){const{maximumPyramidLevel:U=0,pyramidScalingFactor:X=2}=n.storageInfo;b=X**U*c*s}const N=Math.ceil(P/b);m=N===1||N===2&&P/2-p.xmax<b}}let R,h=y;const g=1.001,d=Math.min(2,Math.max(1.414,((j=n.storageInfo)==null?void 0:j.pyramidScalingFactor)||2));if(m){h=x;const P=t.isGeographic?1341104507446289e-21:.29858214164761665,b=P*(96*M*39.37),N=t.isGeographic?4326:3857;R=ln(new k({x:P,y:P,spatialReference:{wkid:N}}),f,p),R.x*=h/b,R.y*=h/b}else{R={x:l.x,y:l.y};let P=0;for(;h<x*(g/2)&&P<u;)P++,h*=d,R.x*=d,R.y*=d;Math.max(h,x)/Math.min(h,x)<=g&&(h=x)}const w=[h],S=[{x:R.x,y:R.y}],T=70.5310735,L=Math.min(T,y)/g;for(;h>=L;)h/=d,R.x/=d,R.y/=d,w.push(h),S.push({x:R.x,y:R.y});if(i){const P=.001*l.x;let b=S.findIndex(N=>N.x>=l.x-P&&N.x<=l.x+P);b>-1?(S.length=b+1,w.length=b+1):(b=S.findIndex(N=>N.x<=l.x+P),b>0&&(S.length=b,w.length=b))}return{projectedPixelSize:a,scales:w,srcResolutions:S,isCustomTilingScheme:!m}}export{ln as C,_ as D,Mn as J,gn as M,Hn as T,Kn as U,wn as V,Vn as Z,nt as a,Dn as e,cn as j,Qn as o,Zn as r,Bn as s,_n as v};
