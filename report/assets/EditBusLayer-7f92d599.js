import{e as R,c as U}from"./subclass-f7409b1b.js";import{o as H}from"./Evented-b5127116.js";import{b as p}from"./Error-21d1d076.js";import{L as T}from"./promiseUtils-1d963c7c.js";import"./typedArrayUtil-2af43698.js";import{U as x,_ as j}from"./request-a10d6950.js";import{o as k}from"./uuid-709b6c67.js";const P=k(),w=new Map,E=new Map;async function K(e,s,d){if(!e||!d)return!1;if(!s)return!0;const n=new URL(e).host;let t=w.get(n);if(!t){const r=e.replace(/\/FeatureServer/i,"/VersionManagementServer").replace(/\/\d*$/,"");t=(await x(r,{responseType:"json",query:{f:"json"}})).data.defaultVersionName}return t===s}async function Q(e,s,d=!1){var r,o;if(!e||!s)return!0;const n=e.replace(/\/FeatureServer/i,"/VersionManagementServer").replace(/\/\d*$/,""),t=(r=E.get(n))==null?void 0:r.entries();if(t){for(const[l,c]of t)if(c.name===s){const u=!((o=c.stack)!=null&&o.hasForwardEdits());if(!u&&d){const[{deleteForwardEdits:m},{default:h}]=await Promise.all([j(()=>import("./deleteForwardEdits-02fda2db.js"),["./deleteForwardEdits-02fda2db.js","./request-a10d6950.js","./Error-21d1d076.js","./typedArrayUtil-2af43698.js","./JSONSupport-acf2865c.js","./subclass-f7409b1b.js","./promiseUtils-1d963c7c.js","./time-0817624a.js","./utils-3234cfff.js"],import.meta.url),j(()=>import("./DeleteForwardEditsParameters-24f43526.js"),["./DeleteForwardEditsParameters-24f43526.js","./subclass-f7409b1b.js","./typedArrayUtil-2af43698.js","./Error-21d1d076.js","./promiseUtils-1d963c7c.js","./JSONSupport-acf2865c.js","./time-0817624a.js"],import.meta.url)]);return m(n,l,new h({sessionId:P,moment:c.moment}))}return u}}return!0}function D(e,s){var t;if(!e)return!1;const d=e.replace(/\/FeatureServer/i,"/VersionManagementServer").replace(/\/\d*$/,""),n=(t=E.get(d))==null?void 0:t.entries();if(n){for(const[r,o]of n)if(o.name===s)return o.lockType==="edit"}return!1}const g=new H.EventEmitter;function O(e){return g.on("apply-edits",new WeakRef(e))}function W(e){return g.on("update-moment",new WeakRef(e))}function X(e,s,d=null,n=!1){const t=T();return n=s==null||n,g.emit("apply-edits",{serviceUrl:e,layerId:s,gdbVersion:d,mayReceiveServiceEdits:n,result:t.promise}),t}const V="esri.layers.mixins.EditBusLayer",$=Symbol(V);function Y(e){return e!=null&&typeof e=="object"&&$ in e}function f(e){return e!=null&&typeof e=="object"&&"gdbVersion"in e}function F(e,s,d){const n=new URL(e).host,t=w.get(n),r=o=>!o||o===t;return r(s)&&r(d)||s===d}const Z=e=>{var s;let d=class extends e{constructor(...n){super(...n),this[s]=!0,this._applyEditsHandler=t=>{const{serviceUrl:r,layerId:o,gdbVersion:l,mayReceiveServiceEdits:c,result:u}=t,m=r===this.url,h=o!=null&&this.layerId!=null&&o===this.layerId,A=f(this),L=f(this)&&F(r,l,this.gdbVersion);if(!m||A&&!L||!h&&!c)return;const S=u.then(i=>{var y;if(h&&(i.addedFeatures.length||i.updatedFeatures.length||i.deletedFeatures.length||i.addedAttachments.length||i.updatedAttachments.length||i.deletedAttachments.length))return this.emit("edits",p(i)),i;const I=(y=i.editedFeatures)==null?void 0:y.find(({layerId:b})=>b===this.layerId);if(I){const{adds:b,updates:M,deletes:v}=I.editedFeatures,_={edits:null,addedAttachments:[],deletedAttachments:[],updatedAttachments:[],addedFeatures:b?b.map(({attributes:a})=>({objectId:this.objectIdField&&a[this.objectIdField],globalId:this.globalIdField&&a[this.globalIdField]})):[],deletedFeatures:v?v.map(({attributes:a})=>({objectId:this.objectIdField&&a[this.objectIdField],globalId:this.globalIdField&&a[this.globalIdField]})):[],updatedFeatures:M?M.map(({current:{attributes:a}})=>({objectId:this.objectIdField&&a[this.objectIdField],globalId:this.globalIdField&&a[this.globalIdField]})):[],editedFeatures:p(i.editedFeatures),exceededTransferLimit:!1,historicMoment:p(i.historicMoment)};return this.emit("edits",_),_}return{edits:null,addedAttachments:[],deletedAttachments:[],updatedAttachments:[],addedFeatures:[],deletedFeatures:[],updatedFeatures:[],editedFeatures:p(i.editedFeatures),exceededTransferLimit:!1,historicMoment:p(i.historicMoment)}}).then(i=>("historicMoment"in this&&this.historicMoment!==i.historicMoment&&D(r,l)&&(this.historicMoment=i.historicMoment),i));this.emit("apply-edits",{result:S})},this._updateMomentHandler=t=>{const{serviceUrl:r,gdbVersion:o,moment:l}=t,c=r===this.url,u=f(this),m=f(this)&&F(r,o,this.gdbVersion),h=f(this)&&!F(r,this.gdbVersion,null);c&&u&&m&&h&&"historicMoment"in this&&this.historicMoment!==l&&(this.historicMoment=l)},this.when().then(()=>{this.addHandles(O(this._applyEditsHandler)),"historicMoment"in this&&this.addHandles(W(this._updateMomentHandler))},()=>{})}};return s=$,d=R([U(V)],d),d};export{Z as F,W as a,K as b,D as c,F as g,X as h,Q as i,O as l,Y as p,P as t};
