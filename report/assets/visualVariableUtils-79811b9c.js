import{u as E}from"./Color-e1a6dfab.js";import{c as T}from"./Graphic-f1881791.js";import{n as q}from"./compilerUtils-7f5a3043.js";import{s as I}from"./Error-21d1d076.js";import{m as A}from"./lengthUtils-1e9c410b.js";var S,m;function O(e){return e&&e.declaredClass==="esri.renderers.visualVariables.SizeVariable"}function y(e){return e!=null&&!isNaN(e)&&isFinite(e)}function P(e){return e.valueExpression?S.Expression:e.field&&typeof e.field=="string"?S.Field:S.Unknown}function re(e,r){const n=r||P(e),a=e.valueUnit||"unknown";return n===S.Unknown?m.Constant:e.stops?m.Stops:e.minSize!=null&&e.maxSize!=null&&e.minDataValue!=null&&e.maxDataValue!=null?m.ClampedLinear:a==="unknown"?e.minSize!=null&&e.minDataValue!=null?e.minSize&&e.minDataValue?m.Proportional:m.Additive:m.Identity:m.RealWorldSize}(function(e){e.Unknown="unknown",e.Expression="expression",e.Field="field"})(S||(S={})),function(e){e.Unknown="unknown",e.Stops="stops",e.ClampedLinear="clamped-linear",e.Proportional="proportional",e.Additive="additive",e.Constant="constant",e.Identity="identity",e.RealWorldSize="real-world-size"}(m||(m={}));const w=()=>I.getLogger("esri.renderers.visualVariables.support.visualVariableUtils"),C=new T,z=Math.PI,L=/^\s*(return\s+)?\$view\.scale\s*(;)?\s*$/i;function D(e,r,n){const a="visualVariables"in e&&e.visualVariables?e.visualVariables.find(c=>c.type==="color"):e;if(!a)return;if(a.declaredClass!=="esri.renderers.visualVariables.ColorVariable")return void w().warn("The visualVariable should be an instance of esri.renderers.visualVariables.ColorVariable");const i=typeof r=="number",t=i?null:r,s=t==null?void 0:t.attributes;let o=i?r:null;const l=a.field,{ipData:d,hasExpression:p}=a.cache;let u=a.cache.compiledFunc;if(!l&&!p){const c=a.stops;return c&&c[0]&&c[0].color}if(typeof o!="number")if(p){if((n==null?void 0:n.arcade)==null)return void w().error("Use of arcade expressions requires an arcade context");const c={viewingMode:n.viewingMode,scale:n.scale,spatialReference:n.spatialReference},f=n.arcade.arcadeUtils,V=f.getViewInfo(c),x=f.createExecContext(t,V,n.timeZone);if(!u){const F=f.createSyntaxTree(a.valueExpression);u=f.createFunction(F),a.cache.compiledFunc=u}o=f.executeFunction(u,x)}else s&&(o=s[l]);const v=a.normalizationField,b=s!=null&&v!=null?parseFloat(s[v]):void 0;if(o!=null&&(!v||i||!isNaN(b)&&b!==0)){isNaN(b)||i||(o/=b);const c=k(o,d);if(c){const f=c[0],V=c[1],x=f===V?a.stops[f].color:E.blendColors(a.stops[f].color,a.stops[V].color,c[2],n!=null?n.color:void 0);return new E(x)}}}function U(e,r,n){const a="visualVariables"in e&&e.visualVariables?e.visualVariables.find(c=>c.type==="opacity"):e;if(!a)return;if(a.declaredClass!=="esri.renderers.visualVariables.OpacityVariable")return void w().warn("The visualVariable should be an instance of esri.renderers.visualVariables.OpacityVariable");const i=typeof r=="number",t=i?null:r,s=t==null?void 0:t.attributes;let o=i?r:null;const l=a.field,{ipData:d,hasExpression:p}=a.cache;let u=a.cache.compiledFunc;if(!l&&!p){const c=a.stops;return c&&c[0]&&c[0].opacity}if(typeof o!="number")if(p){if((n==null?void 0:n.arcade)==null)return void w().error("Use of arcade expressions requires an arcade context");const c={viewingMode:n.viewingMode,scale:n.scale,spatialReference:n.spatialReference},f=n.arcade.arcadeUtils,V=f.getViewInfo(c),x=f.createExecContext(t,V,n.timeZone);if(!u){const F=f.createSyntaxTree(a.valueExpression);u=f.createFunction(F),a.cache.compiledFunc=u}o=f.executeFunction(u,x)}else s&&(o=s[l]);const v=a.normalizationField,b=s!=null&&v!=null?parseFloat(s[v]):void 0;if(o!=null&&(!v||i||!isNaN(b)&&b!==0)){isNaN(b)||i||(o/=b);const c=k(o,d);if(c){const f=c[0],V=c[1];if(f===V)return a.stops[f].opacity;{const x=a.stops[f].opacity;return x+(a.stops[V].opacity-x)*c[2]}}}}function R(e,r,n){const a="visualVariables"in e&&e.visualVariables?e.visualVariables.find(b=>b.type==="rotation"):e;if(!a)return;if(a.declaredClass!=="esri.renderers.visualVariables.RotationVariable")return void w().warn("The visualVariable should be an instance of esri.renderers.visualVariables.RotationVariable");const i=a.axis||"heading",t=i==="heading"&&a.rotationType==="arithmetic"?90:0,s=i==="heading"&&a.rotationType==="arithmetic"?-1:1,o=typeof r=="number"?null:r,l=o==null?void 0:o.attributes,d=a.field,{hasExpression:p}=a.cache;let u=a.cache.compiledFunc,v=0;if(!d&&!p)return v;if(p){if((n==null?void 0:n.arcade)==null)return void w().error("Use of arcade expressions requires an arcade context");const b={viewingMode:n.viewingMode,scale:n.scale,spatialReference:n.spatialReference},c=n.arcade.arcadeUtils,f=c.getViewInfo(b),V=c.createExecContext(o,f,n.timeZone);if(!u){const x=c.createSyntaxTree(a.valueExpression);u=c.createFunction(x),a.cache.compiledFunc=u}v=c.executeFunction(u,V)}else l&&(v=l[d]||0);return v=typeof v!="number"||isNaN(v)?null:t+s*v,v}function Z(e,r,n){const a=typeof r=="number",i=a?null:r,t=i==null?void 0:i.attributes;let s=a?r:null;const{isScaleDriven:o}=e.cache;let l=e.cache.compiledFunc;if(o){const p=n!=null?n.scale:void 0,u=n!=null?n.view:void 0;s=p==null||u==="3d"?_(e):p}else if(!a)switch(e.inputValueType){case S.Expression:{if((n==null?void 0:n.arcade)==null)return void w().error("Use of arcade expressions requires an arcade context");const p={viewingMode:n.viewingMode,scale:n.scale,spatialReference:n.spatialReference},u=n.arcade.arcadeUtils,v=u.getViewInfo(p),b=u.createExecContext(i,v,n.timeZone);if(!l){const c=u.createSyntaxTree(e.valueExpression);l=u.createFunction(c),e.cache.compiledFunc=l}s=u.executeFunction(l,b);break}case S.Field:t&&(s=t[e.field]);break;case S.Unknown:s=null}if(!y(s))return null;if(a||!e.normalizationField)return s;const d=t?parseFloat(t[e.normalizationField]):null;return y(d)&&d!==0?s/d:null}function _(e){let r=null,n=null;const a=e.stops;return a?(r=a[0].value,n=a[a.length-1].value):(r=e.minDataValue||0,n=e.maxDataValue||0),(r+n)/2}function g(e,r,n){const a="visualVariables"in e&&e.visualVariables?e.visualVariables.find(t=>t.type==="size"):e;if(!a)return;if(a.declaredClass!=="esri.renderers.visualVariables.SizeVariable")return void w().warn("The visualVariable should be an instance of esri.renderers.visualVariables.SizeVariable");const i=N(Z(a,r,n),a,r,n,a.cache.ipData);return i==null||isNaN(i)?0:i}function h(e,r,n){return e==null?null:O(e)?g(e,r,n):y(e)?e:null}function M(e,r,n){return y(n)&&e>n?n:y(r)&&e<r?r:e}function W(e,r,n,a){return e+((h(r.minSize,n,a)||r.minDataValue)??0)}function j(e,r,n){const a=e.stops;let i=(a==null?void 0:a.length)&&a[0].size;return i==null&&(i=e.minSize),h(i,r,n)}function B(e,r,n,a){const i=(e-r.minDataValue)/(r.maxDataValue-r.minDataValue),t=h(r.minSize,n,a),s=h(r.maxSize,n,a),o=a!=null?a.shape:void 0;if(e<=r.minDataValue)return t;if(e>=r.maxDataValue)return s;if(t==null||s==null)return null;if(r.scaleBy==="area"&&o){const l=o==="circle",d=l?z*(t/2)**2:t*t,p=d+i*((l?z*(s/2)**2:s*s)-d);return l?2*Math.sqrt(p/z):Math.sqrt(p)}return t+i*(s-t)}function G(e,r,n,a){const i=a!=null?a.shape:void 0,t=e/r.minDataValue,s=h(r.minSize,n,a),o=h(r.maxSize,n,a);let l=null;return l=i==="circle"?2*Math.sqrt(t*(s/2)**2):i==="square"||i==="diamond"||i==="image"?Math.sqrt(t*s**2):t*s,M(l,s,o)}function H(e,r,n,a,i){var l,d,p;const[t,s,o]=k(e,i);if(t===s)return h((l=r.stops)==null?void 0:l[t].size,n,a);{const u=h((d=r.stops)==null?void 0:d[t].size,n,a);return u+(h((p=r.stops)==null?void 0:p[s].size,n,a)-u)*o}}function J(e,r,n,a){const i=((a==null?void 0:a.resolution)??1)*A[r.valueUnit],t=h(r.minSize,n,a),s=h(r.maxSize,n,a),{valueRepresentation:o}=r;let l=null;return l=o==="area"?2*Math.sqrt(e/z)/i:o==="radius"||o==="distance"?2*e/i:e/i,M(l,t,s)}function N(e,r,n,a,i){switch(r.transformationType){case m.Additive:return W(e,r,n,a);case m.Constant:return j(r,n,a);case m.ClampedLinear:return B(e,r,n,a);case m.Proportional:return G(e,r,n,a);case m.Stops:return H(e,r,n,a,i);case m.RealWorldSize:return J(e,r,n,a);case m.Identity:return e;case m.Unknown:return null}}function K(e,r,n){const{isScaleDriven:a}=e.cache;if(!(a&&n==="3d"||r))return null;const i={scale:r,view:n};let t=h(e.minSize,C,i),s=h(e.maxSize,C,i);if(t!=null||s!=null){if(t>s){const o=s;s=t,t=o}return{minSize:t,maxSize:s}}}function Q(e,r,n){if(!e.visualVariables)return;const a=[],i=[],t=[],s=[],o=[];for(const l of e.visualVariables)switch(l.type){case"color":i.push(l);break;case"opacity":t.push(l);break;case"rotation":o.push(l);break;case"size":s.push(l)}return i.forEach(l=>{const d=D(l,r,n);a.push({variable:l,value:d})}),t.forEach(l=>{const d=U(l,r,n);a.push({variable:l,value:d})}),o.forEach(l=>{const d=R(l,r,n);a.push({variable:l,value:d})}),s.forEach(l=>{const d=g(l,r,n);a.push({variable:l,value:d})}),a.filter(l=>l.value!=null)}function k(e,r){if(!r)return;let n=0,a=r.length-1;return r.some((i,t)=>e<i?(a=t,!0):(n=t,!1)),[n,a,(e-r[n])/(r[a]-r[n])]}function X(e,r,n){const a=["proportional","proportional","proportional"];for(const i of e){const t=i.useSymbolValue?"symbol-value":g(i,r,n);switch(i.axis){case"width":a[0]=t;break;case"depth":a[1]=t;break;case"height":a[2]=t;break;case"width-and-depth":a[0]=t,a[1]=t;break;case"all":case void 0:case null:a[0]=t,a[1]=t,a[2]=t;break;default:q(i.axis)}}return a}const te=Object.freeze(Object.defineProperty({__proto__:null,getAllSizes:X,getColor:D,getOpacity:U,getRotationAngle:R,getSize:g,getSizeForValue:N,getSizeFromNumberOrVariable:h,getSizeRangeAtScale:K,getVisualVariableValues:Q,viewScaleRE:L},Symbol.toStringTag,{value:"Module"}));export{X as N,re as a,R as b,L as d,O as e,m as i,P as t,te as v};
