import{a as ge}from"./mathUtils-19b6edfc.js";import{s as le}from"./SpatialReference-428523ee.js";import{e as A}from"./TileKey-a0a7eda8.js";import{b as ye,e as w,c as ae}from"./subclass-f7409b1b.js";import{y as b,S as he,t as _e}from"./JSONSupport-acf2865c.js";import{u as xe}from"./promiseUtils-1d963c7c.js";import"./typedArrayUtil-2af43698.js";import"./Error-21d1d076.js";import{m as ve,b as te}from"./vec2-f44efd17.js";import{_ as Me}from"./QueueProcessor-79c89715.js";import{u as Q,R as we}from"./aaBoundingRect-aef00841.js";import{f as Ie}from"./quickselect-fcce738b.js";import{M as be}from"./Extent-2b4578b8.js";import{a as Se}from"./Query-aaf746b1.js";import{u as U}from"./Color-e1a6dfab.js";function Be(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t}function Te(t){return t[0]=1,t[1]=0,t[2]=0,t[3]=1,t[4]=0,t[5]=0,t}function Ce(t,e,i,s,o,r,n){return t[0]=e,t[1]=i,t[2]=s,t[3]=o,t[4]=r,t[5]=n,t}function $e(t,e){const i=e[0],s=e[1],o=e[2],r=e[3],n=e[4],a=e[5];let l=i*r-s*o;return l?(l=1/l,t[0]=r*l,t[1]=-s*l,t[2]=-o*l,t[3]=i*l,t[4]=(o*a-r*n)*l,t[5]=(s*n-i*a)*l,t):null}function Fe(t){return t[0]*t[3]-t[1]*t[2]}function ce(t,e,i){const s=e[0],o=e[1],r=e[2],n=e[3],a=e[4],l=e[5],h=i[0],c=i[1],u=i[2],f=i[3],m=i[4],g=i[5];return t[0]=s*h+r*c,t[1]=o*h+n*c,t[2]=s*u+r*f,t[3]=o*u+n*f,t[4]=s*m+r*g+a,t[5]=o*m+n*g+l,t}function Ye(t,e,i){const s=e[0],o=e[1],r=e[2],n=e[3],a=e[4],l=e[5],h=Math.sin(i),c=Math.cos(i);return t[0]=s*c+r*h,t[1]=o*c+n*h,t[2]=s*-h+r*c,t[3]=o*-h+n*c,t[4]=a,t[5]=l,t}function Xe(t,e,i){const s=e[0],o=e[1],r=e[2],n=e[3],a=e[4],l=e[5],h=i[0],c=i[1];return t[0]=s*h,t[1]=o*h,t[2]=r*c,t[3]=n*c,t[4]=a,t[5]=l,t}function ke(t,e,i){const s=e[0],o=e[1],r=e[2],n=e[3],a=e[4],l=e[5],h=i[0],c=i[1];return t[0]=s,t[1]=o,t[2]=r,t[3]=n,t[4]=s*h+r*c+a,t[5]=o*h+n*c+l,t}function ze(t,e){const i=Math.sin(e),s=Math.cos(e);return t[0]=s,t[1]=i,t[2]=-i,t[3]=s,t[4]=0,t[5]=0,t}function Pe(t,e){return t[0]=e[0],t[1]=0,t[2]=0,t[3]=e[1],t[4]=0,t[5]=0,t}function Re(t,e){return t[0]=1,t[1]=0,t[2]=0,t[3]=1,t[4]=e[0],t[5]=e[1],t}function Oe(t){return"mat2d("+t[0]+", "+t[1]+", "+t[2]+", "+t[3]+", "+t[4]+", "+t[5]+")"}function Le(t){return Math.sqrt(t[0]**2+t[1]**2+t[2]**2+t[3]**2+t[4]**2+t[5]**2+1)}function qe(t,e,i){return t[0]=e[0]+i[0],t[1]=e[1]+i[1],t[2]=e[2]+i[2],t[3]=e[3]+i[3],t[4]=e[4]+i[4],t[5]=e[5]+i[5],t}function ue(t,e,i){return t[0]=e[0]-i[0],t[1]=e[1]-i[1],t[2]=e[2]-i[2],t[3]=e[3]-i[3],t[4]=e[4]-i[4],t[5]=e[5]-i[5],t}function Ve(t,e,i){return t[0]=e[0]*i,t[1]=e[1]*i,t[2]=e[2]*i,t[3]=e[3]*i,t[4]=e[4]*i,t[5]=e[5]*i,t}function Ae(t,e,i,s){return t[0]=e[0]+i[0]*s,t[1]=e[1]+i[1]*s,t[2]=e[2]+i[2]*s,t[3]=e[3]+i[3]*s,t[4]=e[4]+i[4]*s,t[5]=e[5]+i[5]*s,t}function Ee(t,e){return t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2]&&t[3]===e[3]&&t[4]===e[4]&&t[5]===e[5]}function Ne(t,e){const i=t[0],s=t[1],o=t[2],r=t[3],n=t[4],a=t[5],l=e[0],h=e[1],c=e[2],u=e[3],f=e[4],m=e[5],g=ge();return Math.abs(i-l)<=g*Math.max(1,Math.abs(i),Math.abs(l))&&Math.abs(s-h)<=g*Math.max(1,Math.abs(s),Math.abs(h))&&Math.abs(o-c)<=g*Math.max(1,Math.abs(o),Math.abs(c))&&Math.abs(r-u)<=g*Math.max(1,Math.abs(r),Math.abs(u))&&Math.abs(n-f)<=g*Math.max(1,Math.abs(n),Math.abs(f))&&Math.abs(a-m)<=g*Math.max(1,Math.abs(a),Math.abs(m))}const je=ce,We=ue;Object.freeze(Object.defineProperty({__proto__:null,add:qe,copy:Be,determinant:Fe,equals:Ne,exactEquals:Ee,frob:Le,fromRotation:ze,fromScaling:Pe,fromTranslation:Re,identity:Te,invert:$e,mul:je,multiply:ce,multiplyScalar:Ve,multiplyScalarAndAdd:Ae,rotate:Ye,scale:Xe,set:Ce,str:Oe,sub:We,subtract:ue,translate:ke},Symbol.toStringTag,{value:"Module"}));function $(t,e){return[t,e]}function k(t,e,i){return t[0]=e,t[1]=i,t}function De(t,e,i,s,o){return t[0]=e,t[1]=i,t[2]=s,t[3]=o,t}const I=new A("0/0/0/0");let Ke=class fe{static create(e,i,s=null){const o=le(e.spatialReference),r=i.origin||$(e.origin.x,e.origin.y),n=$(e.size[0]*i.resolution,e.size[1]*i.resolution),a=$(-1/0,-1/0),l=$(1/0,1/0),h=$(1/0,1/0);s!=null&&(k(a,Math.max(0,Math.floor((s.xmin-r[0])/n[0])),Math.max(0,Math.floor((r[1]-s.ymax)/n[1]))),k(l,Math.max(0,Math.floor((s.xmax-r[0])/n[0])),Math.max(0,Math.floor((r[1]-s.ymin)/n[1]))),k(h,l[0]-a[0]+1,l[1]-a[1]+1));const{cols:c,rows:u}=i;let f,m,g,y;return!s&&c&&u&&(k(a,c[0],u[0]),k(l,c[1],u[1]),k(h,c[1]-c[0]+1,u[1]-u[0]+1)),e.isWrappable?(f=$(Math.ceil(Math.round((o.valid[1]-o.valid[0])/i.resolution)/e.size[0]),h[1]),m=$(Math.floor((o.origin[0]-r[0])/n[0]),a[1]),g=$(f[0]+m[0]-1,l[1]),y=!0):(m=a,g=l,f=h,y=!1),new fe(i.level,i.resolution,i.scale,r,a,l,h,n,m,g,f,y)}constructor(e,i,s,o,r,n,a,l,h,c,u,f){this.level=e,this.resolution=i,this.scale=s,this.origin=o,this.first=r,this.last=n,this.size=a,this.norm=l,this.worldStart=h,this.worldEnd=c,this.worldSize=u,this.wrap=f}normalizeCol(e){if(!this.wrap)return e;const i=this.worldSize[0];return e<0?i-1-Math.abs((e+1)%i):e%i}denormalizeCol(e,i){return this.wrap?this.worldSize[0]*i+e:e}getWorldForColumn(e){return this.wrap?Math.floor(e/this.worldSize[0]):0}getFirstColumnForWorld(e){return e*this.worldSize[0]+this.first[0]}getLastColumnForWorld(e){return e*this.worldSize[0]+this.first[0]+this.size[0]-1}getColumnForX(e){return(e-this.origin[0])/this.norm[0]}getXForColumn(e){return this.origin[0]+e*this.norm[0]}getRowForY(e){return(this.origin[1]-e)/this.norm[1]}getYForRow(e){return this.origin[1]-e*this.norm[1]}getTileBounds(e,i,s=!1){I.set(i);const o=s?I.col:this.denormalizeCol(I.col,I.world),r=I.row;return De(e,this.getXForColumn(o),this.getYForRow(r+1),this.getXForColumn(o+1),this.getYForRow(r)),e}getTileCoords(e,i,s=!1){I.set(i);const o=s?I.col:this.denormalizeCol(I.col,I.world);return Array.isArray(e)?k(e,this.getXForColumn(o),this.getYForRow(I.row)):(e.x=this.getXForColumn(o),e.y=this.getYForRow(I.row)),e}},D=class{constructor(){this.spans=[]}acquire(e){this.lodInfo=e}release(){this.lodInfo=null,this.spans.length=0}*keys(){const e=this.lodInfo;for(const{row:i,colFrom:s,colTo:o}of this.spans)for(let r=s;r<=o;r++){const n=e.getWorldForColumn(r);yield new A(e.level,i,e.normalizeCol(r),n)}}forEach(e,i){const{spans:s,lodInfo:o}=this,{level:r}=o;if(s.length!==0)for(const{row:n,colFrom:a,colTo:l}of s)for(let h=a;h<=l;h++)e.call(i,r,n,o.normalizeCol(h),o.getWorldForColumn(h))}};D.pool=new ye(D);let K=class{constructor(e,i,s){this.row=e,this.colFrom=i,this.colTo=s}};const p=new A("0/0/0/0");let He=class me{static create(e,i){e[1]>i[1]&&([e,i]=[i,e]);const[s,o]=e,[r,n]=i,a=r-s,l=n-o,h=l!==0?a/l:0,c=(Math.ceil(o)-o)*h,u=(Math.floor(o)-o)*h;return new me(s,Math.floor(o),Math.ceil(n),h,a<0?c:u,a<0?u:c,a<0?r:s,a<0?s:r)}constructor(e,i,s,o,r,n,a,l){this.x=e,this.ymin=i,this.ymax=s,this.invM=o,this.leftAdjust=r,this.rightAdjust=n,this.leftBound=a,this.rightBound=l}incrRow(){this.x+=this.invM}getLeftCol(){return Math.max(this.x+this.leftAdjust,this.leftBound)}getRightCol(){return Math.min(this.x+this.rightAdjust,this.rightBound)}};const M=[[0,0],[0,0],[0,0],[0,0]],Je=1e-6;let It=class{constructor(e,i=null,s=e.lods[0].level,o=e.lods[e.lods.length-1].level){this.tileInfo=e,this.fullExtent=i,this.scales=[],this._infoByScale={},this._infoByLevel={};const r=e.lods.filter(a=>a.level>=s&&a.level<=o);this.minScale=r[0].scale,this.maxScale=r[r.length-1].scale;const n=this._lodInfos=r.map(a=>Ke.create(e,a,i));r.forEach((a,l)=>{this._infoByLevel[a.level]=n[l],this._infoByScale[a.scale]=n[l],this.scales[l]=a.scale},this),this._wrap=e.isWrappable}get spatialReference(){return this.tileInfo.spatialReference}getLODInfoAt(e){return this._infoByLevel[typeof e=="number"?e:e.level]}getTileBounds(e,i,s=!1){p.set(i);const o=this._infoByLevel[p.level];return o?o.getTileBounds(e,p,s):e}getTileCoords(e,i,s=!1){p.set(i);const o=this._infoByLevel[p.level];return o?o.getTileCoords(e,p,s):e}getTileCoverage(e,i=192,s=!0,o="closest"){if(!s&&(e.scale>this.minScale||e.scale<this.maxScale))return null;const r=o==="closest"?this.getClosestInfoForScale(e.scale):this.getSmallestInfoForScale(e.scale),n=D.pool.acquire(r),a=this._wrap;let l,h,c,u=1/0,f=-1/0;const m=n.spans;M[0][0]=M[0][1]=M[1][1]=M[3][0]=-i,M[1][0]=M[2][0]=e.size[0]+i,M[2][1]=M[3][1]=e.size[1]+i;for(const d of M)e.toMap(d,d),d[0]=r.getColumnForX(d[0]),d[1]=r.getRowForY(d[1]);const g=[];let y=3;for(let d=0;d<4;d++){if(M[d][1]===M[y][1]){y=d;continue}const _=He.create(M[d],M[y]);u=Math.min(_.ymin,u),f=Math.max(_.ymax,f),g[_.ymin]===void 0&&(g[_.ymin]=[]),g[_.ymin].push(_),y=d}if(u==null||f==null||f-u>100)return null;let v=[];for(l=u;l<f;){g[l]!=null&&(v=v.concat(g[l])),h=1/0,c=-1/0;for(let d=v.length-1;d>=0;d--){const _=v[d];h=Math.min(h,_.getLeftCol()),c=Math.max(c,_.getRightCol())}if(h=Math.floor(h),c=Math.floor(c),l>=r.first[1]&&l<=r.last[1])if(a)if(r.size[0]<r.worldSize[0]){const d=Math.floor(c/r.worldSize[0]);for(let _=Math.floor(h/r.worldSize[0]);_<=d;_++)m.push(new K(l,Math.max(r.getFirstColumnForWorld(_),h),Math.min(r.getLastColumnForWorld(_),c)))}else m.push(new K(l,h,c));else h>r.last[0]||c<r.first[0]||(h=Math.max(h,r.first[0]),c=Math.min(c,r.last[0]),m.push(new K(l,h,c)));l+=1;for(let d=v.length-1;d>=0;d--){const _=v[d];_.ymax>=l?_.incrRow():v.splice(d,1)}}return n}getTileParentId(e){p.set(e);const i=this._infoByLevel[p.level],s=this._lodInfos.indexOf(i)-1;return s<0?null:(this._getTileIdAtLOD(p,this._lodInfos[s],p),p.id)}getTileResolution(e){const i=this._infoByLevel[typeof e=="object"?e.level:e];return i?i.resolution:-1}getTileScale(e){const i=this._infoByLevel[e.level];return i?i.scale:-1}intersects(e,i){p.set(i);const s=this._infoByLevel[p.level],o=e.lodInfo;if(o.resolution>s.resolution){this._getTileIdAtLOD(p,o,p);const n=o.denormalizeCol(p.col,p.world);for(const a of e.spans)if(a.row===p.row&&a.colFrom<=n&&a.colTo>=n)return!0}if(o.resolution<s.resolution){const[n,a,l,h]=e.spans.reduce((y,v)=>(y[0]=Math.min(y[0],v.row),y[1]=Math.max(y[1],v.row),y[2]=Math.min(y[2],v.colFrom),y[3]=Math.max(y[3],v.colTo),y),[1/0,-1/0,1/0,-1/0]),c=s.denormalizeCol(p.col,p.world),u=o.getColumnForX(s.getXForColumn(c)),f=o.getRowForY(s.getYForRow(p.row)),m=o.getColumnForX(s.getXForColumn(c+1))-1,g=o.getRowForY(s.getYForRow(p.row+1))-1;return!(u>h||m<l||f>a||g<n)}const r=o.denormalizeCol(p.col,p.world);return e.spans.some(n=>n.row===p.row&&n.colFrom<=r&&n.colTo>=r)}normalizeBounds(e,i,s){if(e[0]=i[0],e[1]=i[1],e[2]=i[2],e[3]=i[3],this._wrap){const o=le(this.tileInfo.spatialReference),r=-s*(o.valid[1]-o.valid[0]);e[0]+=r,e[2]+=r}return e}getSmallestInfoForScale(e){const i=this.scales;if(this._infoByScale[e])return this._infoByScale[e];if(e>i[0])return this._infoByScale[i[0]];for(let s=1;s<i.length-1;s++)if(e>i[s]+Je)return this._infoByScale[i[s-1]];return this._infoByScale[i[i.length-1]]}getClosestInfoForScale(e){const i=this.scales;return this._infoByScale[e]||(e=i.reduce((s,o)=>Math.abs(o-e)<Math.abs(s-e)?o:s,i[0])),this._infoByScale[e]}scaleToLevel(e){const i=this.scales;if(this._infoByScale[e])return this._infoByScale[e].level;for(let s=i.length-1;s>=0;s--)if(e<i[s])return s===i.length-1?this._infoByScale[i[i.length-1]].level:this._infoByScale[i[s]].level+(i[s]-e)/(i[s]-i[s+1]);return this._infoByScale[i[0]].level}scaleToZoom(e){return this.tileInfo.scaleToZoom(e)}_getTileIdAtLOD(e,i,s){const o=this._infoByLevel[s.level];return e.set(s),i.resolution<o.resolution?null:(i.resolution===o.resolution||(e.level=i.level,e.col=Math.floor(s.col*o.resolution/i.resolution+.01),e.row=Math.floor(s.row*o.resolution/i.resolution+.01)),e)}};function Ze(t,e){return t.length=0,e.forEach(i=>t.push(i)),t}const H=new Set,N=[],R=new Map,ie=[0,0];let F=class extends he{constructor(e){super(e),this._keyToItem=new Map,this.concurrency=6,this.strategy="scale-first",this.tileInfoView=null}initialize(){const{concurrency:e,process:i,strategy:s}=this;this._queue=new Me({concurrency:e,process:(o,r)=>{const n=this._keyToItem.get(o);return i(n,{signal:r})},peeker:s==="scale-first"?o=>this._peekByScaleFirst(o):o=>this._peekByCenterFirst(o)})}destroy(){this.clear(),this._queue=xe(this._queue)}get length(){return this._queue?this._queue.length:0}get onGoingCount(){return this._keyToItem.size}abort(e){const i=typeof e=="string"?e:e.id;this._queue.abort(i)}clear(){this._queue.clear(),this._keyToItem.clear()}has(e){return typeof e=="string"?this._keyToItem.has(e):this._keyToItem.has(e.id)}isOngoing(e){const i=typeof e=="string"?e:e.id;return this.has(i)&&this._queue.isOngoing(i)}pause(){this._queue.pause()}push(e){const i=e.key.id;if(this._queue.has(i))return this._queue.get(i);const s=this._queue.push(i),o=()=>{this._keyToItem.delete(i)};return this._keyToItem.set(i,e),s.then(o,o),s}reset(){this._queue.reset()}resume(){this._queue.resume()}_peekByScaleFirst(e){if(!this.state)return e.values().next().value;const i=this.tileInfoView;let s=Number.NEGATIVE_INFINITY,o=Number.POSITIVE_INFINITY;e.forEach(c=>{const u=this._keyToItem.get(c),f=this.tileInfoView.getTileScale(u.key);R.has(f)||(R.set(f,[]),s=Math.max(f,s),o=Math.min(f,o)),R.get(f).push(u.key),H.add(f)});let r=this.state.scale;R.has(r)||(Ze(N,H),N.sort((c,u)=>c-u),r=N.reduce((c,u)=>Math.abs(u-r)<Math.abs(c-r)?u:c,N[0])),r=Math.min(r,s),r=Math.max(r,o);const n=R.get(r),a=i.getClosestInfoForScale(r),l=a.getColumnForX(this.state.center[0]),h=a.getRowForY(this.state.center[1]);return n.sort((c,u)=>{const f=a.denormalizeCol(c.col,c.world),m=a.denormalizeCol(u.col,u.world);return Math.sqrt((l-f)*(l-f)+(h-c.row)*(h-c.row))-Math.sqrt((l-m)*(l-m)+(h-u.row)*(h-u.row))}),H.clear(),R.clear(),n[0].id}_peekByCenterFirst(e){if(!this.state)return e.values().next().value;const i=this.tileInfoView,s=this.state.center;let o,r=Number.POSITIVE_INFINITY;return e.forEach(n=>{const a=this._keyToItem.get(n);i.getTileCoords(ie,a.key);const l=ve(ie,s);l<r&&(r=l,o=a.key)}),o.id}};w([b({constructOnly:!0})],F.prototype,"concurrency",void 0),w([b({constructOnly:!0})],F.prototype,"process",void 0),w([b()],F.prototype,"state",void 0),w([b({constructOnly:!0})],F.prototype,"strategy",void 0),w([b({constructOnly:!0})],F.prototype,"tileInfoView",void 0),F=w([ae("esri.views.2d.tiling.TileQueue")],F);const Bt=F;let Ge=class{constructor(e,i,s){this.maxSize=e,this._tileInfoView=i,this._removedFunc=s,this._tilePerId=new Map,this._tileKeysPerLevel=[]}clear(){this._tilePerId.clear(),this._tileKeysPerLevel=[]}has(e){return this._tilePerId.has(e)}get(e){return this._tilePerId.get(e)}pop(e){const i=this._tilePerId.get(e);if(!i)return;const s=i.key.level,o=this._tileKeysPerLevel[s];se(this._tilePerId,e);for(let r=0;r<o.length;r++)if(o[r].id===e){o.splice(r,1);break}return i.visible=!0,i}add(e){e.visible=!1;const i=e.key,s=i.id;if(this._tilePerId.has(s))return;this._tilePerId.set(s,e);const o=i.level;this._tileKeysPerLevel[o]||(this._tileKeysPerLevel[o]=[]),this._tileKeysPerLevel[o].push(i)}prune(e,i,s){let o=this._tilePerId.size;if(o<=this.maxSize)return;let r=this._tileKeysPerLevel.length-1;for(;o>this.maxSize&&r>=0;)r!==e&&(o=this._pruneAroundCenterTile(o,i,s,r)),r--;o>this.maxSize&&(o=this._pruneAroundCenterTile(o,i,s,e))}_pruneAroundCenterTile(e,i,s,o){const r=this._tileKeysPerLevel[o];if(!r||r.length===0)return e;const{size:n,origin:a}=this._tileInfoView.tileInfo,l=s*n[0],h=s*n[1],c=[0,0],u=[0,0];for(r.sort((f,m)=>(c[0]=a.x+l*(f.col+.5),c[1]=a.y-h*(f.row+.5),u[0]=a.x+l*(m.col+.5),u[1]=a.y-h*(m.row+.5),te(c,i)-te(u,i)));r.length>0;){const f=r.pop();if(this._removeTile(f.id),--e===this.maxSize)break}return e}_removeTile(e){const i=this._tilePerId.get(e);this._removedFunc&&i&&this._removedFunc(i),se(this._tilePerId,e)}};function se(t,e){t.delete(e)}const z=new A(0,0,0,0),T=new Map,P=[],J=[];let Ct=class{constructor(e){this._previousScale=Number.POSITIVE_INFINITY,this.cachePolicy="keep",this.coveragePolicy="closest",this.resampling=!0,this.tileIndex=new Map,this.tiles=[],this.buffer=192,this.acquireTile=e.acquireTile,this.releaseTile=e.releaseTile,this.tileInfoView=e.tileInfoView,e.resampling!=null&&(this.resampling=e.resampling),e.cachePolicy&&(this.cachePolicy=e.cachePolicy),e.coveragePolicy&&(this.coveragePolicy=e.coveragePolicy),e.buffer!=null&&(this.buffer=e.buffer),e.cacheSize&&(this._tileCache=new Ge(e.cacheSize,this.tileInfoView,i=>{this.releaseTile(i)}))}destroy(){this.tileIndex.clear()}update(e){var d,_;const{resampling:i,tileIndex:s}=this,{scale:o,center:r,resolution:n}=e.state,{minScale:a,maxScale:l}=this.tileInfoView,h=!e.stationary&&o>this._previousScale;if(this._previousScale=o,!i&&(o>a||o<l))return this.tiles.length=0,void this.clear();const c=this.tileInfoView.getTileCoverage(e.state,this.buffer,this.resampling,this.coveragePolicy);if(!c)return this.tiles.length=0,void this.clear();const{spans:u,lodInfo:f}=c,{level:m}=f;this.tiles.length=0,s.forEach(x=>x.visible=!0);let g=0,y=0;if(u.length>0)for(const{row:x,colFrom:X,colTo:E}of u)for(let C=X;C<=E;C++){g++;const S=z.set(m,x,f.normalizeCol(C),f.getWorldForColumn(C)).id;let B=s.get(S);if(B)B.isReady?(T.set(S,B),y++):h||this._addParentTile(S,T);else{if((d=this._tileCache)!=null&&d.has(S)){if(B=this._tileCache.pop(S),this.tileIndex.set(S,B),B.isReady){T.set(S,B),y++;continue}}else B=this.acquireTile(z),this.tileIndex.set(S,B);h||this._addParentTile(S,T)}}const v=y===g;for(const[x,X]of s){if(T.has(x))continue;z.set(x);const E=this.tileInfoView.intersects(c,z),C=this.cachePolicy==="purge"?z.level!==m:z.level>m;!E||!h&&v?!C&&E||P.push(X):X.isReady?C&&this.cachePolicy==="purge"&&this._hasReadyAncestor(z,m)?P.push(X):J.push(X):C&&P.push(X)}for(const x of J)x.isReady&&T.set(x.key.id,x);for(const x of P)this._tileCache?this._tileCache.add(x):this.releaseTile(x),s.delete(x.key.id);for(const x of T.values())this.tiles.push(x);for(const x of s.values())T.has(x.key.id)||(x.visible=!1);(_=this._tileCache)==null||_.prune(m,r,n),D.pool.release(c),J.length=0,P.length=0,T.clear()}clear(){const{tileIndex:e}=this;for(const i of e.values())this.releaseTile(i);e.clear()}refresh(e){var i;for(const s of this.tileIndex.values())this.tiles.includes(s)?e(s):P.push(s);for(const s of P)this.releaseTile(s),this.tileIndex.delete(s.key.id);(i=this._tileCache)==null||i.clear()}updateCacheSize(e){this._tileCache&&(this._tileCache.maxSize=e)}_addParentTile(e,i){var r;let s=e,o=null;for(;s=this.tileInfoView.getTileParentId(s),s;)if(this.tileIndex.has(s)){if(o=this.tileIndex.get(s),o==null?void 0:o.isReady){i.has(o.key.id)||i.set(o.key.id,o);break}}else if((r=this._tileCache)!=null&&r.has(s)&&(o=this._tileCache.pop(s),this.tileIndex.set(s,o),o==null?void 0:o.isReady)){i.has(o.key.id)||i.set(o.key.id,o);break}}_hasReadyAncestor(e,i){const s=Q();this.tileInfoView.getTileBounds(s,e,!0);for(const o of this.tileIndex.values())if(o.isReady&&o.key.level>=i&&o.key.level<e.level){const r=Q();if(this.tileInfoView.getTileBounds(r,o.key,!0),we(r,s))return!0}return!1}};function Qe(){const t=new Float32Array(6);return t[0]=1,t[3]=1,t}function Ue(t){const e=new Float32Array(6);return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e}function et(t,e,i,s,o,r){const n=new Float32Array(6);return n[0]=t,n[1]=e,n[2]=i,n[3]=s,n[4]=o,n[5]=r,n}function tt(t,e){return new Float32Array(t,e,6)}function de(t,e,i,s){const o=e[s],r=e[s+1];t[s]=i[0]*o+i[2]*r+i[4],t[s+1]=i[1]*o+i[3]*r+i[5]}function it(t,e,i,s=0,o=0,r=2){const n=o||e.length/r;for(let a=s;a<n;a++)de(t,e,i,a*r)}Object.freeze(Object.defineProperty({__proto__:null,clone:Ue,create:Qe,createView:tt,fromValues:et,transform:de,transformMany:it},Symbol.toStringTag,{value:"Module"}));function ee(t,e){if(!(this instanceof ee))return new ee(t,e);this._maxEntries=Math.max(4,t||9),this._minEntries=Math.max(2,Math.ceil(.4*this._maxEntries)),e&&(typeof e=="function"?this.toBBox=e:this._initFormat(e)),this.clear()}function st(t,e,i){if(!i)return e.indexOf(t);for(var s=0;s<e.length;s++)if(i(t,e[s]))return s;return-1}function O(t,e){q(t,0,t.children.length,e,t)}function q(t,e,i,s,o){o||(o=L(null)),o.minX=1/0,o.minY=1/0,o.maxX=-1/0,o.maxY=-1/0;for(var r,n=e;n<i;n++)r=t.children[n],V(o,t.leaf?s(r):r);return o}function V(t,e){return t.minX=Math.min(t.minX,e.minX),t.minY=Math.min(t.minY,e.minY),t.maxX=Math.max(t.maxX,e.maxX),t.maxY=Math.max(t.maxY,e.maxY),t}function oe(t,e){return t.minX-e.minX}function re(t,e){return t.minY-e.minY}function Z(t){return(t.maxX-t.minX)*(t.maxY-t.minY)}function j(t){return t.maxX-t.minX+(t.maxY-t.minY)}function ot(t,e){return(Math.max(e.maxX,t.maxX)-Math.min(e.minX,t.minX))*(Math.max(e.maxY,t.maxY)-Math.min(e.minY,t.minY))}function rt(t,e){var i=Math.max(t.minX,e.minX),s=Math.max(t.minY,e.minY),o=Math.min(t.maxX,e.maxX),r=Math.min(t.maxY,e.maxY);return Math.max(0,o-i)*Math.max(0,r-s)}function G(t,e){return t.minX<=e.minX&&t.minY<=e.minY&&e.maxX<=t.maxX&&e.maxY<=t.maxY}function W(t,e){return e.minX<=t.maxX&&e.minY<=t.maxY&&e.maxX>=t.minX&&e.maxY>=t.minY}function L(t){return{children:t,height:1,leaf:!0,minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0}}function ne(t,e,i,s,o){for(var r,n=[e,i];n.length;)(i=n.pop())-(e=n.pop())<=s||(r=e+Math.ceil((i-e)/s/2)*s,Ie(t,r,e,i,o),n.push(e,r,r,i))}ee.prototype={all:function(){return this._all(this.data,[])},search:function(t){var e=this.data,i=[],s=this.toBBox;if(!W(t,e))return i;for(var o,r,n,a,l=[];e;){for(o=0,r=e.children.length;o<r;o++)n=e.children[o],W(t,a=e.leaf?s(n):n)&&(e.leaf?i.push(n):G(t,a)?this._all(n,i):l.push(n));e=l.pop()}return i},collides:function(t){var e=this.data,i=this.toBBox;if(!W(t,e))return!1;for(var s,o,r,n,a=[];e;){for(s=0,o=e.children.length;s<o;s++)if(r=e.children[s],W(t,n=e.leaf?i(r):r)){if(e.leaf||G(t,n))return!0;a.push(r)}e=a.pop()}return!1},load:function(t){if(!t||!t.length)return this;if(t.length<this._minEntries){for(var e=0,i=t.length;e<i;e++)this.insert(t[e]);return this}var s=this._build(t.slice(),0,t.length-1,0);if(this.data.children.length)if(this.data.height===s.height)this._splitRoot(this.data,s);else{if(this.data.height<s.height){var o=this.data;this.data=s,s=o}this._insert(s,this.data.height-s.height-1,!0)}else this.data=s;return this},insert:function(t){return t!=null&&this._insert(t,this.data.height-1),this},clear:function(){return this.data=L([]),this},remove:function(t,e){if(t==null)return this;for(var i,s,o,r,n=this.data,a=this.toBBox(t),l=[],h=[];n||l.length;){if(n||(n=l.pop(),s=l[l.length-1],i=h.pop(),r=!0),n.leaf&&(o=st(t,n.children,e))!==-1)return n.children.splice(o,1),l.push(n),this._condense(l),this;r||n.leaf||!G(n,a)?s?(i++,n=s.children[i],r=!1):n=null:(l.push(n),h.push(i),i=0,s=n,n=n.children[0])}return this},toBBox:function(t){return t},compareMinX:oe,compareMinY:re,toJSON:function(){return this.data},fromJSON:function(t){return this.data=t,this},_all:function(t,e){for(var i=[];t;)t.leaf?e.push.apply(e,t.children):i.push.apply(i,t.children),t=i.pop();return e},_build:function(t,e,i,s){var o,r=i-e+1,n=this._maxEntries;if(r<=n)return O(o=L(t.slice(e,i+1)),this.toBBox),o;s||(s=Math.ceil(Math.log(r)/Math.log(n)),n=Math.ceil(r/Math.pow(n,s-1))),(o=L([])).leaf=!1,o.height=s;var a,l,h,c,u=Math.ceil(r/n),f=u*Math.ceil(Math.sqrt(n));for(ne(t,e,i,f,this.compareMinX),a=e;a<=i;a+=f)for(ne(t,a,h=Math.min(a+f-1,i),u,this.compareMinY),l=a;l<=h;l+=u)c=Math.min(l+u-1,h),o.children.push(this._build(t,l,c,s-1));return O(o,this.toBBox),o},_chooseSubtree:function(t,e,i,s){for(var o,r,n,a,l,h,c,u;s.push(e),!e.leaf&&s.length-1!==i;){for(c=u=1/0,o=0,r=e.children.length;o<r;o++)l=Z(n=e.children[o]),(h=ot(t,n)-l)<u?(u=h,c=l<c?l:c,a=n):h===u&&l<c&&(c=l,a=n);e=a||e.children[0]}return e},_insert:function(t,e,i){var s=this.toBBox,o=i?t:s(t),r=[],n=this._chooseSubtree(o,this.data,e,r);for(n.children.push(t),V(n,o);e>=0&&r[e].children.length>this._maxEntries;)this._split(r,e),e--;this._adjustParentBBoxes(o,r,e)},_split:function(t,e){var i=t[e],s=i.children.length,o=this._minEntries;this._chooseSplitAxis(i,o,s);var r=this._chooseSplitIndex(i,o,s),n=L(i.children.splice(r,i.children.length-r));n.height=i.height,n.leaf=i.leaf,O(i,this.toBBox),O(n,this.toBBox),e?t[e-1].children.push(n):this._splitRoot(i,n)},_splitRoot:function(t,e){this.data=L([t,e]),this.data.height=t.height+1,this.data.leaf=!1,O(this.data,this.toBBox)},_chooseSplitIndex:function(t,e,i){var s,o,r,n,a,l,h,c;for(l=h=1/0,s=e;s<=i-e;s++)n=rt(o=q(t,0,s,this.toBBox),r=q(t,s,i,this.toBBox)),a=Z(o)+Z(r),n<l?(l=n,c=s,h=a<h?a:h):n===l&&a<h&&(h=a,c=s);return c},_chooseSplitAxis:function(t,e,i){var s=t.leaf?this.compareMinX:oe,o=t.leaf?this.compareMinY:re;this._allDistMargin(t,e,i,s)<this._allDistMargin(t,e,i,o)&&t.children.sort(s)},_allDistMargin:function(t,e,i,s){t.children.sort(s);var o,r,n=this.toBBox,a=q(t,0,e,n),l=q(t,i-e,i,n),h=j(a)+j(l);for(o=e;o<i-e;o++)r=t.children[o],V(a,t.leaf?n(r):r),h+=j(a);for(o=i-e-1;o>=e;o--)r=t.children[o],V(l,t.leaf?n(r):r),h+=j(l);return h},_adjustParentBBoxes:function(t,e,i){for(var s=i;s>=0;s--)V(e[s],t)},_condense:function(t){for(var e,i=t.length-1;i>=0;i--)t[i].children.length===0?i>0?(e=t[i-1].children).splice(e.indexOf(t[i]),1):this.clear():O(t[i],this.toBBox)},_initFormat:function(t){var e=["return a"," - b",";"];this.compareMinX=new Function("a","b",e.join(t[0])),this.compareMinY=new Function("a","b",e.join(t[1])),this.toBBox=new Function("a","return {minX: a"+t[0]+", minY: a"+t[1]+", maxX: a"+t[2]+", maxY: a"+t[3]+"};")}};class pe{constructor(e,i){this.key=new A(0,0,0,0),this.bounds=Q(),this.objectIds=new Set,this.key.set(i);const s=e.getLODInfoAt(this.key);this.tileInfoView=e,this.tileInfoView.getTileBounds(this.bounds,this.key,!0),this.resolution=s.resolution,this.scale=s.scale,this.level=s.level}get lod(){return this.tileInfoView.getLODInfoAt(this.key)}get id(){return this.key.id}get extent(){return be.fromBounds(this.bounds,this.tileInfoView.tileInfo.spatialReference)}get transform(){return{originPosition:"upperLeft",scale:[this.resolution,this.resolution],translate:[this.bounds[0],this.bounds[3]]}}createArcadeEvaluationOptions(e){return{$view:{scale:this.scale,timeZone:e}}}createChildTiles(){const e=this.key.getChildKeys(),i=_e.acquire();for(let s=0;s<e.length;s++)i[s]=new pe(this.tileInfoView,e[s]);return i}getQuantizationParameters(){return Se.fromJSON({mode:"view",originPosition:"upperLeft",tolerance:this.resolution,extent:{xmin:this.bounds[0],ymin:this.bounds[1],xmax:this.bounds[2],ymax:this.bounds[3],spatialReference:this.tileInfoView.tileInfo.spatialReference}})}}let Y=class extends he{constructor(){super(...arguments),this.color=new U([0,255,255]),this.haloOpacity=1,this.fillOpacity=.25,this.multiHighlightEnabled=!1}equals(t){return this.color.equals(t.color)&&(this.haloColor||this.color).equals(t.haloColor||t.color)&&this.haloOpacity===t.haloOpacity&&this.fillOpacity===t.fillOpacity&&this.multiHighlightEnabled===t.multiHighlightEnabled}};w([b({type:U})],Y.prototype,"color",void 0),w([b({type:U})],Y.prototype,"haloColor",void 0),w([b()],Y.prototype,"haloOpacity",void 0),w([b()],Y.prototype,"fillOpacity",void 0),w([b()],Y.prototype,"multiHighlightEnabled",void 0),Y=w([ae("esri.views.2d.support.HighlightOptions")],Y);const Ft=Y;export{ze as M,ee as a,pe as b,Xe as c,D as d,It as e,Re as f,ce as g,Pe as h,ke as i,Te as j,it as k,Ct as l,Bt as m,Qe as n,Ft as p,Ce as r,Ye as s,$e as u};
