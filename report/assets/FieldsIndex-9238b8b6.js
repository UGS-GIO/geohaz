import{s as N,a as S}from"./Error-21d1d076.js";import{g as O}from"./JSONSupport-acf2865c.js";import{r as b}from"./subclass-f7409b1b.js";import{t as B}from"./UnknownTimeZone-8ede07af.js";import{a as q,c as z,d as y,x as g,H as I,f as $,j as x}from"./fieldUtils-fcb2a714.js";import{i as p,r as f,f as h}from"./date-7940da18.js";import{F as D,I as L}from"./datetime-7e00d9ef.js";function R(s){return"timeZone"in s}function J(s){return"timeZone"in s}function A(s){return"dateFieldsTimeZone"in s}const j=new Map;class u{static fromJSON(e){return new u(e.fields,e.timeZoneByFieldName)}static fromLayer(e){return new u(e.fields??[],T(e))}static fromLayerJSON(e){return new u(e.fields??[],T(e))}constructor(e=[],i){var r;this._fieldsMap=new Map,this._normalizedFieldsMap=new Map,this._dateFieldsSet=new Set,this._numericFieldsSet=new Set,this._requiredFields=null,this.dateFields=[],this.numericFields=[],this.fields=e||[],this._timeZoneByFieldName=i?new Map(i):null;const n=[];for(const t of this.fields){const d=t==null?void 0:t.name,l=_(d);if(d&&l){const o=a(d);this._fieldsMap.set(d,t),this._fieldsMap.set(o,t),this._normalizedFieldsMap.set(l,t),n.push(`${o}:${t.type}:${(r=this._timeZoneByFieldName)==null?void 0:r.get(d)}`),q(t)?(this.dateFields.push(t),this._dateFieldsSet.add(t)):z(t)&&(this._numericFieldsSet.add(t),this.numericFields.push(t)),y(t)||g(t)||(t.editable=t.editable==null||!!t.editable,t.nullable=t.nullable==null||!!t.nullable)}}n.sort(),this.uid=n.join()}get requiredFields(){if(!this._requiredFields){this._requiredFields=[];for(const e of this.fields)y(e)||g(e)||e.nullable||I(e)!==void 0||this._requiredFields.push(e)}return this._requiredFields}equals(e){return this.uid===(e==null?void 0:e.uid)}has(e){return this.get(e)!=null}get(e){if(!e)return;let i=this._fieldsMap.get(e);return i||(i=this._fieldsMap.get(a(e))??this._normalizedFieldsMap.get(_(e)),i&&this._fieldsMap.set(e,i),i)}getTimeZone(e){const i=this.get(e&&typeof e!="string"?e.name:e);return i?this._timeZoneByFieldName?this._timeZoneByFieldName.get(i.name):i.type==="date"||i.type==="esriFieldTypeDate"?(N.getLogger("esri.layers.support.FieldsIndex").error(new S("getTimeZone:no-timezone-information",`no time zone information for field '${i.name}'`)),p):w.has(i.type)?f:null:null}getLuxonTimeZone(e){const i=this.getTimeZone(e);return i?i===f?B.instance:i===p?D.utcInstance:b(j,i,()=>L.create(i)):null}isDateField(e){return this._dateFieldsSet.has(this.get(e))}isTimeOnlyField(e){return $(this.get(e))}isNumericField(e){return this._numericFieldsSet.has(this.get(e))}normalizeFieldName(e){var i;return((i=this.get(e))==null?void 0:i.name)??void 0}toJSON(){return{fields:this.fields.map(e=>O(e)?e.toJSON():e),timeZoneByFieldName:this._timeZoneByFieldName?Array.from(this._timeZoneByFieldName.entries()):null}}}function a(s){return s.trim().toLowerCase()}function _(s){var e;return((e=x(s))==null?void 0:e.toLowerCase())??""}const w=new Set(["time-only","date-only","timestamp-offset","esriFieldTypeDateOnly","esriFieldTypeTimeOnly","esriFieldTypeTimestampOffset"]);function T(s){const e=new Map;if(!s.fields)return e;const i=s.datesInUnknownTimezone===!0,{timeInfo:n,editFieldsInfo:r}=s,t=(n?"startField"in n?n.startField:n.startTimeField:"")??"",d=(n?"endField"in n?n.endField:n.endTimeField:"")??"",l=A(s)?s.dateFieldsTimeZone??null:s.dateFieldsTimeReference?h(s.dateFieldsTimeReference):null,o=r?R(r)?r.timeZone??l:r.dateFieldsTimeReference?h(r.dateFieldsTimeReference):l??p:null,c=n?J(n)?n.timeZone??l:n.timeReference?h(n.timeReference):l:null,Z=new Map([[a((r==null?void 0:r.creationDateField)??""),o],[a((r==null?void 0:r.editDateField)??""),o],[a(t),c],[a(d),c]]);for(const{name:m,type:F}of s.fields)if(w.has(F))e.set(m,f);else if(F!=="date"&&F!=="esriFieldTypeDate")e.set(m,null);else if(i)e.set(m,f);else{const M=Z.get(a(m??""))??l;e.set(m,M)}return e}export{u as Z};
