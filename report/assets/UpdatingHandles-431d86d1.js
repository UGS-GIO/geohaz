import{e as l,c as p}from"./subclass-f7409b1b.js";import{S as _,v as m,y as u}from"./JSONSupport-acf2865c.js";import{e as r}from"./promiseUtils-1d963c7c.js";import{d as o,p as g,v as c,C as v}from"./reactiveUtils-e7d9f86e.js";let h=class extends _{constructor(){super(...arguments),this.updating=!1,this._handleId=0,this._scheduleHandleId=0,this._pendingPromises=new Set}destroy(){this.removeAll()}add(e,t,s={}){return this._installWatch(e,t,s,o)}addWhen(e,t,s={}){return this._installWatch(e,t,s,g)}addOnCollectionChange(e,t,{initial:s=!1,final:n=!1}={}){const d=++this._handleId;return this.addHandles([c(e,"after-changes",this._createSyncUpdatingCallback(),v),c(e,"change",t,{onListenerAdd:s?i=>t({added:i.toArray(),removed:[]}):void 0,onListenerRemove:n?i=>t({added:[],removed:i.toArray()}):void 0})],d),r(()=>this.removeHandles(d))}addPromise(e){if(e==null)return e;const t=++this._handleId;this.addHandles(r(()=>{this._pendingPromises.delete(e)&&(this._pendingPromises.size!==0||this.hasHandles(a)||this._set("updating",!1))}),t),this._pendingPromises.add(e),this._set("updating",!0);const s=()=>this.removeHandles(t);return e.then(s,s),e}removeAll(){this._pendingPromises.clear(),this.removeAllHandles(),this._set("updating",!1)}_installWatch(e,t,s={},n){const d=++this._handleId;s.sync||this._installSyncUpdatingWatch(e,d);const i=n(e,t,s);return this.addHandles(i,d),r(()=>this.removeHandles(d))}_installSyncUpdatingWatch(e,t){const s=this._createSyncUpdatingCallback(),n=o(e,s,{sync:!0,equals:()=>!1});return this.addHandles(n,t),n}_createSyncUpdatingCallback(){return()=>{this.removeHandles(a),++this._scheduleHandleId;const e=this._scheduleHandleId;this._get("updating")||this._set("updating",!0),this.addHandles(m(()=>{e===this._scheduleHandleId&&(this._set("updating",this._pendingPromises.size>0),this.removeHandles(a))}),a)}}};l([u({readOnly:!0})],h.prototype,"updating",void 0),h=l([p("esri.core.support.UpdatingHandles")],h);const a=-42;export{h};
