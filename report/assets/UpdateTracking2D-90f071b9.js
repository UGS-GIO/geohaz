import{h as Yr,k as nr}from"./typedArrayUtil-2af43698.js";import{a as Xn,i as Zn,c as qn}from"./TurboLine-fca76414.js";import"./earcut-9ee3ebef.js";import{e as Li,i as Ai,l as Kn}from"./GeometryUtils-2a8ddcd2.js";import{e as jn}from"./OptimizedGeometry-5ad221bf.js";import{a as Ae,d as Ke,$ as Vt,r as Ge,l as Hr,S as Qn,g as Jn,e as ts,_ as es}from"./definitions-f1268e8f.js";import{$ as yi,A as gi,s as xi,a as pt,g as rs,b as is,c as ns,O as ss,d as os,e as as}from"./CIMSymbolHelper-5fe56705.js";import{t as cs}from"./Polyline-013cde1f.js";import{_ as us}from"./request-a10d6950.js";import{o as ls,e as hs,w as ds,T as ps,r as xe}from"./LabelMetric-dc5934b5.js";import{C as g}from"./enums-52934aad.js";import{u as S}from"./screenUtils-7afeb41c.js";import{u as fs}from"./Color-e1a6dfab.js";import{a as Xr,s as je,t as ms,d as ys}from"./Error-21d1d076.js";import{U as sr,e as or,w as ar,d as cr,i as Gi}from"./enums-2742e74f.js";import{e as d,O as D,P as gs,c as xs}from"./subclass-f7409b1b.js";import{a as be}from"./BindType-d21d71dd.js";import{s as bs}from"./Util-5ae70216.js";import"./Texture-c6ffe640.js";import{r as vs}from"./Program-eff88155.js";import{l as Ui}from"./highlightReasons-e15be521.js";import{M as hr,n as dr,j as _s,i as ws,s as $s}from"./HighlightOptions-4299833f.js";import{t as mt}from"./constants-991354c8.js";import{e as bi}from"./mathUtils-19b6edfc.js";import{O as Wi}from"./utils-064c64c4.js";import{S as ve}from"./vec2-f44efd17.js";import{y as vi,S as Ss}from"./JSONSupport-acf2865c.js";import{s as Ps}from"./QueueProcessor-79c89715.js";import{d as Ts}from"./reactiveUtils-e7d9f86e.js";import{h as Is}from"./UpdatingHandles-431d86d1.js";function Wc(r){return r}function Yc(r){return r}function ks(r,t,e,i,n,s,o){mr=0;const a=(i-e)*s,c=n&&n.length,u=c?(n[0]-e)*s:a;let l,h,f,p,y,x=Yi(t,e,i,0,u,s,!0);if(x&&x.next!==x.prev){if(c&&(x=zs(t,e,i,n,x,s)),a>80*s){l=f=t[0+e*s],h=p=t[1+e*s];for(let v=s;v<u;v+=s){const _=t[v+e*s],$=t[v+1+e*s];l=Math.min(l,_),h=Math.min(h,$),f=Math.max(f,_),p=Math.max(p,$)}y=Math.max(f-l,p-h),y=y!==0?1/y:0}oe(x,r,s,l,h,y,o,0)}}function Yi(r,t,e,i,n,s,o){let a;if(o===Os(r,t,e,i,n,s)>0)for(let c=i;c<n;c+=s)a=_i(c+t*s,r[c+t*s],r[c+1+t*s],a);else for(let c=n-s;c>=i;c-=s)a=_i(c+t*s,r[c+t*s],r[c+1+t*s],a);return a&&St(a,a.next)&&(ae(a),a=a.next),a}function se(r,t=r){if(!r)return r;let e,i=r;do if(e=!1,i.steiner||!St(i,i.next)&&G(i.prev,i,i.next)!==0)i=i.next;else{if(ae(i),i=t=i.prev,i===i.next)break;e=!0}while(e||i!==t);return t}function oe(r,t,e,i,n,s,o,a){if(!r)return;!a&&s&&(r=Hi(r,i,n,s));let c=r;for(;r.prev!==r.next;){const u=r.prev,l=r.next;if(s?Ns(r,i,n,s):Ms(r))t.push(u.index/e+o),t.push(r.index/e+o),t.push(l.index/e+o),ae(r),r=l.next,c=l.next;else if((r=l)===c){a?a===1?oe(r=Vs(r,t,e,o),t,e,i,n,s,o,2):a===2&&Ls(r,t,e,i,n,s,o):oe(se(r),t,e,i,n,s,o,1);break}}}function Ms(r){const t=r.prev,e=r,i=r.next;if(G(t,e,i)>=0)return!1;let n=r.next.next;const s=n;let o=0;for(;n!==r.prev&&(o===0||n!==s);){if(o++,Ct(t.x,t.y,e.x,e.y,i.x,i.y,n.x,n.y)&&G(n.prev,n,n.next)>=0)return!1;n=n.next}return!0}function Ns(r,t,e,i){const n=r.prev,s=r,o=r.next;if(G(n,s,o)>=0)return!1;const a=n.x<s.x?n.x<o.x?n.x:o.x:s.x<o.x?s.x:o.x,c=n.y<s.y?n.y<o.y?n.y:o.y:s.y<o.y?s.y:o.y,u=n.x>s.x?n.x>o.x?n.x:o.x:s.x>o.x?s.x:o.x,l=n.y>s.y?n.y>o.y?n.y:o.y:s.y>o.y?s.y:o.y,h=pr(a,c,t,e,i),f=pr(u,l,t,e,i);let p=r.prevZ,y=r.nextZ;for(;p&&p.z>=h&&y&&y.z<=f;){if(p!==r.prev&&p!==r.next&&Ct(n.x,n.y,s.x,s.y,o.x,o.y,p.x,p.y)&&G(p.prev,p,p.next)>=0||(p=p.prevZ,y!==r.prev&&y!==r.next&&Ct(n.x,n.y,s.x,s.y,o.x,o.y,y.x,y.y)&&G(y.prev,y,y.next)>=0))return!1;y=y.nextZ}for(;p&&p.z>=h;){if(p!==r.prev&&p!==r.next&&Ct(n.x,n.y,s.x,s.y,o.x,o.y,p.x,p.y)&&G(p.prev,p,p.next)>=0)return!1;p=p.prevZ}for(;y&&y.z<=f;){if(y!==r.prev&&y!==r.next&&Ct(n.x,n.y,s.x,s.y,o.x,o.y,y.x,y.y)&&G(y.prev,y,y.next)>=0)return!1;y=y.nextZ}return!0}function _i(r,t,e,i){const n=Ue.create(r,t,e);return i?(n.next=i.next,n.prev=i,i.next.prev=n,i.next=n):(n.prev=n,n.next=n),n}function ae(r){r.next.prev=r.prev,r.prev.next=r.next,r.prevZ&&(r.prevZ.nextZ=r.nextZ),r.nextZ&&(r.nextZ.prevZ=r.prevZ)}function Es(r){let t=r,e=r;do(t.x<e.x||t.x===e.x&&t.y<e.y)&&(e=t),t=t.next;while(t!==r);return e}function zs(r,t,e,i,n,s){const o=new Array;for(let a=0,c=i.length;a<c;a++){const u=Yi(r,t,e,i[a]*s,a<c-1?i[a+1]*s:e*s,s,!1);u===u.next&&(u.steiner=!0),o.push(Es(u))}o.sort(Rs);for(const a of o)n=Ds(a,n);return n}function Ds(r,t){const e=Fs(r,t);if(!e)return t;const i=Zi(e,r);return se(i,i.next),se(e,e.next)}function Fs(r,t){let e=t;const i=r.x,n=r.y;let s,o=-1/0;do{if(n<=e.y&&n>=e.next.y&&e.next.y!==e.y){const f=e.x+(n-e.y)*(e.next.x-e.x)/(e.next.y-e.y);if(f<=i&&f>o){if(o=f,f===i){if(n===e.y)return e;if(n===e.next.y)return e.next}s=e.x<e.next.x?e:e.next}}e=e.next}while(e!==t);if(!s)return null;if(i===o)return s.prev;const a=s,c=s.x,u=s.y;let l,h=1/0;for(e=s.next;e!==a;)i>=e.x&&e.x>=c&&i!==e.x&&Ct(n<u?i:o,n,c,u,n<u?o:i,n,e.x,e.y)&&(l=Math.abs(n-e.y)/(i-e.x),(l<h||l===h&&e.x>s.x)&&ce(e,r)&&(s=e,h=l)),e=e.next;return s}function Hi(r,t,e,i){let n;for(;n!==r;n=n.next){if(n=n||r,n.z===null&&(n.z=pr(n.x,n.y,t,e,i)),n.prev.next!==n||n.next.prev!==n)return n.prev.next=n,n.next.prev=n,Hi(r,t,e,i);n.prevZ=n.prev,n.nextZ=n.next}return r.prevZ.nextZ=null,r.prevZ=null,Bs(r)}function Bs(r){let t,e=1;for(;;){let i,n=r;r=null,t=null;let s=0;for(;n;){s++,i=n;let o=0;for(;o<e&&i;o++)i=i.nextZ;let a=e;for(;o>0||a>0&&i;){let c;o===0?(c=i,i=i.nextZ,a--):a!==0&&i?n.z<=i.z?(c=n,n=n.nextZ,o--):(c=i,i=i.nextZ,a--):(c=n,n=n.nextZ,o--),t?t.nextZ=c:r=c,c.prevZ=t,t=c}n=i}if(t.nextZ=null,e*=2,s<2)return r}}function G(r,t,e){return(t.y-r.y)*(e.x-t.x)-(t.x-r.x)*(e.y-t.y)}function Xi(r,t,e,i){return!!(St(r,t)&&St(e,i)||St(r,i)&&St(e,t))||G(r,t,e)>0!=G(r,t,i)>0&&G(e,i,r)>0!=G(e,i,t)>0}function Cs(r,t){let e=r;do{if(e.index!==r.index&&e.next.index!==r.index&&e.index!==t.index&&e.next.index!==t.index&&Xi(e,e.next,r,t))return!0;e=e.next}while(e!==r);return!1}function Os(r,t,e,i,n,s){let o=0;for(let a=i,c=n-s;a<n;a+=s)o+=(r[c+t*s]-r[a+t*s])*(r[a+1+t*s]+r[c+1+t*s]),c=a;return o}function Ct(r,t,e,i,n,s,o,a){return(n-o)*(t-a)-(r-o)*(s-a)>=0&&(r-o)*(i-a)-(e-o)*(t-a)>=0&&(e-o)*(s-a)-(n-o)*(i-a)>=0}function ce(r,t){return G(r.prev,r,r.next)<0?G(r,t,r.next)>=0&&G(r,r.prev,t)>=0:G(r,t,r.prev)<0||G(r,r.next,t)<0}function pr(r,t,e,i,n){return(r=1431655765&((r=858993459&((r=252645135&((r=16711935&((r=32767*(r-e)*n)|r<<8))|r<<4))|r<<2))|r<<1))|(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t=32767*(t-i)*n)|t<<8))|t<<4))|t<<2))|t<<1))<<1}function St(r,t){return r.x===t.x&&r.y===t.y}function Rs(r,t){return r.x-t.x}function Vs(r,t,e,i){let n=r;do{const s=n.prev,o=n.next.next;!St(s,o)&&Xi(s,n,n.next,o)&&ce(s,o)&&ce(o,s)&&(t.push(s.index/e+i),t.push(n.index/e+i),t.push(o.index/e+i),ae(n),ae(n.next),n=r=o),n=n.next}while(n!==r);return n}function Ls(r,t,e,i,n,s,o){let a=r;do{let c=a.next.next;for(;c!==a.prev;){if(a.index!==c.index&&As(a,c)){let u=Zi(a,c);return a=se(a,a.next),u=se(u,u.next),oe(a,t,e,i,n,s,o,0),void oe(u,t,e,i,n,s,o,0)}c=c.next}a=a.next}while(a!==r)}function As(r,t){return r.next.index!==t.index&&r.prev.index!==t.index&&!Cs(r,t)&&ce(r,t)&&ce(t,r)&&Gs(r,t)}function Gs(r,t){let e=r,i=!1;const n=(r.x+t.x)/2,s=(r.y+t.y)/2;do e.y>s!=e.next.y>s&&e.next.y!==e.y&&n<(e.next.x-e.x)*(s-e.y)/(e.next.y-e.y)+e.x&&(i=!i),e=e.next;while(e!==r);return i}function Zi(r,t){const e=Ue.create(r.index,r.x,r.y),i=Ue.create(t.index,t.x,t.y),n=r.next,s=t.prev;return r.next=t,t.prev=r,e.next=n,n.prev=e,i.next=e,e.prev=i,s.next=i,i.prev=s,i}let Ue=class qi{constructor(){this.index=0,this.x=0,this.y=0,this.prev=null,this.next=null,this.z=null,this.prevZ=null,this.nextZ=null,this.steiner=!1}static create(t,e,i){const n=mr<fr.length?fr[mr++]:new qi;return n.index=t,n.x=e,n.y=i,n.prev=null,n.next=null,n.z=null,n.prevZ=null,n.nextZ=null,n.steiner=!1,n}};const fr=[],Us=8096;let mr=0;for(let r=0;r<Us;r++)fr.push(new Ue);const Ws=1e-5,_t=new Li(0,0,0,1,0),yr=new Li(0,0,0,1,0);function wi(r,t,e){let i=0;for(let n=1;n<e;n++){const s=r[2*(t+n-1)],o=r[2*(t+n-1)+1];i+=(r[2*(t+n)]-s)*(r[2*(t+n)+1]+o)}return i}function Ys(r,t,e,i,n){let s=0;const o=2;for(let a=e;a<i;a+=3){const c=(r[a]-n)*o,u=(r[a+1]-n)*o,l=(r[a+2]-n)*o;s+=Math.abs((t[c]-t[l])*(t[u+1]-t[c+1])-(t[c]-t[u])*(t[l+1]-t[c+1]))}return s}function Hs(r,t){const{coords:e,lengths:i,hasIndeterminateRingOrder:n}=t,s=0,o=r;if(n)return!1;let a=0;for(let c=0;c<i.length;){let u=c,l=i[c],h=wi(e,a,l);const f=[];for(;++u<i.length;){const v=i[u],_=wi(e,a+l,v);if(!(_>0))break;h+=_,f.push(a+l),l+=v}const p=o.length;ks(o,e,a,a+l,f,2,s);const y=Ys(o,e,p,o.length,s),x=Math.abs(h);if(Math.abs((y-x)/Math.max(1e-7,x))>Ws)return o.length=0,!1;c=u,a+=l}return!0}function Xs(r){const{coords:t,lengths:e}=r,{buffer:i}=Xn(t,e);return i}function Zs(r,t,e){let i=0;for(let n=0;n<r.lengths.length;n++){const s=r.lengths[n];for(let o=0;o<s;o++){const a=r.coords[2*(o+i)],c=r.coords[2*(o+i)+1];if(a<t||a>e||c<t||c>e)return!0}i+=s}return!1}function qs(r,t){if(r==null)return null;if(!Zs(r,-128,Ae+128))return r;_t.setPixelMargin(t),_t.reset(Ai.Polygon);let e=0;for(let o=0;o<r.lengths.length;o++){const a=r.lengths[o];let c=r.coords[2*(0+e)],u=r.coords[2*(0+e)+1];_t.moveTo(c,u);for(let l=1;l<a;l++)c=r.coords[2*(l+e)],u=r.coords[2*(l+e)+1],_t.lineTo(c,u);_t.close(),e+=a}const i=_t.result(!1);if(!i)return null;const n=[],s=[];for(const o of i){let a=0;for(const c of o)s.push(c.x),s.push(c.y),a++;n.push(a)}return new jn(n,s)}function Ks(r,t){yr.setPixelMargin(t);const e=yr,i=-t,n=Ae+t;let s=[],o=!1;if(!r.nextPath())return null;let a=!0;for(;a;){r.seekPathStart();const c=[];if(!r.pathSize)return null;e.reset(Ai.LineString),r.nextPoint();let u=r.x,l=r.y;if(o)e.moveTo(u,l);else{if(u<i||u>n||l<i||l>n){o=!0;continue}c.push({x:u,y:l})}let h=!1;for(;r.nextPoint();)if(u=r.x,l=r.y,o)e.lineTo(u,l);else{if(u<i||u>n||l<i||l>n){h=!0;break}c.push({x:u,y:l})}if(h)o=!0;else{if(o){const f=e.resultWithStarts();if(f)for(const p of f)s.push(p)}else s.push({line:c,start:0});a=r.nextPath(),o=!1}}return s=s.filter(c=>c.line.length>1),s.length===0?null:s}_t.setExtent(Ae),yr.setExtent(Ae);const js=96/72;let Qs=class{static executeEffects(t,e,i,n){const s=js,o=yi(t);let a=new xi(e);for(const c of t){const u=gi(c);u&&(a=u.execute(a,c,s,i,n,o))}return a}static applyEffects(t,e,i){if(!t)return e;const n=yi(t);let s,o=new xi(pt.fromJSONCIM(e));for(const u of t){const l=gi(u);l&&(o=l.execute(o,u,1,null,i,n))}const a=[];let c=null;for(;s=o.next();)a.push(...cs(s)),c=s.geometryType;return a.length===0||c===null?null:c==="esriGeometryPolygon"?{rings:a}:{paths:a}}},Ki=null;function Zr(){return Ki}async function Js(){Ki=await us(()=>import("./geometryEngineJSON-654a74ef.js"),["./geometryEngineJSON-654a74ef.js","./geometryEngineBase-77e94ca5.js","./_commonjsHelpers-2f3e7994.js","./geometryEngineJSON-ec02ed97.js","./json-48e3ea08.js"],import.meta.url)}function ji(r){switch(r){case g.BYTE:case g.UNSIGNED_BYTE:return 1;case g.SHORT:case g.UNSIGNED_SHORT:return 2;case g.FLOAT:case g.INT:case g.UNSIGNED_INT:return 4}}function to(r){const t=[],e=[],i=[];for(const n of r){const s=ji(n.type)*n.count;switch(s%2||s%4||4){case 4:t.push(n);continue;case 2:e.push(n);continue;case 1:i.push(n);continue;default:throw new Error("Found unexpected dataType byte count")}}return t.push(...e),t.push(...i),t}let eo=class Qi{static fromVertexSpec({attributes:t},e){let i,n,s;const o=[];for(const p in t){const y=t[p];(e==null?void 0:e[p])!==!1&&(y.pack==="position"?i={...y,name:p,offset:0}:y.pack==="id"?n={...y,name:p,offset:4}:p==="bitset"?s={...y,name:p,offset:7}:o.push({...y,name:p}))}const a=to(o),c=[];let u=8,l=1;for(const p of a)c.push({...p,offset:u}),u+=ji(p.type)*p.count,p.packAlternating&&(l=Math.max(p.packAlternating.count,l));const h=Uint32Array.BYTES_PER_ELEMENT,f=u%h;return new Qi(i,n,s,c,u+(f?h-f:0),l)}constructor(t,e,i,n,s,o){this.position=t,this.id=e,this.bitset=i,this.standardAttributes=n,this.stride=s,this.packVertexCount=o,n.push(i),this._attributes=[t,e,i,...n]}get attributeLayout(){if(!this._attributeLayout){const t=ls(this._attributes),e=this._attributes.map(i=>({name:i.name,count:i.count,offset:i.offset,type:i.type,packPrecisionFactor:i.packPrecisionFactor,normalized:i.normalized??!1}));this._attributeLayout={attributes:e,hash:t,stride:this.stride}}return this._attributeLayout}},ro=class Ji{static fromVertexSpec(t,e){const i=eo.fromVertexSpec(t,e);return new Ji(i)}constructor(t){this._spec=t,this._packed=new Uint8Array(this._spec.stride*this._spec.packVertexCount),this._packedU32View=new Uint32Array(this._packed.buffer),this._dataView=new DataView(this._packed.buffer)}get attributeLayout(){return this._spec.attributeLayout}get stride(){return this._spec.stride}writeVertex(t,e,i,n,s,o){var a;for(let c=0;c<this._spec.packVertexCount;c++){const u=c*this._spec.stride;this._packPosition(i,n,u),this._packId(e,u);const l=this._spec.bitset;if(o){if(l.packTessellation){const h=l.packTessellation(o,s);this._pack(h,l,u)}for(const h of this._spec.standardAttributes)if(h.packTessellation!=null){const f=h.packTessellation(o,s);this._pack(f,h,u)}else if((a=h.packAlternating)!=null&&a.packTessellation){const f=h.packAlternating.packTessellation(o,s);for(let p=0;p<this._spec.packVertexCount;p++){const y=f[p];this._pack(y,h,p*this._spec.stride)}}}}t.vertexWriteRegion(this._packedU32View)}pack(t,e){var i;for(const n of this._spec.standardAttributes)if(n.pack&&typeof n.pack!="string"){const s=n.pack(t,e);for(let o=0;o<this._spec.packVertexCount;o++)this._pack(s,n,o*this._spec.stride)}else if((i=n.packAlternating)!=null&&i.pack){const s=n.packAlternating.pack(t,e);for(let o=0;o<this._spec.packVertexCount;o++){const a=s[o];this._pack(a,n,o*this._spec.stride)}}}_packPosition(t,e,i){const{offset:n}=this._spec.position,s=this._spec.position.packPrecisionFactor??1,o=ds(t*s,e*s);this._dataView.setUint32(i+n,o,!0)}_packId(t,e){const i=t*(this._spec.id.packPrecisionFactor??1),n=4278190080&this._dataView.getUint32(e+this._spec.id.offset,!0);this._dataView.setUint32(e+this._spec.id.offset,i|n,!0)}_pack(t,e,i){hs(this._dataView,t,e,i)}};function io(r){if(!r)return!1;for(const t of r)switch(t.effect.type){case"CIMGeometricEffectBuffer":case"CIMGeometricEffectOffset":case"CIMGeometricEffectDonut":return!0}return!1}let Gt=class{constructor(t,e,i,n){this._instanceId=t,this._evaluator=e,this._viewParams=i,this._optionalAttributes=n,this._evaluator.evaluator=s=>this.vertexSpec.createComputedParams(s)}get _vertexPack(){if(!this._cachedVertexPack){const t=ro.fromVertexSpec(this.vertexSpec,this._optionalAttributes);this._evaluator.hasDynamicProperties||t.pack(this._evaluator.evaluatedMeshParams,this._viewParams),this._cachedVertexPack=t}return this._cachedVertexPack}get evaluatedMeshParams(){return this._evaluator.evaluatedMeshParams}get hasEffects(){return!!this.evaluatedMeshParams.effects}get instanceId(){return this._instanceId}get attributeLayout(){return this._vertexPack.attributeLayout}setReferences(t){this._references=t}getBoundsInfo(){return null}getTileInfo(){return this._viewParams.tileInfo}async loadDependencies(){var t;io((t=this._evaluator.inputMeshParams.params.effects)==null?void 0:t.effectInfos)&&await Js()}enqueueRequest(t,e,i){this._evaluator.hasDynamicProperties&&this._evaluator.enqueueRequest(t,e,i)}write(t,e,i,n,s){var p;this.ensurePacked(e,i,n);const o=this.evaluatedMeshParams.effects;if(!o||o.length===0)return void this._write(t,i,void 0,s);const a=(p=i.readGeometryForDisplay())==null?void 0:p.clone();if(!a)return;const c=pt.fromOptimizedCIM(a,i.geometryType),u=Zr();c.invertY();const l=t.id||"",h=Qs.executeEffects(o,c,l,u);let f;for(;f=h.next();)f.invertY(),this._write(t,i,f,s)}ensurePacked(t,e,i){if(!this._evaluator.hasDynamicProperties)return;const n=this._evaluator.evaluateMeshParams(t,e,i);this._vertexPack.pack(n,this._viewParams)}_writeVertex(t,e,i,n,s){const o=this.evaluatedMeshParams;this._vertexPack.writeVertex(t,e,i,n,o,s)}};const no=100,so=Yr("featurelayer-fast-triangulation-enabled");let tn=class extends Gt{async loadDependencies(){await Promise.all([super.loadDependencies(),Zn()])}_write(t,e,i){const n=(i==null?void 0:i.asOptimized())??e.readGeometryForDisplay(),s=this._clip(n);s&&(t.recordStart(this.instanceId,this.attributeLayout),this._writeGeometry(t,e,s),t.recordEnd())}_clip(t){if(!t)return null;const e=this.hasEffects;return qs(t,e?256:8)}_writeGeometry(t,e,i){const n=i.maxLength>no,s=[],o=this.createTesselationParams(e);if(!n&&so&&Hs(s,i))return void(s.length&&this._writeVertices(t,e,i.coords,o,s));const a=Xs(i);this._writeVertices(t,e,a,o)}_writeVertices(t,e,i,n,s){const o=e.getDisplayId(),a=t.vertexCount(),c=this.hasEffects;let u=0;if(s)for(const l of s){const h=i[2*l],f=i[2*l+1];c&&t.recordBounds(h,f,0,0),this._writeVertex(t,o,h,f,n),u++}else for(let l=0;l<i.length;l+=2){const h=Math.round(i[l]),f=Math.round(i[l+1]);c&&t.recordBounds(h,f,0,0),this._writeVertex(t,o,h,f,n),u++}t.indexEnsureSize(u);for(let l=0;l<u;l++)t.indexWrite(l+a)}};const oo={createComputedParams:r=>r,attributes:{id:{type:g.UNSIGNED_BYTE,count:3,pack:"id"},bitset:{type:g.UNSIGNED_BYTE,count:1},pos:{type:g.SHORT,count:2,pack:"position",packPrecisionFactor:10},inverseArea:{type:g.FLOAT,count:1,packTessellation:({inverseArea:r})=>r}}};let ao=class extends tn{constructor(){super(...arguments),this.vertexSpec=oo}createTesselationParams(t){return{inverseArea:1/t.readGeometryArea()}}};const co=()=>je.getLogger("esri.views.2d.engine.webgl.shaderGraph.techniques.meshWriterUtils"),uo=0,lo=100;function de(r,t){return[!!(r!=null&&r.minScale)&&t.scaleToZoom(r.minScale)||uo,!!(r!=null&&r.maxScale)&&t.scaleToZoom(r.maxScale)||lo]}function Ht(r){return 1<<r}function pe(r){let t=0;for(const[e,i]of r)i&&(t|=1<<e);return t}function L(r){let t;if(!r)return[0,0,0,0];if(typeof r=="string"){const o=fs.fromString(r);if(!o)return co().errorOnce(new Xr("mapview:mesh-processing","Unable to parse string into color",{color:r})),[0,0,0,0];t=o.toArray()}else t=r;const[e,i,n,s]=t;return[e*(s/255),i*(s/255),n*(s/255),s]}function ho(r){switch(r){case"butt":case sr.Butt:return or.BUTT;case"round":case sr.Round:return or.ROUND;case"square":case sr.Square:return or.SQUARE}}function po(r){switch(r){case"bevel":case ar.Bevel:return cr.BEVEL;case"miter":case ar.Miter:return cr.MITER;case"round":case ar.Round:return cr.ROUND}}function ur(r,t){return Math.round(Math.min(Math.sqrt(r*t),255))}function _e(r,t){return Math.round(r*t)/t}function $i(r,t){return Math.ceil(r*t)/t}const en={createComputedParams:r=>r,attributes:{id:{type:g.UNSIGNED_BYTE,count:3,pack:"id"},bitset:{type:g.UNSIGNED_BYTE,count:1},pos:{type:g.SHORT,count:2,pack:"position",packPrecisionFactor:10},zoomRange:{type:g.SHORT,count:2,packPrecisionFactor:Ke,pack:({scaleInfo:r},{tileInfo:t})=>de(r,t)},color:{type:g.UNSIGNED_BYTE,count:4,normalized:!0,pack:({color:r})=>L(r)}}};let qr=class extends tn{constructor(){super(...arguments),this.vertexSpec=en}createTesselationParams(t){return null}};const Qe={createComputedParams:r=>r,attributes:{...en.attributes,tlbr:{count:4,type:g.UNSIGNED_SHORT,pack:({sprite:r})=>{const{rect:t,width:e,height:i}=r,n=t.x+Vt,s=t.y+Vt;return[n,s,n+e,s+i]}},inverseRasterizationScale:{count:1,type:g.BYTE,packPrecisionFactor:16,pack:({sprite:r})=>1/r.rasterizationScale}}};let rn=class extends qr{constructor(){super(...arguments),this.vertexSpec=Qe}_write(t,e,i){var a;const n=(i==null?void 0:i.asOptimized())??e.readGeometryForDisplay(),s=this._clip(n);if(!s)return;const o=(a=this.evaluatedMeshParams.sprite)==null?void 0:a.textureBinding;t.recordStart(this.instanceId,this.attributeLayout,o),this._writeGeometry(t,e,s),t.recordEnd()}};var Si;(function(r){r[r.Geographic=0]="Geographic",r[r.Arithmatic=1]="Arithmatic"})(Si||(Si={}));const Qc=3.14159265359/180,fo=3.14159265359/128,Jc=1,mo=1.1,yo=1,tu=24,eu=8,go=1e-5,Pi=.05,xo=1e-30,Kr=4,jr=0,nn=2,sn=5,on=6,bo=2,vo=3,_o=0,wo=3,$o=16777216;function Qr(r){const{sprite:t,aspectRatio:e,scaleProportionally:i}=r,n=S(r.height),s=n>0?n:t.height;let o=n*e;return o<=0?o=t.width:i&&(o*=t.width/t.height),{width:o,height:s}}function an(r){const{applyRandomOffset:t,sampleAlphaOnly:e}=r,{width:i,height:n}=Qr(r);return pe([[nn,t],[Kr,e],[on,i<Ge],[sn,n<Ge]])}function cn(r){const{width:t}=Qr(r);return Math.round(t<Ge?t*Hr:t)}function un(r){const{height:t}=Qr(r);return Math.round(t<Ge?t*Hr:t)}const ln={createComputedParams:r=>r,attributes:{...Qe.attributes,bitset:{count:1,type:g.UNSIGNED_BYTE,pack:an},width:{count:1,type:g.UNSIGNED_SHORT,pack:cn},height:{count:1,type:g.UNSIGNED_SHORT,pack:un},offset:{count:2,type:g.SHORT,pack:({offsetX:r,offsetY:t})=>[S(r),-S(t)]},scale:{count:2,type:g.UNSIGNED_BYTE,packPrecisionFactor:16,pack:({scaleX:r,scaleY:t})=>[r,t]},angle:{count:1,type:g.UNSIGNED_BYTE,pack:({angle:r})=>Kn(r)}}};let So=class extends rn{constructor(){super(...arguments),this.vertexSpec=ln}},Po=class{constructor(){this.extrusionOffsetX=0,this.extrusionOffsetY=0,this.normalX=0,this.normalY=0,this.directionX=0,this.directionY=0,this.distance=0}};const Je={createComputedParams:r=>r,attributes:{id:{type:g.UNSIGNED_BYTE,count:3,pack:"id"},pos:{type:g.SHORT,count:2,pack:"position",packPrecisionFactor:10},bitset:{type:g.UNSIGNED_BYTE,count:1},zoomRange:{type:g.SHORT,count:2,packPrecisionFactor:Ke,pack:({scaleInfo:r},{tileInfo:t})=>de(r,t)},color:{type:g.UNSIGNED_BYTE,count:4,normalized:!0,pack:({color:r})=>L(r)},offset:{type:g.BYTE,count:2,packPrecisionFactor:16,packTessellation:({extrusionOffsetX:r,extrusionOffsetY:t})=>[_e(r,16),_e(t,16)]},normal:{type:g.BYTE,count:2,packPrecisionFactor:16,packTessellation:({normalX:r,normalY:t})=>[_e(r,16),_e(t,16)]},halfWidth:{type:g.UNSIGNED_SHORT,count:1,packPrecisionFactor:16,pack:({width:r})=>$i(S(.5*r),16)},referenceHalfWidth:{type:g.UNSIGNED_SHORT,count:1,packPrecisionFactor:16,pack:({referenceWidth:r})=>$i(S(.5*r),16)}}};let To=class{constructor(){this.id=0,this.bitset=0,this.indexCount=0,this.vertexCount=0,this.vertexFrom=0,this.vertexBounds=0}};const Ti=65535;let Jr=class extends Gt{constructor(t,e,i,n){super(t,e,i,n),this.vertexSpec=Je,this._currentWrite=new To,this._tessellationOptions={halfWidth:0,pixelCoordRatio:1,offset:0,wrapDistance:Ti,textured:!1},this._tessParams=new Po,this._initializeTessellator()}writeLineVertices(t,e,i){const n=this._getLines(e);n!=null&&this._writeVertices(t,i,n)}_initializeTessellator(){this._lineTessellator=new qn(this._writeTesselatedVertex.bind(this),this._writeTriangle.bind(this),!0)}_write(t,e,i){const n=i??pt.fromFeatureSetReaderCIM(e);n&&this._writeGeometry(t,e,n)}_writeGeometry(t,e,i,n){t.recordStart(this.instanceId,this.attributeLayout,n),this.writeLineVertices(t,i,e),t.recordEnd()}_getLines(t){const e=this.hasEffects;return Ks(t,e?256:16)}_writeVertices(t,e,i){const{_currentWrite:n,_tessellationOptions:s,evaluatedMeshParams:o}=this,{width:a,capType:c,joinType:u,miterLimit:l,hasSizeVV:h}=o,f=S(.5*a);s.halfWidth=f,s.capType=ho(c),s.joinType=po(u),s.miterLimit=l;const p=!h;n.out=t,n.id=e.getDisplayId(),n.vertexCount=0,n.indexCount=0,n.vertexFrom=t.vertexCount(),n.vertexBounds=p&&f<Qn?0:1;for(const{line:y,start:x}of i)s.initialDistance=x%Ti,this._lineTessellator.tessellate(y,s,p)}_writeTesselatedVertex(t,e,i,n,s,o,a,c,u,l,h){const{out:f,id:p,vertexBounds:y}=this._currentWrite;return this.hasEffects&&f.recordBounds(t,e,y,y),this._tessParams.extrusionOffsetX=a,this._tessParams.extrusionOffsetY=c,this._tessParams.normalX=u,this._tessParams.normalY=l,this._tessParams.directionX=s,this._tessParams.directionY=o,this._tessParams.distance=h,this._writeVertex(f,p,t,e,this._tessParams),this._currentWrite.vertexFrom+this._currentWrite.vertexCount++}_writeTriangle(t,e,i){const{out:n}=this._currentWrite;n.indexEnsureSize(3),n.indexWrite(t),n.indexWrite(e),n.indexWrite(i),this._currentWrite.indexCount+=3}};const hn={createComputedParams:r=>r,attributes:{...Je.attributes,bitset:{type:g.UNSIGNED_BYTE,count:1,pack:r=>0},color:{type:g.UNSIGNED_BYTE,count:4,normalized:!0,pack:({color:r})=>L(r)}}},ti={createComputedParams:r=>r,attributes:{...Je.attributes,bitset:{type:g.UNSIGNED_BYTE,count:1,pack:r=>pe([[jr,!0]])},color:{type:g.UNSIGNED_BYTE,count:4,normalized:!0,pack:({outlineColor:r})=>L(r)}}};let ei=class extends Jr{constructor(){super(...arguments),this.vertexSpec=ti}},ri=class extends qr{constructor(t,e,i,n){super(t,e,i,n),this.vertexSpec=hn,this._lineMeshWriter=this._createOutlineWriter(t,e,i,n)}_createOutlineWriter(t,e,i,n){return new ei(t,e,i,n)}_write(t,e,i){const n=(i==null?void 0:i.asOptimized())??e.readGeometryForDisplay(),s=this._clip(n);s&&(t.recordStart(this.instanceId,this.attributeLayout),this._writeGeometry(t,e,s),this._lineMeshWriter.writeLineVertices(t,pt.fromOptimizedCIM(s,"esriGeometryPolyline"),e),t.recordEnd())}ensurePacked(t,e,i){super.ensurePacked(t,e,i),this._lineMeshWriter.ensurePacked(t,e,i)}enqueueRequest(t,e,i){super.enqueueRequest(t,e,i),this._lineMeshWriter.enqueueRequest(t,e,i)}async loadDependencies(){await Promise.all([super.loadDependencies(),this._lineMeshWriter.loadDependencies()])}};const dn=()=>je.getLogger("esri.views.3d.webgl-engine.core.shaderModules.shaderBuilder");let pn=class{constructor(){this._includedModules=new Map}include(t,e){if(this._includedModules.has(t)){const i=this._includedModules.get(t);if(i!==e){dn().error("Trying to include shader module multiple times with different sets of options.");const n=new Set;for(const s of Object.keys(i))i[s]!==t[s]&&n.add(s);for(const s of Object.keys(t))i[s]!==t[s]&&n.add(s);n.forEach(s=>console.error(`  ${s}: current ${i[s]} new ${t[s]}`))}}else this._includedModules.set(t,e),t(this.builder,e)}},Io=class extends pn{constructor(){super(...arguments),this.vertex=new Ii,this.fragment=new Ii,this.attributes=new No,this.varyings=new Eo,this.extensions=new gr,this.constants=new fn}get fragmentUniforms(){return this.fragment.uniforms.entries}get builder(){return this}generate(t,e=!0){const i=this.extensions.generateSource(t),n=this.attributes.generateSource(t),s=this.varyings.generateSource(t),o=t==="vertex"?this.vertex:this.fragment,a=o.uniforms.generateSource(),c=o.code.generateSource(),u=t==="vertex"?Do:zo(e),l=this.constants.generateSource().concat(o.constants.generateSource());return`${e?"#version 300 es":""}
${i.join(`
`)}
${u}
${l.join(`
`)}
${a.join(`
`)}
${n.join(`
`)}
${s.join(`
`)}
${c.join(`
`)}`}generateBindPass(t){const e=new Map;this.vertex.uniforms.entries.forEach(s=>{const o=s.bind[be.Pass];o&&e.set(s.name,o)}),this.fragment.uniforms.entries.forEach(s=>{const o=s.bind[be.Pass];o&&e.set(s.name,o)});const i=Array.from(e.values()),n=i.length;return(s,o)=>{for(let a=0;a<n;++a)i[a](t,s,o)}}generateBindDraw(t){const e=new Map;this.vertex.uniforms.entries.forEach(s=>{const o=s.bind[be.Draw];o&&e.set(s.name,o)}),this.fragment.uniforms.entries.forEach(s=>{const o=s.bind[be.Draw];o&&e.set(s.name,o)});const i=Array.from(e.values()),n=i.length;return(s,o,a)=>{for(let c=0;c<n;++c)i[c](t,s,o,a)}}},ko=class{constructor(){this._entries=new Map}add(...t){for(const e of t)this._add(e)}get(t){return this._entries.get(t)}_add(t){if(t!=null){if(this._entries.has(t.name)&&!this._entries.get(t.name).equals(t))throw new Xr(`Duplicate uniform name ${t.name} for different uniform type`);this._entries.set(t.name,t)}else dn().error(`Trying to add null Uniform from ${new Error().stack}.`)}generateSource(){return Array.from(this._entries.values()).map(t=>t.arraySize!=null?`uniform ${t.type} ${t.name}[${t.arraySize}];`:`uniform ${t.type} ${t.name};`)}get entries(){return Array.from(this._entries.values())}},Mo=class{constructor(){this._entries=new Array}add(t){this._entries.push(t)}generateSource(){return this._entries}},Ii=class extends pn{constructor(){super(...arguments),this.uniforms=new ko,this.code=new Mo,this.constants=new fn}get builder(){return this}},No=class{constructor(){this._entries=new Array}add(t,e){this._entries.push([t,e])}generateSource(t){return t==="fragment"?[]:this._entries.map(e=>`in ${e[1]} ${e[0]};`)}},Eo=class{constructor(){this._entries=new Map}add(t,e){this._entries.has(t)&&bs(this._entries.get(t)===e),this._entries.set(t,e)}generateSource(t){const e=new Array;return this._entries.forEach((i,n)=>e.push(t==="vertex"?`out ${i} ${n};`:`in ${i} ${n};`)),e}},gr=class xr{constructor(){this._entries=new Set}add(t){this._entries.add(t)}generateSource(t){const e=t==="vertex"?xr.ALLOWLIST_VERTEX:xr.ALLOWLIST_FRAGMENT;return Array.from(this._entries).filter(i=>e.includes(i)).map(i=>`#extension ${i} : enable`)}};gr.ALLOWLIST_FRAGMENT=["GL_EXT_shader_texture_lod","GL_OES_standard_derivatives"],gr.ALLOWLIST_VERTEX=[];let fn=class N{constructor(){this._entries=new Set}add(t,e,i){let n="ERROR_CONSTRUCTOR_STRING";switch(e){case"float":n=N._numberToFloatStr(i);break;case"int":n=N._numberToIntStr(i);break;case"bool":n=i.toString();break;case"vec2":n=`vec2(${N._numberToFloatStr(i[0])},                            ${N._numberToFloatStr(i[1])})`;break;case"vec3":n=`vec3(${N._numberToFloatStr(i[0])},                            ${N._numberToFloatStr(i[1])},                            ${N._numberToFloatStr(i[2])})`;break;case"vec4":n=`vec4(${N._numberToFloatStr(i[0])},                            ${N._numberToFloatStr(i[1])},                            ${N._numberToFloatStr(i[2])},                            ${N._numberToFloatStr(i[3])})`;break;case"ivec2":n=`ivec2(${N._numberToIntStr(i[0])},                             ${N._numberToIntStr(i[1])})`;break;case"ivec3":n=`ivec3(${N._numberToIntStr(i[0])},                             ${N._numberToIntStr(i[1])},                             ${N._numberToIntStr(i[2])})`;break;case"ivec4":n=`ivec4(${N._numberToIntStr(i[0])},                             ${N._numberToIntStr(i[1])},                             ${N._numberToIntStr(i[2])},                             ${N._numberToIntStr(i[3])})`;break;case"mat2":case"mat3":case"mat4":n=`${e}(${Array.prototype.map.call(i,s=>N._numberToFloatStr(s)).join(", ")})`}return this._entries.add(`const ${e} ${t} = ${n};`),this}static _numberToIntStr(t){return t.toFixed(0)}static _numberToFloatStr(t){return Number.isInteger(t)?t.toFixed(1):t.toString()}generateSource(){return Array.from(this._entries)}};function zo(r=!0){return`#ifdef GL_FRAGMENT_PRECISION_HIGH
  precision highp float;
  precision highp sampler2D;
#else
  precision mediump float;
  precision mediump sampler2D;
#endif
${r?"out vec4 fragColor;":""}
`}const Do=`precision highp float;
precision highp sampler2D;`;function Fo(r){return r.split(" ").map((t,e)=>e>0?t.charAt(0).toUpperCase()+t.slice(1):t).join("")}function Bo(r,t){const e=[];for(e.push(t);e.length;){const i=e.pop();if(typeof i=="object"&&!r.has(i.uid)){r.add(i.uid);for(const n of i.children)e.push(n)}}}let kt=class br{constructor(){this.uid=br.NodeCount++,this._debugName=null,this._isMutable=!1,this.isImplicit=!1}get isMutable(){return this._isMutable}setMutable(){return this._isMutable=!0,this}setDebugName(t){return t=Fo(t),this._debugName=t,this.isImplicit&&this.children[0]instanceof br&&this.children[0].setDebugName(t),this}get debugInfo(){return{name:this._debugName??""}}cloneInto(t){t._debugName=this._debugName,t._isMutable=this._isMutable,t.isImplicit=this.isImplicit,t.uid=this.uid}};function b(r){return typeof r=="object"?r.clone():r}kt.NodeCount=0;let B=class extends kt{constructor(){super(...arguments),this.shaderType="primitive-node"}},Co=class mn extends kt{constructor(t){super(),this.child=t,this.shaderType="scope-node"}get children(){return[this.child]}clone(){const t=new mn(b(this.child));return this.cloneInto(t),t}},Oo=class yn extends kt{constructor(t,e,i){super(),this.property=t,this.target=e,this.returnType=i,this.shaderType="property-access-node"}get children(){const t=[this.target];return typeof this.property!="string"&&t.push(this.property),t}clone(){const t=new yn(this.property,b(this.target),this.returnType);return this.cloneInto(t),t}},Ro=class gn extends kt{constructor(t,e,i){super(),this.condition=t,this.ifTrue=e,this.ifFalse=i,this.shaderType="condition-node"}get children(){return[this.condition,this.ifTrue,this.ifFalse]}clone(){const t=b(this.ifTrue),e=this.ifFalse?b(this.ifFalse):null,i=new gn(this.condition,t,e);return this.cloneInto(i),i}},Vo=class xn extends kt{constructor(t,e,i,n){super(),this.captureList=t,this.returnType=e,this.generator=n,this.shaderType="block-node",i&&(this.subgraph=new Co(i))}get children(){return Object.keys(this.captureList).map(t=>this.captureList[t]).concat(this.subgraph??[])}clone(){const t={};for(const i in this.captureList)t[i]=b(this.captureList[i]);const e=new xn(t,this.returnType,this.subgraph?b(this.subgraph.child):this.subgraph,this.generator);return this.cloneInto(e),e}},Pt=class bn extends kt{constructor(t,e,i,n,s,o=!1){super(),this.token=t,this._children=e,this.isInfix=i,this.isPropertyAccess=n,this.returnType=s,this.isTernary=o,this.shaderType="function-node"}get children(){return this._children}clone(){const t=new bn(this.token,this._children.map(b),this.isInfix,this.isPropertyAccess,this.returnType,this.isTernary);return this.cloneInto(t),t}};var Jt,vr,_r,wr,$r,Sr,Pr,Tr,Ir,kr,Mr,Nr,Er,zr;function Lo(r){const t=[["float","vec2","vec3","vec4"],["int","ivec2","ivec3","ivec4"],["uint","uvec2","uvec3","uvec4"],["bool","bvec2","bvec3","bvec4"]];for(const e of t)if(e.includes(r))return e.map(i=>Wo[i]);throw new Error("Unable to find type family")}function vn(r){return new Proxy(r,{get(t,e){if(e==="constructor")return new Proxy(t.constructor,{construct:(i,n,s)=>vn(new i(...n))});if(e in t)return t[e];if(typeof e=="string"){const i=Lo(r.type);return X(r,e,i[e.length-1])}}})}function q(r){return new Proxy(r,{construct:(t,e,i)=>vn(new t(...e))})}function Ao(r){return new Proxy(r,{get(t,e){if(e in t)return t[e];if(typeof e=="string"){const i=parseInt(e,10);if(!isNaN(i))return X(r,`[${i}]`,r.elementType.constructor)}}})}function Go(r){return new Proxy(r,{construct:(t,e,i)=>Ao(new t(...e))})}let Dr=class extends Error{},rt=Jt=class extends B{constructor(r,t){super(),this.elementType=r,this.size=t,this.children=[],this.type="array"}clone(){const r=new Jt(this.elementType,this.size);return super.cloneInto(r),r}get(r){if(typeof r=="number"){const t=new gt(r);return t.isImplicit=!0,X(this,t,this.elementType.constructor)}return X(this,r,this.elementType.constructor)}last(){return this.get(this.size-1)}first(){return this.get(0)}findIndex(r,t,e){return Xo(this,r,t,e)}glslFindIndex(r,t,e){return Zo(this,r,t,e)}static ofType(r,t){const e={construct:(i,n)=>new Jt(new r,t)};return new Proxy(Jt,e)}};rt.type="array",rt=Jt=d([Go],rt);let at=class _n extends B{constructor(){super(...arguments),this.type="sampler2D",this.children=[]}clone(){const t=new _n;return t.children=this.children.map(b),super.cloneInto(t),t}};at.type="sampler2D";let m=class Ft extends B{constructor(t){super(),this.type="float",this.children=[t]}clone(){const t=new Ft(b(this.children[0]));return super.cloneInto(t),t}multiply(t){return bt(this,typeof t=="number"?C(t,Ft):t)}divide(t){return me(this,typeof t=="number"?C(t,Ft):t)}add(t){return Ut(this,typeof t=="number"?C(t,Ft):t)}subtract(t){return ye(this,typeof t=="number"?C(t,Ft):t)}};m.type="float";let T=vr=class extends B{constructor(r,t){super(),this.type="vec2",this.children=[r,t].filter(e=>e!=null)}clone(){const r=new vr(b(this.children[0]),b(this.children[1]));return super.cloneInto(r),r}get 0(){return X(this,"[0]",m)}get 1(){return X(this,"[1]",m)}get 2(){throw new Dr}get 3(){throw new Dr}multiply(r){return bt(this,typeof r=="number"?C(r,m):r)}divide(r){return me(this,typeof r=="number"?C(r,m):r)}add(r){return Ut(this,typeof r=="number"?C(r,m):r)}subtract(r){return ye(this,typeof r=="number"?C(r,m):r)}};T.type="vec2",T=vr=d([q],T);let R=_r=class extends B{constructor(r,t,e){super(),this.type="vec3",this.children=[r,t,e].filter(i=>i!=null)}get 0(){return X(this,"[0]",m)}get 1(){return X(this,"[1]",m)}get 2(){return X(this,"[2]",m)}get 3(){throw new Dr}clone(){const r=new _r(b(this.children[0]),b(this.children[1]),b(this.children[2]));return super.cloneInto(r),r}multiply(r){return bt(this,typeof r=="number"?C(r,m):r)}divide(r){return me(this,typeof r=="number"?C(r,m):r)}add(r){return Ut(this,typeof r=="number"?C(r,m):r)}subtract(r){return ye(this,typeof r=="number"?C(r,m):r)}};R.type="vec3",R=_r=d([q],R);let M=wr=class extends B{constructor(r,t,e,i){super(),this.type="vec4",this.children=[r,t,e,i].filter(n=>n!=null)}clone(){const r=new wr(b(this.children[0]),b(this.children[1]),b(this.children[2]),b(this.children[3]));return super.cloneInto(r),r}get 0(){return X(this,"[0]",m)}get 1(){return X(this,"[1]",m)}get 2(){return X(this,"[2]",m)}get 3(){return X(this,"[3]",m)}multiply(r){return bt(this,typeof r=="number"?C(r,m):r)}divide(r){return me(this,typeof r=="number"?C(r,m):r)}add(r){return Ut(this,typeof r=="number"?C(r,m):r)}subtract(r){return ye(this,typeof r=="number"?C(r,m):r)}};M.type="vec4",M=wr=d([q],M);let Ne=$r=class extends B{constructor(r){super(),this.type="uint",this.children=[r]}clone(){const r=new $r(b(this.children[0]));return super.cloneInto(r),r}};Ne.type="uint",Ne=$r=d([q],Ne);let Ee=Sr=class extends B{constructor(r,t){super(),this.type="uvec2",this.children=[r,t].filter(e=>e!=null)}clone(){const r=new Sr(b(this.children[0]),b(this.children[1]));return super.cloneInto(r),r}};Ee.type="uvec2",Ee=Sr=d([q],Ee);let ze=Pr=class extends B{constructor(r,t,e){super(),this.type="uvec3",this.children=[r,t,e].filter(i=>i!=null)}clone(){const r=new Pr(b(this.children[0]),b(this.children[1]),b(this.children[2]));return super.cloneInto(r),r}};ze.type="uvec3",ze=Pr=d([q],ze);let De=Tr=class extends B{constructor(r,t,e,i){super(),this.type="uvec4",this.children=[r,t,e,i].filter(n=>n!=null)}clone(){const r=new Tr(b(this.children[0]),b(this.children[1]),b(this.children[2]),b(this.children[3]));return super.cloneInto(r),r}};De.type="uvec4",De=Tr=d([q],De);class H extends B{constructor(t){super(),this.type="bool",this.children=[t]}and(t){return Br(this,t)}or(t){return Sn(this,t)}clone(){const t=new H(b(this.children[0]));return super.cloneInto(t),t}}H.type="bool";let Fe=Ir=class extends B{constructor(r,t){super(),this.type="bvec2",this.children=[r,t].filter(e=>e!=null)}all(){return si(this)}any(){return oi(this)}clone(){const r=new Ir(b(this.children[0]),b(this.children[1]));return super.cloneInto(r),r}};Fe.type="bvec2",Fe=Ir=d([q],Fe);let Be=kr=class extends B{constructor(r,t,e){super(),this.type="bvec3",this.children=[r,t,e].filter(i=>i!=null)}all(){return si(this)}any(){return oi(this)}clone(){const r=new kr(b(this.children[0]),b(this.children[1]),b(this.children[2]));return super.cloneInto(r),r}};function C(r,t){return typeof r=="number"?new t(r):r}Be.type="bvec3",Be=kr=d([q],Be);let Ce=Mr=class extends B{constructor(r,t,e,i){super(),this.type="bvec4",this.children=[r,t,e,i].filter(n=>n!=null)}all(){return si(this)}any(){return oi(this)}clone(){const r=new Mr(b(this.children[0]),b(this.children[1]),b(this.children[2]),b(this.children[3]));return super.cloneInto(r),r}};Ce.type="bvec4",Ce=Mr=d([q],Ce);let gt=class Bt extends B{constructor(t){super(),this.type="int",this.children=[t]}multiply(t){return bt(this,C(t,Bt))}add(t){return Ut(this,C(t,Bt))}subtract(t){return ye(this,C(t,Bt))}divide(t){return me(this,C(t,Bt))}clone(){const t=new Bt(b(this.children[0]));return super.cloneInto(t),t}};gt.type="int";let Oe=Nr=class extends B{constructor(r,t){super(),this.type="ivec2",this.children=[r,t].filter(e=>e!=null)}clone(){const r=new Nr(b(this.children[0]),b(this.children[1]));return super.cloneInto(r),r}};Oe.type="ivec2",Oe=Nr=d([q],Oe);let Re=Er=class extends B{constructor(r,t,e){super(),this.type="ivec3",this.children=[r,t,e].filter(i=>i!=null)}clone(){const r=new Er(b(this.children[0]),b(this.children[1]),b(this.children[2]));return super.cloneInto(r),r}};Re.type="ivec3",Re=Er=d([q],Re);let Ve=zr=class extends B{constructor(r,t,e,i){super(),this.type="ivec4",this.children=[r,t,e,i].filter(n=>n!=null)}clone(){const r=new zr(b(this.children[0]),b(this.children[1]),b(this.children[2]),b(this.children[3]));return super.cloneInto(r),r}};Ve.type="ivec4",Ve=zr=d([q],Ve);let Uo=class wn extends B{constructor(t,e,i,n){super(),this.type="mat2",this.children=[t,e,i,n]}clone(){const t=new wn(b(this.children[0]),b(this.children[1]),b(this.children[2]),b(this.children[3]));return super.cloneInto(t),t}};Uo.type="mat2";class Y extends B{static identity(){return new Y(1,0,0,0,1,0,0,0,1)}static fromRotation(t){const e=ui(t),i=Pn(t);return new Y(i,e,0,We(e),i,0,0,0,1)}constructor(t,e,i,n,s,o,a,c,u){super(),this.type="mat3",this.children=[t,e,i,n,s,o,a,c,u]}add(t){return Ut(this,t)}multiply(t){return bt(this,t)}clone(){const t=new Y(b(this.children[0]),b(this.children[1]),b(this.children[2]),b(this.children[3]),b(this.children[4]),b(this.children[5]),b(this.children[6]),b(this.children[7]),b(this.children[8]));return super.cloneInto(t),t}}Y.type="mat3";class re extends B{static identity(){return new re(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1)}constructor(t,e,i,n,s,o,a,c,u,l,h,f,p,y,x,v){super(),this.type="mat4",this.children=[t,e,i,n,s,o,a,c,u,l,h,f,p,y,x,v]}static fromColumns(t,e,i,n){return new re(t.x,t.y,t.z,t.w,e.x,e.y,e.z,e.w,i.x,i.y,i.z,i.w,n.x,n.y,n.z,n.w)}multiply(t){return bt(this,t)}clone(){const t=new re(b(this.children[0]),b(this.children[1]),b(this.children[2]),b(this.children[3]),b(this.children[4]),b(this.children[5]),b(this.children[6]),b(this.children[7]),b(this.children[8]),b(this.children[9]),b(this.children[10]),b(this.children[11]),b(this.children[12]),b(this.children[13]),b(this.children[14]),b(this.children[15]));return super.cloneInto(t),t}}re.type="mat4";const Wo={float:m,vec2:T,vec3:R,vec4:M,int:gt,ivec2:Oe,ivec3:Re,ivec4:Ve,uint:Ne,uvec2:Ee,uvec3:ze,uvec4:De,bool:H,bvec2:Fe,bvec3:Be,bvec4:Ce},Et=(...r)=>new gt(...r),E=(...r)=>new m(...r),Fr=(...r)=>new T(...r),Yo=(...r)=>new R(...r),Ho=(...r)=>new M(...r),ki=(...r)=>new Y(...r);function X(r,t,e){const i=new e(new Oo(t,r,e));return i.isImplicit=!0,i}function K(r,t,e,i=null){if(i){const s=new i,o=new i(new Pt(r,[t,e],!0,!1,s));return o.isImplicit=!0,o}if(t.type==="float"||t.type==="int"){const s=new e.constructor(new Pt(r,[t,e],!0,!1,e.constructor));return s.isImplicit=!0,s}if((t.type==="mat2"||t.type==="mat3"||t.type==="mat4")&&e.type!=="float"){const s=new e.constructor(new Pt(r,[t,e],!0,!1,e.constructor));return s.isImplicit=!0,s}const n=new t.constructor(new Pt(r,[t,e],!0,!1,t.constructor));return n.isImplicit=!0,n}function J(r,t,e=t.constructor){const i=new e(new Pt(r,[t],!1,!1,e));return i.isImplicit=!0,i}function Mt(r,t,e,i=t.constructor){const n=new i(new Pt(r,[t,e],!1,!1,i));return n.isImplicit=!0,n}function ii(r,t,e,i,n=t.constructor){const s=new n(new Pt(r,[t,e,i],!1,!1,n));return s.isImplicit=!0,s}function We(r){return bt(r,E(-1))}function $n(r,t,e,i){return new t(new Vo(r,t,e,i))}function Xo(r,t,e=0,i=r.size){const n=new gt(e).setMutable().setDebugName("FindIndexIterator"),s=t(r.get(n)).setDebugName("FindIndexPredicate");return $n({iter:n},gt,s,({out:a,iter:c,subgraph:u})=>`
${a} = -1;

for (; ${c} < ${i}; ${c}++) {

${u.body}

  if (${u.varName}) {
    ${a} = ${c};
    break;
  }

}
`).setDebugName("FindIndexBlock")}function Zo(r,t,e=0,i=r.size){return $n({array:r},gt,null,({out:s,array:o})=>`
${s} = -1;
for (int i = ${e}; i < ${i}; i++) {
  bool condition;
  ${t({array:o,i:"i",out:"condition"})}
  if (condition) {
    ${s} = i;
    break;
  }
}
`).setDebugName("GlslFindIndexBlock")}function V(r,t,e){const i=typeof t=="function"?t():t,n=typeof e=="function"?e():e,s=new i.constructor(new Ro(r,i,n));return s.isImplicit=!0,s}function fe(...r){const t=r.map(([a,c])=>typeof c=="function"?[a,c()]:[a,c]),e=t[0][1].constructor,i=t.findIndex(a=>a[0]===!0);if(i===-1)throw new Error("A cond must have a fallthrough case with `true`/; ");const n=t.slice(0,i),s=t[i][1],o=new e(n.reduceRight((a,c)=>V(c[0],c[1],a),s));return o.isImplicit=!0,o}function bt(r,t){return K("*",r,t)}function me(r,t){return K("/",r,t)}function Ut(r,t){return K("+",r,t)}function ye(r,t){return K("-",r,t)}function gu(r,t){return K(">>",r,t)}function xu(r,t){return K("&",r,t)}function ni(r,t){return K("==",r,t,H)}function qo(r,t){return K("<",r,t,H)}function tr(r,t){return K("<=",r,t,H)}function Z(r,t){return K(">",r,t,H)}function er(r,t){return K(">=",r,t,H)}function Sn(...r){return r.length<=1?r[0]:r.slice(1).reduce((t,e)=>Ko(t,e),r[0])}function Ko(r,t){return K("||",r,t,H)}function Br(...r){return r.length<=1?r[0]:r.slice(1).reduce((t,e)=>jo(t,e),r[0])}function jo(r,t){return K("&&",r,t,H)}function Qo(r){return J("abs",r)}function si(r){return J("all",r,H)}function oi(r){return J("any",r,H)}function Jo(r){return J("ceil",r)}function ai(r,t,e){return ii("clamp",r,t,e,r.constructor)}function Pn(r){return J("cos",r)}function Tn(r,t){return Mt("distance",r,t,m)}function ci(r,t){return Mt("dot",r,t,m)}function ta(r){return J("floor",r)}function In(r){return J("fract",r)}function kn(r){return J("length",r,m)}function Rt(r,t){return Mt("max",r,t)}function Cr(r,t){return Mt("min",r,t)}function Nt(r,t,e){return ii("mix",r,t,e)}function Wt(r,t){return Mt("mod",r,t)}function ea(r){return J("normalize",r)}function ra(r){return r.type==="bool"?J("!",r):J("not",r)}function ui(r){return J("sin",r)}function bu(r,t,e){return ii("smoothstep",r,t,e)}function yt(r,t){return Mt("step",r,t,t.constructor)}function ct(r,t){return Mt("texture2D",r,t,M)}const Xt=5;function A(r,t,e){const i=t.split(`
`);for(const n of i)if(n.trim().length){{let s="";e!=null&&(s+=`/*id:${e??"000"}*/   `),r.body+=s.padEnd(14)}r.body+=" ".repeat(r.indent)+n+`
`}}let Mi=class{write(t){for(const e of t.rootOutputNodes())t.shouldPruneOutputNode(e)||(e.variableName=this._write(t,e.node));return t}_createVarName(t,e){let i="";return typeof e!="boolean"&&typeof e!="number"&&e.debugInfo.name&&(i=`${e.debugInfo.name}_`),`${i}v${t.varCount++}`}_write(t,e,i=!1){if(typeof e=="number"||typeof e=="boolean")return e.toString();let n=t.getEmit(e);if(n)return n;switch(e.shaderType){case"scope-node":n=this._writeScopeNode(t,e);break;case"primitive-node":n=this._writePrimitveNode(t,e,i);break;case"function-node":n=this._writeFunctionNode(t,e);break;case"property-access-node":n=this._writePropertyAccessNode(t,e);break;case"text-node":n=e.text;break;case"block-node":n=this._writeBlockNode(t,e);break;case"condition-node":n=this._writeConditionNode(t,e)}return t.setEmit(e,n),n}_writeScopeNode(t,e){const i=new e.child.constructor;i.setDebugName(e.debugInfo.name);const n=this._write(t,i,!0);return A(t,`{ /*ScopeStart: ${e.uid} ${e.debugInfo.name}*/`),t.indent+=2,A(t,`${n} = ${this._write(t,e.child)};`),t.indent-=2,A(t,`} /*ScopeEnd: ${e.uid} ${e.debugInfo.name}*/`),n}_writeConditionNode(t,e){const i=new e.ifTrue.constructor,n=this._write(t,i,!0);A(t,`if (${this._write(t,e.condition)}) {`),t.indent+=2;const s=t.createSubgraphContext(),o=this._write(s,e.ifTrue);if(t.body+=s.body,o&&A(t,`${n} = ${o};`),t.indent-=2,A(t,"}"),e.ifFalse){A(t,"else {"),t.indent+=2;const a=t.createSubgraphContext(),c=this._write(a,e.ifFalse);t.body+=a.body,c&&A(t,`${n} = ${c};`),t.indent-=2,A(t,"}")}return n}_writeBlockNode(t,e){const{captureList:i,generator:n,returnType:s}=e,o={};for(const l in i){if(!i[l])continue;const h=this._write(t,i[l]);o[l]=h}const a=new s,c=this._write(t,a,!0);if(o.out=c,e.subgraph){const l=t.createSubgraphContext(),h=this._write(l,e.subgraph.child),f=l.body;o.subgraph={varName:h,body:f}}const u=n(o);return A(t,`{
`),t.indent+=2,A(t,u),t.indent-=2,A(t,`}
`),c}_writePropertyAccessNode(t,e){const i=this._write(t,e.target);return typeof e.property=="string"&&e.property.includes("[")?`${i}${e.property}`:typeof e.property!="string"?`${i}[${this._write(t,e.property)}]`:`${i}.${e.property}`}_writeFunctionNode(t,e){const i=e.returnType.type;if(e.isInfix){const[o,a]=e.children.map(u=>this._write(t,u)),c=this._createVarName(t,e);return A(t,`${i.padEnd(Xt)} ${c} = ${o} ${e.token} ${a};`,e.uid),c}const n=e.children.map(o=>this._write(t,o)).join(", "),s=this._createVarName(t,e);return A(t,`${i.padEnd(Xt)} ${s} = ${e.token}(${n});`,e.uid),s}_writePrimitveNode(t,e,i=!1){var u;const n=t.getInput(e);if(n)return n.isUsed=!0,n.variableName;const s=e.children.length===1&&((u=e.children[0])==null?void 0:u.type)===e.type;if(e.isImplicit||s)return this._write(t,e.children[0]);const o=this._createVarName(t,e);if(i)return A(t,`${e.type.padEnd(Xt)} ${o};`,e.uid),o;const a=!e.debugInfo.name&&!e.isMutable;if(a&&e.type==="float"&&typeof e.children[0]=="number")return Number.isInteger(e.children[0])?e.children[0].toFixed(1):e.children[0].toString();if(a&&e.type==="int"&&typeof e.children[0]=="number"&&Number.isInteger(e.children[0]))return e.children[0].toString();const c=e.children.map(l=>this._write(t,l)).join(", ");return e.type==="array"?(A(t,`${e.type.padEnd(Xt)} ${o} = [${c}];`,e.uid),o):a?`${e.type}(${c})`:(A(t,`${e.type.padEnd(Xt)} ${o} = ${e.type}(${c});`,e.uid),o)}},zt=class Mn{constructor(t,e,i){this.variableName=t,this.variableInputType=e,this.node=i,this.type="shader-input",this.isUsed=!1}clone(){return new Mn(this.variableName,this.variableInputType,b(this.node))}},Zt=class Nn{constructor(t,e,i){this.outVariableName=t,this.outVariableType=e,this.node=i,this.type="shader-output"}clone(){const t=new Nn(this.outVariableName,this.outVariableType,b(this.node));return t.variableName=this.variableName,t}},Ni=class Le{static createVertex(t,e,i,n,s,o){const a=[];for(const u in t){const l=t[u],h=i.get(u);h?a.push(new zt(h,"builtin",l)):a.push(new zt("a_"+u,"attribute",l))}for(const u of n){const l=u.uniformHydrated;a.push(new zt(u.uniformName,"uniform",l))}const c=[];for(const u in e){const l=e[u];u==="glPosition"?c.push(new Zt("gl_Position","builtin",l)):u==="glPointSize"?c.push(new Zt("gl_PointSize","builtin",l)):c.push(new Zt("v_"+u,"varying",l))}return new Le(a,c,s,o)}static createFragment(t,e,i,n,s,o){const a=[],c=Array.from(s.rootOutputNodes());for(const l in t){const h=t[l],f=i.get(l);if(f){a.push(new zt(f,"builtin",h));continue}const p=c.find(y=>y.node===h);p&&a.push(new zt(p.outVariableName,p.outVariableType,h))}for(const l of n){const h=l.uniformHydrated;a.push(new zt(l.uniformName,"uniform",h))}const u=[];for(const l in e){const h=e[l],f=i.get(l);if(l==="discard")u.push(new Zt(null,"discard",h));else{if(!f)throw new Error(`Member ${l} in shader fragment output shoule be tagged as builtin`);u.push(new Zt(f,"builtin",h))}}return new Le(a,u,o)}constructor(t,e,i,n){this.type="shader-graph-context",this.indent=0,this.body="",this.varCount=0,this._inputShaderTypesByNodeUid=new Map,this._nodeEmitMap=new Map;for(const s of t)this._inputShaderTypesByNodeUid.set(s.node.uid,s);this._outputShaderTypes=e,this._transformFeedbackBindings=i,this._transformFeedbackNames=new Set(i.map(s=>"v_"+s.propertyKey)),this._usedInFragmentShader=n}shouldPruneOutputNode(t){return!!this._usedInFragmentShader&&t.outVariableType!=="builtin"&&!this._transformFeedbackNames.has(t.outVariableName)&&!this._usedInFragmentShader.has(t.node.uid)}setEmit(t,e){this._nodeEmitMap.set(t.uid,e)}getEmit(t){return this._nodeEmitMap.get(t.uid)}inputs(){return this._inputShaderTypesByNodeUid.values()}getInput(t){return this._inputShaderTypesByNodeUid.get(t.uid)}*rootOutputNodes(){for(const t of this._outputShaderTypes)yield t}*nodes(){const t=[];for(const e of this._outputShaderTypes.values())t.push(e.node);for(;t.length;){const e=t.pop();typeof e!="number"&&typeof e!="boolean"&&t.push(...e.children.filter(Boolean)),yield e}}*nodesOfTypeOrFunction(){for(const t of this.nodes())typeof t!="number"&&typeof t!="boolean"&&(yield t)}createSubgraphContext(){const t=this.clone();return t.body="",t.indent=this.indent+2,t._nodeEmitMap=new Map(this._nodeEmitMap),t}clone(){const t=new Le([],this._outputShaderTypes,this._transformFeedbackBindings,this._usedInFragmentShader);return t._inputShaderTypesByNodeUid=this._inputShaderTypesByNodeUid,t.indent=this.indent,t.body=this.body,t.varCount=this.varCount,t._nodeEmitMap=this._nodeEmitMap,t}insertVertexShader(t){t.vertex.code.add(""),this._insertInputs(t,"vertex"),t.vertex.code.add(""),t.vertex.code.add("// OUTPUTS: "),t.vertex.code.add("// --------------------------------------------------------- ");for(const e of this.rootOutputNodes()){const i=e.outVariableType==="builtin";this.shouldPruneOutputNode(e)||(i?t.vertex.code.add(`// ${e.outVariableType.padEnd(7)} ${e.node.type.padEnd(9)} ${e.outVariableName};`):t.vertex.code.add(`${e.outVariableType.padEnd(10)} ${e.node.type.padEnd(9)} ${e.outVariableName};`))}t.vertex.code.add(""),t.vertex.code.add("void main() {"),t.vertex.code.add("  "+this.body.split(`
`).join(`
  `));for(const e of this.rootOutputNodes())this.shouldPruneOutputNode(e)||t.vertex.code.add(`  ${e.outVariableName} = ${e.variableName};`);t.vertex.code.add("}")}insertFragmentShader(t){this._insertInputs(t,"fragment"),t.fragment.code.add(""),t.fragment.code.add("void main() {"),t.fragment.code.add("  "+this.body.split(`
`).join(`
  `));for(const e of this.rootOutputNodes())e.outVariableType==="discard"?(t.fragment.code.add("  // TODO: Should ensure codegen for discard appears first in fragment shader"),t.fragment.code.add(`  if (${e.variableName}) {`),t.fragment.code.add("    discard;"),t.fragment.code.add("  }"),t.fragment.code.add("  ")):t.fragment.code.add(`  ${e.outVariableName} = ${e.variableName};`);t.fragment.code.add("}")}_insertInputs(t,e){t[e].code.add("// INPUTS: "),t[e].code.add("// --------------------------------------------------------- ");for(const i of this.inputs())i.isUsed&&i.variableInputType!=="builtin"&&(i.node.type==="array"?t[e].code.add(`${i.variableInputType.padEnd(10)} ${i.node.elementType.type.padEnd(9)} ${i.variableName}[${i.node.size}];`):t[e].code.add(`${i.variableInputType.padEnd(10)} ${i.node.type.padEnd(9)} ${i.variableName};`))}};const ia=()=>je.getLogger("esri.views.2d.engine.webgl.shaderGraph.typed.TypedShaderProgram");function qt(r,t,e){const i=t.length;if(i!==e){const n=new Xr("Invalid Uniform",`Invalid length, expected ${e} but got ${i}`,{uniformName:r,values:t});ia().errorOnce(n)}}let Ei=class{constructor(t,e,i,n,s,o){this._program=null,this._vao=null,this._temporaryTextures=[],this.vertexShader=t,this.fragmentShader=e,this._locations=i,this._locationInfo=n,this._uniformBindings=s,this._transformFeedbackBindings=o}destroy(){this._program&&this._program.dispose(),this.cleanupTemporaryTextures()}get locations(){return this._locations}get locationInfo(){return this._locationInfo}setUniforms(t){this._uniforms=t}cleanupTemporaryTextures(){for(const t of this._temporaryTextures)t.dispose();this._temporaryTextures=[]}bind(t){const e=this._uniforms;if(!this._program){const n=new Map;for(const[o,a]of this._locations)n.set(o,a);const s=[];for(const o of this._transformFeedbackBindings??[]){const{index:a,propertyKey:c}=o;s[a]=`v_${c}`}this._program=new vs(t,this.vertexShader,this.fragmentShader,n,new Map,s)}const i=this._program;t.useProgram(i);for(const n of this._uniformBindings){const{shaderModulePath:s,uniformName:o,uniformType:a,uniformArrayLength:c}=n,u=ms(s,e);if(u==null){if(a==="sampler2D")continue;throw new Error(`Failed to find uniform value for ${s}`)}switch(a==="array"?n.uniformArrayElementType:a){case"sampler2D":{const{unit:l,texture:h}=u;if(i.setUniform1i(o,l),"type"in h)t.bindTexture(h,l);else{const f=ps(t,h.descriptor,h.data);t.bindTexture(f,l)}break}case"int":if(!c){i.setUniform1i(o,u);break}qt(n.uniformName,u,c),i.setUniform1iv(o,u);break;case"float":if(!c){i.setUniform1f(o,u);break}qt(n.uniformName,u,c),i.setUniform1fv(o,u);break;case"vec2":if(!c){i.setUniform2f(o,u[0],u[1]);break}qt(n.uniformName,u,c),i.setUniform2fv(o,u.flat());break;case"vec3":if(!c){i.setUniform3f(o,u[0],u[1],u[2]);break}qt(n.uniformName,u,c),i.setUniform3fv(o,u.flat());break;case"vec4":if(!c){i.setUniform4f(o,u[0],u[1],u[2],u[3]);break}qt(n.uniformName,u,c),i.setUniform4fv(o,u.flat());break;case"mat3":i.setUniformMatrix3fv(o,u.flat());break;case"mat4":i.setUniformMatrix4fv(o,u.flat());break;default:throw new Error(`Unable to set uniform for type ${a}`)}}}};function Kt(r){return new r}function Yt(r,t,e){const i=r.constructor[t]??[];r.constructor.hasOwnProperty(t)||Object.defineProperty(r.constructor,t,{value:i.slice()}),r.constructor[t].push(e)}function P(r,t){return(e,i)=>{Yt(e,"locations",{typeCtor:t,propertyKey:i,parameterIndex:null,index:r})}}const na=r=>(t,e)=>{Yt(t,"builtins",{builtin:r,propertyKey:e})},F=r=>(t,e,i)=>{Yt(t,"inputs",{inputCtor:r,propertyKey:e,parameterIndex:i})},w=r=>(t,e)=>{Yt(t,"uniforms",{typeCtor:r,propertyKey:e})},U=r=>(t,e)=>{Yt(t,"options",{typeCtor:r,propertyKey:e})},zi=(r,t)=>{Yt(r,"defines",{propertyKey:t})},Or=(r,t)=>(e,i)=>{e.constructor.builtins.push({builtin:r,propertyKey:i,typeCtor:t})};let Rr=class{};Rr.builtins=[],d([Or("gl_VertexID",gt)],Rr.prototype,"glVertexID",void 0);let sa=class{},ie=class{};ie.builtins=[],d([Or("gl_FragCoord",M)],ie.prototype,"glFragCoord",void 0),d([Or("gl_PointCoord",T)],ie.prototype,"glPointCoord",void 0);let En=class{};d([na("gl_FragColor")],En.prototype,"glFragColor",void 0);let j=class{constructor(){this.type="uniform-group"}get _uniforms(){return this.constructor.uniforms??[]}},oa=class{constructor(){this.logShader=!1,this.computeAttributes={}}get vertexInput(){const t=nr(this._shaderModuleClass.inputs,e=>e.propertyKey==="vertex"&&e.parameterIndex===0);if(!t)throw new Error("Unable to find vertex input parameter");return t}get computeInput(){return nr(this._shaderModuleClass.inputs,t=>t.propertyKey==="vertex"&&t.parameterIndex===1)}get fragmentInput(){const t=nr(this._shaderModuleClass.inputs,e=>e.propertyKey==="fragment");if(!t)throw new Error("Unable to find fragment input parameter");return t}get transformFeedbackBindings(){return this.fragmentInput.inputCtor.transformFeedbackBindings??[]}get locations(){var t;return[...this.vertexInput.inputCtor.locations,...((t=this.computeInput)==null?void 0:t.inputCtor.locations)??[]]}get locationsMap(){const t=new Map,e=new Set;for(const i of this.locations)e.has(i.index)?je.getLogger("esri.views.2d.engine.webgl.shaderGraph.GraphShaderModule").warnOnce("mapview-rendering",`Unable to assigned attribute ${i.propertyKey} to ${i.index}. Index already in use`,{locationsMap:t}):(t.set(i.propertyKey,i.index),e.add(i.index));return t}get locationInfo(){if(!this._locationInfo){const t=this.locationsMap,e=Array.from(t.entries()).map(([n,s])=>`${n}.${s}`).join("."),i=ys(e);this._locationInfo={hash:i,locations:t}}return this._locationInfo}get renamedLocationsMap(){const t=new Map;for(const e of this.locations)t.set("a_"+e.propertyKey,e.index);return t}get optionPropertyKeys(){if(!this._optionPropertyKeys){const t=new Set;for(const e of this._options)t.add(e.propertyKey);this._optionPropertyKeys=t}return this._optionPropertyKeys}get _shaderModuleClass(){return this.constructor}get _defines(){return this._shaderModuleClass.defines??[]}get _options(){return this._shaderModuleClass.options??[]}get _uniforms(){return this._shaderModuleClass.uniforms??[]}getProgram(t,e,i,n){try{const{vertex:s,fragment:o,uniformBindings:a}=this._generateShaders(t,e,i,n);return new Ei(s,o,this.renamedLocationsMap,this.locationInfo,a,this.transformFeedbackBindings)}catch(s){return console.error("Failed to create program",{error:s}),new Ei("","",this.renamedLocationsMap,this.locationInfo,[],this.transformFeedbackBindings)}}getDebugUniformClassInfo(t){const e=this._options.find(n=>n.propertyKey===t);if(e)return{type:"option",className:e.typeCtor};const i=this._uniforms.find(n=>n.propertyKey===t);if(!i)throw new Error(`Unable to find uniform class type for property: ${t}`);return{type:"required",className:i.typeCtor}}getShaderKey(t,e,i,n){const s=Object.keys(i).map(c=>`${c}.${i[c]}`).join("."),o=Object.keys(n).map(c=>`${c}.${n[c]}`).join("."),a=Object.keys(e).filter(c=>this.optionPropertyKeys.has(c)&&e[c]).join(".");return`${this.constructor.name}.${t.hash}.${s}.${o}.${a}`}_generateShaders(t,e,i,n){const s=[];this._setDefines(i),this._setOptionalUniforms(s,e),this._setRequiredUniforms(s);const o=this._hydrateVertexInput(n),a=this._injectPackPrecisionFactor(o,t),c=this._hydrateComputeInput(),u=c&&this._injectPackPrecisionFactor(c,t),l=this.vertex(a,u),h=this._hydrateFragmentInput(l),f=this.fragment(h),p=new Set;for(const O in f){const k=f[O];Bo(p,k)}const y=this._getVertexInputBuiltins(),x=Ni.createVertex({...o,...c},l,y,s,this.transformFeedbackBindings,p);new Mi().write(x);const v=this._getFragmentInputBuiltins(f);v.set("glPointCoord","gl_PointCoord");const _=Ni.createFragment(h,f,v,s,x,this.transformFeedbackBindings);new Mi().write(_);const $=this._createShaderBuilder(x,_),I=$.generate("vertex",!1),z=$.generate("fragment",!1);return this.logShader&&(console.log(I),console.log(z)),{vertex:I,fragment:z,uniformBindings:s}}_setDefines(t){for(const e in t)this[e]=t[e]}_setOptionalUniforms(t,e){for(const i of this._options)e[i.propertyKey]?this[i.propertyKey]=this._hydrateUniformGroup(t,i):this[i.propertyKey]=null}_setRequiredUniforms(t){for(const e of this._uniforms)this[e.propertyKey]=this._hydrateUniformGroup(t,e)}_hydrateUniformGroup(t,e){const i=new e.typeCtor;for(const n of i._uniforms??[]){const s=Kt(n.typeCtor),o=`u_${e.propertyKey}_${n.propertyKey}`,a=s.type,c=[e.propertyKey,n.propertyKey].join(".");if("type"in n.typeCtor&&n.typeCtor.type==="array"){const u=s;t.push({shaderModulePath:c,uniformName:o,uniformType:a,uniformArrayLength:u.size,uniformArrayElementType:u.elementType.type,uniformHydrated:s})}else t.push({shaderModulePath:c,uniformName:o,uniformType:a,uniformHydrated:s});i[n.propertyKey]=s}return i}_hydrateVertexInput(t){const e=this.vertexInput.inputCtor,i=e.locations.reduce((n,s)=>t[s.propertyKey]===!1?n:{...n,[s.propertyKey]:Kt(s.typeCtor)},{});for(const{propertyKey:n,typeCtor:s}of e.builtins){const o=Kt(s);i[n]=o}return i}_hydrateComputeInput(){return this.computeInput==null?null:this.computeInput.inputCtor.locations.reduce((t,e)=>({...t,[e.propertyKey]:Kt(e.typeCtor)}),{})}_injectPackPrecisionFactor(t,e){const i={};for(const n in t){const s=t[n],o=e.attributes.find(a=>a.name===n);if(o!=null&&o.packPrecisionFactor){if(s.type!=="float"&&s.type!=="vec2"&&s.type!=="vec3"&&s.type!=="vec4")throw new Error(`InternalError: packPrecisionFactor requires GenType, but found ${s.type}`);i[n]=s.divide(new m(o.packPrecisionFactor))}else i[n]=s}return i}_hydrateFragmentInput(t){const e={};for(const i in t)e[i]=t[i];for(const{propertyKey:i,typeCtor:n}of ie.builtins){const s=Kt(n);e[i]=s}return e}_getVertexInputBuiltins(){const t=this.vertexInput.inputCtor,e=new Map;for(const{builtin:i,propertyKey:n}of t.builtins)e.set(n,i);return e}_getFragmentInputBuiltins(t){const e=t.constructor,i=new Map;for(const n of e.builtins??[])i.set(n.propertyKey,n.builtin);return i}_createShaderBuilder(t,e){const i=new Io;return this._insertDebugInfo(i),t.insertVertexShader(i),e.insertFragmentShader(i),i}_insertDebugInfo(t){t.vertex.code.add("// DEFINES: "),t.vertex.code.add("// --------------------------------------------------------- ");for(const e of this._defines)this[e.propertyKey]?t.vertex.code.add(`//   ${e.propertyKey}: true`):t.vertex.code.add(`//   ${e.propertyKey}: false`);t.vertex.code.add(""),t.vertex.code.add("// OPTIONS: "),t.vertex.code.add("// --------------------------------------------------------- ");for(const e of this._options)this[e.propertyKey]?t.vertex.code.add(`//   ${e.propertyKey}: true`):t.vertex.code.add(`//   ${e.propertyKey}: false`)}};function Di(r){const t=E(12.9898),e=E(78.233),i=E(43758.5453),n=ci(r,Fr(t,e)),s=Wt(n,E(3.14));return In(ui(s).multiply(i))}function It(r){return ni(r,E(xo))}function aa(r,t){return r.x.multiply(t.y).subtract(t.x.multiply(r.y))}function ca(r){return r.multiply(2).subtract(1)}function it(r,t){const e=E(2**t);return Wt(ta(r.divide(e)),E(2))}function ku(r,t){return Z(it(r,t),E(.5))}function lr(r,t){return it(r,t+Ui.length)}function ua(r,t){return it(r,t)}function la(r){const t=it(r.z,7),e=E(1).subtract(t),i=r.xyz.subtract(Yo(0,0,E(128)));return e.multiply(r).add(t.multiply(i))}function ha(r){const t=Ho(.99609375,.0038909912109375,1519918441772461e-20,59371814131736755e-24);return ci(r,t)}function Mu(r){return Rt(Rt(Rt(r.x,r.y),r.z),r.w)}let st=class extends j{getVisualVariableData(t){if(!this._vvData){const e=this.getAttributeDataCoords(t);this._vvData=ct(this.visualVariableData,e).setDebugName("storage2")}return this._vvData}getAttributeDataCoords(t){if(!this._uv){const e=la(t),i=this.size,n=Et(e.x),s=Et(e.y).multiply(Et(256)),o=Et(e.z).multiply(Et(256)).multiply(Et(256)),a=E(n.add(s).add(o)),c=Wt(a,i),u=a.subtract(c).divide(i);this._uv=new T(c,u).add(.5).divide(i)}return this._uv}getFilterData(t){const e=this.getAttributeDataCoords(t);return ct(this.filterFlags,e).setDebugName("storage0")}getAnimationData(t){const e=this.getAttributeDataCoords(t);return ct(this.animation,e).setDebugName("storage1")}getVVData(t){return this.getVisualVariableData(t)}getDataDrivenData0(t){const e=this.getAttributeDataCoords(t);return ct(this.dataDriven0,e).setDebugName("storage30")}getDataDrivenData1(t){const e=this.getAttributeDataCoords(t);return ct(this.dataDriven1,e).setDebugName("storage31")}getDataDrivenData2(t){const e=this.getAttributeDataCoords(t);return ct(this.dataDriven2,e).setDebugName("storage32")}getGPGPUData(t){const e=this.getAttributeDataCoords(t);return ct(this.gpgpu,e).setDebugName("storage4")}getFilterFlags(t){return Yr("webgl-ignores-sampler-precision")?Jo(this.getFilterData(t).x.multiply(E(255))):this.getFilterData(t).x.multiply(E(255))}getAnimationValue(t){return this.getAnimationData(t).x}getSizeValue(t){return this.getVisualVariableData(t).x}getColorValue(t){return this.getVisualVariableData(t).y}getOpacityValue(t){return this.getVisualVariableData(t).z}getRotationValue(t){return this.getVisualVariableData(t).w}};d([w(at)],st.prototype,"filterFlags",void 0),d([w(at)],st.prototype,"animation",void 0),d([w(at)],st.prototype,"gpgpu",void 0),d([w(at)],st.prototype,"visualVariableData",void 0),d([w(at)],st.prototype,"dataDriven0",void 0),d([w(at)],st.prototype,"dataDriven1",void 0),d([w(at)],st.prototype,"dataDriven2",void 0),d([w(m)],st.prototype,"size",void 0);let Vr=class extends j{};d([w(m)],Vr.prototype,"activeReasons",void 0),d([w(m)],Vr.prototype,"highlightAll",void 0);let te=class extends j{};d([w(T)],te.prototype,"position",void 0),d([w(m)],te.prototype,"distance",void 0),d([w(m)],te.prototype,"smallSymbolDistance",void 0),d([w(m)],te.prototype,"smallSymbolSizeThreshold",void 0);let W=class extends j{};d([w(Y)],W.prototype,"displayViewScreenMat3",void 0),d([w(Y)],W.prototype,"displayViewMat3",void 0),d([w(Y)],W.prototype,"displayMat3",void 0),d([w(Y)],W.prototype,"viewMat3",void 0),d([w(Y)],W.prototype,"tileMat3",void 0),d([w(m)],W.prototype,"displayZoomFactor",void 0),d([w(m)],W.prototype,"requiredZoomFactor",void 0),d([w(T)],W.prototype,"tileOffset",void 0),d([w(m)],W.prototype,"currentScale",void 0),d([w(m)],W.prototype,"currentZoom",void 0),d([w(m)],W.prototype,"metersPerSRUnit",void 0),d([w(m)],W.prototype,"rotation",void 0),d([w(m)],W.prototype,"pixelRatio",void 0);let Tt=class extends Rr{};d([P(0,R)],Tt.prototype,"id",void 0),d([P(1,m)],Tt.prototype,"bitset",void 0),d([P(2,T)],Tt.prototype,"pos",void 0);let dt=class extends sa{};d([P(14,T)],dt.prototype,"nextPos1",void 0),d([P(15,T)],dt.prototype,"nextPos2",void 0);let rr=class extends ie{},lt=class extends oa{clip(t,e){let i=new m(0);const n=this.storage.getFilterFlags(t);if(i=i.add(E(2).multiply(E(1).subtract(lr(n,0)))),this.inside?i=i.add(E(2).multiply(E(1).subtract(lr(n,1)))):this.outside?i=i.add(E(2).multiply(lr(n,1))):this.highlight&&(i=i.add(E(2).multiply(E(1).subtract(this._checkHighlight(n))))),e!=null){const s=new m(1).subtract(yt(e.x,this.view.currentZoom)),o=yt(e.y,this.view.currentZoom);i=i.add(new m(2).multiply(s.add(o)))}return i}getFragmentOutput(t,e,i=new m(1/255)){const n=new En;return n.glFragColor=this._maybeWriteHittest(e)??this._maybeHighlight(t,i)??t,n}_maybeHighlight(t,e){return this.highlight?new M(t.rgb,yt(e,t.a)):null}_checkHighlight(t){let e=this._checkHighlightBit(t,0);for(let i=1;i<Ui.length;i++)e=e.add(this._checkHighlightBit(t,i));return yt(new m(.1),e.add(this.highlight.highlightAll))}_checkHighlightBit(t,e){return ua(t,e).multiply(it(this.highlight.activeReasons,e))}maybeRunHittest(t,e,i){if(this.hittestRequest==null)return null;const n=this.hittest(t,e,i);let s=V(Z(n,this.hittestRequest.distance),new m(2),new m(0));const o=this.storage.getAttributeDataCoords(t.id),a=ca(o);s=s.add(this.clip(t.id,t.zoomRange));const c=new M(new m(1/255),0,0,0);return{glPointSize:new m(1),glPosition:new M(a,s,1),color:c}}_maybeWriteHittest(t){return this.hittestRequest!=null?t.color:null}};d([zi],lt.prototype,"inside",void 0),d([zi],lt.prototype,"outside",void 0),d([U(Vr)],lt.prototype,"highlight",void 0),d([w(st)],lt.prototype,"storage",void 0),d([w(W)],lt.prototype,"view",void 0),d([U(te)],lt.prototype,"hittestRequest",void 0);function da(r,t){return ci(r,ea(t))}function ne(r,t,e){const i=e.subtract(t),n=da(r.subtract(t),i),s=ai(n.divide(kn(i)),new m(0),new m(1));return Tn(r,t.add(s.multiply(e.subtract(t))))}function pa(r){const t=Qo(r);return yt(t.x.add(t.y).add(t.z),new m(1.05))}function fa(r,t,e,i){const n=new Y(e.x.multiply(i.y).subtract(i.x.multiply(e.y)),i.x.multiply(t.y).subtract(t.x.multiply(i.y)),t.x.multiply(e.y).subtract(e.x.multiply(t.y)),e.y.subtract(i.y),i.y.subtract(t.y),t.y.subtract(e.y),i.x.subtract(e.x),t.x.subtract(i.x),e.x.subtract(t.x)),s=t.x.multiply(e.y.subtract(i.y)),o=e.x.multiply(i.y.subtract(t.y)),a=i.x.multiply(t.y.subtract(e.y)),c=s.add(o).add(a);return new m(1).divide(c).multiply(n.multiply(new R(1,r)))}function ma(r,t,e,i){return ni(pa(fa(r,t,e,i)),new m(1))}function ya(r,t,e,i){const n=e.subtract(t),s=i.subtract(t),o=aa(n,s),a=Br(qo(o,new m(Pi)),Z(o,new m(-Pi)));return fe([Br(ra(a),ma(r.xy,t,e,i)),new m(-1)],[!0,()=>{const c=ne(r,t,e),u=ne(r,e,i),l=ne(r,i,t);return Cr(Cr(c,u),l)}])}function zn(r){return r.distance.add(1)}function li(r,t,e){const{viewMat3:i,tileMat3:n}=r.view,s=i.multiply(n),o=s.multiply(new R(t.pos,1)),a=s.multiply(new R(e.nextPos1,1)),c=s.multiply(new R(e.nextPos2,1));return ya(r.hittestRequest.position,o.xy,a.xy,c.xy)}function Ru(r,t,e){return Tn(r,e).subtract(t)}let ue=class extends j{getColor(t,e,i){return fe([Sn(It(t),i),e],[tr(t,this.values.first()),this.colors.first()],[er(t,this.values.last()),this.colors.last()],[!0,()=>{const n=this.values.findIndex(u=>Z(u,t)),s=this.values.get(n),o=n.subtract(1),a=this.values.get(o),c=t.subtract(a).divide(s.subtract(a));return Nt(this.colors.get(o),this.colors.get(n),c)}])}};d([w(rt.ofType(M,8))],ue.prototype,"colors",void 0),d([w(rt.ofType(m,8))],ue.prototype,"values",void 0);let le=class extends j{getOpacity(t){return fe([It(t),new m(1)],[tr(t,this.opacityValues.first()),this.opacities.first()],[er(t,this.opacityValues.last()),this.opacities.last()],[!0,()=>{const e=this.opacityValues.findIndex(a=>Z(a,t)),i=this.opacityValues.get(e),n=e.subtract(1),s=this.opacityValues.get(n),o=t.subtract(s).divide(i.subtract(s));return Nt(this.opacities.get(n),this.opacities.get(e),o)}])}};d([w(rt.ofType(m,8))],le.prototype,"opacities",void 0),d([w(rt.ofType(m,8))],le.prototype,"opacityValues",void 0);function Dn(r){return r.visualVariableSizeMinMaxValue!=null||r.visualVariableSizeScaleStops!=null||r.visualVariableSizeStops!=null||r.visualVariableSizeUnitValue!=null}function ga(r,t,e){var i,n,s,o;if(Dn(r)){const a=r.storage.getSizeValue(t);return((i=r.visualVariableSizeMinMaxValue)==null?void 0:i.getSize(a,e))??((n=r.visualVariableSizeScaleStops)==null?void 0:n.getSizeForViewScale(r.view.currentScale))??((s=r.visualVariableSizeStops)==null?void 0:s.getSize(a,e))??((o=r.visualVariableSizeUnitValue)==null?void 0:o.getSize(a,e))}return e}function hi(r,t,e,i=new H(!1)){if(r.visualVariableColor==null)return e;const n=r.storage.getColorValue(t);return r.visualVariableColor.getColor(n,e,i)}function di(r,t){if(r.visualVariableOpacity==null)return new m(1);const e=r.storage.getOpacityValue(t);return r.visualVariableOpacity.getOpacity(e)}function Au(r,t){if(r.visualVariableRotation==null)return Y.identity();const e=r.storage.getRotationValue(t);return r.visualVariableRotation.getVVRotationMat3(e)}let he=class extends Tt{};d([P(3,M)],he.prototype,"color",void 0),d([P(4,T)],he.prototype,"zoomRange",void 0);let Ot=class extends lt{constructor(){super(...arguments),this.computeAttributes={pos:["nextPos1","nextPos2"]}}vertex(t,e){const i=di(this,t.id),n=hi(this,t.id,t.color).multiply(i),s=this.view.displayViewScreenMat3.multiply(new R(t.pos.xy,1)),o=this.clip(t.id,t.zoomRange);return{glPosition:new M(s.xy,o,1),color:n,...this.maybeRunHittest(t,e,null)}}fragment(t){return this.getFragmentOutput(t.color,t,new m(0))}hittest(t,e){return li(this,t,e)}};d([U(ue)],Ot.prototype,"visualVariableColor",void 0),d([U(le)],Ot.prototype,"visualVariableOpacity",void 0),d([D(0,F(he)),D(1,F(dt))],Ot.prototype,"vertex",null),d([D(0,F(rr))],Ot.prototype,"fragment",null);let Lt=class extends j{getPatternOffsetAtTileOrigin(t,e=new m(0),i=new m(1)){const n=new T($o).divide(t);let s=t.multiply(In(this.maxIntsToLocalOrigin.multiply(n))).add(this.tileOffsetFromLocalOrigin).subtract(new m(.5).multiply(t));return s=new T(s.x.multiply(i).subtract(s.y.multiply(e)),s.x.multiply(e).add(s.y.multiply(i))),Wt(s,t)}};d([w(T)],Lt.prototype,"tileOffsetFromLocalOrigin",void 0),d([w(T)],Lt.prototype,"maxIntsToLocalOrigin",void 0);let At=class extends j{};d([w(T)],At.prototype,"size",void 0),d([w(at)],At.prototype,"texture",void 0);let wt=class extends he{};d([P(5,M)],wt.prototype,"tlbr",void 0),d([P(6,m)],wt.prototype,"width",void 0),d([P(7,m)],wt.prototype,"height",void 0),d([P(8,T)],wt.prototype,"offset",void 0),d([P(9,T)],wt.prototype,"scale",void 0),d([P(10,m)],wt.prototype,"angle",void 0);class xa extends rr{}function ba(r,t,e,i,n){const s=ni(it(n,nn),E(1)),o=ha(new M(r,0));return V(s,ki(i.divide(t.x),e.divide(t.y),0,We(e.divide(t.x)),i.divide(t.y),0,Di(Fr(o,0)),Di(Fr(0,o)),1),ki(i.divide(t.x),e.divide(t.y),0,We(e.divide(t.x)),i.divide(t.y),0,0,0,1))}function Fn(r,t){const e=Nt(new T(1),new T(1/Hr),new T(it(t.bitset,on),it(t.bitset,sn))),i=r.view.requiredZoomFactor,n=new T(t.width,t.height).multiply(e),s=n.multiply(t.scale).multiply(i),o=t.angle.multiply(fo),a=ui(o),c=Pn(o),u=ba(t.id,s,a,c,t.bitset),l=r.localTileOffset.getPatternOffsetAtTileOrigin(n,a,c),h=i.multiply(t.scale).multiply(t.offset.subtract(l)).divide(s),f=new R(t.pos,1),p=u.multiply(f).xy.subtract(h),y=t.tlbr.divide(r.mosaicInfo.size.xyxy);let x=it(t.bitset,Kr);return r.visualVariableColor!=null&&(x=V(It(r.storage.getColorValue(t.id)),new m(0),x)),{tileTextureCoord:p,tlbr:y,sampleAlphaOnly:x}}function Bn(r,t){const e=Wt(t.tileTextureCoord,new m(1)),i=Nt(t.tlbr.xy,t.tlbr.zw,e);let n=ct(r.mosaicInfo.texture,i);return n=V(Z(t.sampleAlphaOnly,new m(.5)),n.aaaa,n),t.color.multiply(n)}let we=class extends Ot{vertex(t,e){return{...super.vertex(t,e),...Fn(this,t)}}fragment(t){const e=Bn(this,t);return this.getFragmentOutput(e,t,new m(0))}};d([w(At)],we.prototype,"mosaicInfo",void 0),d([w(Lt)],we.prototype,"localTileOffset",void 0),d([D(0,F(wt)),D(1,F(dt))],we.prototype,"vertex",null),d([D(0,F(xa))],we.prototype,"fragment",null);let pi=class extends j{getSize(t,e){const i=this.minMaxValueAndSize.xy,n=this.minMaxValueAndSize.zw;return V(It(t),e,()=>{const s=t.subtract(i.x).divide(i.y.subtract(i.x)),o=ai(s,new m(0),new m(1));return n.x.add(o.multiply(n.y.subtract(n.x)))})}};d([w(M)],pi.prototype,"minMaxValueAndSize",void 0);let Ye=class extends j{getSizeForViewScale(t){return fe([tr(t,this.values.first()),this.sizes.first()],[er(t,this.values.last()),this.sizes.last()],[!0,()=>{const e=this.values.findIndex(a=>Z(a,t)),i=this.values.get(e),n=e.subtract(1),s=this.values.get(n),o=t.subtract(s).divide(i.subtract(s));return Nt(this.sizes.get(n),this.sizes.get(e),o)}])}};d([w(rt.ofType(m,8))],Ye.prototype,"sizes",void 0),d([w(rt.ofType(m,8))],Ye.prototype,"values",void 0);let He=class extends j{getSize(t,e){const i=fe([It(t),e],[tr(t,this.values.first()),this.sizes.first()],[er(t,this.values.last()),this.sizes.last()],[!0,()=>{const n=this.values.findIndex(u=>Z(u,t)),s=this.values.get(n),o=n.subtract(1),a=this.values.get(o),c=t.subtract(a).divide(s.subtract(a));return Nt(this.sizes.get(o),this.sizes.get(n),c)}]);return V(It(i),e,i)}};d([w(rt.ofType(m,8))],He.prototype,"sizes",void 0),d([w(rt.ofType(m,8))],He.prototype,"values",void 0);let fi=class extends j{getSize(t,e){return V(It(t),e,t.multiply(this.unitValueToPixelsRatio))}};d([w(m)],fi.prototype,"unitValueToPixelsRatio",void 0);class $t extends Tt{}d([P(3,M)],$t.prototype,"color",void 0),d([P(4,T)],$t.prototype,"offset",void 0),d([P(5,T)],$t.prototype,"normal",void 0),d([P(6,m)],$t.prototype,"halfWidth",void 0),d([P(7,m)],$t.prototype,"referenceHalfWidth",void 0),d([P(8,T)],$t.prototype,"zoomRange",void 0);let Cn=class extends rr{},Xe=class extends j{};function On(r){return Rt(new m(mo).multiply(yt(r,new m(yo))),new m(1))}function va(r,t){const{halfWidth:e,normal:i}=r,n=On(e),s=kn(i).multiply(e);return ai(n.multiply(e.subtract(s)).divide(t.add(n).subtract(new m(1))),new m(0),new m(1))}function _a(r,t){const{id:e,halfWidth:i,referenceHalfWidth:n}=t;if(Dn(r)){const s=new m(2).multiply(n),o=ga(r,e,s);return new m(.5).multiply(i.divide(Rt(n,new m(go)))).multiply(o)}return i}function Rn(r,t){const{id:e,offset:i,pos:n,normal:s,zoomRange:o}=t,{displayViewScreenMat3:a,displayViewMat3:c}=r.view,u=hi(r,e,t.color),l=di(r,e),h=_a(r,t),f=new m(.5).multiply(r.antialiasingControls.antialiasing),p=Rt(h.add(f),new m(.45)).add(new m(.1).multiply(f)),y=On(p).multiply(p).multiply(i),x=c.multiply(new R(y,new m(0))),v=a.multiply(new R(n,new m(1))).add(x),_=new m(2).multiply(yt(h,new m(0))).add(r.clip(e,o)),$=new M(v.xy,_,1);return{color:u,opacity:l,halfWidth:p,normal:s,scaledOffset:y,scaledHalfWidth:h,glPosition:new M($.xy,_,1)}}function ir(r,t){const{opacity:e,color:i}=r,n=va(r,t);return e.multiply(i).multiply(n)}d([w(m)],Xe.prototype,"antialiasing",void 0),d([w(m)],Xe.prototype,"blur",void 0);let nt=class extends lt{constructor(){super(...arguments),this.computeAttributes={pos:["nextPos1","nextPos2"]}}vertex(t,e){const i=Rn(this,t);return{...i,...this.maybeRunHittest(t,e,i.halfWidth)}}fragment(t){const e=ir(t,this.antialiasingControls.blur);return this.getFragmentOutput(e,t)}hittest(t,e,i){const{viewMat3:n,tileMat3:s}=this.view,o=n.multiply(s),a=o.multiply(new R(t.pos,1)),c=o.multiply(new R(e.nextPos1,1)),u=o.multiply(new R(e.nextPos2,1)),{distance:l,smallSymbolDistance:h,smallSymbolSizeThreshold:f}=this.hittestRequest,p=yt(i,f.multiply(.5)).multiply(l.subtract(h)),y=this.hittestRequest.position;return Cr(ne(y,a.xy,c.xy),ne(y,a.xy,u.xy)).subtract(i).add(p)}};d([w(Xe)],nt.prototype,"antialiasingControls",void 0),d([U(ue)],nt.prototype,"visualVariableColor",void 0),d([U(le)],nt.prototype,"visualVariableOpacity",void 0),d([U(pi)],nt.prototype,"visualVariableSizeMinMaxValue",void 0),d([U(Ye)],nt.prototype,"visualVariableSizeScaleStops",void 0),d([U(He)],nt.prototype,"visualVariableSizeStops",void 0),d([U(fi)],nt.prototype,"visualVariableSizeUnitValue",void 0),d([D(0,F($t)),D(1,F(dt))],nt.prototype,"vertex",null),d([D(0,F(Cn))],nt.prototype,"fragment",null);class ft extends Tt{}d([P(3,T)],ft.prototype,"offset",void 0),d([P(4,M)],ft.prototype,"color",void 0),d([P(5,T)],ft.prototype,"normal",void 0),d([P(6,m)],ft.prototype,"halfWidth",void 0),d([P(7,m)],ft.prototype,"referenceHalfWidth",void 0),d([P(8,T)],ft.prototype,"zoomRange",void 0);let Vn=class extends Cn{};function mi(r,t,e){const{id:i,bitset:n}=t,s=it(n,jr),o=Z(s,new m(.5)),a=Rn(r,t),c=V(o,a.halfWidth,new m(0)),u=di(r,i),l=hi(r,i,t.color),h=V(o,t.color,l.multiply(u)),f=r.view.displayViewScreenMat3.multiply(new R(t.pos.xy,1)),p=r.clip(t.id),y=new M(f.xy,p,1),x=V(o,a.glPosition,y),v=e&&r.maybeRunHittest(t,e,o);return{isOutline:s,color:h,opacity:new m(1),halfWidth:c,normal:a.normal,glPosition:x,...v}}let ut=class extends lt{constructor(){super(...arguments),this.computeAttributes={pos:["nextPos1","nextPos2"]}}};d([w(Xe)],ut.prototype,"antialiasingControls",void 0),d([U(ue)],ut.prototype,"visualVariableColor",void 0),d([U(le)],ut.prototype,"visualVariableOpacity",void 0),d([U(pi)],ut.prototype,"visualVariableSizeMinMaxValue",void 0),d([U(Ye)],ut.prototype,"visualVariableSizeScaleStops",void 0),d([U(He)],ut.prototype,"visualVariableSizeStops",void 0),d([U(fi)],ut.prototype,"visualVariableSizeUnitValue",void 0);class Lr extends ut{vertex(t,e){return mi(this,t,e)}fragment(t){const{color:e,isOutline:i}=t,n=Z(i,new m(.5)),s=ir(t,this.antialiasingControls.blur),o=V(n,s,e),a=V(n,new m(1/255),new m(0));return this.getFragmentOutput(o,t,a)}hittest(t,e,i){return V(i,zn(this.hittestRequest),li(this,t,e))}}d([D(0,F(ft)),D(1,F(dt))],Lr.prototype,"vertex",null),d([D(0,F(Vn))],Lr.prototype,"fragment",null);let Ar=class extends he{};d([P(5,M)],Ar.prototype,"tlbr",void 0),d([P(6,m)],Ar.prototype,"inverseRasterizationScale",void 0);let wa=class extends rr{};function $a(r){const t=new m(1),e=new m(0);return new Y(t.divide(r.x),e.divide(r.y),0,We(e.divide(r.x)),t.divide(r.y),0,0,0,1)}function Ln(r,t){const e=t.tlbr.xy,i=t.tlbr.zw,n=i.x.subtract(e.x),s=e.y.subtract(i.y),o=new T(n,s).multiply(t.inverseRasterizationScale),a=o.multiply(r.view.requiredZoomFactor),c=$a(a),u=r.localTileOffset.getPatternOffsetAtTileOrigin(o).divide(a),l=new R(t.pos,1);return{tileTextureCoord:c.multiply(l).xy.subtract(u),tlbr:t.tlbr.divide(r.mosaicInfo.size.xyxy)}}function An(r,t){const e=Wt(r.tileTextureCoord,new m(1)),i=Nt(r.tlbr.xy,r.tlbr.zw,e),n=ct(t.texture,i);return r.color.multiply(n)}let $e=class extends Ot{vertex(t,e){return{...super.vertex(t,e),...Ln(this,t)}}fragment(t){const e=An(t,this.mosaicInfo);return this.getFragmentOutput(e,t,new m(0))}};d([w(At)],$e.prototype,"mosaicInfo",void 0),d([w(Lt)],$e.prototype,"localTileOffset",void 0),d([D(0,F(Ar)),D(1,F(dt))],$e.prototype,"vertex",null),d([D(0,F(wa))],$e.prototype,"fragment",null);let Gr=class extends ft{};d([P(9,M)],Gr.prototype,"tlbr",void 0),d([P(10,m)],Gr.prototype,"inverseRasterizationScale",void 0);let Gn=class extends Vn{},Se=class extends Lr{vertex(t,e){return{...mi(this,t,e),...Ln(this,t)}}fragment(t){const{isOutline:e}=t,i=Z(e,new m(.5)),n=ir(t,this.antialiasingControls.blur),s=An(t,this.mosaicInfo),o=V(i,n,s),a=V(i,new m(1/255),new m(0));return this.getFragmentOutput(o,t,a)}};d([w(At)],Se.prototype,"mosaicInfo",void 0),d([w(Lt)],Se.prototype,"localTileOffset",void 0),d([D(0,F(Gr)),D(1,F(dt))],Se.prototype,"vertex",null),d([D(0,F(Gn))],Se.prototype,"fragment",null);const ht=16,jt=1/ht,Ur=128;class ot extends Tt{}d([P(3,M)],ot.prototype,"color",void 0),d([P(4,M)],ot.prototype,"tlbr",void 0),d([P(5,m)],ot.prototype,"angle",void 0),d([P(6,m)],ot.prototype,"aux1",void 0),d([P(7,m)],ot.prototype,"aux2",void 0),d([P(8,T)],ot.prototype,"aux3",void 0),d([P(9,T)],ot.prototype,"aux4",void 0),d([P(10,T)],ot.prototype,"zoomRange",void 0);let Sa=class extends Gn{};class Pe extends ut{vertex(t,e){const{aux1:i,aux2:n,aux3:s,aux4:o}=t,a={...t,width:i,height:n,offset:s,scale:o.multiply(jt)},c={...t,halfWidth:i.multiply(jt),referenceHalfWidth:n.multiply(jt),offset:s.multiply(jt),normal:o.subtract(Ur).multiply(jt)},u=mi(this,c),l=Fn(this,a),h=Z(u.isOutline,new m(.5));return{...u,...l,...this.maybeRunHittest(t,e,h)}}fragment(t){const{isOutline:e}=t,i=Z(e,new m(.5)),n=ir(t,this.antialiasingControls.blur),s=Bn(this,t),o=V(i,n,s),a=V(i,new m(1/255),new m(0));return this.getFragmentOutput(o,t,a)}hittest(t,e,i){return V(i,zn(this.hittestRequest),li(this,t,e))}}d([w(At)],Pe.prototype,"mosaicInfo",void 0),d([w(Lt)],Pe.prototype,"localTileOffset",void 0),d([D(0,F(ot)),D(1,F(dt))],Pe.prototype,"vertex",null),d([D(0,F(Sa))],Pe.prototype,"fragment",null);const et=ln.attributes,Pa=ti.attributes,Ta={createComputedParams:r=>r,attributes:{id:et.id,pos:et.pos,zoomRange:et.zoomRange,tlbr:et.tlbr,angle:et.angle,color:et.color,bitset:{type:g.UNSIGNED_BYTE,count:1,pack:r=>an(r)},aux1:{count:1,type:g.UNSIGNED_SHORT,pack:r=>cn(r)},aux2:{count:1,type:g.UNSIGNED_SHORT,pack:r=>un(r)},aux3:{count:2,type:g.SHORT,pack:({offsetX:r,offsetY:t})=>[S(r),S(t)]},aux4:{count:2,type:g.UNSIGNED_BYTE,pack:({scaleX:r,scaleY:t})=>[r*ht,t*ht]}}},Ia={createComputedParams:r=>r,attributes:{id:et.id,pos:et.pos,zoomRange:et.zoomRange,tlbr:et.tlbr,angle:et.angle,color:Pa.color,bitset:{type:g.UNSIGNED_BYTE,count:1,pack:r=>pe([[jr,!0]])},aux1:{count:1,type:g.UNSIGNED_SHORT,pack:r=>S(.5*r.width)*ht},aux2:{count:1,type:g.UNSIGNED_SHORT,pack:r=>S(.5*r.referenceWidth)*ht},aux3:{count:2,type:g.SHORT,packTessellation:({extrusionOffsetX:r,extrusionOffsetY:t})=>[r*ht,t*ht]},aux4:{count:2,type:g.UNSIGNED_BYTE,packTessellation:({normalX:r,normalY:t})=>[r*ht+Ur,t*ht+Ur]}}};let ka=class extends ei{constructor(){super(...arguments),this.vertexSpec=Ia}};class Ma extends ri{constructor(){super(...arguments),this.vertexSpec=Ta}_createOutlineWriter(t,e,i,n){return new ka(t,e,i,n)}_write(t,e,i){var a;const n=(i==null?void 0:i.asOptimized())??e.readGeometryForDisplay(),s=this._clip(n);if(!s)return;const o=(a=this.evaluatedMeshParams.sprite)==null?void 0:a.textureBinding;t.recordStart(this.instanceId,this.attributeLayout,o),this._writeGeometry(t,e,s),this._lineMeshWriter.writeLineVertices(t,pt.fromOptimizedCIM(s,"esriGeometryPolyline"),e),t.recordEnd()}ensurePacked(t,e,i){super.ensurePacked(t,e,i),this._lineMeshWriter.ensurePacked(t,e,i)}enqueueRequest(t,e,i){super.enqueueRequest(t,e,i),this._lineMeshWriter.enqueueRequest(t,e,i)}async loadDependencies(){await Promise.all([super.loadDependencies(),this._lineMeshWriter.loadDependencies()])}}const Na={createComputedParams:r=>r,attributes:{...Qe.attributes,...hn.attributes}},Ea={createComputedParams:r=>r,attributes:{...Qe.attributes,...ti.attributes}};let za=class extends ei{constructor(){super(...arguments),this.vertexSpec=Ea}},Da=class extends ri{constructor(){super(...arguments),this.vertexSpec=Na}_createOutlineWriter(t,e,i,n){return new za(t,e,i,n)}_write(t,e,i){var a;const n=(i==null?void 0:i.asOptimized())??e.readGeometryForDisplay(),s=this._clip(n);if(!s)return;const o=(a=this.evaluatedMeshParams.sprite)==null?void 0:a.textureBinding;t.recordStart(this.instanceId,this.attributeLayout,o),this._writeGeometry(t,e,s),this._lineMeshWriter.writeLineVertices(t,pt.fromOptimizedCIM(s,"esriGeometryPolyline"),e),t.recordEnd()}ensurePacked(t,e,i){super.ensurePacked(t,e,i),this._lineMeshWriter.ensurePacked(t,e,i)}enqueueRequest(t,e,i){super.enqueueRequest(t,e,i),this._lineMeshWriter.enqueueRequest(t,e,i)}async loadDependencies(){await Promise.all([super.loadDependencies(),this._lineMeshWriter.loadDependencies()])}};const Fa={createComputedParams:r=>r,attributes:{pos:{type:g.SHORT,count:2,pack:"position",packPrecisionFactor:10},id:{type:g.UNSIGNED_BYTE,count:3,pack:"id"},bitset:{type:g.UNSIGNED_BYTE,count:1},offset:{type:g.BYTE,count:2,packAlternating:{count:4,pack:()=>[[-1,-1],[1,-1],[-1,1],[1,1]]}}}};let Ba=class extends Gt{constructor(){super(...arguments),this.vertexSpec=Fa}_write(t,e){t.recordStart(this.instanceId,this.attributeLayout);const i=e.getDisplayId();if(e.geometryType==="esriGeometryPoint"){const n=e.readXForDisplay(),s=e.readYForDisplay();this._writeQuad(t,i,n,s)}else if(e.geometryType==="esriGeometryMultipoint"){const n=e.readGeometryForDisplay();n==null||n.forEachVertex((s,o)=>{s>=0&&s<=512&&o>=0&&o<=512&&this._writeQuad(t,i,s,o)})}t.recordEnd()}_writeQuad(t,e,i,n){const s=t.vertexCount();this._writeVertex(t,e,i,n),t.indexWrite(s+0),t.indexWrite(s+1),t.indexWrite(s+2),t.indexWrite(s+1),t.indexWrite(s+3),t.indexWrite(s+2)}};const Ca=8388607,Oa=8388608,Te=r=>r&Ca;function fl(r,t){return((t?Oa:0)|r)>>>0}function Fi(r,t,e){return r[0]=t[0]-e[0],r[1]=t[1]-e[1],r}function Un(r,t){return Math.sqrt(r*r+t*t)}function Bi(r){const t=Un(r[0],r[1]);r[0]/=t,r[1]/=t}function Ra(r,t){return Un(r[0]-t[0],r[1]-t[1])}function Va(r,t){return r[t+1]}function Wn(r){return r.length-1}function La(r){let t=0;for(let e=0;e<Wn(r);e++)t+=Aa(r,e);return t}function Aa(r,t,e=1){let[i,n]=Va(r,t);return[i,n]=[Math.round(i),Math.round(n)],Math.sqrt(i*i+n*n)*e}let Ga=class Wr{constructor(t,e,i,n,s){this._segments=t,this._index=e,this._distance=i,this._xStart=n,this._yStart=s,this._done=!1}static create(t){return new Wr(t,0,0,t[0][0],t[0][1])}clone(){return new Wr(this._segments,this._index,this._distance,this.xStart,this.yStart)}equals(t){return this._index===t._index||t._index===this._index-1&&(this._distance===0||t._distance===1)||t._index===this._index+1&&(this._distance===1||t._distance===0)}leq(t){return this._index<t._index||this._index===t._index&&this._distance<=t._distance}geq(t){return this._index>t._index||this._index===t._index&&this._distance>=t._distance}get _segment(){return this._segments[this._index+1]}get angle(){const t=this.dy,e=(0*t+-1*-this.dx)/(1*this.length);let i=Math.acos(e);return t>0&&(i=2*Math.PI-i),i}get xStart(){return this._xStart}get yStart(){return this._yStart}get x(){return this.xStart+this.distance*this.dx}get y(){return this.yStart+this.distance*this.dy}get dx(){return this._segment[0]}get dy(){return this._segment[1]}get xMidpoint(){return this.xStart+.5*this.dx}get yMidpoint(){return this.yStart+.5*this.dy}get xEnd(){return this.xStart+this.dx}get yEnd(){return this.yStart+this.dy}get length(){const{dx:t,dy:e}=this;return Math.sqrt(t*t+e*e)}get remainingLength(){return this.length*(1-this._distance)}get backwardLength(){return this.length*this._distance}get distance(){return this._distance}get done(){return this._done}hasPrev(){return this._index-1>=0}hasNext(){return this._index+1<Wn(this._segments)}next(){return this.hasNext()?(this._xStart+=this.dx,this._yStart+=this.dy,this._distance=0,this._index+=1,this):null}prev(){return this.hasPrev()?(this._index-=1,this._xStart-=this.dx,this._yStart-=this.dy,this._distance=1,this):(this._done=!0,null)}_seekBackwards(t,e){const i=this.backwardLength;if(t<=i)return this._distance=(i-t)/this.length,this;let n=this.backwardLength;for(;this.prev();){if(n+this.length>t)return this._seekBackwards(t-n);n+=this.length}return this._distance=0,e?this:null}seek(t,e=!1){if(t<0)return this._seekBackwards(Math.abs(t),e);if(t<=this.remainingLength)return this._distance=(this.backwardLength+t)/this.length,this;let i=this.remainingLength;for(;this.next();){if(i+this.length>t)return this.seek(t-i,e);i+=this.length}return this._distance=1,e?this:null}};function Ua(r,t,e,i=!0){const n=La(r),s=Ga.create(r),o=n/2;if(!i)return s.seek(o),void(Math.abs(s.x)<mt&&Math.abs(s.y)<mt&&e(s.clone(),0,o+0*t,n));const a=Math.max((n-t)/2,0),c=Math.floor(a/t),u=o-c*t;s.seek(u);for(let l=-c;l<=c;l++)Math.abs(s.x)<mt&&Math.abs(s.y)<mt&&e(s.clone(),l,o+l*t,n),s.seek(t)}function Wa(r,t){const e=t;for(let i=0;i<r.length;i++){let n=r[i];Ya(n,e);const s=[];s.push(n[0]);for(let o=1;o<n.length;o++){const[a,c]=n[o-1],[u,l]=n[o],h=u-a,f=l-c;s.push([h,f])}r[i]=s,n=s}return r}function Ya(r,t){if(t<=0)return;const i=r.length;if(i<3)return;const n=[];let s=0;n.push(0);for(let h=1;h<i;h++)s+=Ra(r[h],r[h-1]),n.push(s);t=Math.min(t,.2*s);const o=[];o.push(r[0][0]),o.push(r[0][1]);const a=r[i-1][0],c=r[i-1][1],u=Fi([0,0],r[0],r[1]);Bi(u),r[0][0]+=t*u[0],r[0][1]+=t*u[1],Fi(u,r[i-1],r[i-2]),Bi(u),r[i-1][0]+=t*u[0],r[i-1][1]+=t*u[1];for(let h=1;h<i;h++)n[h]+=t;n[i-1]+=t;const l=.5*t;for(let h=1;h<i-1;h++){let f=0,p=0,y=0;for(let x=h-1;x>=0&&!(n[x+1]<n[h]-l);x--){const v=l+n[x+1]-n[h],_=n[x+1]-n[x],$=n[h]-n[x]<l?1:v/_;if(Math.abs($)<1e-6)break;const I=$*$,z=$*v-.5*I*_,O=$*_/t,k=r[x+1],Q=r[x][0]-k[0],vt=r[x][1]-k[1];f+=O/z*(k[0]*$*v+.5*I*(v*Q-_*k[0])-I*$*_*Q/3),p+=O/z*(k[1]*$*v+.5*I*(v*vt-_*k[1])-I*$*_*vt/3),y+=O}for(let x=h+1;x<i&&!(n[x-1]>n[h]+l);x++){const v=l-n[x-1]+n[h],_=n[x]-n[x-1],$=n[x]-n[h]<l?1:v/_;if(Math.abs($)<1e-6)break;const I=$*$,z=$*v-.5*I*_,O=$*_/t,k=r[x-1],Q=r[x][0]-k[0],vt=r[x][1]-k[1];f+=O/z*(k[0]*$*v+.5*I*(v*Q-_*k[0])-I*$*_*Q/3),p+=O/z*(k[1]*$*v+.5*I*(v*vt-_*k[1])-I*$*_*vt/3),y+=O}o.push(f/y),o.push(p/y)}o.push(a),o.push(c);for(let h=0,f=0;h<i;h++)r[h][0]=o[f++],r[h][1]=o[f++]}class Yn{static getPlacement(t,e,i,n,s,o){const a=rs(i);return a?(e===-1&&t.invertY(),a.execute(t,i,n,s,o)):null}}const Ci=96;let Ha=class{constructor(t){const{offsetX:e,offsetY:i,postAngle:n,fontSize:s,scaleFactor:o,transforms:a}=t;if(this.offsetX=e,this.offsetY=i,this.postAngle=n,this.fontSize=Math.min(s,Ci),this.transforms=a,a&&a.infos.length>1){const c=Wi(s,n,!1,e,i,a);this.fontSize=Math.min(c.size,Ci),this.postAngle=c.rotation,this.offsetX=c.offsetX,this.offsetY=c.offsetY}o&&(this.fontSize*=o,this.offsetX*=o,this.offsetY*=o)}};const ee=28,xt=[4,4],Ie=[16,4],Xa={topLeft:Ie,topRight:Ie,bottomLeft:Ie,bottomRight:Ie},Ze=[4,2],tt=[4,6],Oi={topLeft:Ze,topRight:Ze,bottomLeft:tt,bottomRight:tt},Ri={topLeft:Ze,topRight:tt,bottomLeft:Ze,bottomRight:tt},Za={topLeft:tt,topRight:tt,bottomLeft:xt,bottomRight:xt},qa={topLeft:xt,topRight:xt,bottomLeft:tt,bottomRight:tt},Ka={topLeft:tt,topRight:xt,bottomLeft:tt,bottomRight:xt},ja={topLeft:xt,topRight:tt,bottomLeft:xt,bottomRight:tt},Qa={createComputedParams:r=>r,attributes:{pos:{type:g.SHORT,count:2,pack:"position",packPrecisionFactor:10},id:{type:g.UNSIGNED_BYTE,count:3,pack:"id"},bitset:{type:g.UNSIGNED_BYTE,count:1,packTessellation:({isBackground:r,mapAligned:t})=>pe([[_o,r],[wo,!!t]])},zoomRange:{type:g.UNSIGNED_SHORT,count:2,packPrecisionFactor:Ke,packTessellation:({minZoom:r,maxZoom:t})=>[r||0,t||ee]},offset:{type:g.SHORT,count:2,packPrecisionFactor:8,packAlternating:{count:4,packTessellation:({offsets:r})=>{const{bottomLeft:t,bottomRight:e,topLeft:i,topRight:n}=r;return[i,n,t,e]}}},textureUV:{type:g.SHORT,count:2,packPrecisionFactor:4,packAlternating:{count:4,packTessellation:({texcoords:r})=>{const{bottomLeft:t,bottomRight:e,topLeft:i,topRight:n}=r;return[i,n,t,e]}}},color:{type:g.UNSIGNED_BYTE,count:4,normalized:!0,packTessellation:({color:r})=>r},fontSize:{type:g.UNSIGNED_SHORT,count:1,packPrecisionFactor:4,packTessellation:({fontSize:r})=>S(r)},referenceSize:{type:g.UNSIGNED_BYTE,count:1,packPrecisionFactor:4,packTessellation:({fontSize:r},{referenceSize:t})=>S(t??r)},haloColor:{type:g.UNSIGNED_BYTE,count:4,normalized:!0,pack:({haloColor:r})=>L(r)},haloFontSize:{type:g.UNSIGNED_SHORT,count:1,packPrecisionFactor:4,pack:({haloFontSize:r})=>S(r)},clipAngle:{type:g.UNSIGNED_BYTE,count:1,packTessellation:({clipAngle:r})=>Ja(r||0)},referenceSymbol:{type:g.BYTE,count:4,packPrecisionFactor:1,packTessellation:(r,t)=>{if(!r.referenceBounds)return[0,0,0,0];const e=is(t.horizontalAlignment),i=ns(t.verticalAlignment),{offsetX:n,offsetY:s,size:o}=r.referenceBounds;return[S(n),-S(s),S(o),e+1<<2|i+1]}}}};let Hn=class extends Gt{constructor(){super(...arguments),this.vertexSpec=Qa,this._textMeshParamsPropsInitialized=!1}ensurePacked(t,e,i){super.ensurePacked(t,e,i),this._textMeshParamsPropsInitialized&&!this._evaluator.hasDynamicProperties||(this._textMeshTransformProps=new Ha(this.evaluatedMeshParams),this._textMeshParamsPropsInitialized=!0)}_write(t,e,i){const n=this._getShaping();if(!n)return;const s=e.getDisplayId();if(this.evaluatedMeshParams.placement!=null)return this._writePlacedTextMarkers(t,e,n,i);if(i&&i.nextPath())return i.nextPoint(),this._writeGlyphs(t,s,i.x,i.y,n,0);if(e.geometryType==="esriGeometryPolygon"){const c=e.readCentroidForDisplay();if(!c)return;const[u,l]=c.coords;return this._writeGlyphs(t,s,u,l,n,0)}if(e.geometryType==="esriGeometryMultipoint"){const c=e.readGeometryForDisplay();return void(c==null?void 0:c.forEachVertex((u,l)=>this._writeGlyphs(t,s,u,l,n,0)))}const o=e.readXForDisplay(),a=e.readYForDisplay();return this._writeGlyphs(t,s,o,a,n,0)}_writePlacedTextMarkers(t,e,i,n){const s=n??pt.fromFeatureSetReaderCIM(e);if(!s)return;const o=-1,a=Yn.getPlacement(s,o,this.evaluatedMeshParams.placement,S(1),t.id,Zr());if(!a)return;const c=e.getDisplayId();let u=a.next();for(;u!=null;){const l=u.tx,h=-u.ty,f=-u.getAngle();this._writeGlyphs(t,c,l,h,i,f),u=a.next()}}_getShaping(){var c;const t=this._textMeshTransformProps,e=this.evaluatedMeshParams;if(!((c=e.glyphs)!=null&&c.glyphs.length))return null;const i=Math.round(S(t.fontSize)),n=S(t.offsetX),s=S(t.offsetY),o=bi(S(e.lineWidth),32,512),a=Jn*bi(e.lineHeightRatio,.25,4);return ss(e.glyphs,{scale:i/ts,angle:t.postAngle,xOffset:n,yOffset:s,horizontalAlignment:e.horizontalAlignment,verticalAlignment:e.verticalAlignment,maxLineWidth:o,lineHeight:a,decoration:e.decoration,borderLineSizePx:S(e.boxBorderLineSize),hasBackground:!!e.boxBackgroundColor,useCIMAngleBehavior:e.useCIMAngleBehavior})}_writeGlyphs(t,e,i,n,s,o,a){const c=this.evaluatedMeshParams,u=this._textMeshTransformProps,l=u.fontSize,h=S(u.offsetX),f=S(u.offsetY);o!==0&&s.setRotation(o);const p=s.bounds,y=i+p.x+h,x=n+p.y-f,v=2*(c.minPixelBuffer?c.minPixelBuffer/l:1),_=Math.max(p.width,p.height)*v;s.textBox&&(t.recordStart(this.instanceId,this.attributeLayout,s.glyphs[0].textureBinding),t.recordBounds(y,x,_,_),this._writeTextBox(t,e,i,n,s.textBox,a),t.recordEnd());for(const $ of s.glyphs){t.recordStart(this.instanceId,this.attributeLayout,$.textureBinding),t.recordBounds(y,x,_,_);const{texcoords:I,offsets:z}=$;this._writeQuad(t,e,i,n,{texcoords:I,offsets:z,fontSize:l,color:L(c.color),isBackground:!1,referenceBounds:a}),t.recordEnd()}o!==0&&s.setRotation(-o)}_writeTextBox(t,e,i,n,s,o,a){const c=this.evaluatedMeshParams,{fontSize:u}=this._textMeshTransformProps,{boxBackgroundColor:l,boxBorderLineColor:h}=c,f={isBackground:!0,fontSize:u,referenceBounds:o,...a};l&&(this._writeQuad(t,e,i,n,{texcoords:Xa,offsets:s.main,color:L(l),...f}),h||(this._writeQuad(t,e,i,n,{texcoords:Za,offsets:s.top,color:L(l),...f}),this._writeQuad(t,e,i,n,{texcoords:qa,offsets:s.bot,color:L(l),...f}),this._writeQuad(t,e,i,n,{texcoords:Ka,offsets:s.left,color:L(l),...f}),this._writeQuad(t,e,i,n,{texcoords:ja,offsets:s.right,color:L(l),...f}))),h&&(this._writeQuad(t,e,i,n,{texcoords:Oi,offsets:s.top,color:L(h),...f}),this._writeQuad(t,e,i,n,{texcoords:Oi,offsets:s.bot,color:L(h),...f}),this._writeQuad(t,e,i,n,{texcoords:Ri,offsets:s.left,color:L(h),...f}),this._writeQuad(t,e,i,n,{texcoords:Ri,offsets:s.right,color:L(h),...f}))}_writeQuad(t,e,i,n,s){const o=t.vertexCount();this._writeVertex(t,e,i,n,s),t.indexWrite(o+0),t.indexWrite(o+1),t.indexWrite(o+2),t.indexWrite(o+1),t.indexWrite(o+3),t.indexWrite(o+2)}};const Ja=r=>Math.round(r*(254/360)),ke=1,Dt=0,tc=128,ec=gs(r=>{let t=0;if(r===0)return 1/0;for(;!(r%2);)t++,r/=2;return t});class rc extends Hn{constructor(){super(...arguments),this._zoomLevel=0}_write(t,e,i,n){if(this._zoomLevel=n||0,i!=null)throw new Error("InternalError: EffectGeometry not support for LabelMeshWriter");switch(e.geometryType){case"esriGeometryPoint":{const s=e.readXForDisplay(),o=e.readYForDisplay();return this._writePoint(t,s,o,e)}case"esriGeometryEnvelope":case"esriGeometryPolygon":case"esriGeometryMultipoint":{const s=e.readCentroidForDisplay();if(!s)return;const[o,a]=s.coords;return this._writePoint(t,o,a,e)}case"esriGeometryPolyline":{const s=e.readLegacyGeometryForDisplay();this._writeLines(t,e,s)}}}_writePoint(t,e,i,n){var p,y;const s=this._getShaping();if(!s)return;let o=this._getPointReferenceBounds();o||(o={offsetX:0,offsetY:0,size:0});const a=s.boundsT,c=os(this.evaluatedMeshParams.horizontalAlignment),u=as(this.evaluatedMeshParams.verticalAlignment),l=((p=this.evaluatedMeshParams.scaleInfo)==null?void 0:p.maxScale)??0,h=((y=this.evaluatedMeshParams.scaleInfo)==null?void 0:y.minScale)??0,f=Te(n.getDisplayId());t.metricStart(new xe(f,e,i,c,u,l,h,o)),t.metricBoxWrite(a),this._writeGlyphs(t,n.getDisplayId(),e,i,s,0,o),t.metricEnd()}_getPointReferenceBounds(){if(!this._references)return null;for(const t of this._references){const e=t.getBoundsInfo();if(e)return e}return null}_writeLines(t,e,i){const{repeatLabel:n,scaleInfo:s}=this.evaluatedMeshParams,o=this.evaluatedMeshParams.repeatLabelDistance||128,a=this._getShaping();if(!a)return;this._current={out:t,id:e.getDisplayId(),shaping:a,zoomRange:de(s,this.getTileInfo()),referenceBounds:this._getPointReferenceBounds()||{offsetX:0,offsetY:0,size:0}};const c=Wa(i.paths,a.bounds.width),u=this._placeSubdivGlyphs.bind(this),l=(a.bounds.width+o)/(1<<ke);for(const h of c)Ua(h,l,u,!!n)}_placeSubdivGlyphs(t,e,i,n){const{allowOverrun:s,labelPosition:o,repeatLabelDistance:a}=this.evaluatedMeshParams,c=this._current.zoomRange[0],u=ec(e),l=this._current.shaping.bounds.width/(1<<ke),h=Math.sqrt(a||tc)/(1<<ke),f=Math.min(i,n-i),p=this._current.shaping.isMultiline?ee:Math.log2(f/(h+l/2)),y=e===0?p:Math.min(u,p),x=Math.max(c,this._zoomLevel+ke-y),v=this._zoomLevel-x,_=this._current.shaping.bounds.width/2*2**v;this._current.shaping.isMultiline?e===0&&this._placeStraight(t,x):s&&v<0?this._placeStraightAlong(t,c):o==="parallel"?this._placeStraightAlong(t,x):o==="curved"&&this._placeCurved(t,x,_)}_placeStraight(t,e){var x,v;const{out:i,id:n,shaping:s,zoomRange:o,referenceBounds:a}=this._current,{x:c,y:u}=t,l=t.angle*(180/Math.PI)%360,h=(t.angle*(180/Math.PI)+180)%360;if(s.textBox){const _=Math.max(e,o[0],0),$=Math.min(ee,o[1]),I=hr(dr(),-t.angle),[z,O]=s.shapeBackground(I),k={minZoom:_,maxZoom:$,clipAngle:l,mapAligned:!0,isLineLabel:!0};i.recordStart(this.instanceId,this.attributeLayout,s.glyphs[0].textureBinding),this._writeTextBox(i,n,t.x,t.y,O,a,k),i.recordEnd(),k.clipAngle=h,i.recordStart(this.instanceId,this.attributeLayout,s.glyphs[0].textureBinding),this._writeTextBox(i,n,t.x,t.y,O,a,k),i.recordEnd()}const f=Te(n),p=((x=this.evaluatedMeshParams.scaleInfo)==null?void 0:x.maxScale)??0,y=((v=this.evaluatedMeshParams.scaleInfo)==null?void 0:v.minScale)??0;i.metricStart(new xe(f,t.x,t.y,0,0,p,y,null)),i.metricBoxWrite(s.bounds);for(const _ of s.glyphs)_.minZoom=e,_.maxZoom=o[1],_.angle=t.angle,this._writeLineGlyph(i,n,c,u,s.bounds,_,l,a,!0),_.angle=t.angle+Math.PI,this._writeLineGlyph(i,n,c,u,s.bounds,_,h,a,!0);i.metricEnd()}_placeCurved(t,e,i){var f,p;const{out:n,id:s}=this._current,o=t.clone(),a=t.angle*(180/Math.PI)%360,c=(t.angle*(180/Math.PI)+180)%360,u=Te(s),l=((f=this.evaluatedMeshParams.scaleInfo)==null?void 0:f.maxScale)??0,h=((p=this.evaluatedMeshParams.scaleInfo)==null?void 0:p.minScale)??0;n.metricStart(new xe(u,t.x,t.y,0,0,l,h,null)),this._placeFirst(o,e,1,a),this._placeBack(t,o,e,i,1,a),this._placeForward(t,o,e,i,1,a),this._placeFirst(o,e,0,c),this._placeBack(t,o,e,i,0,c),this._placeForward(t,o,e,i,0,c),n.metricEnd()}_placeStraightAlong(t,e){var v,_;const{out:i,id:n,shaping:s,zoomRange:o,referenceBounds:a}=this._current,{boxBorderLineColor:c,boxBackgroundColor:u}=this.evaluatedMeshParams,l=t.clone(),h=t.angle*(180/Math.PI)%360,f=(t.angle*(180/Math.PI)+180)%360;if(s.glyphs.length>0&&(c||u)){const $=Math.max(e,o[0],0),I=Math.min(ee,o[1]),z=hr(dr(),-t.angle),[O,k]=s.shapeBackground(z),Q={minZoom:$,maxZoom:I,clipAngle:h,mapAligned:!0,isLineLabel:!0};i.recordStart(this.instanceId,this.attributeLayout,s.glyphs[0].textureBinding),this._writeTextBox(i,n,t.x,t.y,k,a,Q),i.recordEnd(),Q.clipAngle=f,i.recordStart(this.instanceId,this.attributeLayout,s.glyphs[0].textureBinding),this._writeTextBox(i,n,t.x,t.y,k,a,Q),i.recordEnd()}const p=Te(n),y=((v=this.evaluatedMeshParams.scaleInfo)==null?void 0:v.maxScale)??0,x=((_=this.evaluatedMeshParams.scaleInfo)==null?void 0:_.minScale)??0;i.metricStart(new xe(p,t.x,t.y,0,0,y,x,null)),this._placeFirst(l,e,1,h,!0),this._placeFirst(l,e,0,f,!0),i.metricEnd()}_placeBack(t,e,i,n,s,o){const a=t.clone();let c=t.backwardLength+Dt;for(;a.prev()&&!(c>=n);)this._placeOnSegment(a,e,c,i,-1,s,o),c+=a.length+Dt}_placeForward(t,e,i,n,s,o){const a=t.clone();let c=t.remainingLength+Dt;for(;a.next()&&!(c>=n);)this._placeOnSegment(a,e,c,i,1,s,o),c+=a.length+Dt}_placeFirst(t,e,i,n,s=!1){const o=t,{out:a,id:c,shaping:u,zoomRange:l,referenceBounds:h}=this._current,f=u.glyphs;for(const p of f){const y=p.x>u.bounds.x?i:1-i,x=y*t.remainingLength+(1-y)*t.backwardLength,v=Math.abs(p.x+p.width/2-u.bounds.x),_=Math.max(0,this._zoomLevel+Math.log2(v/(x+Dt))),$=Math.max(e,s?0:_);p.maxZoom=Math.min(l[1],ee),p.angle=t.angle+(1-i)*Math.PI,p.minZoom=Math.max(l[0],$),a.metricBoxWrite(p.bounds),this._writeLineGlyph(a,c,o.x,o.y,u.bounds,p,n,h,!0)}}_placeOnSegment(t,e,i,n,s,o,a){const{out:c,id:u,shaping:l,referenceBounds:h}=this._current,f=l.glyphs,p=t.dx/t.length,y=t.dy/t.length,x={x:t.x+i*-s*p,y:t.y+i*-s*y};for(const v of f){const _=v.x>l.bounds.x?o:1-o;if(!(_&&s===1||!_&&s===-1))continue;const $=Math.abs(v.x+v.width/2-l.bounds.x),I=Math.max(0,this._zoomLevel+Math.log2($/i)-.1),z=Math.max(n,this._zoomLevel+Math.log2($/(i+t.length+Dt)));I!==0&&(v.angle=t.angle+(1-o)*Math.PI,v.minZoom=z,v.maxZoom=I,this._writeLineGlyph(c,u,x.x,x.y,l.bounds,v,a,h,!0))}}_writeLineGlyph(t,e,i,n,s,o,a,c,u){const l=i+s.x,h=n+s.y,f=2*(this.evaluatedMeshParams.minPixelBuffer?this.evaluatedMeshParams.minPixelBuffer/this._textMeshTransformProps.fontSize:1),p=Math.max(s.width,s.height)*f;t.recordStart(this.instanceId,this.attributeLayout,o.textureBinding),t.recordBounds(l,h,p,p);const{texcoords:y,offsets:x}=o,v=this._textMeshTransformProps.fontSize;this._writeQuad(t,e,i,n,{texcoords:y,offsets:x,fontSize:v,color:L(this.evaluatedMeshParams.color),isBackground:!1,referenceBounds:c,minZoom:Math.max(this._current.zoomRange[0],o.minZoom),maxZoom:Math.min(this._current.zoomRange[1],o.maxZoom),clipAngle:a,mapAligned:u,isLineLabel:!0}),t.recordEnd()}}const ic={createComputedParams:r=>r,attributes:{...Je.attributes,bitset:{type:g.UNSIGNED_BYTE,count:1,pack:({shouldSampleAlphaOnly:r,shouldScaleDash:t,isSDF:e})=>pe([[Kr,r],[bo,t],[vo,e]])},tlbr:{type:g.UNSIGNED_SHORT,count:4,pack:({sprite:r})=>{const{rect:t,width:e,height:i}=r,n=t.x+Vt,s=t.y+Vt;return[n,s,n+e,s+i]}},accumulatedDistance:{type:g.UNSIGNED_SHORT,count:1,packTessellation:({distance:r})=>r},segmentDirection:{type:g.BYTE,count:2,packPrecisionFactor:16,packTessellation:({directionX:r,directionY:t})=>[r,t]}}};class nc extends Jr{constructor(t,e,i,n){super(t,e,i,n),this.vertexSpec=ic,this._tessellationOptions.textured=!0}_write(t,e,i){const n=i??pt.fromFeatureSetReaderCIM(e);if(!n)return;const{sprite:s}=this.evaluatedMeshParams;this._writeGeometry(t,e,n,s==null?void 0:s.textureBinding)}}class qe{static from(t){return"width"in t?this.fromSimpleMeshParams(t):this.fromComplexMeshParams(t)}static fromSimpleMeshParams(t){const e=new qe(t.sprite,t.color,t.outlineColor,t.minPixelBuffer,t.placement,t.scaleInfo,t.effects),{type:i,width:n,height:s,angle:o,outlineSize:a,referenceSize:c,sprite:u,overrideOutlineColor:l}=t;e.rawWidth=S(n),e.rawHeight=S(s),e.angle=o,e.outlineSize=S(a),e.referenceSize=S(c),e.overrideOutlineColor=l,e.offsetX=S(t.offsetX),e.offsetY=S(t.offsetY),i!=="simple"||u.sdf||(e.rawWidth=u.width,e.rawHeight=u.height);const h=2;return e.sizeRatio=u.sdf?h:1,e._computeSize(t,!1),e}static fromComplexMeshParams(t){const e=new qe(t.sprite,t.color,t.outlineColor,t.minPixelBuffer,t.placement,t.scaleInfo,t.effects);let{alignment:i,transforms:n,size:s,scaleX:o,anchorX:a,anchorY:c,angle:u,colorLocked:l,frameHeight:h,widthRatio:f,offsetX:p,offsetY:y,outlineSize:x,referenceSize:v,scaleFactor:_,sizeRatio:$,isAbsoluteAnchorPoint:I,rotateClockwise:z,scaleSymbolsProportionally:O,sprite:k}=t;if(n&&n.infos.length>0){const ge=Wi(s,u,z,p,y,n);s=ge.size,u=ge.rotation,p=ge.offsetX,y=ge.offsetY,z=!1}_&&(s*=_,p*=_,y*=_);const Q=o*(k.width/k.height);e.alignment=i,e.rawHeight=S(s),e.rawWidth=e.rawHeight*Q,e.referenceSize=S(v),e.sizeRatio=$,e.angle=u,e.rotateClockwise=z,e.anchorX=a,e.anchorY=c,e.offsetX=S(p),e.offsetY=S(y),I&&s&&(k.sdf?e.anchorX=a/(s*f):e.anchorX=a/(s*Q),e.anchorY=c/s);const vt=O&&h?s/h:1;return e.outlineSize=x===0||isNaN(x)?0:S(x)*vt,e.scaleSymbolsProportionally=O,e.colorLocked=l,e._computeSize(t,!0),e}constructor(t,e,i,n,s,o,a){this.sprite=t,this.color=e,this.outlineColor=i,this.minPixelBuffer=n,this.placement=s,this.scaleInfo=o,this.effects=a,this.rawWidth=0,this.rawHeight=0,this.angle=0,this.outlineSize=0,this.referenceSize=0,this.sizeRatio=1,this.alignment=Gi.SCREEN,this.scaleSymbolsProportionally=!1,this.overrideOutlineColor=!1,this.colorLocked=!1,this.anchorX=0,this.anchorY=0,this.computedWidth=0,this.computedHeight=0,this.texXmin=0,this.texYmin=0,this.texXmax=0,this.texYmax=0,this.offsetX=0,this.offsetY=0,this.rotateClockwise=!0}get boundsInfo(){return{size:Math.max(this.computedHeight,this.computedWidth),offsetX:this.offsetX,offsetY:this.offsetY}}_computeSize(t,e){const{sprite:i,hasSizeVV:n}=t,s=!!i.sdf,{rawWidth:o,rawHeight:a,sizeRatio:c,outlineSize:u}=this,l=o*c,h=a*c;if(s&&!n){const I=e&&o>a?l:o,z=a,O=u+2*1;this.computedWidth=Math.min(I+O,l),this.computedHeight=Math.min(z+O,h)}else this.computedWidth=l,this.computedHeight=h;const f=s?es/Math.max(l,h):1,p=.5*(l-this.computedWidth)*f,y=.5*(h-this.computedHeight)*f,x=i.rect.x+Vt+p,v=i.rect.y+Vt+y,_=x+i.width-2*p,$=v+i.height-2*y;this.texXmin=Math.floor(x),this.texYmin=Math.floor(v),this.texXmax=Math.ceil(_),this.texYmax=Math.ceil($),this.computedWidth*=(this.texXmax-this.texXmin)/(_-x),this.computedHeight*=(this.texYmax-this.texYmin)/($-v),this.anchorX*=l/this.computedWidth,this.anchorY*=h/this.computedHeight}}const Qt={bitset:{isSDF:0,isMapAligned:1,scaleSymbolsProportionally:2,overrideOutlineColor:3,colorLocked:4}},Vi=3.14159265359/180,sc=128/Math.PI;function oc(r,t){return r%=t,Math.abs(r>=0?r:r+t)}function ac(r){return oc(r*sc,256)}function cc(r,t,e,i,n=!1){const s=dr(),o=n?1:-1;return r?hr(s,o*Vi*r):_s(s),(t||e)&&ws(s,s,[t,-e]),i&&$s(s,s,o*Vi*-i),s}const uc={createComputedParams:r=>qe.from(r),attributes:{pos:{type:g.SHORT,count:2,pack:"position",packPrecisionFactor:10},id:{type:g.UNSIGNED_BYTE,count:3,pack:"id"},bitset:{type:g.UNSIGNED_BYTE,count:1,pack:({sprite:r,alignment:t,scaleSymbolsProportionally:e,overrideOutlineColor:i,colorLocked:n})=>{let s=0;return r.sdf&&(s|=Ht(Qt.bitset.isSDF)),t===Gi.MAP&&(s|=Ht(Qt.bitset.isMapAligned)),e&&(s|=Ht(Qt.bitset.scaleSymbolsProportionally)),i&&(s|=Ht(Qt.bitset.overrideOutlineColor)),n&&(s|=Ht(Qt.bitset.colorLocked)),s}},zoomRange:{type:g.SHORT,count:2,packPrecisionFactor:Ke,pack:({scaleInfo:r},{tileInfo:t})=>de(r,t)},offset:{type:g.SHORT,count:2,packPrecisionFactor:4,packAlternating:{count:4,pack:({angle:r,computedWidth:t,computedHeight:e,anchorX:i,anchorY:n,offsetX:s,offsetY:o,rotateClockwise:a})=>{const c=cc(0,s,o,-r,a),u=-(.5+i)*t,l=-(.5-n)*e,h=[u,l],f=[u+t,l],p=[u,l+e],y=[u+t,l+e];return ve(h,h,c),ve(f,f,c),ve(p,p,c),ve(y,y,c),[h,f,p,y]}}},textureUV:{type:g.SHORT,count:2,packPrecisionFactor:4,packAlternating:{count:4,pack:({texXmax:r,texXmin:t,texYmax:e,texYmin:i})=>[[t,i],[r,i],[t,e],[r,e]]}},color:{type:g.UNSIGNED_BYTE,count:4,normalized:!0,pack:({color:r})=>L(r)},outlineColor:{type:g.UNSIGNED_BYTE,count:4,normalized:!0,pack:({outlineColor:r})=>L(r)},sizing:{type:g.UNSIGNED_BYTE,count:4,pack:({rawWidth:r,rawHeight:t,outlineSize:e,referenceSize:i})=>{const n=Math.max(r,t);return[ur(n,128),ur(e,128),ur(i,128),0]}},placementAngle:{type:g.UNSIGNED_BYTE,count:1,packTessellation:({placementAngle:r})=>ac(r)},sizeRatio:{type:g.UNSIGNED_SHORT,count:1,packPrecisionFactor:64,pack:({sizeRatio:r})=>r}}};class lc extends Gt{constructor(){super(...arguments),this.vertexSpec=uc}getBoundsInfo(){return this.evaluatedMeshParams.boundsInfo}_write(t,e,i){var h;const n=(h=this.evaluatedMeshParams.sprite)==null?void 0:h.textureBinding,s=e.getDisplayId();t.recordStart(this.instanceId,this.attributeLayout,n);const o=this.evaluatedMeshParams.minPixelBuffer,a=Math.max(this.evaluatedMeshParams.computedWidth,o),c=Math.max(this.evaluatedMeshParams.computedHeight,o),u=this.evaluatedMeshParams.offsetX,l=-this.evaluatedMeshParams.offsetY;if(this.evaluatedMeshParams.placement!=null)this._writePlacedMarkers(t,e,i,a,c);else if(i&&i.nextPath()){i.nextPoint();const f=i.x,p=i.y;t.recordBounds(f+u,p+l,a,c),this._writeQuad(t,s,f,p)}else if(e.geometryType==="esriGeometryPolygon"){const f=e.readCentroidForDisplay();if(!f)return;const[p,y]=f.coords;t.recordBounds(p+u,y+l,a,c),this._writeQuad(t,s,p,y)}else if(e.geometryType==="esriGeometryPoint"){const f=e.readXForDisplay(),p=e.readYForDisplay();t.recordBounds(f+u,p+l,a,c),this._writeQuad(t,s,f,p)}else{const f=e.readGeometryForDisplay();f==null||f.forEachVertex((p,y)=>{t.recordBounds(p+u,y+l,a,c),Math.abs(p)>mt||Math.abs(y)>mt||this._writeQuad(t,s,p,y)})}t.recordEnd()}_writePlacedMarkers(t,e,i,n,s){var p;const o=i??((p=pt.fromFeatureSetReaderCIM(e))==null?void 0:p.clone());if(!o)return;const a=-1,c=Yn.getPlacement(o,a,this.evaluatedMeshParams.placement,S(1),t.id,Zr());if(!c)return;const u=e.getDisplayId();let l=c.next();const h=this.evaluatedMeshParams.offsetX,f=-this.evaluatedMeshParams.offsetY;for(;l!=null;){const y=l.tx,x=-l.ty;if(Math.abs(y)>mt||Math.abs(x)>mt){l=c.next();continue}const v=-l.getAngle();t.recordBounds(y+h,x+f,n,s),this._writeQuad(t,u,y,x,v),l=c.next()}}_writeQuad(t,e,i,n,s){const o=t.vertexCount(),a=s==null?null:{placementAngle:s};this._writeVertex(t,e,i,n,a),t.indexWrite(o+0),t.indexWrite(o+1),t.indexWrite(o+2),t.indexWrite(o+1),t.indexWrite(o+3),t.indexWrite(o+2)}}const hc={createComputedParams:r=>r,attributes:{pos:{type:g.SHORT,count:2,packPrecisionFactor:10,pack:"position"},id:{type:g.UNSIGNED_BYTE,count:3,pack:"id"},bitset:{type:g.UNSIGNED_BYTE,count:1,pack:r=>0},offset:{type:g.SHORT,count:2,packPrecisionFactor:16,packAlternating:{count:4,pack:({size:r})=>{const t=S(r),e=-t/2,i=-t/2;return[[e,i],[e+t,i],[e,i+t],[e+t,i+t]]}}},texCoords:{type:g.SHORT,count:2,packPrecisionFactor:4,packAlternating:{count:4,pack:()=>[[0,1],[1,1],[0,0],[1,0]]}},size:{type:g.UNSIGNED_BYTE,count:2,pack:({size:r})=>[r,r]},referenceSize:{type:g.UNSIGNED_BYTE,count:1,pack:({size:r})=>S(r)},zoomRange:{type:g.UNSIGNED_BYTE,count:2,pack:({scaleInfo:r},{tileInfo:t})=>de(r,t)}}};class dc extends Gt{constructor(){super(...arguments),this.vertexSpec=hc}_write(t,e){const i=e.getDisplayId(),n=this.evaluatedMeshParams.minPixelBuffer,s=Math.max(S(this.evaluatedMeshParams.size),n);let o,a;if(e.geometryType==="esriGeometryPoint")o=e.readXForDisplay(),a=e.readYForDisplay();else{const u=e.readCentroidForDisplay();if(!u)return;o=u==null?void 0:u.coords[0],a=u==null?void 0:u.coords[1]}t.recordStart(this.instanceId,this.attributeLayout),t.recordBounds(o,a,s,s);const c=t.vertexCount();this._writeVertex(t,i,o,a),t.indexWrite(c+0),t.indexWrite(c+1),t.indexWrite(c+2),t.indexWrite(c+1),t.indexWrite(c+3),t.indexWrite(c+2),t.recordEnd()}}const gl=pc({FillMeshWriter:qr,DotDensityMeshWriter:ao,ComplexFillMeshWriter:So,PatternFillMeshWriter:rn,OutlineFillMeshWriter:ri,PatternOutlineFillMeshWriter:Da,ComplexOutlineFillMeshWriter:Ma,MarkerMeshWriter:lc,PieChartMeshWriter:dc,TextMeshWriter:Hn,LineMeshWriter:Jr,TexturedLineMeshWriter:nc,HeatmapMeshWriter:Ba,LabelMeshWriter:rc});function pc(r){const t={};for(const e in r){const i={name:e,constructor:r[e]};t[e]=i}return t}let Me=class extends Ss{constructor(r){super(r),this.debugName="",this._updatingHandles=new Is,this._idToUpdatingState=new Ps}get updating(){const r=this._updatingHandles.updating||Array.from(this._idToUpdatingState.values()).some(t=>t);if(Yr("esri-2d-log-updating")){const t=Array.from(this._idToUpdatingState.entries()).map(([e,i])=>`-> ${e}: ${i}`).join(`
`);console.log(`${this.debugName}: Updating: ${r}
-> Handles: ${this._updatingHandles.updating}
${t}`)}return r}addUpdateTracking(r,t){const e=Ts(()=>t.updating,i=>this._idToUpdatingState.set(r,i),{sync:!0});this.addHandles(e)}addPromise(r){return this._updatingHandles.addPromise(r)}};d([vi({constructOnly:!0})],Me.prototype,"debugName",void 0),d([vi({readOnly:!0})],Me.prototype,"updating",null),Me=d([xs("esri.view.2d.layers.support.UpdateTracking2D")],Me);export{tu as $,$e as A,Rt as B,T as C,Se as D,we as E,En as F,R as G,M as H,ie as I,V as J,It as K,ni as L,Si as M,Qc as N,Pn as O,j as P,U as Q,Ru as R,at as S,sa as T,rt as U,Cr as V,ui as W,Qo as X,ta as Y,it as Z,w as _,P as a,ga as a0,Au as a1,eu as a2,ya as a3,gt as a4,gu as a5,xu as a6,H as a7,_o as a8,wo as a9,Tn as aA,fa as aB,We as aC,pa as aD,Qt as aE,Ei as aF,Ca as aG,fl as aH,xo as aI,Te as aJ,Yc as aK,ue as aa,le as ab,pi as ac,Ye as ad,He as ae,fi as af,At as ag,nt as ah,$t as ai,In as aj,Nt as ak,ha as al,ai as am,Z as an,Rn as ao,va as ap,bo as aq,vo as ar,Kr as as,dt as at,ku as au,di as av,hi as aw,fo as ax,qo as ay,Jc as az,Rr as b,m as c,Me as d,yt as e,bu as f,F as g,W as h,rr as i,oa as j,kn as k,Qs as l,Tt as m,Wc as n,lt as o,re as p,ci as q,Mu as r,ct as s,Y as t,zn as u,Ot as v,gl as w,zi as x,Pe as y,Lr as z};
