import{x as p,f as g,g as u,m as C,n as I,o as x,e as D,p as L,q as M,L as U}from"./symbols-b3e075ad.js";import{a as y}from"./Error-21d1d076.js";import{b as j}from"./layerUtils-c805b05c.js";import{f as k,y as v,S as N,g as R}from"./TextSymbol-53669eb2.js";import{R as S,U as T,K as q}from"./request-a10d6950.js";import{p as A}from"./promiseUtils-1d963c7c.js";import{Q as E,c as P}from"./Portal-cb507469.js";import{h as i}from"./typedArrayUtil-2af43698.js";const c={retainId:!1,ignoreDrivers:!1,hasLabelingContext:!0};function F(e,r=c){var a,f;if(!e)return{symbol:null};const{retainId:s=c.retainId,ignoreDrivers:t=c.ignoreDrivers,hasLabelingContext:o=c.hasLabelingContext,retainCIM:l=c.retainCIM}=r;let n=null;if(p(e)||e instanceof g)n=e.clone();else if(e.type==="cim"){const m=(f=(a=e.data)==null?void 0:a.symbol)==null?void 0:f.type;if(m!=="CIMPointSymbol")return{error:new y("symbol-conversion:unsupported-cim-symbol",`CIM symbol of type '${m||"unknown"}' is unsupported in 3D`,{symbol:e})};n=l?e.clone():u.fromCIMSymbol(e)}else if(e instanceof k)n=C.fromSimpleLineSymbol(e);else if(e instanceof v)n=u.fromSimpleMarkerSymbol(e);else if(e instanceof I)n=u.fromPictureMarkerSymbol(e);else if(e instanceof N)n=r.geometryType&&r.geometryType==="mesh"?x.fromSimpleFillSymbol(e):D.fromSimpleFillSymbol(e);else{if(!(e instanceof R))return{error:new y("symbol-conversion:unsupported-2d-symbol",`2D symbol of type '${e.type||e.declaredClass}' is unsupported in 3D`,{symbol:e})};n=o?L.fromTextSymbol(e):u.fromTextSymbol(e)}return s&&n&&n.type!=="cim"&&(n.id=e.id),t&&p(n)&&n.symbolLayers.forEach(m=>m.ignoreDrivers=!0),{symbol:n}}function se(e,r,s,t){const o=$(e,{},{context:t,isLabelSymbol:!1});o!=null&&(r[s]=o)}function oe(e,r,s,t){const o=$(e,{},{context:t,isLabelSymbol:!0});o!=null&&(r[s]=o)}function d(e){return e instanceof M||e instanceof g}function $(e,r,s){if(e==null)return null;const{context:t,isLabelSymbol:o}=s,l=t==null?void 0:t.origin,n=t==null?void 0:t.messages;if(l==="web-scene"&&!d(e)){const a=F(e,{retainCIM:!0,hasLabelingContext:o});return a.symbol!=null?a.symbol.write(r,t):(n==null||n.push(new y("symbol:unsupported",`Symbols of type '${e.declaredClass}' are not supported in scenes. Use 3D symbology instead when working with WebScene and SceneView`,{symbol:e,context:t,error:a.error})),null)}return(l==="web-map"||l==="portal-item"&&!j(t==null?void 0:t.layer))&&d(e)?(n==null||n.push(new y("symbol:unsupported",`Symbols of type '${e.declaredClass}' are not supported in web maps and portal items. Use 2D symbology and CIMSymbol instead when working with MapView`,{symbol:e,context:t})),null):e.write(r,t)}function le(e,r){return U(e,null,r)}const K=()=>!!i("enable-feature:force-wosr"),Q=()=>i.add("enable-feature:direct-3d-object-feature-layer-display",!0,!0,!0),V=()=>i.add("enable-feature:direct-3d-object-feature-layer-display",!1,!0,!0),W=()=>i.add("enable-i3s-patching",!0,!0,!0),_=()=>i.add("enable-i3s-patching",!1,!0,!0),ae=()=>!!i("enable-feature:SceneLayer-editing"),z=(e="i3s-patching")=>{switch(_(),V(),i.add("enable-feature:SceneLayer-editing",!0,!0,!0),e){case"feature-layer-view":Q();break;case"i3s-patching":W()}};z("i3s-patching");let b={};async function B(e,r){try{return{data:(await J(e,r)).data,baseUrl:S(e),styleUrl:e}}catch(s){return A(s),null}}function G(e,r,s){const t=r.portal!=null?r.portal:E.getDefault();let o;const l=`${t.url} - ${t.user&&t.user.username} - ${e}`;return b[l]||(b[l]=H(e,t,s).then(n=>(o=n,n.fetchData())).then(n=>({data:n,baseUrl:o.itemUrl??"",styleName:e}))),b[l]}function H(e,r,s){return r.load(s).then(()=>{const t=new P({disableExtraQuery:!0,query:`owner:${h} AND type:${w} AND typekeywords:"${e}"`});return r.queryItems(t,s)}).then(({results:t})=>{var n;let o=null;const l=e.toLowerCase();if(t&&Array.isArray(t)){for(const a of t)if(((n=a.typeKeywords)==null?void 0:n.some(m=>m.toLowerCase()===l))&&a.type===w&&a.owner===h){o=a;break}}if(!o)throw new y("symbolstyleutils:style-not-found",`The style '${e}' could not be found`,{styleName:e});return o.load(s)})}function ie(e,r,s){return(e==null?void 0:e.styleUrl)!=null?B(e.styleUrl,s):(e==null?void 0:e.styleName)!=null?G(e.styleName,r,s):Promise.reject(new y("symbolstyleutils:style-url-and-name-missing","Either styleUrl or styleName is required to resolve a style"))}function me(e){return e===null||e.type==="CIMSymbolReference"?e:{type:"CIMSymbolReference",symbol:e}}function ye(e,r,s=["gltf"]){if(r==="cimRef")return e.cimRef;if(e.formatInfos&&!K())for(const t of s){const o=e.formatInfos.find(l=>l.type===t);if(o)return o.href}return e.webRef}function J(e,r){const s={responseType:"json",query:{f:"json"},...r};return T(q(e),s)}const h="esri_en",w="Style",ce="https://cdn.arcgis.com/sharing/rest/content/items/220936cc6ed342c9937abd8f180e7d1e/resources/styles/cim/{SymbolName}.json?f=json";export{le as a,J as b,ie as c,ye as d,oe as i,se as l,ae as n,me as p,ce as w};
