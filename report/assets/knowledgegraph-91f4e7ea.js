import{_ as k}from"./request-a10d6950.js";import{c as N}from"./Error-21d1d076.js";import"./geometry-31b45acd.js";import{a as I,b as m,r as l,a0 as Q,d as T,G as y,aG as U,q as V,N as E,U as _,T as K,E as q,X as P,l as M,t as j,aH as B,aI as A,aJ as C}from"./arcadeUtils-2b696ebb.js";import{l as L}from"./portalUtils-99815786.js";import{n as W,R as O,d as H}from"./Extent-2b4578b8.js";import{E as X,B as Y,U as z}from"./projection-41da473c.js";import{Q as b}from"./Portal-cb507469.js";import Z from"./PortalItem-9d3416e3.js";import{p as $,n as tt}from"./project-44b24f84.js";import{a as rt,m as nt,t as et,p as it,c as ot}from"./GraphQueryStreaming-7c6b1c66.js";import{f as G}from"./SpatialReference-428523ee.js";import"./typedArrayUtil-2af43698.js";import"./JSONSupport-acf2865c.js";import"./subclass-f7409b1b.js";import"./promiseUtils-1d963c7c.js";import"./time-0817624a.js";import"./Polyline-013cde1f.js";import"./aaBoundingRect-aef00841.js";import"./Axis-30be7e73.js";import"./mathUtils-19b6edfc.js";import"./typeUtils-3056a943.js";import"./jsonMap-5ba4a9c2.js";import"./TimeOnly-e43464ca.js";import"./UnknownTimeZone-8ede07af.js";import"./datetime-7e00d9ef.js";import"./locale-bde6d0f6.js";import"./ImmutableArray-ee1d0ce7.js";import"./Field-be948aef.js";import"./enumeration-4a4e87c4.js";import"./fieldType-4834e8bc.js";import"./number-6ee739f3.js";import"./jsonUtils-2c7f966c.js";import"./featureConversionUtils-e62978d0.js";import"./aaBoundingBox-7242ce3e.js";import"./OptimizedFeature-0af09c7a.js";import"./OptimizedFeatureSet-1d1ac4b9.js";import"./OptimizedGeometry-5ad221bf.js";import"./FieldsIndex-9238b8b6.js";import"./fieldUtils-fcb2a714.js";import"./intl-fe039018.js";import"./date-7940da18.js";import"./messages-2d262041.js";import"./assets-6fd92e57.js";import"./cast-e7a2f9aa.js";import"./SimpleObservable-ae589a25.js";import"./projectBuffer-af7b4ad9.js";import"./zscale-d7e12601.js";import"./Loadable-8a1ead8b.js";import"./Promise-ec74e14b.js";import"./persistableUrlUtils-ca6bb38d.js";import"./utils-3234cfff.js";import"./utils-ed91a700.js";let u=null;async function at(t){const r=N.geometryServiceUrl??"";if(!r){X()||await Y();for(const n of t)n.container[n.indexer]=z(n.container[n.indexer],G.WGS84);return}const e=t.map(n=>n.container[n.indexer]),o=new $({geometries:e,outSpatialReference:G.WGS84}),p=await tt(r,o);for(let n=0;n<p.length;n++){const i=t[n];i.container[i.indexer]=p[n]}}async function D(t,r){const e=new Z({portal:t,id:r});return await e.load(),u===null&&(u=await k(()=>import("./knowledgeGraphService-bc5f863d.js").then(o=>o.k),["./knowledgeGraphService-bc5f863d.js","./geometry-31b45acd.js","./subclass-f7409b1b.js","./typedArrayUtil-2af43698.js","./Error-21d1d076.js","./promiseUtils-1d963c7c.js","./Extent-2b4578b8.js","./JSONSupport-acf2865c.js","./time-0817624a.js","./SpatialReference-428523ee.js","./jsonMap-5ba4a9c2.js","./request-a10d6950.js","./assets-6fd92e57.js","./cast-e7a2f9aa.js","./Polyline-013cde1f.js","./aaBoundingRect-aef00841.js","./Axis-30be7e73.js","./mathUtils-19b6edfc.js","./typeUtils-3056a943.js","./GraphQueryStreaming-7c6b1c66.js"],import.meta.url)),await u.fetchKnowledgeGraph(e.url)}function v(t,r,e,o,p){if(t===null)return null;if(y(t)||q(t))return t;if(P(t)||P(t))return t.toJSDate();if(M(t))return t.toStorageFormat();if(j(t))return t.toStorageString();if(B(t)){const n={};for(const i of t.keys())n[i]=v(t.field(i),r,e,o,p),n[i]instanceof W&&p.push({container:n,indexer:i});return n}if(_(t)){const n=t.map(i=>v(i,r,e,o,p));for(let i=0;i<n.length;i++)n[i]instanceof W&&p.push({container:n,indexer:i});return n}if(A(t)){if(t.spatialReference.isWGS84)return t;if(t.spatialReference.isWebMercator&&r)return O(t);if(!r||!e)return t;throw new m(o,l.WrongSpatialReference,null)}}function pt(t,r){if(!t)return t;if(t.spatialReference.isWGS84&&r.spatialReference.isWebMercator)return H(t);if(t.spatialReference.equals(r.spatialReference))return t;throw new m(r,l.WrongSpatialReference,null)}function S(t,r){if(!t)return null;const e={};for(const o in t)e[o]=w(t[o],r);return e}function w(t,r){return t===null?null:_(t)?t.map(e=>w(e,r)):t instanceof nt?{graphTypeName:t.typeName,id:t.id,graphType:"entity",properties:S(t.properties,r)}:t instanceof et?{graphType:"object",properties:S(t.properties,r)}:t instanceof it?{graphTypeName:t.typeName,id:t.id,graphType:"relationship",originId:t.originId??null,destinationId:t.destinationId??null,properties:S(t.properties,r)}:t instanceof ot?{graphType:"path",path:t.path?t.path.map(e=>w(e,r)):null}:A(t)?pt(t,r):y(t)||q(t)||C(t)?t:null}function pr(t){t.mode==="async"&&(t.functions.knowledgegraphbyportalitem=function(r,e){return t.standardFunctionAsync(r,e,(o,p,n)=>{var c,d;if(I(n,2,2,r,e),n[0]===null)throw new m(r,l.PortalRequired,e);if(n[0]instanceof Q){const f=T(n[1]);let h=null;return h=(c=r.services)!=null&&c.portal?r.services.portal:b.getDefault(),D(L(n[0],h),f)}if(y(n[0])===!1)throw new m(r,l.InvalidParameter,e);const i=T(n[0]);return D(((d=r.services)==null?void 0:d.portal)??b.getDefault(),i)})},t.signatures.push({name:"knowledgegraphbyportalitem",min:2,max:2}),t.functions.querygraph=function(r,e){return t.standardFunctionAsync(r,e,async(o,p,n)=>{var x;I(n,2,4,r,e);const i=n[0];if(!U(i))throw new m(r,l.InvalidParameter,e);const c=n[1];if(!y(c))throw new m(r,l.InvalidParameter,e);u===null&&(u=await k(()=>import("./knowledgeGraphService-bc5f863d.js").then(a=>a.k),["./knowledgeGraphService-bc5f863d.js","./geometry-31b45acd.js","./subclass-f7409b1b.js","./typedArrayUtil-2af43698.js","./Error-21d1d076.js","./promiseUtils-1d963c7c.js","./Extent-2b4578b8.js","./JSONSupport-acf2865c.js","./time-0817624a.js","./SpatialReference-428523ee.js","./jsonMap-5ba4a9c2.js","./request-a10d6950.js","./assets-6fd92e57.js","./cast-e7a2f9aa.js","./Polyline-013cde1f.js","./aaBoundingRect-aef00841.js","./Axis-30be7e73.js","./mathUtils-19b6edfc.js","./typeUtils-3056a943.js","./GraphQueryStreaming-7c6b1c66.js"],import.meta.url));let d=null;const f=V(n[2],null);if(!(f instanceof E||f===null))throw new m(r,l.InvalidParameter,e);if(f){let a=[];d=v(f,!0,!1,r,a),a=a.filter(s=>!s.container[s.indexer].spatialReference.isWGS84),a.length>0&&await at(a)}const h=new rt({openCypherQuery:c,bindParameters:d});(((x=i==null?void 0:i.serviceDefinition)==null?void 0:x.currentVersion)??11.3)>11.2&&(h.outputSpatialReference=r.spatialReference);const F=(await u.executeQueryStreaming(i,h)).resultRowsStream.getReader(),R=[];try{for(;;){const{done:a,value:s}=await F.read();if(a)break;if(_(s))for(const g of s)R.push(w(g,r));else{const g=[];for(const J of s)g.push(w(s[J],r));R.push(g)}}}catch(a){throw a}return E.convertJsonToArcade(R,K(r),!1,!0)})},t.signatures.push({name:"querygraph",min:2,max:4}))}export{pr as registerFunctions};
