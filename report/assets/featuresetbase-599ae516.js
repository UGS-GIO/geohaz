import{m as Ie}from"./TimeOnly-e43464ca.js";import{a as E,t as De,l as X,B as A,N as v,b as c,r as p,G as P,d as N,ar as Te,T as me,X as ue,q as L,S as M,U as x,H as G,a0 as be,Q as k,I as Ee,h as O,D as Ne,as as xe,at as B,a5 as Y,au as Ae,av as q}from"./arcadeUtils-2b696ebb.js";import{e as de,j as Se,q as ce,f as Le,c as _,a as Ce,b as ve,d as Pe,g as ee,k as Ze,F as $e,A as Ue,B as R,h as Re,i as K,L as C,I as te}from"./featureSetUtils-837ec12a.js";import{t as ke}from"./ImmutableArray-ee1d0ce7.js";import{l as Me}from"./portalUtils-99815786.js";import{u as Oe,D as pe}from"./SpatialFilter-4d4462ce.js";import{S as ze}from"./promiseUtils-1d963c7c.js";import{x as T}from"./WhereClause-239b807b.js";import ne from"./FeatureLayer-f68eb3e5.js";import{y as j}from"./Field-be948aef.js";import{Q as ye}from"./Portal-cb507469.js";import"./Error-21d1d076.js";import"./typedArrayUtil-2af43698.js";import"./UnknownTimeZone-8ede07af.js";import"./datetime-7e00d9ef.js";import"./locale-bde6d0f6.js";import"./Extent-2b4578b8.js";import"./subclass-f7409b1b.js";import"./JSONSupport-acf2865c.js";import"./time-0817624a.js";import"./SpatialReference-428523ee.js";import"./jsonMap-5ba4a9c2.js";import"./request-a10d6950.js";import"./assets-6fd92e57.js";import"./cast-e7a2f9aa.js";import"./geometry-31b45acd.js";import"./Polyline-013cde1f.js";import"./aaBoundingRect-aef00841.js";import"./Axis-30be7e73.js";import"./mathUtils-19b6edfc.js";import"./typeUtils-3056a943.js";import"./number-6ee739f3.js";import"./jsonUtils-2c7f966c.js";import"./featureConversionUtils-e62978d0.js";import"./aaBoundingBox-7242ce3e.js";import"./OptimizedFeature-0af09c7a.js";import"./OptimizedFeatureSet-1d1ac4b9.js";import"./OptimizedGeometry-5ad221bf.js";import"./FieldsIndex-9238b8b6.js";import"./fieldUtils-fcb2a714.js";import"./intl-fe039018.js";import"./date-7940da18.js";import"./messages-2d262041.js";import"./Graphic-f1881791.js";import"./PopupTemplate-18f22683.js";import"./Clonable-b71fa929.js";import"./Collection-aa6ef54b.js";import"./Evented-b5127116.js";import"./SimpleObservable-ae589a25.js";import"./enumeration-4a4e87c4.js";import"./Color-e1a6dfab.js";import"./colorUtils-ac6863dc.js";import"./Identifiable-1430bdc2.js";import"./symbols-b3e075ad.js";import"./TextSymbol-53669eb2.js";import"./screenUtils-7afeb41c.js";import"./opacityUtils-f0a081b4.js";import"./symbolLayerUtils3D-5b91ffd6.js";import"./persistableUrlUtils-ca6bb38d.js";import"./collectionUtils-b6e30316.js";import"./reactiveUtils-e7d9f86e.js";import"./MD5-715f37cd.js";import"./SubtypeGroupLayer-209b3958.js";import"./loadAll-19f96669.js";import"./Loadable-8a1ead8b.js";import"./Promise-ec74e14b.js";import"./MultiOriginJSONSupport-9bd581c6.js";import"./Layer-668dff8a.js";import"./APIKeyMixin-7c0d27b5.js";import"./ArcGISService-1a65aba0.js";import"./arcgisLayerUrl-0c479f71.js";import"./BlendLayer-2e0705c7.js";import"./mat4f32-1b45b54f.js";import"./mat4-a6ac6b0f.js";import"./CustomParametersMixin-882f293c.js";import"./EditBusLayer-7f92d599.js";import"./uuid-709b6c67.js";import"./FeatureLayerBase-5d10c7bd.js";import"./commonProperties-0c35c2c9.js";import"./TimeExtent-579f0e32.js";import"./timeUtils-24502426.js";import"./ElevationInfo-e9f55e40.js";import"./lengthUtils-1e9c410b.js";import"./HeightModelInfo-46c4a968.js";import"./featureLayerUtils-87358b6a.js";import"./Query-aaf746b1.js";import"./DataLayerSource-62d0bfcf.js";import"./layerUtils-c805b05c.js";import"./SimpleRenderer-2c5d637a.js";import"./UniqueValueRenderer-983c9a3e.js";import"./diffUtils-d0e8b583.js";import"./colorRamps-bef5e122.js";import"./ColorStop-6cee3909.js";import"./visualVariableUtils-79811b9c.js";import"./compilerUtils-7f5a3043.js";import"./styleUtils-d9ef5ac0.js";import"./AttachmentQuery-36a8e4f4.js";import"./RelationshipQuery-722111d3.js";import"./fieldType-4834e8bc.js";import"./LayerFloorInfo-88589fec.js";import"./serviceCapabilitiesUtils-d90db62d.js";import"./OperationalLayer-04352719.js";import"./PortalLayer-f8b97b56.js";import"./PortalItem-9d3416e3.js";import"./portalItemUtils-8aceb0b8.js";import"./projection-41da473c.js";import"./projectBuffer-af7b4ad9.js";import"./zscale-d7e12601.js";import"./RefreshableLayer-9477518b.js";import"./ScaleRangeLayer-61383a56.js";import"./TemporalLayer-114f16ec.js";import"./TimeInfo-c87ecbc7.js";import"./fieldProperties-663ad9a8.js";import"./ClassBreaksRenderer-aa69b6ca.js";import"./jsonUtils-7ee1282d.js";import"./LRUCache-000d0e19.js";import"./Version-ef27dfc4.js";import"./colorUtils-f660fd36.js";import"./vec42-a95eff2d.js";import"./vec4f64-430e4feb.js";import"./utils-064c64c4.js";import"./heatmapUtils-7a838493.js";import"./FormTemplate-b1394f1a.js";import"./FeatureTemplate-231bfadc.js";import"./LabelClass-bca4dcea.js";import"./defaults-473b7c21.js";import"./defaultsJSON-b087dd4d.js";import"./labelingInfo-f5739018.js";import"./popupUtils-de5a8217.js";import"./versionUtils-28beeff3.js";import"./interfaces-f1f22245.js";import"./infoFor3D-24efd44a.js";import"./executeQueryJSON-7d8733f5.js";import"./utils-3234cfff.js";import"./query-21390169.js";import"./normalizeUtils-059b11cb.js";import"./normalizeUtilsCommon-c4e9ddb1.js";import"./utils-ed91a700.js";import"./urlUtils-6a004888.js";import"./pbfQueryUtils-06460449.js";import"./pbf-1d598563.js";import"./queryZScale-b694be92.js";import"./FeatureSet-32e85c3a.js";import"./executeQueryPBF-9bfb856e.js";import"./AttachmentInfo-9ba6d827.js";import"./executeForIds-6ac7b389.js";import"./TopFeaturesQuery-827caf55.js";import"./FeatureType-d0808bff.js";import"./geometryEngineAsync-3f38ddd3.js";import"./workers-1be2b889.js";import"./Connection-2d969448.js";import"./editsZScale-c4af7049.js";import"./FeatureEffectLayer-f145f4bc.js";import"./FeatureReductionLayer-b89875ed.js";import"./FeatureReductionSelection-d7d28c54.js";import"./OrderedLayer-69f0528e.js";import"./styleUtils-f1a4091c.js";function He(o,t,r,d){if(d.length===1){if(x(d[0]))return q(o,d[0],-1);if(k(d[0]))return q(o,d[0].toArray(),-1)}return q(o,d,-1)}async function ie(o,t,r){const d=o.getVariables();if(d.length>0){const F=[];for(let n=0;n<d.length;n++){const a={name:d[n]};F.push(await t.evaluateIdentifier(r,a))}const e={};for(let n=0;n<d.length;n++)e[d[n]]=F[n];return o.parameters=e,o}return o}function u(o,t,r=null){for(const d in o)if(d.toLowerCase()===t.toLowerCase())return o[d];return r}function we(o){if(o===null)return null;const t={type:u(o,"type",""),name:u(o,"name","")};if(t.type==="range")t.range=u(o,"range",[]);else{t.codedValues=[];for(const r of u(o,"codedValues",[]))t.codedValues.push({name:u(r,"name",""),code:u(r,"code",null)})}return t}function re(o){if(o===null)return null;const t={},r=u(o,"wkt",null);r!==null&&(t.wkt=r);const d=u(o,"wkid",null);return d!==null&&(t.wkid=d),t}function he(o){if(o===null)return null;const t={hasZ:u(o,"hasz",!1),hasM:u(o,"hasm",!1)},r=u(o,"spatialreference",null);r&&(t.spatialReference=re(r));const d=u(o,"x",null);if(d!==null)return t.x=d,t.y=u(o,"y",null),t.hasZ&&(t.z=u(o,"z",null)),t.hasM&&(t.m=u(o,"m",null)),t;const F=u(o,"rings",null);if(F!==null)return t.rings=F,t;const e=u(o,"paths",null);if(e!==null)return t.paths=e,t;const n=u(o,"points",null);if(n!==null)return t.points=n,t;for(const a of["xmin","xmax","ymin","ymax","zmin","zmax","mmin","mmax"]){const m=u(o,a,null);m!==null&&(t[a]=m)}return t}function We(o,t){for(const r of t)if(r===o)return!0;return!1}function je(o){return!!o.layerDefinition&&!!o.featureSet&&We(o.layerDefinition.geometryType,["",null,"esriGeometryNull","esriGeometryPoint","esriGeometryPolyline","esriGeometryPolygon","esriGeometryMultipoint","esriGeometryEnvelope"])!==!1&&x(o.layerDefinition.fields)!==!1&&x(o.featureSet.features)!==!1}function z(o){return(o==null?void 0:o.toLowerCase())==="utc"?"UTC":(o==null?void 0:o.toLowerCase())==="unknown"?"Unknown":o}function zi(o){o.mode==="async"&&(o.functions.timezone=function(t,r){return o.standardFunctionAsync(t,r,async(d,F,e)=>{var m,y;if(E(e,1,2,t,r),De(e[0])||X(e[0]))return"Unknown";if(A(e[0])){if(await e[0].load(),e.length===1||e[1]===null)return e[0].datesInUnknownTimezone?z("unknown"):z(e[0].dateFieldsTimeZone);if(!(e[1]instanceof v)||e[1].hasField("type")===!1)throw new c(t,p.InvalidParameter,r);const l=e[1].field("type");if(P(l)===!1)throw new c(t,p.InvalidParameter,r);switch(N(l).toLowerCase()){case"preferredtimezone":return z(e[0].preferredTimeZone);case"editfieldsinfo":return z(((m=e[0].editFieldsInfo)==null?void 0:m.timeZone)??null);case"timeinfo":return z(((y=e[0].timeInfo)==null?void 0:y.timeZone)??null);case"field":if(e[1].hasField("fieldname")&&P(e[1].field("fieldname")))return z(e[0].fieldTimeZone(N(e[1].field("fieldname"))))}throw new c(t,p.InvalidParameter,r)}const n=Te(e[0],me(t));if(n===null)return null;const a=n.timeZone;return a==="system"?Ie.systemTimeZoneCanonicalName:a.toLowerCase()==="utc"?"UTC":a.toLowerCase()==="unknown"?"Unknown":a})},o.functions.sqltimestamp=function(t,r){return o.standardFunctionAsync(t,r,async(d,F,e)=>{E(e,1,3,t,r);const n=e[0];if(ue(n)){if(e.length===1)return n.toSQLWithKeyword();if(e.length===2)return n.changeTimeZone(N(e[1])).toSQLWithKeyword();throw new c(t,p.InvalidParameter,r)}if(X(n))return n.toSQLWithKeyword();if(A(n)){if(e.length!==3)throw new c(t,p.InvalidParameter,r);await n.load();const a=N(e[1]);if(X(e[2]))return e[2].toSQLWithKeyword();if(ue(e[2])===!1)throw new c(t,p.InvalidParameter,r);const m=n.fieldTimeZone(a);return m===null?e[2].toSQLWithKeyword():e[2].changeTimeZone(m).toSQLWithKeyword()}throw new c(t,p.InvalidParameter,r)})},o.signatures.push({name:"sqltimestamp",min:2,max:4}),o.functions.featuresetbyid=function(t,r){return o.standardFunctionAsync(t,r,(d,F,e)=>{if(E(e,2,4,t,r),e[0]instanceof de){const n=N(e[1]);let a=L(e[2],null);const m=M(L(e[3],!0));if(a===null&&(a=["*"]),x(a)===!1)throw new c(t,p.InvalidParameter,r);return e[0].featureSetById(n,m,a)}throw new c(t,p.InvalidParameter,r)})},o.signatures.push({name:"featuresetbyid",min:2,max:4}),o.functions.getfeatureset=function(t,r){return o.standardFunctionAsync(t,r,(d,F,e)=>{if(E(e,1,2,t,r),G(e[0])){let n=L(e[1],"datasource");return n===null&&(n="datasource"),n=N(n).toLowerCase(),Se(e[0].fullSchema(),n,t.lrucache,t.interceptor,t.spatialReference)}throw new c(t,p.InvalidParameter,r)})},o.signatures.push({name:"getfeatureset",min:1,max:2}),o.functions.featuresetbyportalitem=function(t,r){return o.standardFunctionAsync(t,r,(d,F,e)=>{var l,i;if(E(e,2,5,t,r),e[0]===null)throw new c(t,p.PortalRequired,r);if(e[0]instanceof be){const s=N(e[1]),f=N(e[2]);let I=L(e[3],null);const D=M(L(e[4],!0));if(I===null&&(I=["*"]),x(I)===!1)throw new c(t,p.InvalidParameter,r);let w=null;return w=(l=t.services)!=null&&l.portal?t.services.portal:ye.getDefault(),w=Me(e[0],w),ce(s,f,t.spatialReference,I,D,w,t.lrucache,t.interceptor)}if(P(e[0])===!1)throw new c(t,p.PortalRequired,r);const n=N(e[0]),a=N(e[1]);let m=L(e[2],null);const y=M(L(e[3],!0));if(m===null&&(m=["*"]),x(m)===!1)throw new c(t,p.InvalidParameter,r);return ce(n,a,t.spatialReference,m,y,((i=t.services)==null?void 0:i.portal)??ye.getDefault(),t.lrucache,t.interceptor)})},o.signatures.push({name:"featuresetbyportalitem",min:2,max:5}),o.functions.featuresetbyname=function(t,r){return o.standardFunctionAsync(t,r,(d,F,e)=>{if(E(e,2,4,t,r),e[0]instanceof de){const n=N(e[1]);let a=L(e[2],null);const m=M(L(e[3],!0));if(a===null&&(a=["*"]),x(a)===!1)throw new c(t,p.InvalidParameter,r);return e[0].featureSetByName(n,m,a)}throw new c(t,p.InvalidParameter,r)})},o.signatures.push({name:"featuresetbyname",min:2,max:4}),o.functions.featureset=function(t,r){return o.standardFunction(t,r,(d,F,e)=>{E(e,1,1,t,r);let n=e[0];const a={layerDefinition:{geometryType:"",objectIdField:"",hasM:!1,hasZ:!1,globalIdField:"",typeIdField:"",fields:[]},featureSet:{geometryType:"",features:[]}};if(P(n))n=JSON.parse(n),n.layerDefinition!==void 0?(a.layerDefinition=n.layerDefinition,a.featureSet=n.featureSet,n.layerDefinition.spatialReference&&(a.layerDefinition.spatialReference=n.layerDefinition.spatialReference)):(a.featureSet.features=n.features,a.featureSet.geometryType=n.geometryType,a.layerDefinition.geometryType=a.featureSet.geometryType,a.layerDefinition.objectIdField=n.objectIdFieldName??"",a.layerDefinition.typeIdField=n.typeIdFieldName,a.layerDefinition.globalIdField=n.globalIdFieldName,a.layerDefinition.fields=n.fields,n.spatialReference&&(a.layerDefinition.spatialReference=n.spatialReference));else{if(!(e[0]instanceof v))throw new c(t,p.InvalidParameter,r);{n=JSON.parse(e[0].castToText(!0));const m=u(n,"layerdefinition");if(m!==null){a.layerDefinition.geometryType=u(m,"geometrytype",""),a.featureSet.geometryType=a.layerDefinition.geometryType,a.layerDefinition.globalIdField=u(m,"globalidfield",""),a.layerDefinition.objectIdField=u(m,"objectidfield",""),a.layerDefinition.typeIdField=u(m,"typeidfield",""),a.layerDefinition.hasZ=u(m,"hasz",!1)===!0,a.layerDefinition.hasM=u(m,"hasm",!1)===!0;const y=u(m,"spatialreference",null);y&&(a.layerDefinition.spatialReference=re(y));for(const i of u(m,"fields",[])){const s={name:u(i,"name",""),alias:u(i,"alias",""),type:u(i,"type",""),nullable:u(i,"nullable",!0),editable:u(i,"editable",!0),length:u(i,"length",null),domain:we(u(i,"domain"))};a.layerDefinition.fields.push(s)}const l=u(n,"featureset",null);if(l){const i={};for(const s of a.layerDefinition.fields)i[s.name.toLowerCase()]=s.name;for(const s of u(l,"features",[])){const f={},I=u(s,"attributes",{});for(const D in I)f[i[D.toLowerCase()]]=I[D];a.featureSet.features.push({attributes:f,geometry:he(u(s,"geometry",null))})}}}else{a.layerDefinition.hasZ=u(n,"hasz",!1)===!0,a.layerDefinition.hasM=u(n,"hasm",!1)===!0,a.layerDefinition.geometryType=u(n,"geometrytype",""),a.featureSet.geometryType=a.layerDefinition.geometryType,a.layerDefinition.objectIdField=u(n,"objectidfieldname",""),a.layerDefinition.typeIdField=u(n,"typeidfieldname","");const y=u(n,"spatialreference",null);y&&(a.layerDefinition.spatialReference=re(y));let l=u(n,"fields",null);if(x(l))for(const f of l){const I={name:u(f,"name",""),alias:u(f,"alias",""),type:u(f,"type",""),nullable:u(f,"nullable",!0),editable:u(f,"editable",!0),length:u(f,"length",null),domain:we(u(f,"domain"))};a.layerDefinition.fields.push(I)}else l=null,a.layerDefinition.fields=l;const i={};for(const f of a.layerDefinition.fields)i[f.name.toLowerCase()]=f.name;let s=u(n,"features",null);if(x(s))for(const f of s){const I={},D=u(f,"attributes",{});for(const w in D)I[i[w.toLowerCase()]]=D[w];a.featureSet.features.push({attributes:I,geometry:he(u(f,"geometry",null))})}else s=null,a.featureSet.features=s}}}if(je(a)===!1)throw new c(t,p.InvalidParameter,r);return a.layerDefinition.geometryType||(a.layerDefinition.geometryType="esriGeometryNull"),Le.create(a,t.spatialReference)})},o.signatures.push({name:"featureset",min:1,max:1}),o.functions.filter=function(t,r){return o.standardFunctionAsync(t,r,async(d,F,e)=>{if(E(e,2,2,t,r),x(e[0])||k(e[0])){const n=[];let a=e[0];a instanceof ke&&(a=a.toArray());let m=null;if(!Ee(e[1]))throw new c(t,p.InvalidParameter,r);m=e[1].createFunction(t);for(const y of a){const l=m(y);ze(l)?await l===!0&&n.push(y):l===!0&&n.push(y)}return n}if(A(e[0])){const n=await e[0].load(),a=T.create(e[1],n.getFieldsIndex(),n.dateFieldsTimeZoneDefaultUTC),m=a.getVariables();if(m.length>0){const y=[];for(let i=0;i<m.length;i++){const s={name:m[i]};y.push(await o.evaluateIdentifier(t,s))}const l={};for(let i=0;i<m.length;i++)l[m[i]]=y[i];return a.parameters=l,new _({parentfeatureset:e[0],whereclause:a})}return new _({parentfeatureset:e[0],whereclause:a})}throw new c(t,p.InvalidParameter,r)})},o.signatures.push({name:"filter",min:2,max:2}),o.functions.orderby=function(t,r){return o.standardFunctionAsync(t,r,async(d,F,e)=>{if(E(e,2,2,t,r),A(e[0])){const n=new Ce(e[1]);return new ve({parentfeatureset:e[0],orderbyclause:n})}throw new c(t,p.InvalidParameter,r)})},o.signatures.push({name:"orderby",min:2,max:2}),o.functions.top=function(t,r){return o.standardFunctionAsync(t,r,async(d,F,e)=>{if(E(e,2,2,t,r),A(e[0]))return new Pe({parentfeatureset:e[0],topnum:e[1]});if(x(e[0]))return O(e[1])>=e[0].length?e[0].slice(0):e[0].slice(0,O(e[1]));if(k(e[0]))return O(e[1])>=e[0].length()?e[0].slice(0):e[0].slice(0,O(e[1]));throw new c(t,p.InvalidParameter,r)})},o.signatures.push({name:"top",min:2,max:2}),o.functions.first=function(t,r){return o.standardFunctionAsync(t,r,async(d,F,e)=>{if(E(e,1,1,t,r),A(e[0])){const n=await e[0].first(d.abortSignal);if(n!==null){const a=Ne.createFromGraphicLikeObject(n.geometry,n.attributes,e[0],t.timeZone);return a._underlyingGraphic=n,a}return n}return x(e[0])?e[0].length===0?null:e[0][0]:k(e[0])?e[0].length()===0?null:e[0].get(0):null})},o.signatures.push({name:"first",min:1,max:1}),o.functions.attachments=function(t,r){return o.standardFunctionAsync(t,r,async(d,F,e)=>{E(e,1,2,t,r);const n={minsize:-1,maxsize:-1,types:null,returnMetadata:!1};if(e.length>1){if(e[1]instanceof v){if(e[1].hasField("minsize")&&(n.minsize=O(e[1].field("minsize"))),e[1].hasField("metadata")&&(n.returnMetadata=M(e[1].field("metadata"))),e[1].hasField("maxsize")&&(n.maxsize=O(e[1].field("maxsize"))),e[1].hasField("types")){const a=xe(e[1].field("types"),!1);a.length>0&&(n.types=a)}}else if(e[1]!==null)throw new c(t,p.InvalidParameter,r)}if(G(e[0])){let a=e[0]._layer;return a instanceof ne&&(a=ee(a,t.spatialReference,["*"],!0,t.lrucache,t.interceptor)),a===null?[]:A(a)===!1?[]:(await a.load(),a.queryAttachments(e[0].field(a.objectIdField),n.minsize,n.maxsize,n.types,n.returnMetadata))}if(e[0]===null)return[];throw new c(t,p.InvalidParameter,r)})},o.signatures.push({name:"attachments",min:1,max:2}),o.functions.featuresetbyrelationshipname=function(t,r){return o.standardFunctionAsync(t,r,async(d,F,e)=>{E(e,2,4,t,r);const n=e[0],a=N(e[1]);let m=L(e[2],null);const y=M(L(e[3],!0));if(m===null&&(m=["*"]),x(m)===!1)throw new c(t,p.InvalidParameter,r);if(e[0]===null)return null;if(!G(e[0]))throw new c(t,p.InvalidParameter,r);let l=n._layer;if(l instanceof ne&&(l=ee(l,t.spatialReference,["*"],!0,t.lrucache,t.interceptor)),l===null||A(l)===!1)return null;l=await l.load();const i=l.relationshipMetaData().filter(w=>w.name===a);if(i.length===0)return null;if(i[0].relationshipTableId!==void 0&&i[0].relationshipTableId!==null&&i[0].relationshipTableId>-1)return Ze(l,i[0],n.field(l.objectIdField),l.spatialReference,m,y,t.lrucache,t.interceptor);let s=l.serviceUrl();if(!s)return null;s=s.charAt(s.length-1)==="/"?s+i[0].relatedTableId.toString():s+"/"+i[0].relatedTableId.toString();const f=await $e(s,l.spatialReference,m,y,t.lrucache,t.interceptor);await f.load();let I=f.relationshipMetaData();if(I=I.filter(w=>w.id===i[0].id),n.hasField(i[0].keyField)===!1||n.field(i[0].keyField)===null){const w=await l.getFeatureByObjectId(n.field(l.objectIdField),[i[0].keyField]);if(w){const b=T.create(I[0].keyField+"= @id",f.getFieldsIndex(),f.dateFieldsTimeZoneDefaultUTC);return b.parameters={id:w.attributes[i[0].keyField]},f.filter(b)}return new Oe({parentfeatureset:f})}const D=T.create(I[0].keyField+"= @id",f.getFieldsIndex(),f.dateFieldsTimeZoneDefaultUTC);return D.parameters={id:n.field(i[0].keyField)},f.filter(D)})},o.signatures.push({name:"featuresetbyrelationshipname",min:2,max:4}),o.functions.featuresetbyassociation=function(t,r){return o.standardFunctionAsync(t,r,async(d,F,e)=>{E(e,2,3,t,r);const n=e[0],a=N(L(e[1],"")).toLowerCase(),m=P(e[2])?N(e[2]):null;if(e[0]===null)return null;if(!G(e[0]))throw new c(t,p.InvalidParameter,r);let y=n._layer;if(y instanceof ne&&(y=ee(y,t.spatialReference,["*"],!0,t.lrucache,t.interceptor)),y===null||A(y)===!1)return null;await y.load();const l=y.serviceUrl(),i=await Ue(l,t.spatialReference);let s=null,f=null,I=!1;if(m!==null&&m!==""&&m!==void 0){for(const g of i.terminals)g.terminalName===m&&(f=g.terminalId);f===null&&(I=!0)}const D=i.associations.getFieldsIndex(),w=D.get("TOGLOBALID").name,b=D.get("FROMGLOBALID").name,Q=D.get("TOTERMINALID").name,V=D.get("FROMTERMINALID").name,H=D.get("FROMNETWORKSOURCEID").name,W=D.get("TONETWORKSOURCEID").name,U=D.get("ASSOCIATIONTYPE").name,ge=D.get("ISCONTENTVISIBLE").name,Fe=D.get("OBJECTID").name;for(const g of y.fields)if(g.type==="global-id"){s=n.field(g.name);break}let Z=null,ae=new R(new j({name:"percentalong",alias:"percentalong",type:"double"}),T.create("0",i.associations.getFieldsIndex(),i.associations.dateFieldsTimeZoneDefaultUTC)),oe=new R(new j({name:"side",alias:"side",type:"string"}),T.create("''",i.associations.getFieldsIndex(),i.associations.dateFieldsTimeZoneDefaultUTC));const S="globalid",se="globalId",le={};for(const g in i.lkp)le[g]=i.lkp[g].sourceId;const $=new Re(new j({name:"classname",alias:"classname",type:"string"}),null,le);let h="";switch(a){case"midspan":{h=`((${w}='${s}') OR ( ${b}='${s}')) AND (${U} IN (5))`,$.codefield=T.create(`CASE WHEN (${w}='${s}') THEN ${H} ELSE ${W} END`,i.associations.getFieldsIndex(),i.associations.dateFieldsTimeZoneDefaultUTC);const g=Y(C.findField(i.associations.fields,b));g.name=S,g.alias=S,Z=new R(g,T.create(`CASE WHEN (${b}='${s}') THEN ${w} ELSE ${b} END`,i.associations.getFieldsIndex(),i.associations.dateFieldsTimeZoneDefaultUTC)),ae=i.unVersion>=4?new te(C.findField(i.associations.fields,D.get("PERCENTALONG").name)):new R(new j({name:"percentalong",alias:"percentalong",type:"double"}),T.create("0",i.associations.getFieldsIndex(),i.associations.dateFieldsTimeZoneDefaultUTC));break}case"junctionedge":{h=`((${w}='${s}') OR ( ${b}='${s}')) AND (${U} IN (4,6))`,$.codefield=T.create(`CASE WHEN (${w}='${s}') THEN ${H} ELSE ${W} END`,i.associations.getFieldsIndex(),i.associations.dateFieldsTimeZoneDefaultUTC);const g=Y(C.findField(i.associations.fields,b));g.name=S,g.alias=S,Z=new R(g,T.create(`CASE WHEN (${b}='${s}') THEN ${w} ELSE ${b} END`,i.associations.getFieldsIndex(),i.associations.dateFieldsTimeZoneDefaultUTC)),oe=new R(new j({name:"side",alias:"side",type:"string"}),T.create(`CASE WHEN (${U}=4) THEN 'from' ELSE 'to' END`,i.associations.getFieldsIndex(),i.associations.dateFieldsTimeZoneDefaultUTC));break}case"connected":{let g=`${w}='@T'`,fe=`${b}='@T'`;f!==null&&(g+=` AND ${Q}=@A`,fe+=` AND ${V}=@A`),h="(("+g+") OR ("+fe+"))",h=B(h,"@T",s??""),g=B(g,"@T",s??""),f!==null&&(g=B(g,"@A",f.toString()),h=B(h,"@A",f.toString())),$.codefield=T.create("CASE WHEN "+g+` THEN ${H} ELSE ${W} END`,i.associations.getFieldsIndex(),i.associations.dateFieldsTimeZoneDefaultUTC);const J=Y(C.findField(i.associations.fields,b));J.name=S,J.alias=S,Z=new R(J,T.create("CASE WHEN "+g+` THEN ${b} ELSE ${w} END`,i.associations.getFieldsIndex(),i.associations.dateFieldsTimeZoneDefaultUTC));break}case"container":h=`${w}='${s}' AND ${U} = 2`,f!==null&&(h+=` AND ${Q} = `+f.toString()),$.codefield=H,h="( "+h+" )",Z=new K(C.findField(i.associations.fields,b),S,S);break;case"content":h=`(${b}='${s}' AND ${U} = 2)`,f!==null&&(h+=` AND ${V} = `+f.toString()),$.codefield=W,h="( "+h+" )",Z=new K(C.findField(i.associations.fields,w),S,S);break;case"structure":h=`(${w}='${s}' AND ${U} = 3)`,f!==null&&(h+=` AND ${Q} = `+f.toString()),$.codefield=H,h="( "+h+" )",Z=new K(C.findField(i.associations.fields,b),S,se);break;case"attached":h=`(${b}='${s}' AND ${U} = 3)`,f!==null&&(h+=` AND ${V} = `+f.toString()),$.codefield=W,h="( "+h+" )",Z=new K(C.findField(i.associations.fields,w),S,se);break;default:throw new c(t,p.InvalidParameter,r)}return I&&(h="1 <> 1"),new C({parentfeatureset:i.associations,adaptedFields:[new te(C.findField(i.associations.fields,Fe)),new te(C.findField(i.associations.fields,ge)),Z,oe,$,ae],extraFilter:h?T.create(h,i.associations.getFieldsIndex(),i.associations.dateFieldsTimeZoneDefaultUTC):null})})},o.signatures.push({name:"featuresetbyassociation",min:2,max:6}),o.functions.groupby=function(t,r){return o.standardFunctionAsync(t,r,async(d,F,e)=>{if(E(e,3,3,t,r),!A(e[0]))throw new c(t,p.InvalidParameter,r);const n=await e[0].load(),a=[],m=[];let y=!1,l=[];if(P(e[1]))l.push(e[1]);else if(e[1]instanceof v)l.push(e[1]);else if(x(e[1]))l=e[1];else{if(!k(e[1]))throw new c(t,p.InvalidParameter,r);l=e[1].toArray()}for(const i of l)if(P(i)){const s=T.create(N(i),n.getFieldsIndex(),n.dateFieldsTimeZoneDefaultUTC),f=pe(s)===!0?N(i):"%%%%FIELDNAME";a.push({name:f,expression:s}),f==="%%%%FIELDNAME"&&(y=!0)}else{if(!(i instanceof v))throw new c(t,p.InvalidParameter,r);{const s=i.hasField("name")?i.field("name"):"%%%%FIELDNAME",f=i.hasField("expression")?i.field("expression"):"";if(s==="%%%%FIELDNAME"&&(y=!0),!s)throw new c(t,p.InvalidParameter,r);a.push({name:s,expression:T.create(f||s,n.getFieldsIndex(),n.dateFieldsTimeZoneDefaultUTC)})}}if(l=[],P(e[2]))l.push(e[2]);else if(x(e[2]))l=e[2];else if(k(e[2]))l=e[2].toArray();else{if(!(e[2]instanceof v))throw new c(t,p.InvalidParameter,r);l.push(e[2])}for(const i of l){if(!(i instanceof v))throw new c(t,p.InvalidParameter,r);{const s=i.hasField("name")?i.field("name"):"",f=i.hasField("statistic")?i.field("statistic"):"",I=i.hasField("expression")?i.field("expression"):"";if(!s||!f||!I)throw new c(t,p.InvalidParameter,r);m.push({name:s,statistic:f.toLowerCase(),expression:T.create(I,n.getFieldsIndex(),n.dateFieldsTimeZoneDefaultUTC)})}}if(y){const i={};for(const f of n.fields)i[f.name.toLowerCase()]=1;for(const f of a)f.name!=="%%%%FIELDNAME"&&(i[f.name.toLowerCase()]=1);for(const f of m)f.name!=="%%%%FIELDNAME"&&(i[f.name.toLowerCase()]=1);let s=0;for(const f of a)if(f.name==="%%%%FIELDNAME"){for(;i["field_"+s.toString()]===1;)s++;i["field_"+s.toString()]=1,f.name="FIELD_"+s.toString()}}for(const i of a)await ie(i.expression,o,t);for(const i of m)await ie(i.expression,o,t);return e[0].groupby(a,m)})},o.signatures.push({name:"groupby",min:3,max:3}),o.functions.distinct=function(t,r){return o.standardFunctionAsync(t,r,async(d,F,e)=>{if(A(e[0])){E(e,2,2,t,r);const n=await e[0].load(),a=[];let m=[];if(P(e[1]))m.push(e[1]);else if(e[1]instanceof v)m.push(e[1]);else if(x(e[1]))m=e[1];else{if(!k(e[1]))throw new c(t,p.InvalidParameter,r);m=e[1].toArray()}let y=!1;for(const l of m)if(P(l)){const i=T.create(N(l),n.getFieldsIndex(),n.dateFieldsTimeZoneDefaultUTC),s=pe(i)===!0?N(l):"%%%%FIELDNAME";a.push({name:s,expression:i}),s==="%%%%FIELDNAME"&&(y=!0)}else{if(!(l instanceof v))throw new c(t,p.InvalidParameter,r);{const i=l.hasField("name")?l.field("name"):"%%%%FIELDNAME",s=l.hasField("expression")?l.field("expression"):"";if(i==="%%%%FIELDNAME"&&(y=!0),!i)throw new c(t,p.InvalidParameter,r);a.push({name:i,expression:T.create(s||i,n.getFieldsIndex(),n.dateFieldsTimeZoneDefaultUTC)})}}if(y){const l={};for(const s of n.fields)l[s.name.toLowerCase()]=1;for(const s of a)s.name!=="%%%%FIELDNAME"&&(l[s.name.toLowerCase()]=1);let i=0;for(const s of a)if(s.name==="%%%%FIELDNAME"){for(;l["field_"+i.toString()]===1;)i++;l["field_"+i.toString()]=1,s.name="FIELD_"+i.toString()}}for(const l of a)await ie(l.expression,o,t);return e[0].groupby(a,[])}return He("distinct",d,F,e)})}),o.functions.getfeaturesetinfo=function(t,r){return o.standardFunctionAsync(t,r,async(d,F,e)=>{if(E(e,1,1,t,r),!A(e[0]))return null;const n=await e[0].getFeatureSetInfo();return n?v.convertObjectToArcadeDictionary({layerId:n.layerId,layerName:n.layerName,itemId:n.itemId,serviceLayerUrl:n.serviceLayerUrl,webMapLayerId:n.webMapLayerId??null,webMapLayerTitle:n.webMapLayerTitle??null,className:null,objectClassId:null},me(t),!1,!1):null})},o.signatures.push({name:"getfeaturesetinfo",min:1,max:1}),o.functions.filterbysubtypecode=function(t,r){return o.standardFunctionAsync(t,r,async(d,F,e)=>{if(E(e,2,2,t,r),A(e[0])){const n=await e[0].load(),a=e[1];if(!Ae(a))throw new c(t,p.InvalidParameter,r);if(n.subtypeField){const y=T.create(`${n.subtypeField}= ${e[1]}`,n.getFieldsIndex(),n.dateFieldsTimeZoneDefaultUTC);return new _({parentfeatureset:e[0],whereclause:y})}if(n.typeIdField===null||n.typeIdField==="")throw new c(t,p.FeatureSetDoesNotHaveSubtypes,r);const m=T.create(`${n.typeIdField}= ${e[1]}`,n.getFieldsIndex(),n.dateFieldsTimeZoneDefaultUTC);return new _({parentfeatureset:e[0],whereclause:m})}throw new c(t,p.InvalidParameter,r)})},o.signatures.push({name:"filterbysubtypecode",min:2,max:2})}export{zi as registerFunctions};
